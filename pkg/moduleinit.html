<!DOCTYPE html>
<html lang="en">
<head>
  <title>Nim Package Directory</title>
  <link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="alternate" type="application/rss+xml" title="New and updated Nim packages" href="https://nimble.directory/packages.xml">
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/highlite.css">
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script type="text/javascript" src="/js/app.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg fixed-top py-3">
  <div class="container">
    <a href="/" class="logo fw-500 display-1 text-black text-decoration-none navbar-brand"></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item mx-2">
          <a href="https://nim-lang.org/" class="nav-link">What's Nim?</a>
        </li>
        <li class="nav-item mx-2">
          <a href="/about.html" class="nav-link">What's Nimble?</a>
        </li>
        <li class="nav-item mx-2">
          <a href="https://github.com/nim-lang/packages/" class="nav-link">Publish your package</a>
        </li>
        <!-- TODO: replace with something different -->
        <li class="nav-item ms-3">
          <a class="nav-link" href="https://www.youtube.com/channel/UCDAYn_VFt0VisL5-1a5Dk7Q/">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon></svg>
          </a>
        </li>
        <li class="nav-item ms-3">
          <a class="nav-link theme-switcher-btn" id="darkmode" onclick="toggle_dark_mode()" href="#">
            <span id="light-mode-icon">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </span>
            <span id="dark-mode-icon">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="content">
  <div class="container">
    <div class="container pt-10">
        <h3 class="mb-3 fw-bold display-6 pt-4">moduleinit</h3>
        <p class="tags">
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">library</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">parallelism</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">threads</button></a>
                </span>
            
        </p>
        <p class="pkg-desc">some("Nim module/thread initialisation ordering library")</p>
        <a title="Copy" onclick="document.querySelector('#cmd').select();document.execCommand('copy');"
            alt="Copy on clipboard">
            <i class="fa fa-copy"></i>
        </a>
        <input id="cmd" onclick="this.select();" value="nimble install moduleinit" readonly="">
        <br>
        <small style="font-size: 0.8rem;">Need help? Read <a
                href="https://github.com/nim-lang/nimble#creating-packages">Nimble</a></small>
    </div>

    <div class="container row pt-4" id="pkg-content">
        <div class="col-8 box rounded p-3" id="readme-section">
            
                <document><h2>moduleinit</h2>
<p>nim package that provides module/thread initialisation ordering</p>
<h4>Function provided by moduleinit:</h4>
<ul>
<li>Control the order of (de)initialisation of Nim modules</li>
<li>Control the order of (de)initialisation of threadvars created by Nim modules</li>
<li>Use &quot;modules aliases&quot; / &quot;virtual modules&quot; for complex (de)initialisation</li>
<li>Circular dependencies are NOT supported, nor is there any plan to do so</li>
<li>A utility &quot;string value&quot; helper module</li>
<li>A utility &quot;any value&quot; helper module, with optional converters.</li>
<li>An optional &quot;stdlog&quot; sub module, which sets up Nim standard logging</li>
<li>TODO: Explicit support for dynamically loaded libraries</li>
</ul>
<h4>Documentation</h4>
<p>Module initialisation is broken into &quot;level 0&quot; initialisation and &quot;level 1&quot;
initialisation. There is only one level of thread initialisation.</p>
<p>Level 0 initialisation is what the runtime does for you. We don&apos;t really
have any control over it. We just know that it is done, by the time we can
actually access a module. Level 0 is used for the &quot;discovery&quot; of all modules,
so in Level 0, we should make sure to access all modules we need at least
once. To make this easy, all modules should provide an init proc like this:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">level0InitModuleXXX</span><span class="op">*</span>(): <span class="ide">void</span> <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="com">## Registers module xxx.</span></div></div><div class="line"><div class="line-content">  <span class="kwd">if</span> <span class="ide">registerModule</span>(<span class="str">&quot;xxx&quot;</span>, <span class="op">@</span>[<span class="str">&quot;yyy&quot;</span>,<span class="str">&quot;zzz&quot;</span>], <span class="ide">level1InitModuleXXX</span>,</div></div><div class="line"><div class="line-content">      <span class="ide">level1DeInitModuleXXX</span>, <span class="ide">threadInitXXX</span>, <span class="ide">threadDeInitXXX</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">level0InitModuleYYY</span>()</div></div><div class="line"><div class="line-content">    <span class="ide">level0InitModuleZZZ</span>()</div></div>  </code></pre>
<p>Modules yyy and zzz are assumed to be direct dependencies of xxx.
Everything is &quot;optional&quot;, except the name. The order of the dependencies
should not make any difference in level 0.</p>
<p>level0InitModuleXXX() can be called any number of times, once for each direct
dependent module. It should register itself with it&apos;s name, the names of it&apos;s
direct dependencies, and it&apos;s own higher-level (de)init procs. No resource
should be allocated in level0InitModuleXXX(); all resources, and in
particular threads, should be allocated in level1InitModuleXXX().
level0InitModuleXXX() should not do anything else, and leave any
initialisation that depends on other modules for level1InitModuleXXX() ...
(note that consts are safe to use on level 0).</p>
<p>threadInitXXX is a proc pointer, that will be called on thread creation, to
ensure safe initialisation of your threadvars. This requires cooperation of
the code that creates the threads.</p>
<p>registerModule() will return true only on the first call, so that we avoid
calling the level0InitModule() of dependencies more than once.</p>
<p>Once the main module level0InitModuleXXX() has been called, we can assume
that all level0InitModuleXXX() procs were called. At that point, we know all
the registered modules, can assume that no other module is used, and can move
to level 1 initialisation. This is done with runInitialisers().
runDeInitialisers() should be called before shutting down (or &quot;resetting&quot;).</p>
<p>level1InitModuleXXX() are never called directly by your code. A level 1 init
proc is called, when all level 1 init procs of it&apos;s dependencies have been
called. This proceeds, until all init procs were called (or a failure
happens). Deinitialisation works the same way, but backwards.</p>
<p>When creating a new thread, make sure to call runThreadLocalInitialisers()
as the first line of code. This will ensure that your threadInitXXX() proc,
and those of your dependencies, are called, in the right order.
runThreadLocalInitialisers() can also safely be called within threads in
which your code runs, but which were created by modules outside your control.
For example, the asyncdispatch/asyncnet standard modules. This works, because
runThreadLocalInitialisers() &quot;remembers&quot; if it was called already. Calls to
runThreadLocalDeInitialisers() are normally performed automatically, by
registering a thread-death handler in runThreadLocalInitialisers().
(The main thread is a special case.)</p>
<p>If your code use some xxx module over which you have no control, for example
a stdlib module, but that module also needs some initialisation, you can just
create a xxxinit module, that registers itself and takes care of the required
initialisation. Also use &quot;xxxinit&quot; as module name and in the dependencies.</p>
<p>OTOH, if some code depends on a third-party module, without dependencies or
initialisation requirements, you can just add the name to runInitialisers(),
as a &apos;noinit&apos; parameter. We basically pretend, that the modules in &apos;noinit&apos;
were initialised.</p>
<p>To allow things like dependency injection, or runtime composition, or if the
initialisation requires configuration parameters, or when using multi-step
initialisation, &quot;modules aliases&quot; can be used. A module alias is an abstract
module name that is mapped at runtime to a real module. Since it is abstract,
it cannot actually be accessed by the module &quot;depending&quot; on it, but allows
the dependent module to express their dependency on something that &quot;someone
else&quot; must provide.</p>
<p>For example, if you define an &quot;interface&quot; module, which exposes proc pointers
such that multiple implementations can be defined, and accessed indirectly
through the interface module, you can define an alias for the implementation.
Concretely, if you have a &quot;cluster&quot; interface module, you can, by convention,
refer to the implementation as &quot;cluster.impl&quot;. Any module that needs to
access the cluster must then depend both on &quot;cluster&quot; which is available to
them at compile time, and &quot;cluster.impl&quot; which is just a convenient way to
make sure that cluster is initialised to an actual implementation before your
module tries to access the cluster. The main (presumably) application module
will map &quot;cluster.impl&quot; to a concrete module, for example &quot;tcpcluster&quot;. The
cluster module can then come with multiple implementations, including
third-party implementations, that the application can choose from at runtime.</p>
<p>If tcpcluster itself requires a &quot;server&quot; port and IP address to be set
before it can initialise itself, it could depend, again by convention, on
&quot;tcpcluster.config&quot;, which could either be mapped, or directly implemented,
by the application code.</p>
<p>Effectively, in the current version, it would be possible to register
multiple &quot;virtual&quot; modules in a &quot;physical&quot; module file, since the
registration only requires names and proc pointers.</p>
<p>Any module that allocates resources, and in particular threads, in it&apos;s init
proc, should free those resources in it&apos;s deinit proc. Note that deinit might
also be called in the case of an initialisation failure (TODO), such that it
is best to not assume full successful initialisation when running deinit.
Implementing deinit procs make it possible for an application to re-configure
at runtime, without leaking resources.</p>
<p>Note that circular dependencies are NOT supported, nor is there any plan to
do so. Breaking modules into interface and implementation, along with using
module aliases and &quot;virtual&quot; modules, should solve most circular dependencies
problems.</p>
<p>There currently isn&apos;t explicit support for dynamically loaded libraries, but
this module is designed to support them, such that this can be added in the
future.</p>
<p>I have considered if it would be possible to find the dependencies
automatically at compile time, by scanning the imports, but I believe this
would be problematic, since all the stdlib imports would also be added as
dependencies, while not having been explicitly registered, causing the
initialisation to fail on &quot;missing modules&quot;. Also, since module aliases are
a core part of the design, and those dependencies can (presumably) not be
detected automatically, I believe that specifying the dependencies &quot;manually&quot;
is (currently) the best solution. The main downside is that you have to
remember to update level0InitModuleXXX() when changing the imports.</p>
</document>
            
        </div>
        <div class="col-3" id="meta-section">
            <div class="container box rounded p-3">
                
                    <p>
                        <strong>Licence:</strong>
                        MIT
                    </p>
                

                
                    <p> <a href="https://github.com/skunkiferous/moduleinit">Project website</a> </p>
                

                
            </div>
        </div>
    </div>
</div>
</div>

<footer class="pt-10 px-3">
  <div class="container pt-4">
    <div class="row mb-4">
      <div class="col-lg-3">
        <h4 class="h5">Getting started with Nim</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://learnxinyminutes.com/docs/nim/">Learn Nim in 5 minutes</a></li>
          <li><a class="text-decoration-none" href="https://nim-by-example.github.io/">Nim by Example</a></li>
          <li><a class="text-decoration-none" href="https://play.nim-lang.org/">Official Playground</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Official Tutorials</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut1.html">General Tutorial</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut2.html">Advanced Features</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut3.html">Macros and Metaprogramming</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Nim for...</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-C-programmers">C programmers</a></li>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-Python-Programmers">Python programmers</a></li>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-TypeScript-Programmers">TypeScript programmers</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Documentation</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/lib.html">Standard Library</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/manual.html">Language Manual</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tools.html">Tools Documentation</a></li>
        </ul>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-12 text-center mt-4 mx-auto">
        <a href="#" class="d-block mb-3 mx-auto bw"></a>
        <p class="text-muted">
        Created in <a href="https://nim-lang.org/">Nim</a> on <a href="https://pages.github.com/">GitHub Pages</a>.
        <a href="https://github.com/gabbhack/nimidirectory">Available</a>
        under <a href="https://en.wikipedia.org/wiki/GNU_General_Public_License#Version_3">GPLv3</a>
        </p>
        <p class="text-muted">
        Builded at 2023-08-27T01:10:01Z
        </p>
      </div>
    </div>
  </div>
</footer>
<script>
</script>
</body>
</html>
