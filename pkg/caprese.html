<!DOCTYPE html>
<html lang="en">
<head>
  <title>Nim Package Directory</title>
  <link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="alternate" type="application/rss+xml" title="New and updated Nim packages" href="https://nimble.directory/packages.xml">
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/highlite.css">
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script type="text/javascript" src="/js/app.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg fixed-top py-3">
  <div class="container">
    <a href="/" class="logo fw-500 display-1 text-black text-decoration-none navbar-brand"></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item mx-2">
          <a href="https://nim-lang.org/" class="nav-link">What's Nim?</a>
        </li>
        <li class="nav-item mx-2">
          <a href="/about.html" class="nav-link">What's Nimble?</a>
        </li>
        <li class="nav-item mx-2">
          <a href="https://github.com/nim-lang/packages/" class="nav-link">Publish your package</a>
        </li>
        <!-- TODO: replace with something different -->
        <li class="nav-item ms-3">
          <a class="nav-link" href="https://www.youtube.com/channel/UCDAYn_VFt0VisL5-1a5Dk7Q/">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon></svg>
          </a>
        </li>
        <li class="nav-item ms-3">
          <a class="nav-link theme-switcher-btn" id="darkmode" onclick="toggle_dark_mode()" href="#">
            <span id="light-mode-icon">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </span>
            <span id="dark-mode-icon">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="content">
  <div class="container">
    <div class="container pt-10">
        <h3 class="mb-3 fw-bold display-6 pt-4">caprese</h3>
        <p class="tags">
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">web</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">http</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">https</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">ssl</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">tls</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">websocket</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">proxy</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">framework</button></a>
                </span>
            
        </p>
        
            <p class="pkg-desc">A front-end web server specialized for real-time message exchange</p>
        
        <a title="Copy" onclick="document.querySelector('#cmd').select();document.execCommand('copy');"
            alt="Copy on clipboard">
            <i class="fa fa-copy"></i>
        </a>
        <input id="cmd" onclick="this.select();" value="nimble install caprese" readonly="">
        <br>
        <small style="font-size: 0.8rem;">Need help? Read <a
                href="https://github.com/nim-lang/nimble#creating-packages">Nimble</a></small>
    </div>

    <div class="container row pt-4" id="pkg-content">
        <div class="col-8 box rounded p-3" id="readme-section">
            
                <document><h1>Caprese</h1>
<p>A front-end web server specialized for real-time message exchange</p>
<h3>Appetizers</h3>
<blockquote>
<p>  <em>Can I write server-side APIs, back-end services, client-side applications, javascript, wasm, even html, in one language and in one code file, and even in one executable binary and process? 〜a certain geek〜</em></p>
</blockquote>
<p>  <em>Yes, you can do it with the Caprese. It is free and flexible. Actually, though, it&apos;s thanks to a great Nim and libraries.</em></p>
<blockquote>
<p>  <em>Is web3 a web? Are there any web server that can be called web3? 〜a certain tweet〜</em></p>
</blockquote>
<p>  <em>Caprese will be the base of that system. It would be a decentralized web server with server-to-server connections that could verify the reliability of contents and applications.</em></p>
<h3>Quick Trial</h3>
<h4>Install Nim</h4>
<p>I heard you like Ubuntu, so the following are required to install <a href="https://nim-lang.org/">Nim</a>.</p>
<pre>  <code>sudo apt install build-essential curl
</code></pre>
<p>Install with <a href="https://github.com/dom96/choosenim#choosenim">choosenim</a>.</p>
<pre>  <code>curl https://nim-lang.org/choosenim/init.sh -sSf | sh
echo &apos;export PATH=&apos;$HOME&apos;/.nimble/bin:$PATH&apos; &gt;&gt; ~/.bashrc
. ~/.bashrc
</code></pre>
<p>See <a href="https://nim-lang.org/">Nim</a> for installation details.</p>
<h4>Build Caprese and Launch</h4>
<p>you also require the following installation to build the SSL libraries, <em>golang</em> is required to build <em>BoringSSL</em>. The version of <em>golang</em> installed by the Ubuntu package tool might be old, so you might want to download and install the latest version from <a href="https://go.dev/">The Go Programming Language</a>, you can choose either.</p>
<pre>  <code>sudo apt install autoconf libtool cmake pkg-config golang
</code></pre>
<p>Do you have git installed?</p>
<pre>  <code>sudo apt install git
</code></pre>
<p>Now let&apos;s build the Caprese.</p>
<pre>  <code>git clone https://github.com/zenywallet/caprese
cd caprese
nimble install --depsOnly
nimble depsAll
nim c -r -d:EXAMPLE1 -d:release --threads:on --mm:orc src/caprese.nim
</code></pre>
<p>Open <a href="https://localhost:8009/">https://localhost:8009/</a> in your browser. You&apos;ll probably get a SSL certificate warning, but make sure it&apos;s a local server and proceed.</p>
<h4>Build Your Custom Web Server</h4>
<p>Install Caprese package.</p>
<pre>  <code>nimble install https://github.com/zenywallet/caprese
</code></pre>
<p>It will take quite a while, so make some coffee. The Caprese body is located <em>~/.nimble/pkgs/caprese-0.1.0/</em> when installed. The version number may change, though. If you can&apos;t find it, try looking for <em>~/.nimble/pkgs2</em>.</p>
<p>In some directory, create <em>server.nim</em> file with the following code.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">caprese</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">ssl</span> <span class="op">=</span> <span class="ide">true</span>, <span class="ide">ip</span> <span class="op">=</span> <span class="str">&quot;0.0.0.0&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">8009</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">send</span>(<span class="str">&quot;Hello!&quot;</span><span class="op">.</span><span class="ide">addHeader</span>())</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="kwd">return</span> <span class="ide">send</span>(<span class="str">&quot;Not found&quot;</span><span class="op">.</span><span class="ide">addHeader</span>(<span class="ide">Status404</span>))</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">serverStart</span>()</div></div>  </code></pre>
<p>Build and launch.</p>
<pre>  <code>nim c -r --threads:on server.nim
</code></pre>
<p>Open <a href="https://localhost:8009/">https://localhost:8009/</a> in your browser. You&apos;ll get a SSL certificate warning, but do something.</p>
<h3>Features</h3>
<ul>
<li>Multi-threaded server processing</li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc6455">WebSocket</a> support</li>
<li><a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">TLS/SSL</a> support. <a href="https://bearssl.org/">BearSSL</a>, <a href="https://www.openssl.org/">OpenSSL</a>, <a href="https://www.libressl.org/">LibreSSL</a>, or <a href="https://boringssl.googlesource.com/boringssl/">BoringSSL</a> can be selected depending on the performance and the future security situation</li>
<li><a href="https://en.wikipedia.org/wiki/Server_Name_Indication">SNI</a> support for TLS/SSL. Servers can use multiple certificates of different hostnames with the same IP address</li>
<li>Support for automatic renewal of <a href="https://letsencrypt.org/">Let&apos;s Encrypt</a> SSL certificates without application restart</li>
<li>Web pages are in-memory static files at compile time, dynamic file loading is also available for development</li>
<li>Reverse proxy for backend and internal services, server load balancing is available</li>
<li>Messaging functionality to send data from the server to clients individually or in groups</li>
<li>Dependency-free executable for easy server deployment</li>
<li>Build on your device from source code, this repository does not include binary modules such as SSL libraries</li>
<li>Languages - Nim 100.0%</li>
</ul>
<h3>Requirements</h3>
<ul>
<li>Linux, recommended Debian or Ubuntu<br />
BSD and Windows will be supported</li>
</ul>
<h3>Closure Compiler Setup</h3>
<p>The closure-compiler is needed to minify javascript. It thoroughly optimizes even somewhat verbose and human understandable javascript generated by Nim into short code.</p>
<pre>  <code>sudo apt install openjdk-19-jre maven
</code></pre>
<p>Maven is used to download the closure-compiler. Caprese automatically downloads and runs the closure-compiler internally. To download manually,</p>
<pre>  <code>mvn dependency:get -Ddest=./ -Dartifact=com.google.javascript:closure-compiler:LATEST
</code></pre>
<p>You can find closure-compiler-vyyyyMMdd.jar in the current path. Copy the file to the <em>src</em> path or <em>~/.nimble/pkgs/caprese-0.1.0/</em> of the caprese repository, <em>~/.nimble/pkgs</em> could be <em>~/.nimble/pkgs2</em>. If several versions of a closure-compiler are found in the path, the latest version is used.</p>
<p>Use <code>scriptMinifier()</code> to make minified javascript.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">caprese</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">const</span> <span class="ide">HelloJs</span> <span class="op">=</span> <span class="ide">staticScript</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">import</span> <span class="ide">jsffi</span></div></div><div class="line"><div class="line-content">  <span class="kwd">var</span> <span class="ide">console</span> {<span class="op">.</span><span class="ide">importc</span>, <span class="ide">nodecl</span><span class="op">.</span>}: <span class="ide">JsObject</span></div></div><div class="line"><div class="line-content">  <span class="ide">console</span><span class="op">.</span><span class="ide">log</span>(<span class="str">&quot;hello&quot;</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">const</span> <span class="ide">HelloMinJs</span> <span class="op">=</span> <span class="ide">scriptMinifier</span>(<span class="ide">code</span> <span class="op">=</span> <span class="ide">HelloJs</span>, <span class="ide">extern</span> <span class="op">=</span> <span class="str">&quot;&quot;</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">const</span> <span class="ide">HelloHtml</span> <span class="op">=</span> <span class="ide">staticHtmlDocument</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">buildHtml</span>(<span class="ide">html</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">head</span>:</div></div><div class="line"><div class="line-content">      <span class="ide">meta</span>(<span class="ide">charset</span><span class="op">=</span><span class="str">&quot;utf-8&quot;</span>)</div></div><div class="line"><div class="line-content">    <span class="ide">body</span>:</div></div><div class="line"><div class="line-content">      <span class="ide">tdiv</span>: <span class="ide">text</span> <span class="str">&quot;hello&quot;</span></div></div><div class="line"><div class="line-content">      <span class="ide">script</span>: <span class="ide">verbatim</span> <span class="ide">HelloMinJs</span></div></div>  </code></pre>
<p>It&apos;s amazing. Nothing could be more wonderful. <a href="https://github.com/karaxnim/karax">Karax</a> is used to generate HTML.</p>
<p>Register in <code>extern</code> the names of some variables and functions that should not be changed by the closure-compiler. If a string is specified for <code>extern</code>, it will be read directly into <code>--externs</code> option of the closure-compiler via a file. You can also pass <code>extern</code> a list of keywords you want to prevent the closure-compiler from replacing strings in <code>seq[string]</code>. The list of keywords will be converted to a readable format by <code>--externs</code> and passed to the closure-compiler. In addition to them, when the Nim generates javascript, some keywords that should not be changed are automatically added internally to <code>extern</code>.</p>
<h3>Server Configuration</h3>
<p>The server configuration is written in the <code>config:</code> block. The <code>config:</code> block should be set before the <code>server:</code> block. Below are the default settings. You only need to set the items you want to change or explain explicitly.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">config</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">sslLib</span> <span class="op">=</span> <span class="ide">BearSSL</span></div></div><div class="line"><div class="line-content">  <span class="ide">debugLog</span> <span class="op">=</span> <span class="ide">false</span></div></div><div class="line"><div class="line-content">  <span class="ide">sigTermQuit</span> <span class="op">=</span> <span class="ide">true</span></div></div><div class="line"><div class="line-content">  <span class="ide">sigPipeIgnore</span> <span class="op">=</span> <span class="ide">true</span></div></div><div class="line"><div class="line-content">  <span class="ide">limitOpenFiles</span> <span class="op">=</span> <span class="op">-</span><span class="num">1</span></div></div><div class="line"><div class="line-content">  <span class="ide">serverWorkerNum</span> <span class="op">=</span> <span class="op">-</span><span class="num">1</span></div></div><div class="line"><div class="line-content">  <span class="ide">epollEventsSize</span> <span class="op">=</span> <span class="num">10</span></div></div><div class="line"><div class="line-content">  <span class="ide">soKeepalive</span> <span class="op">=</span> <span class="ide">false</span></div></div><div class="line"><div class="line-content">  <span class="ide">tcpNodelay</span> <span class="op">=</span> <span class="ide">true</span></div></div><div class="line"><div class="line-content">  <span class="ide">clientMax</span> <span class="op">=</span> <span class="num">32000</span></div></div><div class="line"><div class="line-content">  <span class="ide">connectionTimeout</span> <span class="op">=</span> <span class="num">120</span></div></div><div class="line"><div class="line-content">  <span class="ide">recvBufExpandBreakSize</span> <span class="op">=</span> <span class="num">131072</span> <span class="op">*</span> <span class="num">5</span></div></div><div class="line"><div class="line-content">  <span class="ide">maxFrameSize</span> <span class="op">=</span> <span class="num">131072</span> <span class="op">*</span> <span class="num">5</span></div></div><div class="line"><div class="line-content">  <span class="ide">certsPath</span> <span class="op">=</span> <span class="str">&quot;./certs&quot;</span></div></div><div class="line"><div class="line-content">  <span class="ide">privKeyFile</span> <span class="op">=</span> <span class="str">&quot;privkey.pem&quot;</span></div></div><div class="line"><div class="line-content">  <span class="ide">fullChainFile</span> <span class="op">=</span> <span class="str">&quot;fullchain.pem&quot;</span></div></div><div class="line"><div class="line-content">  <span class="ide">httpVersion</span> <span class="op">=</span> <span class="num">1.1</span></div></div><div class="line"><div class="line-content">  <span class="ide">serverName</span> <span class="op">=</span> <span class="str">&quot;Caprese&quot;</span></div></div><div class="line"><div class="line-content">  <span class="ide">headerServer</span> <span class="op">=</span> <span class="ide">false</span></div></div><div class="line"><div class="line-content">  <span class="ide">headerDate</span> <span class="op">=</span> <span class="ide">false</span></div></div><div class="line"><div class="line-content">  <span class="ide">errorCloseMode</span> <span class="op">=</span> <span class="ide">CloseImmediately</span></div></div><div class="line"><div class="line-content">  <span class="ide">connectionPreferred</span> <span class="op">=</span> <span class="ide">ExternalConnection</span></div></div>  </code></pre>
<ul>
<li><strong>sslLib:</strong> <em>None</em>, <em>BearSSL</em>(default), <em>OpenSSL</em>, <em>LibreSSL</em>, <em>BoringSSL</em><br />
Somewhat surprisingly, Caprese supports 4 different SSL libraries. I would like to keep it a secret that <em>BearSSL</em> is the most extreme, with the smallest binary size and the fastest SSL processing speed. Enjoy the differences.</li>
</ul>
<p>If SSL is not required, it is recommended set to <em>None</em>. This will enable the experimental implementation of fast dispatch processing based on number of client connections and requests. At this time, it is only available for <em>None</em>.</p>
<ul>
<li><strong>debugLog:</strong> <em>true</em> or <em>false</em>(default). If <em>true</em>, debug messages are output to the console.</li>
<li><strong>sigTermQuit:</strong> <em>true</em>(default) or <em>false</em>. If <em>true</em>, handling SIGTERM at the end of the process. The code in the <code>onQuit:</code> block is called before the process is terminated.</li>
<li><strong>sigPipeIgnore:</strong> Whether to ignore SIGPIPE. Caprese requires SIGPIPE to be ignored, but can be set to <em>false</em> if duplicated in other libraries.</li>
<li><strong>limitOpenFiles:</strong> <em>[Number of open files]</em>, <em>-1</em>(default, automatically set the maximum number of open files)</li>
<li><strong>serverWorkerNum:</strong> <em>[Number of processing threads]</em>, <em>-1</em>(default, automatically set the number of CPUs in the system)</li>
<li><strong>connectionTimeout:</strong> <em>[Client connection timeout in seconds]</em>, <em>-1</em>(disabled). The time to disconnect is not exact. Disconnection occurs between a specified second and twice the time.</li>
<li><strong>headerServer:</strong> <em>true</em> or <em>false</em>(default), If <em>true</em>, include <code>Server:</code> in the response headers. Common benchmarks require this value to be <em>true</em>. In benchmark competition, even a single byte of copying can feel heavy.</li>
<li><strong>headerDate:</strong> <em>true</em> or <em>false</em>(default), If <em>true</em>, include <code>Date:</code> in the response headers. Common benchmarks require this value to be <em>true</em>. It should not be the essence of benchmarking, but sometimes it is a competition of how to implement the date strings.</li>
<li><strong>errorCloseMode:</strong> <em>CloseImmediately</em>(default) or <em>UntilConnectionTimeout</em>. Behavior when disconnecting clients on error.</li>
<li><strong>connectionPreferred:</strong> <em>ExternalConnection</em>(default) or <em>InternalConnection</em>. Optimize server processing depending on whether the clients are connected from external or internal network connections. The situation is different when the client and server are on separate PCs or on the same PC, therefore, the benchmarks should be evaluated separately. If the client and server are running on the same PC using virtual technology such as <em>Docker</em> and sharing CPU resources, they should rather be considered internal connections.</li>
</ul>
<h3>Server Routes</h3>
<h4>Example of a simple <code>server:</code> block</h4>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">ip</span> <span class="op">=</span> <span class="str">&quot;0.0.0.0&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">8089</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">send</span>(<span class="ide">IndexHtml</span><span class="op">.</span><span class="ide">addHeader</span>())</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">serverStart</span>()</div></div>  </code></pre>
<h4>Multiple URL paths</h4>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">get</span> <span class="str">&quot;/home&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">send</span>(<span class="ide">HomeHtml</span><span class="op">.</span><span class="ide">addHeader</span>())</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/about&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">send</span>(<span class="ide">AboutHtml</span><span class="op">.</span><span class="ide">addHeader</span>())</div></div>  </code></pre>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">get</span> <span class="str">&quot;/home&quot;</span>, <span class="str">&quot;/about&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">send</span>(<span class="ide">MainHtml</span><span class="op">.</span><span class="ide">addHeader</span>())</div></div>  </code></pre>
<h4>URL path handling using Regular expression</h4>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">get</span> re"/([a-z]+)(\d+)":</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">send</span>(<span class="ide">sanitizeHtml</span>(<span class="ide">matches</span>[<span class="num">0</span>] <span class="op">&amp;</span> <span class="str">&quot;|&quot;</span> <span class="op">&amp;</span> <span class="ide">matches</span>[<span class="num">1</span>])<span class="op">.</span><span class="ide">addHeader</span>())</div></div>  </code></pre>
<h4>404 Not Found</h4>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">routes</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="op">...</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="kwd">let</span> <span class="ide">urlText</span> <span class="op">=</span> <span class="ide">sanitizeHtml</span>(<span class="ide">reqUrl</span>)</div></div><div class="line"><div class="line-content">    <span class="kwd">return</span> <span class="ide">send</span>(fmt"Not found: {urlText}"<span class="op">.</span><span class="ide">addDocType</span>()<span class="op">.</span><span class="ide">addHeader</span>(<span class="ide">Status404</span>))</div></div>  </code></pre>
<h4>Multiple ports for SSL website and no SSL website</h4>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">ssl</span> <span class="op">=</span> <span class="ide">true</span>, <span class="ide">ip</span> <span class="op">=</span> <span class="str">&quot;0.0.0.0&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">8009</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>(<span class="ide">host</span> <span class="op">=</span> <span class="str">&quot;website1&quot;</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">certificates</span>(<span class="ide">path</span> <span class="op">=</span> <span class="str">&quot;./certs/website1&quot;</span>):</div></div><div class="line"><div class="line-content">      <span class="ide">privKey</span>: <span class="str">&quot;privkey.pem&quot;</span></div></div><div class="line"><div class="line-content">      <span class="ide">fullChain</span>: <span class="str">&quot;fullchain.pem&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">send</span>(<span class="ide">WebSite1Html</span><span class="op">.</span><span class="ide">addHeader</span>())</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">ip</span> <span class="op">=</span> <span class="str">&quot;0.0.0.0&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">8089</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>(<span class="ide">host</span> <span class="op">=</span> <span class="str">&quot;website1&quot;</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">send</span>(<span class="ide">WebSite1Html</span><span class="op">.</span><span class="ide">addHeader</span>())</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">serverStart</span>()</div></div>  </code></pre>
<p>The <code>host</code> value of the <code>routes:</code> block is actually set to your domain name.</p>
<h4>Set the certificate path for each</h4>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">certificates</span>:</div></div><div class="line"><div class="line-content">      <span class="ide">privKey</span>: <span class="str">&quot;./certs/priv/privkey.pem&quot;</span></div></div><div class="line"><div class="line-content">      <span class="ide">fullChain</span>: <span class="str">&quot;./certs/chain/fullchain.pem&quot;</span></div></div>  </code></pre>
<h4>Specify default certificate file names and omit them</h4>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">config</span>:</div></div><div class="line"><div class="line-content">  <span class="op">...</span></div></div><div class="line"><div class="line-content">  <span class="ide">privKeyFile</span> <span class="op">=</span> <span class="str">&quot;privkey.pem&quot;</span></div></div><div class="line"><div class="line-content">  <span class="ide">fullChainFile</span> <span class="op">=</span> <span class="str">&quot;fullchain.pem&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">ssl</span> <span class="op">=</span> <span class="ide">true</span>, <span class="ide">ip</span> <span class="op">=</span> <span class="str">&quot;0.0.0.0&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">8009</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>(<span class="ide">host</span> <span class="op">=</span> <span class="str">&quot;website1&quot;</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">certificates</span>(<span class="ide">path</span> <span class="op">=</span> <span class="str">&quot;./certs/website1&quot;</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">send</span>(<span class="ide">WebSite1Html</span><span class="op">.</span><span class="ide">addHeader</span>())</div></div>  </code></pre>
<h4>Specify default certificate path and omit <code>certificates:</code> block</h4>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">config</span>:</div></div><div class="line"><div class="line-content">  <span class="op">...</span></div></div><div class="line"><div class="line-content">  <span class="ide">certsPath</span> <span class="op">=</span> <span class="str">&quot;./certs&quot;</span></div></div><div class="line"><div class="line-content">  <span class="ide">privKeyFile</span> <span class="op">=</span> <span class="str">&quot;privkey.pem&quot;</span></div></div><div class="line"><div class="line-content">  <span class="ide">fullChainFile</span> <span class="op">=</span> <span class="str">&quot;fullchain.pem&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">ssl</span> <span class="op">=</span> <span class="ide">true</span>, <span class="ide">ip</span> <span class="op">=</span> <span class="str">&quot;0.0.0.0&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">8009</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>(<span class="ide">host</span> <span class="op">=</span> <span class="str">&quot;website1&quot;</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">send</span>(<span class="ide">WebSite1Html</span><span class="op">.</span><span class="ide">addHeader</span>())</div></div>  </code></pre>
<p>In the above example, the following two files are loaded.</p>
<pre>  <code>./certs/website1/privkey.pem
./certs/website1/fullchain.pem
</code></pre>
<p>The <code>host</code> value of the <code>routes:</code> block is used for the file location.</p>
<pre>  <code>&lt;certsPath&gt;/&lt;routes host&gt;/{&lt;privKeyFile&gt;,&lt;fullChainFile&gt;}
</code></pre>
<h4>Multi-website configuration on the same port with SSL</h4>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">ssl</span> <span class="op">=</span> <span class="ide">true</span>, <span class="ide">ip</span> <span class="op">=</span> <span class="str">&quot;0.0.0.0&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">8009</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>(<span class="ide">host</span> <span class="op">=</span> <span class="str">&quot;website1&quot;</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">certificates</span>(<span class="ide">path</span> <span class="op">=</span> <span class="str">&quot;./certs/website1&quot;</span>):</div></div><div class="line"><div class="line-content">      <span class="ide">privKey</span>: <span class="str">&quot;privkey.pem&quot;</span></div></div><div class="line"><div class="line-content">      <span class="ide">fullChain</span>: <span class="str">&quot;fullchain.pem&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">send</span>(<span class="ide">WebSite1Html</span><span class="op">.</span><span class="ide">addHeader</span>())</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>(<span class="ide">host</span> <span class="op">=</span> <span class="str">&quot;website2&quot;</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">certificates</span>(<span class="ide">path</span> <span class="op">=</span> <span class="str">&quot;./certs/website2&quot;</span>):</div></div><div class="line"><div class="line-content">      <span class="ide">privKey</span>: <span class="str">&quot;privkey.pem&quot;</span></div></div><div class="line"><div class="line-content">      <span class="ide">fullChain</span>: <span class="str">&quot;fullchain.pem&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">send</span>(<span class="ide">WebSite2Html</span><span class="op">.</span><span class="ide">addHeader</span>())</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">serverStart</span>()</div></div>  </code></pre>
<p>I hope you get the idea... This is SNI.</p>
<h4>Pending and workers</h4>
<p>The runnable level inside the <code>server:</code> block is called the server dispatch-level. Inside the block is called from multiple threads, it must not call functions that generate long waits and must return results immediately. If the response cannot be returned immediately, return pending first and then process it in another worker thread. Feel free to use async/await in another thread.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">type</span></div></div><div class="line"><div class="line-content">  <span class="ide">PendingData</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">url</span>: <span class="ide">string</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">reqs</span>: <span class="ide">Pendings</span>[<span class="ide">PendingData</span>]</div></div><div class="line"><div class="line-content"><span class="ide">reqs</span><span class="op">.</span><span class="ide">newPending</span>(<span class="ide">limit</span> <span class="op">=</span> <span class="num">100</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">worker</span>(<span class="ide">num</span> <span class="op">=</span> <span class="num">2</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">reqs</span><span class="op">.</span><span class="ide">recvLoop</span>(<span class="ide">req</span>):</div></div><div class="line"><div class="line-content">    <span class="kwd">let</span> <span class="ide">urlText</span> <span class="op">=</span> <span class="ide">sanitizeHtml</span>(<span class="ide">req</span><span class="op">.</span><span class="ide">data</span><span class="op">.</span><span class="ide">url</span>)</div></div><div class="line"><div class="line-content">    <span class="kwd">let</span> <span class="ide">clientId</span> <span class="op">=</span> <span class="ide">req</span><span class="op">.</span><span class="ide">cid</span></div></div><div class="line"><div class="line-content">    <span class="ide">clientId</span><span class="op">.</span><span class="ide">send</span>(<span class="ide">fmt</span>(<span class="str">&quot;worker {urlText}&quot;</span>)<span class="op">.</span><span class="ide">addHeader</span>())</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">ip</span> <span class="op">=</span> <span class="str">&quot;0.0.0.0&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">8089</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>(<span class="ide">host</span> <span class="op">=</span> <span class="str">&quot;website1&quot;</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/test&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">reqs</span><span class="op">.</span><span class="ide">pending</span>(<span class="ide">PendingData</span>(<span class="ide">url</span>: <span class="ide">reqUrl</span>))</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="kwd">let</span> <span class="ide">urlText</span> <span class="op">=</span> <span class="ide">sanitizeHtml</span>(<span class="ide">reqUrl</span>)</div></div><div class="line"><div class="line-content">    <span class="kwd">return</span> <span class="ide">send</span>(fmt"Not found: {urlText}"<span class="op">.</span><span class="ide">addDocType</span>()<span class="op">.</span><span class="ide">addHeader</span>(<span class="ide">Status404</span>))</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">serverStart</span>()</div></div>  </code></pre>
<p>The send commands executed by another worker thread invoke a server dispatch-level thread to execute the sending process. The number of threads in the <code>server:</code> block is the number of <em>serverWorkerNum</em> in the <code>config:</code> block. The same worker threads are used even in a multi-port configuration with multiple <code>server:</code> blocks, and the number of threads remains the same.</p>
<p>One of the reasons for creating Caprese is stream encryption. The common method of stream encryption using a reverse proxy server in a separate process seems inefficient. To reduce context switches, it would be better to handle stream encryption in the same thread context as the SSL process, like the <code>server:</code> block in the Caprese.</p>
<h4>Thread context variables</h4>
<p>Put before the <code>routes:</code> block in the <code>server:</code> block. Um, how do I access it?</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">ip</span> <span class="op">=</span> <span class="str">&quot;0.0.0.0&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">8089</span>):</div></div><div class="line"><div class="line-content">  <span class="kwd">var</span> <span class="ide">localThreadBuffer</span> <span class="op">=</span> <span class="ide">newSeq</span>[<span class="ide">byte</span>](<span class="num">1024</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>:</div></div><div class="line"><div class="line-content">    <span class="op">...</span></div></div>  </code></pre>
<h4>Web pages and WebSocket use the same port</h4>
<p>To use WebSocket, add a <code>stream:</code> block in the <code>routes:</code> block. When a WebSocket connection is established, the <code>onOpen:</code> block is called. When a message is received, the <code>onMessage:</code> block is called. When the connection is closed, the <code>onClose:</code> block is called.
Although a bit tricky to use, WebSockets and web pages can also use the same url path like <code>/</code>, <code>/ws</code>. In that case, the <code>get:</code> path to the web page should be after the <code>stream:</code>.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">ssl</span> <span class="op">=</span> <span class="ide">true</span>, <span class="ide">ip</span> <span class="op">=</span> <span class="str">&quot;0.0.0.0&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">8009</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>(<span class="ide">host</span> <span class="op">=</span> <span class="str">&quot;website1&quot;</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">certificates</span>(<span class="ide">path</span> <span class="op">=</span> <span class="str">&quot;./certs/website1&quot;</span>):</div></div><div class="line"><div class="line-content">      <span class="ide">privKey</span>: <span class="str">&quot;privkey.pem&quot;</span></div></div><div class="line"><div class="line-content">      <span class="ide">fullChain</span>: <span class="str">&quot;fullchain.pem&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/wstest&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">send</span>(<span class="ide">WsTestHtml</span><span class="op">.</span><span class="ide">addHeader</span>())</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">stream</span>(<span class="ide">path</span> <span class="op">=</span> <span class="str">&quot;/ws&quot;</span>, <span class="ide">protocol</span> <span class="op">=</span> <span class="str">&quot;caprese-0.1&quot;</span>):</div></div><div class="line"><div class="line-content">      <span class="ide">onOpen</span>:</div></div><div class="line"><div class="line-content">        <span class="com"># client: Client</span></div></div><div class="line"><div class="line-content">        <span class="ide">echo</span> <span class="str">&quot;onOpen&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">      <span class="ide">onMessage</span>:</div></div><div class="line"><div class="line-content">        <span class="com"># client: Client</span></div></div><div class="line"><div class="line-content">        <span class="com"># opcode: WebSocketOpCode</span></div></div><div class="line"><div class="line-content">        <span class="com"># data: ptr UncheckedArray[byte]</span></div></div><div class="line"><div class="line-content">        <span class="com"># size: int</span></div></div><div class="line"><div class="line-content">        <span class="ide">echo</span> <span class="str">&quot;onMessage&quot;</span></div></div><div class="line"><div class="line-content">        <span class="kwd">return</span> <span class="ide">wsSend</span>(<span class="ide">data</span><span class="op">.</span><span class="ide">toString</span>(<span class="ide">size</span>), <span class="ide">WebSocketOpcode</span><span class="op">.</span><span class="ide">Binary</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">      <span class="ide">onClose</span>:</div></div><div class="line"><div class="line-content">        <span class="com"># client: Client</span></div></div><div class="line"><div class="line-content">        <span class="ide">echo</span> <span class="str">&quot;onClose&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/ws&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">send</span>(<span class="str">&quot;WebSocket Protocol: caprese-0.1&quot;</span><span class="op">.</span><span class="ide">addHeader</span>())</div></div>  </code></pre>
<h4>Custom WebSocket handling such as ping and pong</h4>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">stream</span>(<span class="ide">path</span> <span class="op">=</span> <span class="str">&quot;/ws&quot;</span>, <span class="ide">protocol</span> <span class="op">=</span> <span class="str">&quot;caprese-0.1&quot;</span>):</div></div><div class="line"><div class="line-content">      <span class="com"># client: Client</span></div></div><div class="line"><div class="line-content">      <span class="ide">onOpen</span>:</div></div><div class="line"><div class="line-content">        <span class="ide">echo</span> <span class="str">&quot;onOpen&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">      <span class="com"># client: Client</span></div></div><div class="line"><div class="line-content">      <span class="com"># opcode: WebSocketOpCode</span></div></div><div class="line"><div class="line-content">      <span class="com"># data: ptr UncheckedArray[byte]</span></div></div><div class="line"><div class="line-content">      <span class="com"># size: int</span></div></div><div class="line"><div class="line-content">      <span class="kwd">case</span> <span class="ide">opcode</span></div></div><div class="line"><div class="line-content">      <span class="kwd">of</span> <span class="ide">WebSocketOpcode</span><span class="op">.</span><span class="ide">Binary</span>, <span class="ide">WebSocketOpcode</span><span class="op">.</span><span class="ide">Text</span>, <span class="ide">WebSocketOpcode</span><span class="op">.</span><span class="kwd">Continue</span>:</div></div><div class="line"><div class="line-content">        <span class="ide">echo</span> <span class="str">&quot;onMessage&quot;</span></div></div><div class="line"><div class="line-content">        <span class="kwd">return</span> <span class="ide">wsSend</span>(<span class="ide">data</span><span class="op">.</span><span class="ide">toString</span>(<span class="ide">size</span>), <span class="ide">WebSocketOpcode</span><span class="op">.</span><span class="ide">Binary</span>)</div></div><div class="line"><div class="line-content">      <span class="kwd">of</span> <span class="ide">WebSocketOpcode</span><span class="op">.</span><span class="ide">Ping</span>:</div></div><div class="line"><div class="line-content">        <span class="kwd">return</span> <span class="ide">wsSend</span>(<span class="ide">data</span><span class="op">.</span><span class="ide">toString</span>(<span class="ide">size</span>), <span class="ide">WebSocketOpcode</span><span class="op">.</span><span class="ide">Pong</span>)</div></div><div class="line"><div class="line-content">      <span class="kwd">of</span> <span class="ide">WebSocketOpcode</span><span class="op">.</span><span class="ide">Pong</span>:</div></div><div class="line"><div class="line-content">        <span class="ide">debug</span> <span class="str">&quot;pong &quot;</span>, <span class="ide">data</span><span class="op">.</span><span class="ide">toString</span>(<span class="ide">size</span>)</div></div><div class="line"><div class="line-content">        <span class="kwd">return</span> <span class="ide">SendResult</span><span class="op">.</span><span class="ide">Success</span></div></div><div class="line"><div class="line-content">      <span class="kwd">else</span>: <span class="com"># WebSocketOpcode.Close</span></div></div><div class="line"><div class="line-content">        <span class="ide">echo</span> <span class="str">&quot;onClose&quot;</span></div></div><div class="line"><div class="line-content">        <span class="kwd">return</span> <span class="ide">SendResult</span><span class="op">.</span><span class="ide">None</span></div></div>  </code></pre>
<h4>WebSocket without protocol check</h4>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">routes</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/wstest&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="op">...</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">stream</span> <span class="str">&quot;/ws&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="op">...</span></div></div>  </code></pre>
<h4>Check multiple protocols of the WebSocket</h4>
<p>Use <code>onProtocol:</code> block.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">routes</span>:</div></div><div class="line"><div class="line-content">    <span class="op">...</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">stream</span> <span class="str">&quot;/ws&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="ide">onProtocol</span>:</div></div><div class="line"><div class="line-content">        <span class="kwd">let</span> <span class="ide">prot</span> <span class="op">=</span> <span class="ide">reqProtocol</span>()</div></div><div class="line"><div class="line-content">        <span class="kwd">if</span> <span class="ide">prot</span> <span class="op">==</span> <span class="str">&quot;caprese-0.2&quot;</span>:</div></div><div class="line"><div class="line-content">          <span class="kwd">return</span> (<span class="ide">true</span>, <span class="str">&quot;caprese-0.2&quot;</span>)</div></div><div class="line"><div class="line-content">        <span class="kwd">elif</span> <span class="ide">prot</span> <span class="op">==</span> <span class="str">&quot;caprese-0.1&quot;</span>:</div></div><div class="line"><div class="line-content">          <span class="kwd">return</span> (<span class="ide">true</span>, <span class="str">&quot;caprese-0.1&quot;</span>)</div></div><div class="line"><div class="line-content">        <span class="kwd">else</span>:</div></div><div class="line"><div class="line-content">          <span class="kwd">return</span> (<span class="ide">false</span>, <span class="str">&quot;&quot;</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">      <span class="ide">onOpen</span>:</div></div><div class="line"><div class="line-content">        <span class="op">...</span></div></div>  </code></pre>
<h4>Routes helper APIs</h4>
<ul>
<li><strong>reqUrl:</strong> URL requested from client, always starts <code>/</code>. Caprese will reject requests that do not begin with <code>/</code>. This means that when concatenating URL strings in a request, it is guaranteed that there will always be a <code>/</code> between the strings.</li>
<li><strong>reqHost:</strong> Hostname requested in the header from client. It may be different from the hostname negotiated by SSL. Incorrect hostnames should be rejected. If the <code>host</code> of <code>routes:</code> is specified, unmatched hosts will be ignored and will not be processed within that <code>routes:</code> block. You may use <code>reqHost</code> for custom handling without <code>host</code> of <code>routes:</code>.</li>
<li><strong>reqProtocol:</strong> WebSocket protocol requested by the client. See <a href="#check-multiple-protocols-of-the-websocket">Check multiple protocols of the WebSocket</a> for details.</li>
<li><strong>reqHeader(HeaderID):</strong> Get the specific header parameter of the client request by <em>HeaderID</em>. See <a href="#http-headers">Http Headers</a> for details.</li>
<li><strong>reqClient:</strong> Pointer to the client object currently being processed in the thread context, the same as <code>client</code>. Normally, <code>client</code> should be used.</li>
</ul>
<h3>Client Object Custom Extension</h3>
<p>Custom parameters can be added to the client object. When custom pragmas <code>{.clientExt.}</code> are added to a regular object definitions, all the fields of that object are appended to the client object. However, fields that have already been defined in the client object cannot be added.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">caprese</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">type</span></div></div><div class="line"><div class="line-content">  <span class="ide">CipherContext</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">encryptVector</span>: <span class="ide">array</span>[<span class="num">16</span>, <span class="ide">byte</span>]</div></div><div class="line"><div class="line-content">    <span class="ide">decryptVector</span>: <span class="ide">array</span>[<span class="num">16</span>, <span class="ide">byte</span>]</div></div><div class="line"><div class="line-content">    <span class="ide">key</span>: <span class="ide">array</span>[<span class="num">140</span>, <span class="ide">uint32</span>]</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">ClientExt</span> {<span class="op">.</span><span class="ide">clientExt</span><span class="op">.</span>} <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">cipherCtx</span>: <span class="ide">CipherContext</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">cipherInit</span>(<span class="ide">ctx</span>: <span class="kwd">var</span> <span class="ide">CipherContext</span>) <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="ide">zeroMem</span>(<span class="kwd">addr</span> <span class="ide">ctx</span>, <span class="ide">sizeof</span>(<span class="ide">CipherContext</span>))</div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;ctx=&quot;</span>, <span class="ide">ctx</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">ssl</span> <span class="op">=</span> <span class="ide">true</span>, <span class="ide">ip</span> <span class="op">=</span> <span class="str">&quot;0.0.0.0&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">8009</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">stream</span> <span class="str">&quot;/&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="ide">onOpen</span>:</div></div><div class="line"><div class="line-content">        <span class="ide">cipherInit</span>(<span class="ide">client</span><span class="op">.</span><span class="ide">cipherCtx</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> """<script>new WebSocket("wss://localhost:8009")</script>"""<span class="op">.</span><span class="ide">addHeader</span><span class="op">.</span><span class="ide">send</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="kwd">return</span> <span class="str">&quot;Not found&quot;</span><span class="op">.</span><span class="ide">addHeader</span>(<span class="ide">Status404</span>)<span class="op">.</span><span class="ide">send</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">serverStart</span>()</div></div>  </code></pre>
<p>One more thing... The following function may be used to access the client extension object from workers that only know the client ID. However, the client objects are usually intended to be accessed from the <code>server:</code> blocks and are not permanently accessible from the workers. In some cases, resource management such as locking may be necessary.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">getClient</span>(<span class="ide">clientId</span>: <span class="ide">ClientId</span>): <span class="ide">Client</span></div></div>  </code></pre>
<h3>Http Headers</h3>
<p>There are various efficient ways to parse http headers, though, Caprese uses the approach of predefining only the headers to be used and reading only those headers that are needed. I could not find any servers implementing this approach, so it may be very novel approach. Compared to a fast header parsing algorithm, this approach had an advantage over it.</p>
<p>Enumerate any header IDs you have determined and target strings of headers to be retrieved in the <code>httpHeader:</code> block. The <code>httpHeader:</code> block must be in the <code>config:</code> block.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">config</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">sslLib</span> <span class="op">=</span> <span class="ide">BearSSL</span></div></div><div class="line"><div class="line-content">  <span class="op">...</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">httpHeader</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">HeaderHost</span>: <span class="str">&quot;Host&quot;</span></div></div><div class="line"><div class="line-content">    <span class="ide">HeaderUserAgent</span>: <span class="str">&quot;User-Agent&quot;</span></div></div><div class="line"><div class="line-content">    <span class="op">...</span></div></div>  </code></pre>
<p>Get the header string by specifying the header ID with the <code>reqHeader()</code> in the <code>routes:</code> block.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">routes</span>:</div></div><div class="line"><div class="line-content">    <span class="kwd">let</span> <span class="ide">userAgent</span> <span class="op">=</span> <span class="ide">reqHeader</span>(<span class="ide">HeaderUserAgent</span>)</div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="ide">userAgent</span></div></div>  </code></pre>
<p>The <code>reqHeader()</code> can only be called within the <code>routes:</code> block contexts, because the headers only manage the read position of the receive buffer, which may be in the server thread context.</p>
<h3>Publishing Static Files</h3>
<p>Use <code>public:</code> block. All files in <code>importPath</code> are statically imported into the code at compile time. Specify the <code>importPath</code> as relative path like Nim <code>import</code>, however, double quotes are necessary. The <code>getProjectPath()</code> is added internally to the <code>importPath</code>.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">routes</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">public</span>(<span class="ide">importPath</span> <span class="op">=</span> <span class="str">&quot;../public&quot;</span>)</div></div>  </code></pre>
<p>Inside the <code>public:</code> block, <code>responce()</code> is used, which sends compressed files if the client allows to receive <em>Brotli</em> or <em>Deflate</em>. It also checks the <em>If-None-Match</em> header and return <em>304 Not Modified</em> if the file has not been changed.</p>
<p>Custom handling such as changing the base URL.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">routes</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">public</span>(<span class="ide">importPath</span> <span class="op">=</span> <span class="str">&quot;../public&quot;</span>):</div></div><div class="line"><div class="line-content">      <span class="kwd">let</span> <span class="ide">retFile</span> <span class="op">=</span> <span class="ide">getFile</span>(<span class="str">&quot;/webroot&quot;</span> <span class="op">&amp;</span> <span class="ide">reqUrl</span>)</div></div><div class="line"><div class="line-content">      <span class="kwd">if</span> <span class="ide">retFile</span><span class="op">.</span><span class="ide">err</span> <span class="op">==</span> <span class="ide">FileContentSuccess</span>:</div></div><div class="line"><div class="line-content">        <span class="kwd">return</span> <span class="ide">response</span>(<span class="ide">retFile</span><span class="op">.</span><span class="ide">data</span>)</div></div>  </code></pre>
<p>You can also create static content objects from static strings with <code>content()</code>. The content object has uncompressed, Deflate compressed, Brotli compressed, MIME type, SHA256 hash, and MD5 hash.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">const</span> <span class="ide">IndexHtml</span> <span class="op">=</span> <span class="ide">staticHtmlDocument</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">buildHtml</span>(<span class="ide">html</span>):</div></div><div class="line"><div class="line-content">    <span class="op">...</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">const</span> <span class="ide">AppJs</span> <span class="op">=</span> <span class="ide">staticScript</span>:</div></div><div class="line"><div class="line-content">    <span class="op">...</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">const</span> <span class="ide">AppMinJs</span> <span class="op">=</span> <span class="ide">scriptMinifier</span>(<span class="ide">code</span> <span class="op">=</span> <span class="ide">AppJs</span>, <span class="ide">extern</span> <span class="op">=</span> <span class="str">&quot;&quot;</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">ssl</span> <span class="op">=</span> <span class="ide">true</span>, <span class="ide">ip</span> <span class="op">=</span> <span class="str">&quot;0.0.0.0&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">8009</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>(<span class="ide">host</span> <span class="op">=</span> <span class="str">&quot;website1&quot;</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">response</span>(<span class="ide">content</span>(<span class="ide">IndexHtml</span>, <span class="str">&quot;text/html&quot;</span>))</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/js/app.js&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">response</span>(<span class="ide">content</span>(<span class="ide">AppMinJs</span>, <span class="str">&quot;application/javascript&quot;</span>))</div></div>  </code></pre>
<p>The second argument of <code>content()</code> can be an extension such as <em>html</em> or <em>js</em> instead of formal MIME types.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">get</span> <span class="str">&quot;/&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">response</span>(<span class="ide">content</span>(<span class="ide">IndexHtml</span>, <span class="str">&quot;html&quot;</span>))</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/js/app.js&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">response</span>(<span class="ide">content</span>(<span class="ide">AppMinJs</span>, <span class="str">&quot;js&quot;</span>))</div></div>  </code></pre>
<h3>Reverse Proxy</h3>
<p>The Caprese&apos;s reverse proxy is different from a typical reverse proxy server and is more simplified. It may be faster than a typical reverse proxy server due to the following specifications. It would be more useful in simple configurations.</p>
<ul>
<li>The request URL and http headers are not changed. Since data is sent and received without changing the data to the proxy destination, it would work fine with WebSockets and such.</li>
<li>When a client makes a request to a proxy path, all subsequent communication is connected to the proxy destination until disconnected. The proxy path is simply compared to the URL, and if the first string matches, proxy forwarding starts. It may be better to add a <code>/</code> at the end of the proxy path to make it strict.</li>
<li>External connections are made with SSL, but no SSL inside the proxy. It could be used for internal connections or to connect to back-end services.</li>
</ul>
<h4><code>proxy:</code> block</h4>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">caprese</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">ssl</span> <span class="op">=</span> <span class="ide">true</span>, <span class="ide">ip</span> <span class="op">=</span> <span class="str">&quot;0.0.0.0&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">8009</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>(<span class="ide">host</span> <span class="op">=</span> <span class="str">&quot;localhost&quot;</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">proxy</span>(<span class="ide">path</span> <span class="op">=</span> <span class="str">&quot;/&quot;</span>, <span class="ide">host</span> <span class="op">=</span> <span class="str">&quot;localhost&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">8089</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">ip</span> <span class="op">=</span> <span class="str">&quot;127.0.0.1&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">8089</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>(<span class="ide">host</span> <span class="op">=</span> <span class="str">&quot;localhost:8009&quot;</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">response</span>(<span class="ide">content</span>(<span class="str">&quot;Hello!&quot;</span>, <span class="str">&quot;text/html&quot;</span>))</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="kwd">return</span> <span class="ide">send</span>(<span class="str">&quot;Not found&quot;</span><span class="op">.</span><span class="ide">addHeader</span>(<span class="ide">Status404</span>))</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">serverStart</span>()</div></div>  </code></pre>
<p>It might be better not to check the hostname and port.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">ip</span> <span class="op">=</span> <span class="str">&quot;127.0.0.1&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">8089</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>: <span class="com"># no hostname and port check</span></div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/&quot;</span>:</div></div>  </code></pre>
<h4>Debug or custom handling</h4>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">ssl</span> <span class="op">=</span> <span class="ide">true</span>, <span class="ide">ip</span> <span class="op">=</span> <span class="str">&quot;0.0.0.0&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">8009</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>(<span class="ide">host</span> <span class="op">=</span> <span class="str">&quot;localhost&quot;</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">proxy</span>(<span class="ide">path</span> <span class="op">=</span> <span class="str">&quot;/&quot;</span>, <span class="ide">host</span> <span class="op">=</span> <span class="str">&quot;localhost&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">8089</span>):</div></div><div class="line"><div class="line-content">      <span class="ide">debug</span> <span class="str">&quot;url=&quot;</span>, <span class="ide">reqUrl</span></div></div><div class="line"><div class="line-content">      <span class="com"># custom handling here</span></div></div>  </code></pre>
<h4>UNIX domain socket</h4>
<p>You can also use UNIX domain sockets. It will provide a fast internal connection.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">caprese</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">ssl</span> <span class="op">=</span> <span class="ide">true</span>, <span class="ide">ip</span> <span class="op">=</span> <span class="str">&quot;0.0.0.0&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">8009</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>(<span class="ide">host</span> <span class="op">=</span> <span class="str">&quot;localhost&quot;</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">proxy</span>(<span class="ide">path</span> <span class="op">=</span> <span class="str">&quot;/&quot;</span>, <span class="ide">unix</span> <span class="op">=</span> <span class="str">&quot;/tmp/caprese1.sock&quot;</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">unix</span> <span class="op">=</span> <span class="str">&quot;/tmp/caprese1.sock&quot;</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>(<span class="ide">host</span> <span class="op">=</span> <span class="str">&quot;localhost:8009&quot;</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">response</span>(<span class="ide">content</span>(<span class="str">&quot;Hello!&quot;</span>, <span class="str">&quot;text/html&quot;</span>))</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="kwd">return</span> <span class="ide">send</span>(<span class="str">&quot;Not found&quot;</span><span class="op">.</span><span class="ide">addHeader</span>(<span class="ide">Status404</span>))</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">serverStart</span>()</div></div>  </code></pre>
<h4>Server load balancing</h4>
<p>It would be better to assign the servers according to the load of each server, but if you simply assign them in order, it would look something like this. There are many ways to do this, and the various configurations will be flexible.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">std</span><span class="op">/</span><span class="ide">atomics</span></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">caprese</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">const</span> <span class="ide">ProxyHostList</span> <span class="op">=</span> [<span class="str">&quot;host1&quot;</span>, <span class="str">&quot;host2&quot;</span>, <span class="str">&quot;host3&quot;</span>, <span class="str">&quot;host4&quot;</span>]</div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">proxyHostCounter</span>: <span class="ide">Atomic</span>[<span class="ide">uint</span>]</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">getProxyHost</span>(): <span class="ide">string</span> <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="kwd">var</span> <span class="ide">curIdx</span> <span class="op">=</span> <span class="ide">proxyHostCounter</span><span class="op">.</span><span class="ide">fetchAdd</span>(<span class="num">1</span>) <span class="kwd">mod</span> <span class="ide">ProxyHostList</span><span class="op">.</span><span class="ide">len</span><span class="op">.</span><span class="ide">uint</span></div></div><div class="line"><div class="line-content">  <span class="ide">result</span> <span class="op">=</span> <span class="ide">ProxyHostList</span>[<span class="ide">curIdx</span>]</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">ssl</span> <span class="op">=</span> <span class="ide">true</span>, <span class="ide">ip</span> <span class="op">=</span> <span class="str">&quot;0.0.0.0&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">8009</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>(<span class="ide">host</span> <span class="op">=</span> <span class="str">&quot;localhost&quot;</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">proxy</span>(<span class="ide">path</span> <span class="op">=</span> <span class="str">&quot;/&quot;</span>, <span class="ide">host</span> <span class="op">=</span> <span class="ide">getProxyHost</span>(), <span class="ide">port</span> <span class="op">=</span> <span class="num">8089</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">serverStart</span>()</div></div>  </code></pre>
<p><strong>Note:</strong> Since <code>proxy:</code> block is Nim&apos;s <em>template</em>, <code>getProxyHost()</code> function is called after the <code>proxy:</code> <code>path</code> is matched.</p>
<h3>Tag-based Message Exchange</h3>
<p>Let me explain one of the unique features of the Caprese that is not implemented in common web servers. Tags can be attached to client connections. It is possible to send some data to the tag. That data will be sent to all tagged clients. The tag value must be a number or at least 8 bytes of data. It could be a string or something else, but it is better to use hashed data. It is assumed that the data is hashed originally, and no internal hashing of tags is performed. Hashing would be easy with Nim&apos;s <code>converter</code>. To control the tags, you need the <em>ClientId</em>, which you can get with <code>markPending()</code>.</p>
<h4>The tag control functions</h4>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">markPending</span>(<span class="ide">client</span>: <span class="ide">Client</span>): <span class="ide">ClientId</span></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">unmarkPending</span>(<span class="ide">clientId</span>: <span class="ide">ClientId</span>)</div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">unmarkPending</span>(<span class="ide">client</span>: <span class="ide">Client</span>)</div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">setTag</span>(<span class="ide">clientId</span>: <span class="ide">ClientId</span>, <span class="ide">tag</span>: <span class="ide">Tag</span>)</div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">delTag</span>(<span class="ide">clientId</span>: <span class="ide">ClientId</span>, <span class="ide">tag</span>: <span class="ide">Tag</span>)</div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">delTags</span>(<span class="ide">clientId</span>: <span class="ide">ClientId</span>)</div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">delTags</span>(<span class="ide">tag</span>: <span class="ide">Tag</span>)</div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">getClientIds</span>(<span class="ide">tag</span>: <span class="ide">Tag</span>): <span class="ide">Array</span>[<span class="ide">ClientId</span>]</div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">getTags</span>(<span class="ide">clientId</span>: <span class="ide">ClientId</span>): <span class="ide">Array</span>[<span class="ide">Tag</span>]</div></div><div class="line"><div class="line-content"><span class="kwd">iterator</span> <span class="ide">getClientIds</span>(<span class="ide">tag</span>: <span class="ide">Tag</span>): <span class="ide">ClientId</span></div></div><div class="line"><div class="line-content"><span class="kwd">iterator</span> <span class="ide">getTags</span>(<span class="ide">clientId</span>: <span class="ide">ClientId</span>): <span class="ide">Tag</span></div></div>  </code></pre>
<h4>Send to tag, WebSocket only</h4>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">template</span> <span class="ide">wsSend</span>(<span class="ide">tag</span>: <span class="ide">Tag</span>, <span class="ide">data</span>: <span class="ide">seq</span>[<span class="ide">byte</span>] <span class="op">|</span> <span class="ide">string</span> <span class="op">|</span> <span class="ide">Array</span>[<span class="ide">byte</span>],</div></div><div class="line"><div class="line-content">                <span class="ide">opcode</span>: <span class="ide">WebSocketOpCode</span> <span class="op">=</span> <span class="ide">WebSocketOpCode</span><span class="op">.</span><span class="ide">Binary</span>): <span class="ide">int</span></div></div>  </code></pre>
<p>This is a feature that was originally used in the server of the block explorer. What this is used for is that if the HASH160 of addresses in the user wallets are registered as tags, when a new block is found, in the process of parsing the block and transactions, address-related information can be sent to the tags of the found addresses, and the user wallets will be notified in real time.</p>
<h3>Deploying a release-built executable</h3>
<p>Non-root users cannot use privileged ports such as 80 or 443 by default, so capabilities must be added on the target server after each build.</p>
<pre>  <code>sudo setcap cap_net_bind_service=+ep &lt;executable_file_name&gt;
</code></pre>
<p>If the above command is not executed, the following bind error will occur.</p>
<pre>  <code>error: bind ret=-1 errno=13
</code></pre>
<p>Check if the capabilities is attached.</p>
<pre>  <code>getcap &lt;executable_file_name&gt;
</code></pre>
<h3>Let’s Encrypt</h3>
<p>At least http port 80 needs to be open for ACME HTTP-01 challenge. One method is to reply ACME tokens on http port 80, another is to redirect http port 80 to https port 443 and reply ACME tokens on the https connection. ACME does not verify certificates, Caprese has self-certificates and can connect with SSL by simply enabling SSL, so SSL connections for ACME are available on https even without certificate files yet. Try redirecting http to https and handling ACME.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">caprese</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">ssl</span> <span class="op">=</span> <span class="ide">true</span>, <span class="ide">ip</span> <span class="op">=</span> <span class="str">&quot;0.0.0.0&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">443</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>(<span class="ide">host</span> <span class="op">=</span> <span class="str">&quot;YOUR_DOMAIN&quot;</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">certificates</span>(<span class="ide">path</span> <span class="op">=</span> <span class="str">&quot;./certs/YOUR_DOMAIN&quot;</span>):</div></div><div class="line"><div class="line-content">      <span class="ide">privKey</span>: <span class="str">&quot;privkey.pem&quot;</span></div></div><div class="line"><div class="line-content">      <span class="ide">fullChain</span>: <span class="str">&quot;fullchain.pem&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">get</span> <span class="str">&quot;/&quot;</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">return</span> <span class="ide">send</span>(<span class="str">&quot;Hello!&quot;</span><span class="op">.</span><span class="ide">addHeader</span>())</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">acme</span>(<span class="ide">path</span> <span class="op">=</span> <span class="str">&quot;./www/YOUR_DOMAIN&quot;</span>):</div></div><div class="line"><div class="line-content">      <span class="ide">echo</span> <span class="str">&quot;acme &quot;</span>, <span class="ide">reqUrl</span>, <span class="str">&quot; &quot;</span>, <span class="ide">mime</span></div></div><div class="line"><div class="line-content">      <span class="ide">echo</span> <span class="ide">content</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="kwd">return</span> <span class="ide">send</span>(<span class="str">&quot;Not Found&quot;</span><span class="op">.</span><span class="ide">addHeader</span>())</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">server</span>(<span class="ide">ip</span> <span class="op">=</span> <span class="str">&quot;0.0.0.0&quot;</span>, <span class="ide">port</span> <span class="op">=</span> <span class="num">80</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">routes</span>(<span class="ide">host</span> <span class="op">=</span> <span class="str">&quot;YOUR_DOMAIN&quot;</span>):</div></div><div class="line"><div class="line-content">    <span class="kwd">return</span> <span class="ide">send</span>(<span class="ide">redirect301</span>(<span class="str">&quot;https://YOUR_DOMAIN&quot;</span> <span class="op">&amp;</span> <span class="ide">reqUrl</span>))</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">serverStart</span>()</div></div>  </code></pre>
<p>Create a <em>server.nim</em> file with the above code and launch <em>server</em> as a non-root user. Open ports 80 and 443 to allow connections from external clients.</p>
<pre>  <code>nim c -d:release --threads:on --mm:orc server.nim
sudo setcap cap_net_bind_service=+ep ./server
./server
</code></pre>
<p>With <em>server</em> running, execute the following <em>certbot</em> command as root user. Specify the web root folder where <em>certbot</em> will place the ACME HTTP-01 challenge token.</p>
<pre>  <code>certbot certonly --webroot -w /path/to/www/YOUR_DOMAIN -d YOUR_DOMAIN
</code></pre>
<p>ECDSA or something if you like.</p>
<pre>  <code>certbot certonly --key-type ecdsa --elliptic-curve secp384r1 --webroot -w /path/to/www/YOUR_DOMAIN -d YOUR_DOMAIN
</code></pre>
<p>Or write it in <em>/etc/letsencrypt/cli.ini</em> file.</p>
<pre>  <code>key-type = ecdsa
elliptic-curve = secp384r1
</code></pre>
<p>If successful, the certificate files will be created in the following path.</p>
<pre>  <code>/etc/letsencrypt/live/YOUR_DOMAIN/{privkey.pem,fullchain.pem}
</code></pre>
<p>These files should be copied to the <em>certs</em> folder. Caprese monitors the files in the <em>certs</em> folder and automatically loads the new certificates if any files are changed. However, it is necessary to change the permissions on the certificate files so that user running Caprese can access it.</p>
<p>Create <em>caprese_certs_update.sh</em>, in the following, user and group is assumed to be <em>caprese</em>.</p>
<pre>  <code class="language-bash">#!/bin/bash
mkdir -p /path/to/certs/YOUR_DOMAIN
cp /etc/letsencrypt/live/YOUR_DOMAIN/{privkey.pem,fullchain.pem} /path/to/certs/YOUR_DOMAIN
chown -R caprese:caprese /path/to/certs
</code></pre>
<p>Copy <em>caprese_certs_update.sh</em> to letsencrypt post hook.</p>
<pre>  <code>cp caprese_certs_update.sh /etc/letsencrypt/renewal-hooks/post
</code></pre>
<p>First copy of certificate files, also for testing.</p>
<pre>  <code>certbot renew --dry-run
</code></pre>
<p>Now open <a href="http://YOUR_DOMAIN/">http://YOUR_DOMAIN/</a> in your browser. If the URL http redirects to https and there is no certificate warning, it is successful.</p>
<p>If you have just created the directory <em>/path/to/certs/YOUR_DOMAIN</em>, wait about 30 seconds before opening the URL. This is because if the directory does not exist yet, real-time file monitoring to update the certificates is deactivated. Once the Caprese has detected the directory, monitoring is activated, the certificates will be updated instantly after the certificate files have been changed.</p>
<h3>Leftover Desserts</h3>
<ul>
<li>POST</li>
<li>IPv6</li>
<li>QUIC</li>
<li>Cookies</li>
</ul>
<h3>License</h3>
<p>MIT</p>
</document>
            
        </div>
        <div class="col-3" id="meta-section">
            <div class="container box rounded p-3">
                
                    <p>
                        <strong>Licence:</strong>
                        MIT
                    </p>
                

                
                    <p> <a href="https://github.com/zenywallet/caprese">Project website</a> </p>
                

                
            </div>
        </div>
    </div>
</div>
</div>

<footer class="pt-10 px-3">
  <div class="container pt-4">
    <div class="row mb-4">
      <div class="col-lg-3">
        <h4 class="h5">Getting started with Nim</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://learnxinyminutes.com/docs/nim/">Learn Nim in 5 minutes</a></li>
          <li><a class="text-decoration-none" href="https://nim-by-example.github.io/">Nim by Example</a></li>
          <li><a class="text-decoration-none" href="https://play.nim-lang.org/">Official Playground</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Official Tutorials</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut1.html">General Tutorial</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut2.html">Advanced Features</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut3.html">Macros and Metaprogramming</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Nim for...</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-C-programmers">C programmers</a></li>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-Python-Programmers">Python programmers</a></li>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-TypeScript-Programmers">TypeScript programmers</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Documentation</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/lib.html">Standard Library</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/manual.html">Language Manual</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tools.html">Tools Documentation</a></li>
        </ul>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-12 text-center mt-4 mx-auto">
        <a href="#" class="d-block mb-3 mx-auto bw"></a>
        <p class="text-muted">
        Created in <a href="https://nim-lang.org/">Nim</a> on <a href="https://pages.github.com/">GitHub Pages</a>.
        <a href="https://github.com/gabbhack/nimidirectory">Available</a>
        under <a href="https://en.wikipedia.org/wiki/GNU_General_Public_License#Version_3">GPLv3</a>
        </p>
        <p class="text-muted">
        Builded at 2024-03-14T01:07:18Z
        </p>
      </div>
    </div>
  </div>
</footer>
<script>
</script>
</body>
</html>
