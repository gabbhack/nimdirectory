<!DOCTYPE html>
<html lang="en">
<head>
  <title>Nim Package Directory</title>
  <link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="alternate" type="application/rss+xml" title="New and updated Nim packages" href="https://nimble.directory/packages.xml">
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/highlite.css">
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script type="text/javascript" src="/js/app.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg fixed-top py-3">
  <div class="container">
    <a href="/" class="logo fw-500 display-1 text-black text-decoration-none navbar-brand"></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item mx-2">
          <a href="https://nim-lang.org/" class="nav-link">What's Nim?</a>
        </li>
        <li class="nav-item mx-2">
          <a href="/about.html" class="nav-link">What's Nimble?</a>
        </li>
        <li class="nav-item mx-2">
          <a href="https://github.com/nim-lang/packages/" class="nav-link">Publish your package</a>
        </li>
        <!-- TODO: replace with something different -->
        <li class="nav-item ms-3">
          <a class="nav-link" href="https://www.youtube.com/channel/UCDAYn_VFt0VisL5-1a5Dk7Q/">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon></svg>
          </a>
        </li>
        <li class="nav-item ms-3">
          <a class="nav-link theme-switcher-btn" id="darkmode" onclick="toggle_dark_mode()" href="#">
            <span id="light-mode-icon">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </span>
            <span id="dark-mode-icon">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="content">
  <div class="container">
    <div class="container pt-10">
        <h3 class="mb-3 fw-bold display-6 pt-4">anonimongo</h3>
        <p class="tags">
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">mongo</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">mongodb</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">driver</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">pure</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">library</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">bson</button></a>
                </span>
            
        </p>
        <p class="pkg-desc">some("ANOther pure NIm MONGO driver.")</p>
        <a title="Copy" onclick="document.querySelector('#cmd').select();document.execCommand('copy');"
            alt="Copy on clipboard">
            <i class="fa fa-copy"></i>
        </a>
        <input id="cmd" onclick="this.select();" value="nimble install anonimongo" readonly="">
        <br>
        <small style="font-size: 0.8rem;">Need help? Read <a
                href="https://github.com/nim-lang/nimble#creating-packages">Nimble</a></small>
    </div>

    <div class="container row pt-4" id="pkg-content">
        <div class="col-8 box rounded p-3" id="readme-section">
            
                <document><h1>Anonimongo - Another pure Nim Mongo driver</h1>
<hr />
<p>  <strong>NOTE:</strong></p>
<p>Starting from v0.6.0, All objects are defined in generic which accept <code>net.Socket</code>
or <code>asyncnet.AsyncSocket</code> only. All APIs are following this change and also defined as generic too.<br />
For users, the only things that they have to change is the adding the type <code>Mongo</code>, <code>Database</code>, <code>Query</code>, <code>Cursor</code>,
<code>Collection</code> which socket type it&apos;d be working. E.g.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># Previous</span></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">m</span>: <span class="ide">Mongo</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com">#or</span></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">m</span> <span class="op">=</span> <span class="ide">newMongo</span>(<span class="ide">urlconn</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># to be</span></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">m</span>: <span class="ide">Mongo</span>[<span class="ide">AsyncSocket</span>] <span class="com"># or Mongo[Socket] for using net.Socket</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># or</span></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">m</span> <span class="op">=</span> <span class="ide">newMongo</span>[<span class="ide">AsyncSocket</span>](<span class="ide">urlconn</span>)</div></div>  </code></pre>
<p>Other than those, any other APIs should work the same since all work for both Socket and AsyncSocket.</p>
<hr />
<h2>Table of content</h2>
<ol>
<li>
<p>  <a href="#Introduction">Introduction</a></p>
</li>
<li>
<p>  <a href="#examples">Examples</a></p>
<ul>
<li>  <a href="#simple-operations">Simple operations</a></li>
<li>  <a href="#authenticate">Authenticate</a></li>
<li>  <a href="#ssl-uri-connect">SSL URI connect</a></li>
<li>  <a href="#upload-file-to-gridfs">Upload file to GridFS</a></li>
<li>  <a href="#bson-examples">Bson examples</a></li>
<li>  <a href="#convert-object-to-bsondocument">Convert object to BsonDocument</a></li>
<li>  <a href="#convert-from-bson-to-object-variant">Convert from Bson to object variant</a></li>
<li>  <a href="#convert-with-custom-key-bson">Convert with custom key Bson</a></li>
<li>  <a href="#convert-json-bson">Convert Json to and Bson and vice versa</a></li>
<li>  <a href="#watching-a-collection">Watching a collection</a></li>
<li>  <a href="#todolist-app">Todolist app</a></li>
<li>  <a href="#upload-file">Upload-file</a></li>
<li>  <a href="#benchmark-examples">Benchmark examples</a></li>
</ul>
</li>
<li>
<p>  <a href="#working-with-bson">Specific Mentions for Working with Bson</a></p>
</li>
<li>
<p>  <a href="#install">Install</a></p>
</li>
<li>
<p>  <a href="#implemented-apis">Implemented APIs</a></p>
</li>
<li>
<p>  <a href="#caveats">Caveats</a></p>
</li>
<li>
<p>  <a href="#license">License</a></p>
</li>
</ol>
<h2>Introduction</h2>
<p><a href="https://www.mongodb.com">Mongodb</a> is a document-based key-value database which emphasize in high performance read
and write capabilities together with many strategies for clustering, consistency, and availability.</p>
<p>Anonimongo is a driver for Mongodb developed using pure Nim. As library, it&apos;s developed to enable
developers to be able to access and use Mongodb in projects using Nim. Several implementad as
APIs for low-level which works directly with <a href="https://mashingan.github.io/anonimongo/src/htmldocs/anonimongo/core/types.html#Database">Database</a> and higher level APIs which works with
<a href="https://mashingan.github.io/anonimongo/src/htmldocs/anonimongo/core/types.html#Collection">Collection</a>. Any casual user just have to access the <a href="https://mashingan.github.io/anonimongo/src/htmldocs/anonimongo/collections.html">Collection API</a> directly instead of
working with various <a href="https://github.com/mashingan/anonimongo/tree/master/src/anonimongo/dbops">Database operations</a>.</p>
<p>The APIs are closely following <a href="https://docs.mongodb.com/manual/reference">Mongo documentation</a> with a bit variant for <code>explain</code> API. Each supported
command for <code>explain</code> added optional string value to indicate the verbosity of <code>explain</code> command.<br />
By default, it&apos;s empty string which also indicate the command operations working without the need to
<code>explain</code> the queries. For others detailed caveats can be found <a href="#caveats">here</a>.</p>
<p>All APIs are generic which work asynchronous by using AsyncSocket or synchronously using Socket.<br />
In case of using AsyncSocket, the user must <code>await</code> or <code>waitfor</code> depend on scope. When using Socket, it&apos;s not
needed.<br />
Any API that insert/update/delete will return <a href="https://mashingan.github.io/anonimongo/src/htmldocs/anonimongo/core/types.html#WriteResult">WriteResult</a>. So the user can check
whether the write operation is successful or not with its field boolean <code>success</code> and the field
string <code>reason</code> to know what&apos;s the error message returned. However it&apos;s still throwing any other
error such as</p>
<ul>
<li><code>MongoError</code> (the failure related to Database APIs and Mongo APIs),</li>
<li><code>BsonFetchError</code> (getting the wrong Bson type from BsonBase),</li>
<li><code>KeyError</code> (accessing non-existent key BsonDocument or embedded document in BsonBase),</li>
<li><code>IndexError</code> (accessing index more than BsonArray length or BsonBase that&apos;s actually BsonArray length),</li>
<li><code>IOError</code> (related to socket),</li>
<li><code>TimeoutError</code> (when connecting with <code>mongodb+srv</code> scheme URI)</li>
</ul>
<p>which are raised by the underlying process. Those errors are indicating an err in the program flow hence elevated
on how the user handles them.</p>
<p><a href="https://mashingan.github.io/anonimongo/src/htmldocs/anonimongo.html">This page</a> (<code>anonimongo.html</code>) is the elaborate documentation. It also explains several
modules and the categories for those modules. <a href="https://mashingan.github.io/anonimongo/src/htmldocs/theindex.html">The index</a> also available.</p>
<p>  <a href="#table-of-content">TOC</a></p>
<h2>Examples</h2>
<h3>Simple operations</h3>
<p>There are two ways to define Bson object (<code>newBson</code> and <code>bson</code>) but it&apos;s preferable use <code>bson</code>
as <code>newBson</code> is the low-level object definition. Users can roll-out their own operator like
in example below.<br />
For creating client, it&apos;s preferable to use <code>newMongo</code> overload with <code>MongoUri</code> argument because
the <code>MongoUri</code> overload has better support for various client options such as</p>
<ul>
<li><code>AppName</code> for identifying your application when connecting to Mongodb server.</li>
<li><code>readPreference</code> which support <code>primary</code> (default), <code>primaryPreferred</code>, <code>secondary</code>, <code>secondaryPreferred</code>.</li>
<li><code>w</code> (as write concern option).</li>
<li><code>retryableWrites</code> which can be supplied with <code>false</code> (default) or <code>true</code>.</li>
<li><code>compressors</code> which support list of compressor: <code>snappy</code> and <code>zlib</code>.</li>
<li><code>authSource</code> that point which database we want to authenticate.<br />
This won&apos;t be used if in the <code>MongoUri</code> users provide the path to the database intended.</li>
</ul>
<p>So the database source in case of <code>MongoUri</code> <code>&quot;mongodb://localhost:27017/not-admin?authSource=admin&quot;</code> is <code>&quot;not-admin&quot;</code>.</p>
<ul>
<li><code>ssl</code> or <code>tls</code> which can be <code>false</code> (default if not using <code>mongodb+srv</code> scheme), or true (default if using <code>mongodb+srv</code> scheme).</li>
<li><code>tlsInsecure</code>, <code>tlsAllowInvalidCertificates</code>, <code>tlsAllowInvalidHostnames</code>. Please refer to Mongodb documentation
as these 3 options have elaborate usage. In most cases, users don&apos;t have to bother about these 3 options.</li>
</ul>
<p>All above options parameters are case-insensitive but the values are not because
Mongodb server is not accepting case-insensitive values.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">times</span></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">anonimongo</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">mongo</span> <span class="op">=</span> <span class="ide">newMongo</span>[<span class="ide">AsyncSocket</span>](<span class="ide">poolconn</span> <span class="op">=</span> <span class="num">16</span>) <span class="com"># default is 64</span></div></div><div class="line"><div class="line-content"><span class="kwd">if</span> <span class="kwd">not</span> <span class="ide">waitFor</span> <span class="ide">mongo</span><span class="op">.</span><span class="ide">connect</span>:</div></div><div class="line"><div class="line-content">  <span class="com"># default is localhost:27017</span></div></div><div class="line"><div class="line-content">  <span class="ide">quit</span> <span class="str">&quot;Cannot connect to localhost:27017&quot;</span></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">coll</span> <span class="op">=</span> <span class="ide">mongo</span>[<span class="str">&quot;temptest&quot;</span>][<span class="str">&quot;colltest&quot;</span>]</div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">currtime</span> <span class="op">=</span> <span class="ide">now</span>()<span class="op">.</span><span class="ide">toTime</span>()</div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">idoc</span> <span class="op">=</span> <span class="ide">newseq</span>[<span class="ide">BsonDocument</span>](<span class="num">10</span>)</div></div><div class="line"><div class="line-content"><span class="kwd">for</span> <span class="ide">i</span> <span class="kwd">in</span> <span class="num">0</span> <span class="op">..</span> <span class="ide">idoc</span><span class="op">.</span><span class="ide">high</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">idoc</span>[<span class="ide">i</span>] <span class="op">=</span> <span class="ide">bson</span> {</div></div><div class="line"><div class="line-content">    <span class="ide">datetime</span>: <span class="ide">currtime</span> <span class="op">+</span> <span class="ide">initDuration</span>(<span class="ide">hours</span> <span class="op">=</span> <span class="ide">i</span>),</div></div><div class="line"><div class="line-content">    <span class="ide">insertId</span>: <span class="ide">i</span></div></div><div class="line"><div class="line-content">  }</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># insert documents</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">writeRes</span> <span class="op">=</span> <span class="ide">waitfor</span> <span class="ide">coll</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">idoc</span>)</div></div><div class="line"><div class="line-content"><span class="kwd">if</span> <span class="kwd">not</span> <span class="ide">writeRes</span><span class="op">.</span><span class="ide">success</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;Cannot insert to collection: &quot;</span>, <span class="ide">coll</span><span class="op">.</span><span class="ide">name</span></div></div><div class="line"><div class="line-content"><span class="kwd">else</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;inserted documents: &quot;</span>, <span class="ide">writeRes</span><span class="op">.</span><span class="ide">n</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">id5doc</span> <span class="op">=</span> <span class="ide">waitfor</span> <span class="ide">coll</span><span class="op">.</span><span class="ide">findOne</span>(<span class="ide">bson</span> {</div></div><div class="line"><div class="line-content">  <span class="ide">insertId</span>: <span class="num">5</span></div></div><div class="line"><div class="line-content">})</div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">id5doc</span>[<span class="str">&quot;datetime&quot;</span>] <span class="op">==</span> <span class="ide">currtime</span> <span class="op">+</span> <span class="ide">initDuration</span>(<span class="ide">hours</span> <span class="op">=</span> <span class="num">5</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># we define our own operator `!&gt;` for this example only.</span></div></div><div class="line"><div class="line-content"><span class="kwd">template</span> `<span class="op">!&gt;</span>`(<span class="ide">b</span>: <span class="ide">untyped</span>): <span class="ide">BsonDocument</span> <span class="op">=</span> <span class="ide">bson</span>(<span class="ide">b</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># find one and modify, return the old document by default</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">oldid8doc</span> <span class="op">=</span> <span class="ide">waitfor</span> <span class="ide">coll</span><span class="op">.</span><span class="ide">findAndModify</span>(</div></div><div class="line"><div class="line-content">  <span class="op">!&gt;</span>{ <span class="ide">insertId</span>: <span class="num">8</span>},</div></div><div class="line"><div class="line-content">  <span class="op">!&gt;</span>{ <span class="str">&quot;$set&quot;</span>: { <span class="ide">insertId</span>: <span class="num">80</span> }})</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># find documents with combination of find which return query and one/all/iter</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">query</span> <span class="op">=</span> <span class="ide">coll</span><span class="op">.</span><span class="ide">find</span>()</div></div><div class="line"><div class="line-content"><span class="ide">query</span><span class="op">.</span><span class="ide">limit</span> <span class="op">=</span> <span class="num">5.</span><span class="ide">int32</span> <span class="com"># limit the documents we&apos;ll look</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">fivedocs</span> <span class="op">=</span> <span class="ide">waitfor</span> <span class="ide">query</span><span class="op">.</span><span class="ide">all</span>()</div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">fivedocs</span><span class="op">.</span><span class="ide">len</span> <span class="op">==</span> <span class="num">5</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># let&apos;s iterate the documents instead of bulk find</span></div></div><div class="line"><div class="line-content"><span class="com"># this iteration is bit different with iterating result</span></div></div><div class="line"><div class="line-content"><span class="com"># from `query.all` because `query.iter` is returning `Future[Cursor]`</span></div></div><div class="line"><div class="line-content"><span class="com"># which then the Cursor has `items` iterator.</span></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">count</span> <span class="op">=</span> <span class="num">0</span></div></div><div class="line"><div class="line-content"><span class="kwd">for</span> <span class="ide">doc</span> <span class="kwd">in</span> <span class="ide">waitfor</span> <span class="ide">query</span><span class="op">.</span><span class="ide">iter</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">inc</span> <span class="ide">count</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">count</span> <span class="op">==</span> <span class="num">5</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># find one document, which newly modified</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">newid8doc</span> <span class="op">=</span> <span class="ide">waitfor</span> <span class="ide">coll</span><span class="op">.</span><span class="ide">findOne</span>(<span class="ide">bson</span> { <span class="ide">insertId</span>: <span class="num">80</span> })</div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">oldid8doc</span>[<span class="str">&quot;datetime&quot;</span>]<span class="op">.</span><span class="ide">ofTime</span> <span class="op">==</span> <span class="ide">newid8doc</span>[<span class="str">&quot;datetime&quot;</span>]</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># remove a document</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">delStat</span> <span class="op">=</span> <span class="ide">waitfor</span> <span class="ide">coll</span><span class="op">.</span><span class="ide">remove</span>(<span class="ide">bson</span> {</div></div><div class="line"><div class="line-content">  <span class="ide">insertId</span>: <span class="num">9</span>,</div></div><div class="line"><div class="line-content">}, <span class="ide">justone</span> <span class="op">=</span> <span class="ide">true</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">delStat</span><span class="op">.</span><span class="ide">success</span>  <span class="com"># must be true if query success</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">delStat</span><span class="op">.</span><span class="ide">kind</span> <span class="op">==</span> <span class="ide">wkMany</span> <span class="com"># remove operation returns</span></div></div><div class="line"><div class="line-content">                                <span class="com"># the WriteObject result variant</span></div></div><div class="line"><div class="line-content">                                <span class="com"># of wkMany which withhold the</span></div></div><div class="line"><div class="line-content">                                <span class="com"># integer n field for n affected</span></div></div><div class="line"><div class="line-content">                                <span class="com"># document in successfull operation</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">delStat</span><span class="op">.</span><span class="ide">n</span> <span class="op">==</span> <span class="num">1</span>   <span class="com"># number of affected documents</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># count all documents in current collection</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">currNDoc</span> <span class="op">=</span> <span class="ide">waitfor</span> <span class="ide">coll</span><span class="op">.</span><span class="ide">count</span>()</div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">currNDoc</span> <span class="op">==</span> (<span class="ide">idoc</span><span class="op">.</span><span class="ide">len</span> <span class="op">-</span> <span class="ide">delStat</span><span class="op">.</span><span class="ide">n</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">close</span> <span class="ide">mongo</span></div></div>  </code></pre>
<p>  <a href="#table-of-content">TOC</a></p>
<h3>Authenticate</h3>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">std</span><span class="op">/</span><span class="ide">net</span></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">anonimongo</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># note in this example we&apos;re using net.Socket instead of AsyncSocket</span></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">mongo</span> <span class="op">=</span> <span class="ide">newMongo</span>[<span class="ide">Socket</span>]()</div></div><div class="line"><div class="line-content"><span class="kwd">if</span> <span class="kwd">not</span> <span class="ide">mongo</span><span class="op">.</span><span class="ide">connect</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">quit</span> <span class="str">&quot;Cannot connect to localhost:27017&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># change to :SHA1Digest for SCRAM-SHA-1 mechanism</span></div></div><div class="line"><div class="line-content"><span class="kwd">if</span> <span class="kwd">not</span> <span class="ide">mongo</span><span class="op">.</span><span class="ide">authenticate</span>[:<span class="ide">SHA256Digest</span>](<span class="ide">username</span>, <span class="ide">password</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">quit</span> <span class="str">&quot;Cannot login to localhost:27017&quot;</span></div></div><div class="line"><div class="line-content"><span class="ide">close</span> <span class="ide">mongo</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Authenticating using URI</span></div></div><div class="line"><div class="line-content"><span class="ide">mongo</span> <span class="op">=</span> <span class="ide">newMongo</span>[<span class="ide">Socket</span>](<span class="ide">MongoUri</span>(<span class="str">&quot;mongodb://username:password@domain-host/admin&quot;</span>))</div></div><div class="line"><div class="line-content"><span class="kwd">if</span> <span class="kwd">not</span> <span class="ide">waitfor</span> <span class="ide">mongo</span><span class="op">.</span><span class="ide">connect</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">quit</span> <span class="str">&quot;Cannot connect to domain-host&quot;</span></div></div><div class="line"><div class="line-content"><span class="kwd">if</span> <span class="kwd">not</span> <span class="ide">mongo</span><span class="op">.</span><span class="ide">authenticate</span>[:<span class="ide">SHA256Digest</span>]():</div></div><div class="line"><div class="line-content">  <span class="ide">quit</span> <span class="str">&quot;Cannot login to domain-host&quot;</span></div></div><div class="line"><div class="line-content"><span class="ide">close</span> <span class="ide">mongo</span></div></div>  </code></pre>
<p>  <a href="#table-of-content">TOC</a></p>
<h3>SSL URI connect</h3>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># need to compile with -d:ssl option to enable ssl</span></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">strformat</span></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">anonimongo</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">uriserver</span> <span class="op">=</span> <span class="str">&quot;mongo://username:password@localhost:27017/&quot;</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">sslkey</span> <span class="op">=</span> <span class="str">&quot;/path/to/ssl/key.pem&quot;</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">sslcert</span> <span class="op">=</span> <span class="str">&quot;/path/to/ssl/cert.pem&quot;</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">urissl</span> <span class="op">=</span> <span class="op">&amp;</span><span class="str">&quot;{uriserver}?tlsCertificateKeyFile=certificate:{encodeURL sslcert},key:{encodeURL sslkey}&quot;</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">connectToAtlast</span> <span class="op">=</span> <span class="str">&quot;mongo+srv://username:password@atlas-domain/admin&quot;</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">multipleHostUri</span> <span class="op">=</span> <span class="str">&quot;mongo://uname:passwd@domain-1,uname:passwd@domain-2,uname:passwd@domain-3/admin&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># uri ssl connection</span></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">mongo</span> <span class="op">=</span> <span class="ide">newMongo</span>[<span class="ide">AsyncSocket</span>](<span class="ide">MongoUri</span> <span class="ide">urissl</span>)</div></div><div class="line"><div class="line-content"><span class="ide">close</span> <span class="ide">mongo</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># or for `mongo+srv` connection scheme</span></div></div><div class="line"><div class="line-content"><span class="ide">mongo</span> <span class="op">=</span> <span class="ide">newMongo</span>[<span class="ide">AsyncSocket</span>](<span class="ide">MongoUri</span> <span class="ide">connectToAtlas</span>)</div></div><div class="line"><div class="line-content"><span class="ide">close</span> <span class="ide">mongo</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># for multipleHostUri</span></div></div><div class="line"><div class="line-content"><span class="ide">mongo</span> <span class="op">=</span> <span class="ide">newMongo</span>(<span class="ide">MongoUri</span> <span class="ide">multipleHostUri</span>)</div></div><div class="line"><div class="line-content"><span class="ide">close</span> <span class="ide">mongo</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># custom DNS server and its port</span></div></div><div class="line"><div class="line-content"><span class="com"># by default it&apos;s: `dnsserver = &quot;8.8.8.8&quot;` and `dnsport = 53`</span></div></div><div class="line"><div class="line-content"><span class="ide">mongo</span> <span class="op">=</span> <span class="ide">newMongo</span>[<span class="ide">AsyncSocket</span>](</div></div><div class="line"><div class="line-content">  <span class="ide">MongoUri</span> <span class="ide">connectToAtlas</span>,</div></div><div class="line"><div class="line-content">  <span class="ide">dnsserver</span> <span class="op">=</span> <span class="str">&quot;1.1.1.1&quot;</span>,</div></div><div class="line"><div class="line-content">  <span class="ide">dnssport</span> <span class="op">=</span> <span class="num">5000</span>)</div></div><div class="line"><div class="line-content"><span class="ide">close</span> <span class="ide">mongo</span></div></div>  </code></pre>
<p>In the <a href="tests/test_replication_sslcon.nim">test_replication_sslcon.nim</a>, there&apos;s example of emulated
<a href="tests/utils_replica.nim#L29-L92">DNS server custom for <code>SRV</code></a>
of DNS seedlist lookup. So the URI to connect is <code>localhost:5000</code> which in return replying with
<code>localhost:27018</code>, <code>localhost:27019</code> and <code>localhost:27020</code> as domain of replication set.</p>
<p>  <a href="#table-of-content">TOC</a></p>
<h3>Upload file to GridFS</h3>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># this time the server doesn&apos;t need SSL/TLS or authentication</span></div></div><div class="line"><div class="line-content"><span class="com"># gridfs is useful when the file bigger than a document capsize 16 megabytes</span></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">std</span><span class="op">/</span><span class="ide">net</span></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">anonimongo</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">mongo</span> <span class="op">=</span> <span class="ide">newMongo</span>[<span class="ide">Socket</span>]()</div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">mongo</span><span class="op">.</span><span class="ide">connect</span></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">grid</span> <span class="op">=</span> <span class="ide">mongo</span>[<span class="str">&quot;target-db&quot;</span>]<span class="op">.</span><span class="ide">createBucket</span>() <span class="com"># by default, the bucket name is &quot;fs&quot;</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">res</span> <span class="op">=</span> <span class="ide">grid</span><span class="op">.</span><span class="ide">uploadFile</span>(<span class="str">&quot;/path/to/our/file&quot;</span>)</div></div><div class="line"><div class="line-content"><span class="kwd">if</span> <span class="kwd">not</span> <span class="ide">res</span><span class="op">.</span><span class="ide">success</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;some error happened: &quot;</span>, <span class="ide">res</span><span class="op">.</span><span class="ide">reason</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">gstream</span> <span class="op">=</span> <span class="ide">grid</span><span class="op">.</span><span class="ide">getStream</span>(<span class="str">&quot;our-available-file&quot;</span>)</div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">data</span> <span class="op">=</span> <span class="ide">gstream</span><span class="op">.</span><span class="ide">read</span>(<span class="num">5.</span><span class="ide">megabytes</span>) <span class="com"># reading 5 megabytes of binary data</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">data</span><span class="op">.</span><span class="ide">len</span> <span class="op">==</span> <span class="num">5.</span><span class="ide">megabytes</span></div></div><div class="line"><div class="line-content"><span class="ide">close</span> <span class="ide">gstream</span></div></div><div class="line"><div class="line-content"><span class="ide">close</span> <span class="ide">mongo</span></div></div>  </code></pre>
<p>  <a href="#table-of-content">TOC</a></p>
<h3>Bson examples</h3>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">times</span></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">anonimongo</span><span class="op">/</span><span class="ide">core</span><span class="op">/</span><span class="ide">bson</span> <span class="com"># if we only need to work with Bson</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">simple</span> <span class="op">=</span> <span class="ide">bson</span>({</div></div><div class="line"><div class="line-content">  <span class="ide">thisField</span>: <span class="str">&quot;isString&quot;</span>,</div></div><div class="line"><div class="line-content">  <span class="ide">embedDoc</span>: {</div></div><div class="line"><div class="line-content">    <span class="ide">embedField1</span>: <span class="str">&quot;unicodeこんにちは異世界&quot;</span>,</div></div><div class="line"><div class="line-content">    <span class="str">&quot;type&quot;</span>: <span class="str">&quot;cannot use any literal or Nim keyword except string literal or symbol&quot;</span>,</div></div><div class="line"><div class="line-content">    `<span class="kwd">distinct</span>`: <span class="ide">true</span>, <span class="com"># this is acceptable make distinct as symbol using `</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="com"># the trailing comma is accepted</span></div></div><div class="line"><div class="line-content">    <span class="ide">embedTimes</span>: <span class="ide">now</span>()<span class="op">.</span><span class="ide">toTime</span>,</div></div><div class="line"><div class="line-content">  },</div></div><div class="line"><div class="line-content">  <span class="str">&quot;1.2&quot;</span>: <span class="num">1.2</span>,</div></div><div class="line"><div class="line-content">  <span class="ide">arraybson</span>: [<span class="num">1</span>, <span class="str">&quot;hello&quot;</span>, <span class="ide">false</span>], <span class="com"># heterogenous elements</span></div></div><div class="line"><div class="line-content">})</div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">simple</span>[<span class="str">&quot;thisField&quot;</span>] <span class="op">==</span> <span class="str">&quot;isString&quot;</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">simple</span>[<span class="str">&quot;embedDoc&quot;</span>][<span class="str">&quot;embedField1&quot;</span>] <span class="op">==</span> <span class="str">&quot;unicodeこんにちは異世界&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># explicit fetch when BsonBase cannot be automatically converted.</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">simple</span>[<span class="str">&quot;embedDoc&quot;</span>][<span class="str">&quot;distinct&quot;</span>]<span class="op">.</span><span class="ide">ofBool</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">simple</span>[<span class="str">&quot;1.2&quot;</span>]<span class="op">.</span><span class="ide">ofDouble</span> <span class="kwd">is</span> <span class="ide">float64</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Bson support object conversion too</span></div></div><div class="line"><div class="line-content"><span class="kwd">type</span></div></div><div class="line"><div class="line-content">  <span class="ide">IntString</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">field1</span><span class="op">*:</span> <span class="ide">int</span></div></div><div class="line"><div class="line-content">    <span class="ide">field2</span><span class="op">*:</span> <span class="ide">string</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">bintstr</span> <span class="op">=</span> <span class="ide">bson</span> {</div></div><div class="line"><div class="line-content">  <span class="ide">field1</span>: <span class="num">1000</span>,</div></div><div class="line"><div class="line-content">  <span class="ide">field2</span>: <span class="str">&quot;power-level&quot;</span></div></div><div class="line"><div class="line-content">}</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">ourObj</span> <span class="op">=</span> <span class="ide">bintstr</span><span class="op">.</span><span class="ide">to</span> <span class="ide">IntString</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">ourObj</span><span class="op">.</span><span class="ide">field1</span> <span class="op">==</span> <span class="num">1000</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">ourObj</span><span class="op">.</span><span class="ide">field2</span> <span class="op">==</span> <span class="str">&quot;power-level&quot;</span></div></div>  </code></pre>
<p>  <a href="#table-of-content">TOC</a></p>
<h3>Convert object to BsonDocument</h3>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">anonimongo</span><span class="op">/</span><span class="ide">core</span><span class="op">/</span><span class="ide">bson</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">type</span></div></div><div class="line"><div class="line-content">  <span class="ide">Obj1</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">str</span>: <span class="ide">string</span></div></div><div class="line"><div class="line-content">    `<span class="ide">int</span>`: <span class="ide">int</span></div></div><div class="line"><div class="line-content">    `<span class="ide">float</span>`: <span class="ide">float</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">toBson</span>(<span class="ide">obj</span>: <span class="ide">Obj1</span>): <span class="ide">BsonDocument</span> <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="ide">result</span> <span class="op">=</span> <span class="ide">bson</span>()</div></div><div class="line"><div class="line-content">  <span class="kwd">for</span> <span class="ide">k</span>, <span class="ide">v</span> <span class="kwd">in</span> <span class="ide">obj</span><span class="op">.</span><span class="ide">fieldPairs</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">result</span>[<span class="ide">k</span>] <span class="op">=</span> <span class="ide">v</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">obj1</span> <span class="op">=</span> <span class="ide">Obj1</span>(</div></div><div class="line"><div class="line-content">  <span class="ide">str</span>: <span class="str">&quot;test&quot;</span>,</div></div><div class="line"><div class="line-content">  `<span class="ide">int</span>`: <span class="num">42</span>,</div></div><div class="line"><div class="line-content">  `<span class="ide">float</span>`: <span class="num">42.0</span></div></div><div class="line"><div class="line-content">)</div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">obj1doc</span> <span class="op">=</span> <span class="ide">obj1</span><span class="op">.</span><span class="ide">toBson</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">obj1doc</span>[<span class="str">&quot;str&quot;</span>] <span class="op">==</span> <span class="ide">obj1</span><span class="op">.</span><span class="ide">str</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">obj1doc</span>[<span class="str">&quot;int&quot;</span>] <span class="op">==</span> <span class="ide">obj1</span><span class="op">.</span>`<span class="ide">int</span>`</div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">obj1doc</span>[<span class="str">&quot;float&quot;</span>] <span class="op">==</span> <span class="ide">obj1</span><span class="op">.</span>`<span class="ide">float</span>`</div></div>  </code></pre>
<p>The converting example above can be made generic like:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">toBson</span>[<span class="ide">T</span>: <span class="kwd">tuple</span> <span class="op">|</span> <span class="kwd">object</span>](<span class="ide">o</span>: <span class="ide">T</span>): <span class="ide">BsonDocument</span> <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="ide">result</span> <span class="op">=</span> <span class="ide">bson</span>()</div></div><div class="line"><div class="line-content">  <span class="kwd">for</span> <span class="ide">k</span>, <span class="ide">v</span> <span class="kwd">in</span> <span class="ide">o</span><span class="op">.</span><span class="ide">fieldPairs</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">result</span>[<span class="ide">k</span>] <span class="op">=</span> <span class="ide">v</span></div></div>  </code></pre>
<p>But according to the <code>fieldPairs</code> documentation, it can only support
tuple and object so if the user is working with ref object, they can
only convert it manually.</p>
<p>Above <code>toBson</code> snippet code can be modified to accomodate the <code>bsonKey</code> pragma
(starting from <code>v0.4.5</code>) to be:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">macros</span></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">anonimongo</span><span class="op">/</span><span class="ide">core</span><span class="op">/</span><span class="ide">bson</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">toBson</span>[<span class="ide">T</span>: <span class="kwd">tuple</span> <span class="op">|</span> <span class="kwd">object</span>](<span class="ide">o</span>: <span class="ide">T</span>): <span class="ide">BsonDocument</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">result</span> <span class="op">=</span> <span class="ide">bson</span>()</div></div><div class="line"><div class="line-content">  <span class="kwd">for</span> <span class="ide">k</span>, <span class="ide">v</span> <span class="kwd">in</span> <span class="ide">o</span><span class="op">.</span><span class="ide">fieldPairs</span>:</div></div><div class="line"><div class="line-content">    <span class="kwd">when</span> <span class="ide">v</span><span class="op">.</span><span class="ide">hasCustomPragma</span>(<span class="ide">bsonKey</span>):</div></div><div class="line"><div class="line-content">      <span class="kwd">var</span> <span class="ide">key</span> <span class="op">=</span> <span class="ide">v</span><span class="op">.</span><span class="ide">getCustomPragmaVal</span>(<span class="ide">bsonKey</span>)</div></div><div class="line"><div class="line-content">      <span class="ide">result</span>[<span class="ide">key</span>] <span class="op">=</span> <span class="ide">v</span> <span class="com"># or v.toBson for explicit conversion</span></div></div><div class="line"><div class="line-content">    <span class="kwd">else</span>:</div></div><div class="line"><div class="line-content">      <span class="ide">result</span>[<span class="ide">k</span>] <span class="op">=</span> <span class="ide">v</span> <span class="com"># or v.toBson for explicit conversion</span></div></div>  </code></pre>
<p>Check <a href="tests/">tests</a> for more examples of detailed usages.<br />
Elaborate Bson examples and cases are covered in <a href="tests/test_bson_test.nim">bson_test.nim</a></p>
<p>  <a href="#table-of-content">TOC</a></p>
<h3>Convert from Bson to object variant</h3>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># Below example is almost the same with test code from</span></div></div><div class="line"><div class="line-content"><span class="com"># `test_bson_test.nim` file in tests</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">anonimongo</span><span class="op">/</span><span class="ide">core</span><span class="op">/</span><span class="ide">bson</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">type</span></div></div><div class="line"><div class="line-content">  <span class="ide">OVKind</span> <span class="op">=</span> <span class="kwd">enum</span></div></div><div class="line"><div class="line-content">    <span class="ide">ovOne</span> <span class="ide">ovMany</span> <span class="ide">ovNone</span></div></div><div class="line"><div class="line-content">  <span class="ide">EmbedObjectVariant</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">field1</span><span class="op">*:</span> <span class="ide">int</span></div></div><div class="line"><div class="line-content">    <span class="ide">field2</span><span class="op">*:</span> <span class="ide">string</span></div></div><div class="line"><div class="line-content">    <span class="ide">truthy</span> {<span class="op">.</span><span class="ide">bsonExport</span><span class="op">.</span>}: <span class="ide">bool</span></div></div><div class="line"><div class="line-content">  <span class="ide">RefEmbedObjVariant</span> <span class="op">=</span> <span class="kwd">ref</span> <span class="ide">EmbedObjectVariant</span></div></div><div class="line"><div class="line-content">  <span class="ide">ObjectVariant</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">baseField</span><span class="op">*:</span> <span class="ide">string</span></div></div><div class="line"><div class="line-content">    <span class="ide">baseInt</span><span class="op">*:</span> <span class="ide">int</span></div></div><div class="line"><div class="line-content">    <span class="ide">baseEmbed</span><span class="op">*:</span> <span class="ide">BsonDocument</span></div></div><div class="line"><div class="line-content">    <span class="kwd">case</span> <span class="ide">kind</span><span class="op">*:</span> <span class="ide">OVKind</span></div></div><div class="line"><div class="line-content">    <span class="kwd">of</span> <span class="ide">ovOne</span>:</div></div><div class="line"><div class="line-content">      <span class="ide">theOnlyField</span><span class="op">*:</span> <span class="ide">string</span></div></div><div class="line"><div class="line-content">    <span class="kwd">of</span> <span class="ide">ovMany</span>:</div></div><div class="line"><div class="line-content">      <span class="ide">manyField1</span><span class="op">*:</span> <span class="ide">string</span></div></div><div class="line"><div class="line-content">      <span class="ide">intField</span><span class="op">*:</span> <span class="ide">int</span></div></div><div class="line"><div class="line-content">      <span class="ide">embed</span><span class="op">*:</span> <span class="ide">EmbedObjectVariant</span></div></div><div class="line"><div class="line-content">      <span class="ide">refembed</span><span class="op">*:</span> <span class="ide">RefEmbedObjVariant</span></div></div><div class="line"><div class="line-content">    <span class="kwd">of</span> <span class="ide">ovNone</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">nil</span></div></div><div class="line"><div class="line-content">  <span class="ide">OuterObject</span> <span class="op">=</span> <span class="kwd">ref</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">variant</span> {<span class="op">.</span><span class="ide">bsonExport</span>, <span class="ide">bsonKey</span>: <span class="str">&quot;objectVariant&quot;</span><span class="op">.</span>}: <span class="ide">ObjectVariant</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># our Bson data</span></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">bov</span> <span class="op">=</span> <span class="ide">bson</span>({</div></div><div class="line"><div class="line-content">  <span class="ide">baseField</span>: <span class="str">&quot;this is base string&quot;</span>,</div></div><div class="line"><div class="line-content">  <span class="ide">baseInt</span>: <span class="num">3453</span>,</div></div><div class="line"><div class="line-content">  <span class="ide">kind</span>: <span class="str">&quot;ovMany&quot;</span>,</div></div><div class="line"><div class="line-content">  <span class="ide">manyField1</span>: <span class="str">&quot;example of ovMany&quot;</span>,</div></div><div class="line"><div class="line-content">  <span class="ide">intField</span>: <span class="num">42</span>,</div></div><div class="line"><div class="line-content">  <span class="ide">embed</span>: {</div></div><div class="line"><div class="line-content">    <span class="ide">truthy</span>: <span class="ide">true</span>,</div></div><div class="line"><div class="line-content">  },</div></div><div class="line"><div class="line-content">  <span class="ide">refembed</span>: {</div></div><div class="line"><div class="line-content">    <span class="ide">truthy</span>: <span class="ide">true</span>,</div></div><div class="line"><div class="line-content">  },</div></div><div class="line"><div class="line-content">})</div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">outb</span> <span class="op">=</span> <span class="ide">bson</span> { <span class="ide">objectVariant</span>: <span class="ide">bov</span> }</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># let&apos;s see if it&apos;s converted to OVKind ovMany</span></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">outer</span>: <span class="ide">OuterObject</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">objmany</span> <span class="op">=</span> <span class="ide">bov</span><span class="op">.</span><span class="ide">to</span> <span class="ide">ObjectVariant</span></div></div><div class="line"><div class="line-content"><span class="ide">outer</span> <span class="op">=</span> <span class="ide">outb</span><span class="op">.</span><span class="ide">to</span> <span class="ide">OuterObject</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">objmany</span><span class="op">.</span><span class="ide">kind</span> <span class="op">==</span> <span class="ide">ovMany</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">objmany</span><span class="op">.</span><span class="ide">baseField</span> <span class="op">==</span> <span class="ide">bov</span>[<span class="str">&quot;baseField&quot;</span>]</div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">objmany</span><span class="op">.</span><span class="ide">baseInt</span> <span class="op">==</span> <span class="ide">bov</span>[<span class="str">&quot;baseInt&quot;</span>]</div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">objmany</span><span class="op">.</span><span class="ide">embed</span><span class="op">.</span><span class="ide">truthy</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">objmany</span><span class="op">.</span><span class="ide">refembed</span><span class="op">.</span><span class="ide">truthy</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">objmany</span><span class="op">.</span><span class="ide">manyField1</span> <span class="op">==</span> <span class="ide">bov</span>[<span class="str">&quot;manyField1&quot;</span>]</div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">objmany</span><span class="op">.</span><span class="ide">intField</span> <span class="op">==</span> <span class="ide">bov</span>[<span class="str">&quot;intField&quot;</span>]</div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">outer</span><span class="op">.</span><span class="ide">variant</span><span class="op">.</span><span class="ide">kind</span> <span class="op">==</span> <span class="ide">ovMany</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">outer</span><span class="op">.</span><span class="ide">variant</span><span class="op">.</span><span class="ide">baseField</span> <span class="op">==</span> <span class="str">&quot;this is base string&quot;</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">outer</span><span class="op">.</span><span class="ide">variant</span><span class="op">.</span><span class="ide">baseInt</span> <span class="op">==</span> <span class="num">3453</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">outer</span><span class="op">.</span><span class="ide">variant</span><span class="op">.</span><span class="ide">baseEmbed</span><span class="op">.</span><span class="ide">isNil</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># let&apos;s change the kind to &quot;ovOne&quot;</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">onlyFieldMsg</span> <span class="op">=</span> <span class="str">&quot;this is dynamically added&quot;</span></div></div><div class="line"><div class="line-content"><span class="ide">bov</span>[<span class="str">&quot;kind&quot;</span>] <span class="op">=</span> <span class="str">&quot;ovOne&quot;</span></div></div><div class="line"><div class="line-content"><span class="ide">bov</span>[<span class="str">&quot;theOnlyField&quot;</span>] <span class="op">=</span> <span class="ide">onlyFieldMsg</span></div></div><div class="line"><div class="line-content"><span class="ide">outb</span><span class="op">.</span><span class="ide">mget</span>(<span class="str">&quot;objectVariant&quot;</span>)[<span class="str">&quot;kind&quot;</span>] <span class="op">=</span> <span class="str">&quot;ovOne&quot;</span></div></div><div class="line"><div class="line-content"><span class="ide">outb</span><span class="op">.</span><span class="ide">mget</span>(<span class="str">&quot;objectVariant&quot;</span>)[<span class="str">&quot;theOnlyField&quot;</span>] <span class="op">=</span> <span class="ide">onlyFieldMsg</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">objone</span> <span class="op">=</span> <span class="ide">bov</span><span class="op">.</span><span class="ide">to</span> <span class="ide">ObjectVariant</span></div></div><div class="line"><div class="line-content"><span class="ide">outer</span> <span class="op">=</span> <span class="ide">outb</span><span class="op">.</span><span class="ide">to</span> <span class="ide">OuterObject</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">objone</span><span class="op">.</span><span class="ide">kind</span> <span class="op">==</span> <span class="ide">ovOne</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">objone</span><span class="op">.</span><span class="ide">baseField</span> <span class="op">==</span> <span class="ide">bov</span>[<span class="str">&quot;baseField&quot;</span>]</div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">objone</span><span class="op">.</span><span class="ide">theOnlyField</span> <span class="op">==</span> <span class="str">&quot;this is dynamically added&quot;</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">outer</span><span class="op">.</span><span class="ide">variant</span><span class="op">.</span><span class="ide">kind</span> <span class="op">==</span> <span class="ide">ovOne</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">outer</span><span class="op">.</span><span class="ide">variant</span><span class="op">.</span><span class="ide">theOnlyField</span> <span class="op">==</span> <span class="ide">onlyFieldMsg</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># lastly, convert to &quot;ovNone&quot;</span></div></div><div class="line"><div class="line-content"><span class="ide">bov</span>[<span class="str">&quot;kind&quot;</span>] <span class="op">=</span> <span class="str">&quot;ovNone&quot;</span></div></div><div class="line"><div class="line-content"><span class="ide">outb</span><span class="op">.</span><span class="ide">mget</span>(<span class="str">&quot;objectVariant&quot;</span>)[<span class="str">&quot;kind&quot;</span>] <span class="op">=</span> <span class="str">&quot;ovNone&quot;</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">objnone</span> <span class="op">=</span> <span class="ide">bov</span><span class="op">.</span><span class="ide">to</span> <span class="ide">ObjectVariant</span></div></div><div class="line"><div class="line-content"><span class="ide">outer</span> <span class="op">=</span> <span class="ide">outb</span><span class="op">.</span><span class="ide">to</span> <span class="ide">OuterObject</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">objnone</span><span class="op">.</span><span class="ide">kind</span> <span class="op">==</span> <span class="ide">ovNone</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">outer</span><span class="op">.</span><span class="ide">variant</span><span class="op">.</span><span class="ide">kind</span> <span class="op">==</span> <span class="ide">ovNone</span></div></div>  </code></pre>
<p>  <a href="#table-of-content">TOC</a></p>
<h3>Convert with Custom Key Bson</h3>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># This example will show to extract a specific Bson key</span></div></div><div class="line"><div class="line-content"><span class="com"># check the test_bson_test.nim for elaborate bsonKey example</span></div></div><div class="line"><div class="line-content"><span class="com"># Available since v0.4.5</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">oids</span>, <span class="ide">times</span>, <span class="ide">macros</span></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">anonimongo</span><span class="op">/</span><span class="ide">core</span><span class="op">/</span><span class="ide">bson</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">type</span></div></div><div class="line"><div class="line-content">  <span class="ide">SimpleIntString</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">intfield</span> {<span class="op">.</span><span class="ide">bsonExport</span><span class="op">.</span>}: <span class="ide">int</span></div></div><div class="line"><div class="line-content">    <span class="ide">strfield</span><span class="op">*:</span> <span class="ide">string</span></div></div><div class="line"><div class="line-content">  <span class="ide">OidString</span> <span class="op">=</span> <span class="ide">string</span> <span class="com"># provided to enable our own custom conversion definition</span></div></div><div class="line"><div class="line-content">  <span class="ide">CustomObj</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="com"># we retrieve the same &quot;_id&quot; into `id` and `idStr` with</span></div></div><div class="line"><div class="line-content">    <span class="com"># `idStr` defined with specific conversion proc</span></div></div><div class="line"><div class="line-content">    <span class="ide">id</span> {<span class="op">.</span><span class="ide">bsonExport</span>, <span class="ide">bsonKey</span>: <span class="str">&quot;_id&quot;</span><span class="op">.</span>}: <span class="ide">Oid</span></div></div><div class="line"><div class="line-content">    <span class="ide">idStr</span> {<span class="op">.</span><span class="ide">bsonExport</span>, <span class="ide">bsonKey</span>: <span class="str">&quot;_id&quot;</span><span class="op">.</span>}: <span class="ide">OidString</span></div></div><div class="line"><div class="line-content">    <span class="ide">sis</span> {<span class="op">.</span><span class="ide">bsonExport</span>, <span class="ide">bsonKey</span>: <span class="str">&quot;sisEmbed&quot;</span><span class="op">.</span>}: <span class="ide">SimpleIntString</span></div></div><div class="line"><div class="line-content">    <span class="ide">currentTime</span> {<span class="op">.</span><span class="ide">bsonExport</span>, <span class="ide">bsonKey</span>: <span class="str">&quot;now&quot;</span><span class="op">.</span>}: <span class="ide">Time</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">ofOidString</span>(<span class="ide">b</span>: <span class="ide">BsonBase</span>): <span class="ide">OidString</span> <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;ofOidString is called&quot;</span></div></div><div class="line"><div class="line-content">  <span class="ide">result</span> <span class="op">=</span> <span class="op">$</span><span class="ide">b</span><span class="op">.</span><span class="ide">ofObjectId</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">bobj</span> <span class="op">=</span> <span class="ide">bson</span>({</div></div><div class="line"><div class="line-content">  <span class="str">&quot;_id&quot;</span>: <span class="ide">genOid</span>(),</div></div><div class="line"><div class="line-content">  <span class="ide">sisEmbed</span>: {</div></div><div class="line"><div class="line-content">    <span class="ide">intfield</span>: <span class="num">42</span>,</div></div><div class="line"><div class="line-content">    <span class="ide">strfield</span>: <span class="str">&quot;forthy two&quot;</span></div></div><div class="line"><div class="line-content">  },</div></div><div class="line"><div class="line-content">  <span class="ide">now</span>: <span class="ide">now</span>()<span class="op">.</span><span class="ide">toTime</span>,</div></div><div class="line"><div class="line-content">})</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">cobj</span>: <span class="ide">CustomObj</span></div></div><div class="line"><div class="line-content"><span class="ide">expandMacros</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">cobj</span> <span class="op">=</span> <span class="ide">bobj</span><span class="op">.</span><span class="ide">to</span> <span class="ide">CustomObj</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="op">$</span><span class="ide">cobj</span><span class="op">.</span><span class="ide">id</span> <span class="op">==</span> <span class="op">$</span><span class="ide">bobj</span>[<span class="str">&quot;_id&quot;</span>]<span class="op">.</span><span class="ide">ofObjectId</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">cobj</span><span class="op">.</span><span class="ide">idStr</span> <span class="op">==</span> <span class="op">$</span><span class="ide">bobj</span>[<span class="str">&quot;_id&quot;</span>]<span class="op">.</span><span class="ide">ofObjectId</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="op">$</span><span class="ide">cobj</span><span class="op">.</span><span class="ide">id</span> <span class="op">==</span> <span class="ide">cobj</span><span class="op">.</span><span class="ide">idStr</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">cobj</span><span class="op">.</span><span class="ide">sis</span><span class="op">.</span><span class="ide">strfield</span> <span class="op">==</span> <span class="ide">bobj</span>[<span class="str">&quot;sisEmbed&quot;</span>][<span class="str">&quot;strfield&quot;</span>]</div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">cobj</span><span class="op">.</span><span class="ide">currentTime</span> <span class="op">==</span> <span class="ide">bobj</span>[<span class="str">&quot;now&quot;</span>]</div></div>  </code></pre>
<p>  <a href="#table-of-content">TOC</a></p>
<h3>Convert Json Bson</h3>
<p>It&apos;s often so handy to work directly between Json and Bson. As currently, there&apos;s no direct support for
converting directly Json to Bson and vice versa. However this snippet example will come useful for generic
conversion between Json and Bson. This snippet example needs the Anonimongo since <code>v0.4.8</code>
(patch for working with <code>BsonArray</code>).</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">json</span>, <span class="ide">times</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">anonimongo</span><span class="op">/</span><span class="ide">core</span><span class="op">/</span><span class="ide">bson</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">jsonobj</span> <span class="op">=</span> <span class="op">%*</span>{</div></div><div class="line"><div class="line-content">  <span class="str">&quot;businessName&quot;</span>:<span class="str">&quot;TEST&quot;</span>,</div></div><div class="line"><div class="line-content">  <span class="str">&quot;businessZip&quot;</span>:<span class="str">&quot;55555&quot;</span>,</div></div><div class="line"><div class="line-content">  <span class="str">&quot;arr&quot;</span>: [<span class="num">1</span>, <span class="num">2</span>, <span class="num">3</span>, <span class="num">4</span>]</div></div><div class="line"><div class="line-content">}</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">toBson</span>(<span class="ide">j</span>: <span class="ide">JsonNode</span>): <span class="ide">BsonDocument</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">convertElem</span>(<span class="ide">v</span>: <span class="ide">JsonNode</span>): <span class="ide">BsonBase</span> <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="kwd">case</span> <span class="ide">v</span><span class="op">.</span><span class="ide">kind</span></div></div><div class="line"><div class="line-content">  <span class="kwd">of</span> <span class="ide">JInt</span>: <span class="ide">result</span> <span class="op">=</span> <span class="ide">v</span><span class="op">.</span><span class="ide">getInt</span></div></div><div class="line"><div class="line-content">  <span class="kwd">of</span> <span class="ide">JString</span>: <span class="ide">result</span> <span class="op">=</span> <span class="ide">v</span><span class="op">.</span><span class="ide">getStr</span></div></div><div class="line"><div class="line-content">  <span class="kwd">of</span> <span class="ide">JFloat</span>: <span class="ide">result</span> <span class="op">=</span> <span class="ide">v</span><span class="op">.</span><span class="ide">getFloat</span></div></div><div class="line"><div class="line-content">  <span class="kwd">of</span> <span class="ide">JObject</span>: <span class="ide">result</span> <span class="op">=</span> <span class="ide">v</span><span class="op">.</span><span class="ide">toBson</span></div></div><div class="line"><div class="line-content">  <span class="kwd">of</span> <span class="ide">JBool</span>: <span class="ide">result</span> <span class="op">=</span> <span class="ide">v</span><span class="op">.</span><span class="ide">getBool</span></div></div><div class="line"><div class="line-content">  <span class="kwd">of</span> <span class="ide">JNull</span>: <span class="ide">result</span> <span class="op">=</span> <span class="ide">bsonNull</span>()</div></div><div class="line"><div class="line-content">  <span class="kwd">of</span> <span class="ide">JArray</span>:</div></div><div class="line"><div class="line-content">    <span class="kwd">var</span> <span class="ide">arrval</span> <span class="op">=</span> <span class="ide">bsonArray</span>()</div></div><div class="line"><div class="line-content">    <span class="kwd">for</span> <span class="ide">elem</span> <span class="kwd">in</span> <span class="ide">v</span>:</div></div><div class="line"><div class="line-content">      <span class="ide">arrval</span><span class="op">.</span><span class="ide">add</span> <span class="ide">elem</span><span class="op">.</span><span class="ide">convertElem</span></div></div><div class="line"><div class="line-content">    <span class="ide">result</span> <span class="op">=</span> <span class="ide">arrval</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">toBson</span>(<span class="ide">j</span>: <span class="ide">JsonNode</span>): <span class="ide">BsonDocument</span> <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="ide">result</span> <span class="op">=</span> <span class="ide">bson</span>()</div></div><div class="line"><div class="line-content">  <span class="kwd">for</span> <span class="ide">k</span>, <span class="ide">v</span> <span class="kwd">in</span> <span class="ide">j</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">result</span>[<span class="ide">k</span>] <span class="op">=</span> <span class="ide">v</span><span class="op">.</span><span class="ide">convertElem</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">bobj</span> <span class="op">=</span> <span class="ide">jsonobj</span><span class="op">.</span><span class="ide">toBson</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">bobj</span>[<span class="str">&quot;businessName&quot;</span>] <span class="op">==</span> <span class="ide">jsonobj</span>[<span class="str">&quot;businessName&quot;</span>]<span class="op">.</span><span class="ide">getStr</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">bobj</span>[<span class="str">&quot;businessZip&quot;</span>] <span class="op">==</span> <span class="ide">jsonobj</span>[<span class="str">&quot;businessZip&quot;</span>]<span class="op">.</span><span class="ide">getStr</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">bobj</span>[<span class="str">&quot;arr&quot;</span>]<span class="op">.</span><span class="ide">len</span> <span class="op">==</span> <span class="ide">jsonobj</span>[<span class="str">&quot;arr&quot;</span>]<span class="op">.</span><span class="ide">len</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">toJson</span>(<span class="ide">b</span>: <span class="ide">BsonDocument</span>): <span class="ide">JsonNode</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">convertElem</span>(<span class="ide">v</span>: <span class="ide">BsonBase</span>): <span class="ide">JsonNode</span> <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="kwd">case</span> <span class="ide">v</span><span class="op">.</span><span class="ide">kind</span></div></div><div class="line"><div class="line-content">  <span class="kwd">of</span> <span class="ide">bkInt32</span>, <span class="ide">bkInt64</span>: <span class="ide">result</span> <span class="op">=</span> <span class="ide">newJInt</span> <span class="ide">v</span><span class="op">.</span><span class="ide">ofInt</span></div></div><div class="line"><div class="line-content">  <span class="kwd">of</span> <span class="ide">bkString</span>: <span class="ide">result</span> <span class="op">=</span> <span class="ide">newJString</span> <span class="ide">v</span><span class="op">.</span><span class="ide">ofString</span></div></div><div class="line"><div class="line-content">  <span class="kwd">of</span> <span class="ide">bkBinary</span>: <span class="ide">result</span> <span class="op">=</span> <span class="ide">newJString</span> <span class="ide">v</span><span class="op">.</span><span class="ide">ofBinary</span><span class="op">.</span><span class="ide">stringbytes</span></div></div><div class="line"><div class="line-content">  <span class="kwd">of</span> <span class="ide">bkBool</span>: <span class="ide">result</span> <span class="op">=</span> <span class="ide">newJBool</span> <span class="ide">v</span><span class="op">.</span><span class="ide">ofBool</span></div></div><div class="line"><div class="line-content">  <span class="kwd">of</span> <span class="ide">bkDouble</span>: <span class="ide">result</span> <span class="op">=</span> <span class="ide">newJFloat</span> <span class="ide">v</span><span class="op">.</span><span class="ide">ofDouble</span></div></div><div class="line"><div class="line-content">  <span class="kwd">of</span> <span class="ide">bkEmbed</span>: <span class="ide">result</span> <span class="op">=</span> <span class="ide">v</span><span class="op">.</span><span class="ide">ofEmbedded</span><span class="op">.</span><span class="ide">toJson</span></div></div><div class="line"><div class="line-content">  <span class="kwd">of</span> <span class="ide">bkNull</span>: <span class="ide">result</span> <span class="op">=</span> <span class="ide">newJNull</span>()</div></div><div class="line"><div class="line-content">  <span class="kwd">of</span> <span class="ide">bkTime</span>: <span class="ide">result</span> <span class="op">=</span> <span class="ide">newJString</span> <span class="op">$</span><span class="ide">v</span><span class="op">.</span><span class="ide">ofTime</span></div></div><div class="line"><div class="line-content">  <span class="kwd">of</span> <span class="ide">bkArray</span>:</div></div><div class="line"><div class="line-content">    <span class="kwd">var</span> <span class="ide">jarray</span> <span class="op">=</span> <span class="ide">newJArray</span>()</div></div><div class="line"><div class="line-content">    <span class="kwd">for</span> <span class="ide">elem</span> <span class="kwd">in</span> <span class="ide">v</span><span class="op">.</span><span class="ide">ofArray</span>:</div></div><div class="line"><div class="line-content">      <span class="ide">jarray</span><span class="op">.</span><span class="ide">add</span> <span class="ide">elem</span><span class="op">.</span><span class="ide">convertElem</span></div></div><div class="line"><div class="line-content">    <span class="ide">result</span> <span class="op">=</span> <span class="ide">jarray</span></div></div><div class="line"><div class="line-content">  <span class="kwd">else</span>:</div></div><div class="line"><div class="line-content">    <span class="kwd">discard</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">toJson</span>(<span class="ide">b</span>: <span class="ide">BsonDocument</span>): <span class="ide">JsonNode</span> <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="ide">result</span> <span class="op">=</span> <span class="ide">newJObject</span>()</div></div><div class="line"><div class="line-content">  <span class="kwd">for</span> <span class="ide">k</span>, <span class="ide">v</span> <span class="kwd">in</span> <span class="ide">b</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">result</span>[<span class="ide">k</span>] <span class="op">=</span> <span class="ide">v</span><span class="op">.</span><span class="ide">convertElem</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">jobj</span> <span class="op">=</span> <span class="ide">bobj</span><span class="op">.</span><span class="ide">toJson</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">jobj</span>[<span class="str">&quot;businessName&quot;</span>]<span class="op">.</span><span class="ide">getStr</span> <span class="op">==</span> <span class="ide">jsonobj</span>[<span class="str">&quot;businessName&quot;</span>]<span class="op">.</span><span class="ide">getStr</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">jobj</span>[<span class="str">&quot;businessZip&quot;</span>]<span class="op">.</span><span class="ide">getStr</span> <span class="op">==</span> <span class="ide">jsonobj</span>[<span class="str">&quot;businessZip&quot;</span>]<span class="op">.</span><span class="ide">getStr</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">jobj</span>[<span class="str">&quot;arr&quot;</span>]<span class="op">.</span><span class="ide">len</span> <span class="op">==</span> <span class="ide">jsonobj</span>[<span class="str">&quot;arr&quot;</span>]<span class="op">.</span><span class="ide">len</span></div></div>  </code></pre>
<p>Above example we convert the <code>jsonobj</code> (<code>JsonNode</code>) to <code>bobj</code> (<code>BsonDocument</code>)
and convert again from <code>bobj</code> to <code>jobj</code> (<code>JsonNode</code>). This should be useful
for most cases of working with Bson and Json.</p>
<p>  <a href="#table-of-content">TOC</a></p>
<h3>Watching a collection</h3>
<p>This example is the example of changeStream operation. In this example we will
watch a collection and print the change to the console. It will stop when
there&apos;s <code>delete</code> or collection <code>drop</code> operation.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">sugar</span></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">anonimongo</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com">## watching feature can only be done to the replica set Mongodb server so users</span></div></div><div class="line"><div class="line-content"><span class="com">## need to run the available replica set first</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">main</span> <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="kwd">var</span> <span class="ide">mongo</span> <span class="op">=</span> <span class="ide">newMongo</span>[<span class="ide">AsyncSocket</span>](</div></div><div class="line"><div class="line-content">    <span class="ide">MongoUri</span> <span class="str">&quot;mongodb://localhost:27018,localhost:27019,localhost27020/admin&quot;</span></div></div><div class="line"><div class="line-content">    <span class="ide">poolconn</span> <span class="op">=</span> <span class="num">2</span>)</div></div><div class="line"><div class="line-content">  <span class="kwd">defer</span>: <span class="ide">close</span> <span class="ide">mongo</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="kwd">if</span> <span class="kwd">not</span> <span class="ide">waitfor</span> <span class="ide">mongo</span><span class="op">.</span><span class="ide">connect</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;failed to connect, quit&quot;</span></div></div><div class="line"><div class="line-content">    <span class="kwd">return</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="kwd">var</span> <span class="ide">cursor</span>: <span class="ide">Cursor</span></div></div><div class="line"><div class="line-content">  <span class="kwd">let</span> <span class="ide">db</span> <span class="op">=</span> <span class="ide">mongo</span>[<span class="str">&quot;temptest&quot;</span>]</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="com"># we are create the collection explicitly</span></div></div><div class="line"><div class="line-content">  <span class="ide">dump</span> <span class="ide">waitfor</span> <span class="ide">db</span><span class="op">.</span><span class="ide">create</span>(<span class="str">&quot;templog&quot;</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="com"># the namespace will be `temptest.templog`</span></div></div><div class="line"><div class="line-content">  <span class="kwd">let</span> <span class="ide">coll</span> <span class="op">=</span> <span class="ide">db</span>[<span class="str">&quot;templog&quot;</span>]</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="com"># we try to watch the collection, there&apos;s possible error</span></div></div><div class="line"><div class="line-content">  <span class="com"># for example the collection is not in replica set database,</span></div></div><div class="line"><div class="line-content">  <span class="com"># or the invalid options, in this example we simply do nothing</span></div></div><div class="line"><div class="line-content">  <span class="com"># to handle the error except printing it out to the screen</span></div></div><div class="line"><div class="line-content">  <span class="kwd">try</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">cursor</span> <span class="op">=</span> <span class="ide">waitfor</span> <span class="ide">coll</span><span class="op">.</span><span class="ide">watch</span>()</div></div><div class="line"><div class="line-content">  <span class="kwd">except</span> <span class="ide">MongoError</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;cannot watch the cursor&quot;</span></div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="ide">getCurrentExceptionMsg</span>()</div></div><div class="line"><div class="line-content">    <span class="kwd">return</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="kwd">var</span> <span class="ide">lastChange</span>: <span class="ide">ChangeStream</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="com"># we define our callback for how we&apos;re going to handle it,</span></div></div><div class="line"><div class="line-content">  <span class="com"># in this example we dump the change info to the screen</span></div></div><div class="line"><div class="line-content">  <span class="com"># and using the closure to assign the value to the</span></div></div><div class="line"><div class="line-content">  <span class="com"># `lastChange` variable</span></div></div><div class="line"><div class="line-content">  <span class="com"># With `stopWhen = {csDelete, csDrop}`, the loop of watch</span></div></div><div class="line"><div class="line-content">  <span class="com"># will break when there&apos;s delete operation or the collection</span></div></div><div class="line"><div class="line-content">  <span class="com"># is dropped.</span></div></div><div class="line"><div class="line-content">  <span class="com"># note that in the current example, we just only want to</span></div></div><div class="line"><div class="line-content">  <span class="com"># watch the collection so we `waitFor` it to end, in case</span></div></div><div class="line"><div class="line-content">  <span class="com"># we want to do the other thing we can run the `cursor.forEach`</span></div></div><div class="line"><div class="line-content">  <span class="com"># in the background.</span></div></div><div class="line"><div class="line-content">  <span class="ide">waitFor</span> <span class="ide">cursor</span><span class="op">.</span><span class="ide">forEach</span>(</div></div><div class="line"><div class="line-content">    <span class="kwd">proc</span>(<span class="ide">cs</span>: <span class="ide">ChangeStream</span>) <span class="op">=</span> <span class="ide">dump</span> <span class="ide">cs</span>; <span class="ide">lastChange</span> <span class="op">=</span> <span class="ide">cs</span>,</div></div><div class="line"><div class="line-content">    <span class="ide">stopWhen</span> <span class="op">=</span> {<span class="ide">csDelete</span>, <span class="ide">csDrop</span>})</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">dump</span> <span class="ide">lastChange</span></div></div><div class="line"><div class="line-content">  <span class="com">#doAssert lastChange.operationType == csDelete</span></div></div><div class="line"><div class="line-content">  <span class="ide">dump</span> <span class="ide">waitfor</span> <span class="ide">coll</span><span class="op">.</span><span class="ide">drop</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">main</span>()</div></div>  </code></pre>
<p>  <a href="#table-of-content">TOC</a></p>
<h3>Todolist App</h3>
<p>Head over to <a href="examples/todolist">Todolist Example</a>.</p>
<h3>Upload-file</h3>
<p>Check <a href="examples/uploadfile">Upload-file Example</a>.</p>
<h3>Benchmark Examples</h3>
<p>Various examples while measuring <a href="examples/benchmark">here</a>.</p>
<p>  <a href="#table-of-content">TOC</a></p>
<h2>Working with Bson</h2>
<p>Bson module has some functionalities to convert to and from the Object. However there are
some points to be aware:</p>
<ol>
<li>
<p>The <code>to</code> macro is working exlusively converting object typedesc converting basic types already
supplied with <code>ofType</code> (with <code>Type</code> is <code>Int|Int32|Int64|Double|String|Time|Embedded|ObjectId</code>).</p>
</li>
<li>
<p>User can provide the custom proc, func, or converter with pattern of <code>of{Typename}</code> which
accepting a <code>BsonBase</code> and return <code>Typename</code>. For example:</p>
</li>
</ol>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">macros</span></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">anonimongo</span><span class="op">/</span><span class="ide">core</span><span class="op">/</span><span class="ide">bson</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">type</span></div></div><div class="line"><div class="line-content">  <span class="ide">Embedtion</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">embedfield</span><span class="op">*:</span> <span class="ide">int</span></div></div><div class="line"><div class="line-content">    <span class="ide">embedstat</span><span class="op">*:</span> <span class="ide">string</span></div></div><div class="line"><div class="line-content">    <span class="ide">wasProcInvoked</span>: <span class="ide">bool</span></div></div><div class="line"><div class="line-content">  <span class="ide">SimpleEmbedObject</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">intfield</span><span class="op">*:</span> <span class="ide">int</span></div></div><div class="line"><div class="line-content">    <span class="ide">strfield</span><span class="op">*:</span> <span class="ide">string</span></div></div><div class="line"><div class="line-content">    <span class="ide">embed</span><span class="op">*:</span> <span class="ide">Embedtion</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">ofEmbedtion</span>(<span class="ide">b</span>: <span class="ide">BsonBase</span>): <span class="ide">Embedtion</span> <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="kwd">let</span> <span class="ide">embed</span> <span class="op">=</span> <span class="ide">b</span><span class="op">.</span><span class="ide">ofEmbedded</span></div></div><div class="line"><div class="line-content">  <span class="ide">result</span><span class="op">.</span><span class="ide">embedfield</span> <span class="op">=</span> <span class="ide">embed</span>[<span class="str">&quot;embedfield&quot;</span>]</div></div><div class="line"><div class="line-content">  <span class="ide">result</span><span class="op">.</span><span class="ide">embedstat</span> <span class="op">=</span> <span class="ide">embed</span>[<span class="str">&quot;embedstat&quot;</span>]</div></div><div class="line"><div class="line-content">  <span class="ide">result</span><span class="op">.</span><span class="ide">wasProcInvoked</span> <span class="op">=</span> <span class="ide">true</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">bsimple</span> <span class="op">=</span> <span class="ide">bson</span>({</div></div><div class="line"><div class="line-content">  <span class="ide">intfield</span>: <span class="num">42</span>,</div></div><div class="line"><div class="line-content">  <span class="ide">strfield</span>: <span class="str">&quot;that&apos;s 42&quot;</span>,</div></div><div class="line"><div class="line-content">  <span class="ide">embed</span>: {</div></div><div class="line"><div class="line-content">    <span class="ide">embedfield</span>: <span class="num">42</span>,</div></div><div class="line"><div class="line-content">    <span class="ide">embedstat</span>: <span class="str">&quot;42&quot;</span>,</div></div><div class="line"><div class="line-content">  },</div></div><div class="line"><div class="line-content">})</div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">simple</span>: <span class="ide">SimpleEmbedObject</span></div></div><div class="line"><div class="line-content"><span class="ide">expandMacros</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">simple</span> <span class="op">=</span> <span class="ide">bsimple</span><span class="op">.</span><span class="ide">to</span> <span class="ide">SimpleEmbedObject</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">simple</span><span class="op">.</span><span class="ide">intfield</span> <span class="op">==</span> <span class="num">42</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">simple</span><span class="op">.</span><span class="ide">strfield</span> <span class="op">==</span> <span class="str">&quot;that&apos;s 42&quot;</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">simple</span><span class="op">.</span><span class="ide">embed</span><span class="op">.</span><span class="ide">embedfield</span> <span class="op">==</span> <span class="num">42</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">simple</span><span class="op">.</span><span class="ide">embed</span><span class="op">.</span><span class="ide">embedstat</span> <span class="op">==</span> <span class="str">&quot;42&quot;</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">simple</span><span class="op">.</span><span class="ide">embed</span><span class="op">.</span><span class="ide">wasProcInvoked</span></div></div>  </code></pre>
<p>Note that the conversion <code>to</code> <code>SimpleEmbedObject</code> with <code>ofSimpleEmbedObject</code> custom proc,
func, or converter isn&apos;t checked as it becomes meaningless to use <code>to</code> macro
when the user can simply calling it directly. So any most outer type won&apos;t check whether
the user provides <code>of{MostOuterTypename}</code> implementation or not.</p>
<ol start="3">
<li>
<p>Auto Bson to Type conversion can only be done to the fields that are exported or
has custom pragma <code>bsonExport</code> as shown in this <a href="#convert-from-bson-to-object-variant">example</a>.</p>
</li>
<li>
<p>~It potentially breaks when there&apos;s some arbitrary hierarchy of types definition. While it can handle
any deep of <code>distinct</code> types (that&apos;s distinct of distinct of distinct of .... of Type), but this</p>
</li>
</ol>
<p>should be indication of some broken type definition and better be remedied from
the type design itself. If user thinks otherwise, please report this issue with the example code.~<br />
As with v2 of <code>to</code> macro, the conversion of arbitrary <code>ref</code> and <code>distinct</code> is supported. It cannot support the
<code>ref distinct Type</code> as it&apos;s not making any sense but it supports the <code>distinct ref Type</code>. Please report the issue
if user finds the otherwise.</p>
<ol start="5">
<li>
<p>In case the user wants to persist with the current definition of any custom deep of <code>distinct</code> type,
user should define the custom mechanism mentioned in point #1 above.</p>
</li>
<li>
<p>With <code>v0.4.5</code>, users are able to extract custom Bson key to map with specific field name by supplying the pragma
<code>bsonKey</code> e.g. <code>{.bsonKey: &quot;theBsonKey&quot;.}</code>. Refer to the example <a href="#convert-with-custom-key-bson">above</a>. The key is <strong>case-sensitive</strong>.</p>
</li>
<li>
<p><code>to</code> macro doesn&apos;t support for cyclic object types.</p>
</li>
<li>
<p>As mentioned in point #1, the <code>to</code> macro is working exclusively converting the defined object type. As
pointed out that here, <a href="https://github.com/mashingan/anonimongo/issues/10">issue/10</a>, <code>to</code> make it generic, it&apos;s</p>
</li>
</ol>
<p>reasonable for uniformed <code>to</code> convert any <code>typedesc</code>. Because the <code>ofType</code> variants for basic types are implemented
as <code>converters</code>, it&apos;s easy for user to supply the <code>to</code> overload:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">template</span> <span class="ide">to</span>(<span class="ide">b</span>: <span class="ide">BsonBase</span>, <span class="ide">name</span>: <span class="ide">typedesc</span>): <span class="ide">untyped</span> <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="kwd">var</span> <span class="ide">r</span>: <span class="ide">name</span> <span class="op">=</span> <span class="ide">b</span></div></div><div class="line"><div class="line-content">  <span class="ide">move</span> <span class="ide">r</span></div></div>  </code></pre>
<p>There&apos;s no plan to add this snippet to the library but it maybe changed in later version.</p>
<ol start="9">
<li>Any form of field type <code>Option[T]</code> is ignored. Refer to point #2 (defining the users <code>ofTypename</code>)
to support automatic conversion. For example, the Bson field we received can have <code>int</code> or <code>null</code> so</li>
</ol>
<p>we implement it:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">type</span></div></div><div class="line"><div class="line-content">  <span class="com"># note that we need an intermediate alias type name as `to` only knows</span></div></div><div class="line"><div class="line-content">  <span class="com"># the symbol for custom proc conversion.</span></div></div><div class="line"><div class="line-content">  <span class="ide">OptionalInt</span> <span class="op">=</span> <span class="ide">Option</span>[<span class="ide">int</span>]</div></div><div class="line"><div class="line-content">  <span class="ide">TheObj</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">optint</span> {<span class="op">.</span><span class="ide">bsonExport</span><span class="op">.</span>}: <span class="ide">OptionalInt</span></div></div><div class="line"><div class="line-content">    <span class="ide">optstr</span> {<span class="op">.</span><span class="ide">bsonExport</span><span class="op">.</span>}: <span class="ide">Option</span>[<span class="ide">string</span>]</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">intexist</span> <span class="op">=</span> <span class="ide">bson</span> {</div></div><div class="line"><div class="line-content">  <span class="ide">optint</span>: <span class="num">42</span>,</div></div><div class="line"><div class="line-content">  <span class="ide">optstr</span>: <span class="str">&quot;this will be ignored&quot;</span>,</div></div><div class="line"><div class="line-content">}</div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">intnull</span> <span class="op">=</span> <span class="ide">bson</span> {</div></div><div class="line"><div class="line-content">  <span class="ide">optint</span>: <span class="ide">bsonNull</span>(),</div></div><div class="line"><div class="line-content">  <span class="ide">optstr</span>: <span class="str">&quot;not converted&quot;</span>,</div></div><div class="line"><div class="line-content">}</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">ofOptionalInt</span>(<span class="ide">b</span>: <span class="ide">BsonBase</span>): <span class="ide">Option</span>[<span class="ide">int</span>] <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="kwd">if</span> <span class="ide">b</span><span class="op">.</span><span class="ide">kind</span> <span class="op">==</span> <span class="ide">bkInt32</span>: <span class="ide">result</span> <span class="op">=</span> <span class="ide">some</span> <span class="ide">b</span><span class="op">.</span><span class="ide">ofInt</span></div></div><div class="line"><div class="line-content">  <span class="kwd">else</span>: <span class="ide">result</span> <span class="op">=</span> <span class="ide">none</span>[<span class="ide">int</span>]()</div></div><div class="line"><div class="line-content">  <span class="com"># or we can</span></div></div><div class="line"><div class="line-content">  <span class="com"># elif b.kind == bkNull: result = none[int]()</span></div></div><div class="line"><div class="line-content">  <span class="com"># just for clarity that it can have BsonInt32 or BsonNull</span></div></div><div class="line"><div class="line-content">  <span class="com"># as its value from Bson</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span></div></div><div class="line"><div class="line-content">  <span class="ide">haveint</span> <span class="op">=</span> <span class="ide">intexist</span><span class="op">.</span><span class="ide">to</span> <span class="ide">TheObj</span></div></div><div class="line"><div class="line-content">  <span class="ide">noint</span> <span class="op">=</span> <span class="ide">intnull</span><span class="op">.</span><span class="ide">to</span> <span class="ide">TheObj</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">haveint</span><span class="op">.</span><span class="ide">optint</span><span class="op">.</span><span class="ide">isSome</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">haveint</span><span class="op">.</span><span class="ide">optint</span><span class="op">.</span><span class="ide">get</span> <span class="op">==</span> <span class="num">42</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">haveint</span><span class="op">.</span><span class="ide">optstr</span><span class="op">.</span><span class="ide">isNone</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">noint</span><span class="op">.</span><span class="ide">optint</span><span class="op">.</span><span class="ide">isNone</span></div></div><div class="line"><div class="line-content"><span class="ide">doAssert</span> <span class="ide">noint</span><span class="op">.</span><span class="ide">optstr</span><span class="op">.</span><span class="ide">isNone</span></div></div>  </code></pre>
<ol start="10">
<li>
<p>Conversion to generic object and generic field type are not tested. Very likely it will break
the whole <code>to</code> conversion.</p>
</li>
<li>
<p>Object fields conversion doesn&apos;t support when the fields are grouped together, for example:</p>
</li>
</ol>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">type</span></div></div><div class="line"><div class="line-content">  <span class="ide">SStr</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">ss1</span><span class="op">*</span>, <span class="ide">ss2</span><span class="op">*:</span> <span class="ide">string</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">SOkay</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">ss1</span><span class="op">*:</span> <span class="ide">string</span></div></div><div class="line"><div class="line-content">    <span class="ide">ss2</span><span class="op">*:</span> <span class="ide">string</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">bstr</span> <span class="op">=</span> <span class="ide">bson</span> {</div></div><div class="line"><div class="line-content">  <span class="ide">ss1</span>: <span class="str">&quot;string 1&quot;</span>,</div></div><div class="line"><div class="line-content">  <span class="ide">ss2</span>: <span class="str">&quot;string 2&quot;</span>,</div></div><div class="line"><div class="line-content">}</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># The compiler will complain that &quot;node&quot; has no type.</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">sstr</span> <span class="op">=</span> <span class="ide">bstr</span><span class="op">.</span><span class="ide">to</span> <span class="ide">SStr</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># This works because the `ss1` and `ss2` aren&apos;t grouped together</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">sokay</span> <span class="op">=</span> <span class="ide">bstr</span><span class="op">.</span><span class="ide">to</span> <span class="ide">SOkay</span></div></div>  </code></pre>
<p>Since each field can have differents pragma definition, it&apos;s always preferable to define
each field as its own.</p>
<p>  <a href="#table-of-content">TOC</a></p>
<h2>Install</h2>
<p>Anonimongo requires minimum Nim version of <code>v1.4.0</code>.</p>
<p>For installation, we can choose several methods will be mentioned below.</p>
<p>Using Nimble package:</p>
<pre>  <code>nimble install anonimongo
</code></pre>
<p>Or to install it locally</p>
<pre>  <code>git clone https://github.com/mashingan/anonimongo
cd anonimongo
nimble develop
</code></pre>
<p>or directly from Github repo</p>
<pre>  <code>nimble install https://github.com/mashingan/anonimongo 
</code></pre>
<p>to install the <code>#head</code> branch</p>
<pre>  <code>nimble install https://github.com/mashingan/anonimongo@#head
#or
nimble install anonimongo@#head
</code></pre>
<p>The code in <code>#head</code> is always in tagged version. Untagged <code>#head</code> master branch
is usually only changes in something unrelated to the code itself.</p>
<h3>For dependency</h3>
<pre>  <code>requires &quot;anonimongo&quot;
</code></pre>
<p>or directly from Github repo</p>
<pre>  <code>requires &quot;https://github.com/mashingan/anonimongo&quot;
</code></pre>
<p>  <a href="#table-of-content">TOC</a></p>
<h2>Implemented APIs</h2>
<p>This implemented APIs for Mongo from <a href="https://docs.mongodb.com/manual/reference/command/">Mongo reference manual</a>
and <a href="https://github.com/mongodb/specifications">mongo spec</a>.</p>
<h3>Features connection</h3>
<ul>
<li>:heavy_check_mark: Driver for Mongo 6 and up</li>
<li>:heavy_check_mark: URI connect</li>
<li>:heavy_check_mark: Multiquery on URI connect</li>
<li>:heavy_check_mark: Multihost on URI connect</li>
<li>:white_square_button: Multihost on simple connect</li>
<li>:heavy_check_mark: SSL/TLS connection</li>
<li>:heavy_check_mark: SCRAM-SHA-1 authentication</li>
<li>:heavy_check_mark: SCRAM-SHA-256 authentication</li>
<li>:heavy_check_mark: <code>isMaster</code> connection</li>
<li>:heavy_check_mark: <code>TailableCursor</code> connection</li>
<li>:heavy_check_mark: <code>SlaveOk</code> operations</li>
<li>:heavy_check_mark: Compression connection</li>
<li>:heavy_check_mark: Retryable writes</li>
<li>:white_square_button: Retryable reads</li>
<li>:white_square_button: Sessions</li>
</ul>
<h3>Features commands</h3>
<h4>:white_check_mark: Aggregation commands 4/4 <a href="https://docs.mongodb.com/manual/reference/command/nav-aggregation/">Mongo doc</a> <a href="src/anonimongo/dbops/aggregation.nim">Anonimongo module</a></h4>
<ul>
<li>:heavy_check_mark: <code>aggregate</code> (collection procs: <a href="/src/anonimongo/collections.nim#L289">  <code>aggregate</code></a>)</li>
<li>:heavy_check_mark: <code>count</code> (collection procs: <a href="/src/anonimongo.collections.nim#L236">  <code>count</code></a>)</li>
<li>:heavy_check_mark: <code>distinct</code> (collection procs: <a href="/src/anonimongo.collections.nim#L273">  <code>distinct</code></a>)</li>
<li>:heavy_check_mark: <code>mapReduce</code> (db procs: <a href="/src/anonimongo/dbops/aggregation.nim#L81">  <code>mapReduce</code></a>)</li>
</ul>
<h4>:white_check_mark: Geospatial command 1/1 <a href="https://docs.mongodb.com/manual/reference/command/nav-geospatial/">Mongo doc</a> <a href="src/anonimongo/dbops/geospatial.nim#L109">Anonimongo module</a></h4>
<ul>
<li>:heavy_check_mark: <code>geoSearch</code> (db procs: <a href="/src/anonimongo/dbops/aggregation.nim#L110">  <code>geoSearch</code></a>)</li>
</ul>
<h4>:white_check_mark: Query and write operations commands 7/7 (<del>8</del>) <a href="https://docs.mongodb.com/manual/reference/command/nav-crud/">Mongo doc</a> <a href="src/anonimongo/dbops/crud.nim">Anonimongo module</a></h4>
<ul>
<li>:heavy_check_mark: <code>delete</code> (collection procs: <a href="/src/anonimongo/collections.nim#L167">  <code>remove</code></a>, <a href="/src/anonimongo/collections.nim#L179">  <code>remove</code></a>, <a href="/src/anonimongo/collections.nim#L199">  <code>remove</code></a>)</li>
<li>:heavy_check_mark: <code>find</code> (collection procs: <a href="/src/anonimongo/collections.nim#L99">  <code>find</code></a>, <a href="/src/anonimongo/collections.nim#L103">  <code>findOne</code></a>, <a href="/src/anonimongo/collections.nim#L109">  <code>findAll</code></a>, <a href="/src/anonimongo/collections.nim#L116">  <code>findIter</code></a>)</li>
<li>:heavy_check_mark: <code>findAndModify</code> (collection procs: <a href="/src/anonimongo/collections.nim#L122">  <code>findAndModify</code></a>)</li>
<li>:heavy_check_mark: <code>getMore</code> (db procs: <a href="/src/anonimongo/dbops/crud.nim#L73">  <code>getMore</code></a>)</li>
<li>:heavy_check_mark: <code>insert</code> (collection procs: <a href="/src/anonimongo/collections.nim#L211">  <code>insert</code></a>)</li>
<li>:heavy_check_mark: <code>update</code> (collection procs: <a href="/src/anonimongo/collections.nim#L143">  <code>update</code></a>)</li>
<li>:heavy_check_mark: <code>getLastError</code> (db procs: <a href="/src/anonimongo/dbops/crud.nim#L147">  <code>getLastError</code></a>)</li>
<li>:white_square_button: <code>resetError</code> (deprecated)</li>
</ul>
<h4>:x: Query plan cache commands 0/6 <a href="https://docs.mongodb.com/manual/reference/command/nav-plan-cache/">Mongo doc</a> <del>Anonimongo module</del></h4>
<ul>
<li>:white_square_button: <code>planCacheClear</code></li>
<li>:white_square_button: <code>planCacheClearFilters</code></li>
<li>:white_square_button: <code>planCacheListFilters</code></li>
<li>:white_square_button: <code>planCacheListPlans</code></li>
<li>:white_square_button: <code>planCacheListQueryShapes</code></li>
<li>:white_square_button: <code>planCacheSetFilter</code></li>
</ul>
<h4>:ballot_box_with_check: Database operations commands 1/3 <a href="https://docs.mongodb.com/manual/reference/command/nav-authentication/">Mongo doc</a> <a href="src/anonimongo/core/types.nim#L511">Anonimongo module</a></h4>
<ul>
<li>:heavy_check_mark: <code>authenticate</code>, implemented as Mongo proc. (<a href="src/anonimongo/core/types.nim#L509">  <code>authenticate</code></a>, <a href="src/anonimongo/core/types.nim#L517">  <code>authenticate</code></a>)</li>
<li>:white_square_button: <code>getnonce</code></li>
<li>:white_square_button: <code>logout</code></li>
</ul>
<h4>:white_check_mark: User management commands 7/7 <a href="https://docs.mongodb.com/manual/reference/command/nav-user-management/">Mongo doc</a> <a href="src/anonimongo/dbops/client.nim">Anonimongo module</a></h4>
<ul>
<li>:heavy_check_mark: <code>createUser</code> (db procs: <a href="/src/anonimongo/dbops/client.nim#L162">  <code>createUser</code></a>)</li>
<li>:heavy_check_mark: <code>dropAllUsersFromDatabase</code> (db:procs <a href="/src/anonimongo/dbops/client.nim#L196">  <code>dropAllUsersFromDatabase</code></a>)</li>
<li>:heavy_check_mark: <code>dropUser</code> (db procs: <a href="/src/anonimongo/dbops/client.nim#L218">  <code>dropUser</code></a>)</li>
<li>:heavy_check_mark: <code>grantRolesToUser</code> (db procs: <a href="/src/anonimongo/dbops/client.nim#L231">  <code>grantRolesToUser</code></a>)</li>
<li>:heavy_check_mark: <code>revokeRolesFromUser</code> (db procs: <a href="/src/anonimongo/dbops/client.nim#L235">  <code>revokeRolesFromUser</code></a>)</li>
<li>:heavy_check_mark: <code>updateUser</code> (db procs: <a href="/src/anonimongo/dbops/client.nim#L171">  <code>updateUser</code></a>)</li>
<li>:heavy_check_mark: <code>usersInfo</code> (db procs: <a href="/src/anonimongo/dbops/client.nim#L180">  <code>usersInfo</code></a>)</li>
</ul>
<h4>:white_check_mark: Role management commands 10/10 <a href="https://docs.mongodb.com/manual/reference/command/nav-role-management/">Mongo doc</a> <a href="src/anonimongo/dbops/rolemgmt.nim">Anonimongo module</a></h4>
<ul>
<li>:heavy_check_mark: <code>createRole</code> (db procs: <a href="/src/anonimongo/dbops/rolemgmt.nim#L18">  <code>createRole</code></a>)</li>
<li>:heavy_check_mark: <code>dropRole</code> (db procs: <a href="/src/anonimongo/dbops/rolemgmt.nim#L53">  <code>dropRole</code></a>)</li>
<li>:heavy_check_mark: <code>dropAllRolesFromDatabase</code> (db procs: <a href="/src/anonimongo/dbops/rolemgmt.nim#L59">  <code>dropAllRolesFromDatabase</code></a>)</li>
<li>:heavy_check_mark: <code>grantPrivilegesToRole</code>(db procs: <a href="/src/anonimongo/dbops/rolemgmt.nim#L73">  <code>grantPrivilegesToRole</code></a>)</li>
<li>:heavy_check_mark: <code>grantRolesToRole</code> (db procs: <a href="/src/anonimongo/dbops/rolemgmt.nim#L78">  <code>grantRolesToRole</code></a>)</li>
<li>:heavy_check_mark: <code>invalidateUserCache</code> (db procs: <a href="/src/anonimongo/dbops/rolemgmt.nim#L83">  <code>invalidateUserCache</code></a>)</li>
<li>:heavy_check_mark: <code>revokePrivilegesFromRole</code> (db procs: <a href="/src/anonimongo/dbops/rolemgmt.nim#L86">  <code>revokePrivilegesFromRole</code></a>)</li>
<li>:heavy_check_mark: <code>revokeRolesFromRole</code> (db procs: <a href="/src/anonimongo/dbops/rolemgmt.nim#L91">  <code>revokeRolesFromRole</code></a>)</li>
<li>:heavy_check_mark: <code>rolesInfo</code> (db procs: <a href="/src/anonimongo/dbops/rolemgmt.nim#L96">  <code>rolesInfo</code></a>)</li>
<li>:heavy_check_mark: <code>updateRole</code> (db procs: <a href="/src/anonimongo/dbops/rolemgmt.nim#L31">  <code>updateRole</code></a>)</li>
</ul>
<h4>:white_check_mark: Replication commands 12/12(<del>13</del>) <a href="https://docs.mongodb.com/manual/reference/command/nav-replication/">Mongo doc</a> <a href="src/anonimongo/dbops/replication.nim">Anonimongo module</a></h4>
<ul>
<li>:white_square_button: <code>applyOps</code> (internal command)</li>
<li>:heavy_check_mark: <code>isMaster</code> (db procs: <a href="/src/anonimongo/dbops/replication.nim#L5">  <code>isMaster</code></a>)</li>
<li>:heavy_check_mark: <code>replSetAbortPrimaryCatchUp</code> (db procs: <a href="/src/anonimongo/dbops/replication.nim#L16">  <code>replSetAbortPrimaryCatchUp</code></a>)</li>
<li>:heavy_check_mark: <code>replSetFreeze</code> (db procs: <a href="/src/anonimongo/dbops/replication.nim#L19">  <code>replSetFreeze</code></a>)</li>
<li>:heavy_check_mark: <code>replSetGetConfig</code> (db procs: <a href="/src/anonimongo/dbops/replication.nim#L22">  <code>replSetGetConfig</code></a>)</li>
<li>:heavy_check_mark: <code>replSetGetStatus</code> (db procs: <a href="/src/anonimongo/dbops/replication.nim#L32">  <code>replSetGetStatus</code></a>)</li>
<li>:heavy_check_mark: <code>replSetInitiate</code> (db procs: <a href="/src/anonimongo/dbops/replication.nim#L38">  <code>replSetInitiate</code></a>)</li>
<li>:heavy_check_mark: <code>replSetMaintenance</code> (db procs: <a href="/src/anonimongo/dbops/replication.nim#L44">  <code>replSetMaintenance</code></a>)</li>
<li>:heavy_check_mark: <code>replSetReconfig</code> (db procs: <a href="/src/anonimongo/dbops/replication.nim#L48">  <code>replSetReconfig</code></a>)</li>
<li>:heavy_check_mark: <code>replSetResizeOplog</code> (db procs: <a href="/src/anonimongo/dbops/replication.nim#L58">  <code>replSetResizeOplog</code></a>)</li>
<li>:heavy_check_mark: <code>replSetStepDown</code> (db procs: <a href="/src/anonimongo/dbops/replication.nim#L67">  <code>replSetStepDown</code></a>)</li>
<li>:heavy_check_mark: <code>replSetSyncFrom</code> (db procs: <a href="/src/anonimongo/dbops/replication.nim#L81">  <code>replSetSyncFrom</code></a>)</li>
</ul>
<h4>:x: Sharding commands 0/27 <a href="https://docs.mongodb.com/manual/reference/command/nav-sharding/">Mongo doc</a> <del>Anonimongo module</del></h4>
<ul>
<li>:white_square_button: <code>addShard</code></li>
<li>:white_square_button: <code>addShardToZone</code></li>
<li>:white_square_button: <code>balancerStart</code></li>
<li>:white_square_button: <code>balancerStop</code></li>
<li>:white_square_button: <code>checkShardingIndex</code></li>
<li>:white_square_button: <code>clearJumboFlag</code></li>
<li>:white_square_button: <code>cleanupOrphaned</code></li>
<li>:white_square_button: <code>enableSharding</code></li>
<li>:white_square_button: <code>flushRouterConfig</code></li>
<li>:white_square_button: <code>getShardMap</code></li>
<li>:white_square_button: <code>getShardVersion</code></li>
<li>:white_square_button: <code>isdbgrid</code></li>
<li>:white_square_button: <code>listShard</code></li>
<li>:white_square_button: <code>medianKey</code></li>
<li>:white_square_button: <code>moveChunk</code></li>
<li>:white_square_button: <code>movePrimary</code></li>
<li>:white_square_button: <code>mergeChunks</code></li>
<li>:white_square_button: <code>removeShard</code></li>
<li>:white_square_button: <code>removeShardFromZone</code></li>
<li>:white_square_button: <code>setShardVersion</code></li>
<li>:white_square_button: <code>shardCollection</code></li>
<li>:white_square_button: <code>shardCollection</code></li>
<li>:white_square_button: <code>split</code></li>
<li>:white_square_button: <code>splitChunk</code></li>
<li>:white_square_button: <code>splitVector</code></li>
<li>:white_square_button: <code>unsetSharding</code></li>
<li>:white_square_button: <code>updateZoneKeyRange</code></li>
</ul>
<h4>:x: Session commands 0/8 <a href="https://docs.mongodb.com/manual/reference/command/nav-sessions/">Mongo doc</a> <del>Anonimongo module</del></h4>
<ul>
<li>:white_square_button: <code>abortTransaction</code></li>
<li>:white_square_button: <code>commitTransaction</code></li>
<li>:white_square_button: <code>endSessions</code></li>
<li>:white_square_button: <code>killAllSessions</code></li>
<li>:white_square_button: <code>killAllSessionByPattern</code></li>
<li>:white_square_button: <code>killSessions</code></li>
<li>:white_square_button: <code>refreshSessions</code></li>
<li>:white_square_button: <code>startSession</code></li>
</ul>
<h4>:ballot_box_with_check: Administration commands 15/32 <a href="https://docs.mongodb.com/manual/reference/command/nav-administration/">Mongo doc</a> <a href="src/anonimongo/dbops/admmgmt.nim">Anonimongo module</a></h4>
<ul>
<li>:white_square_button: <code>clean</code> (internal namespace command)</li>
<li>:white_square_button: <code>cloneCollection</code></li>
<li>:white_square_button: <code>cloneCollectionAsCapped</code></li>
<li>:white_square_button: <code>collMod</code></li>
<li>:white_square_button: <code>compact</code></li>
<li>:white_square_button: <code>connPoolSync</code></li>
<li>:white_square_button: <code>convertToCapped</code></li>
<li>:heavy_check_mark: <code>create</code> (db procs: <a href="/src/anonimongo/dbops/admmgmt.nim#L23">  <code>create</code></a>)</li>
<li>:heavy_check_mark: <code>createIndexes</code> (collection proc: <a href="src/anonimongo/collections.nim#L248">  <code>createIndexes</code></a>)</li>
<li>:heavy_check_mark: <code>currentOp</code> (db procs: <a href="/src/anonimongo/dbops/admmgmt.nim#L192">  <code>currentOp</code></a>)</li>
<li>:heavy_check_mark: <code>drop</code> (collection procs: <a href="/src/anonimongo/collections.nim#L233">  <code>drop</code></a>)</li>
<li>:heavy_check_mark: <code>dropDatabase</code> (db procs: <a href="/src/anonimongo/dbops/admmgmt.nim#L71">  <code>dropDatabase</code></a>)</li>
<li>:white_square_button: <code>dropConnections</code></li>
<li>:heavy_check_mark: <code>dropIndexes</code> (collection procs: <a href="src/anonimongo/collections.nim#L275">  <code>dropIndex</code></a>, <a href="src/anonimongo/collections.nim#L275">  <code>dropIndexes</code></a>)</li>
<li>:white_square_button: <code>filemd5</code></li>
<li>:white_square_button: <code>fsync</code></li>
<li>:white_square_button: <code>fsyncUnlock</code></li>
<li>:white_square_button: <code>getParameter</code></li>
<li>:heavy_check_mark: <code>getDefaultReadConcern</code> (db procs: <a href="/src/anonimongo/dbops/admmgmt.nim#L241">  <code>getDefaultReadConcern</code></a>)</li>
<li>:heavy_check_mark: <code>killCursors</code> (db procs: <a href="/src/anonimongo/dbops/admmgmt.nim#L223">  <code>killCursors</code></a>)</li>
<li>:heavy_check_mark: <code>killOp</code> (db procs: <a href="/src/anonimongo/dbops/admmgmt.nim#L205">  <code>killOp</code></a>)</li>
<li>:heavy_check_mark: <code>listCollections</code> (db procs: <a href="/src/anonimongo/dbops/admmgmt.nim#L87">  <code>listCollections</code></a>)</li>
<li>:heavy_check_mark: <code>listDatabases</code> (db procs: <a href="/src/anonimongo/dbops/admmgmt.nim#L114">  <code>listDatabases</code></a></li>
<li>:heavy_check_mark: <code>listIndexes</code> (collection proc: <a href="src/anonimongo/collections.nim#L264">  <code>listIndexes</code></a>)</li>
<li>:white_square_button: <code>logRotate</code></li>
<li>:white_square_button: <code>reIndex</code></li>
<li>:heavy_check_mark: <code>renameCollection</code> (db procs: <a href="/src/anonimongo/dbops/admmgmt.nim#L158">  <code>renameCollection</code></a>)</li>
<li>:heavy_check_mark: <code>setDefaultRWConcern</code> (db procs: <a href="/src/anonimongo/dbops/admmgmt.nim#L228">  <code>setDefaultRWConcern</code></a>)</li>
<li>:white_square_button: <code>setFeatureCompabilityVersion</code></li>
<li>:white_square_button: <code>setIndexCommitQuorum</code></li>
<li>:white_square_button: <code>setParameter</code></li>
<li>:heavy_check_mark: <code>shutdown</code> (db procs: <a href="/src/anonimongo/dbops/admmgmt.nim#L173">  <code>shutdown</code></a>)</li>
</ul>
<h4>:white_check_mark: Diagnostic commands 17/17 (<del>26</del>) <a href="https://docs.mongodb.com/manual/reference/command/nav-diagnostic/">Mongo module</a> <a href="src/anonimongo/dbops/diagnostic.nim">Anonimongo module</a></h4>
<ul>
<li>:white_square_button: <code>availableQueryOptions</code> (internal command)</li>
<li>:heavy_check_mark: <code>buildInfo</code> (db procs: <a href="src/anonimongo/dbops/diagnostic.nim#L18">  <code>buildInfo</code></a>)</li>
<li>:heavy_check_mark: <code>collStats</code> (db procs: <a href="src/anonimongo/dbops/diagnostic.nim#L21">  <code>collStats</code></a>)</li>
<li>:heavy_check_mark: <code>connPoolStats</code> (db procs: <a href="src/anonimongo/dbops/diagnostic.nim#L25">  <code>connPoolStats</code></a>)</li>
<li>:heavy_check_mark: <code>connectionStatus</code> *(db procs: <a href="src/anonimongo/dbops/diagnostic.nim#L28">  <code>connectionStatus</code></a>)</li>
<li>:white_square_button: <code>cursorInfo</code> (removed, use metrics.cursor from <code>serverStatus</code> instead)</li>
<li>:heavy_check_mark: <code>dataSize</code> (db procs: <a href="src/anonimongo/dbops/diagnostic.nim#L33">  <code>dataSize</code></a>)</li>
<li>:heavy_check_mark: <code>dbHash</code> (db procs: <a href="src/anonimongo/dbops/diagnostic.nim#L41">  <code>dbHash</code></a>)</li>
<li>:heavy_check_mark: <code>dbStats</code> (db procs: <a href="src/anonimongo/dbops/diagnostic.nim#L46">  <code>dbStats</code></a>)</li>
<li>:white_square_button: <code>diagLogging</code> (removed, on Mongo 3.6, use mongoreplay instead)</li>
<li>:white_square_button: <code>driverOIDTest</code> (internal command)</li>
<li>:heavy_check_mark: <code>explain</code> (db procs: <a href="src/anonimongo/dbops/diagnostic.nim#L51">  <code>explain</code></a>)</li>
<li>:white_square_button: <code>features</code> (internal command)</li>
<li>:heavy_check_mark: <code>getCmdLineOpts</code> (db procs: <a href="src/anonimongo/dbops/diagnostic.nim#L56">  <code>getCmdLineOpts</code></a>)</li>
<li>:heavy_check_mark: <code>getLog</code> (db procs: <a href="src/anonimongo/dbops/diagnostic.nim#L59">  <code>getLog</code></a>)</li>
<li>:heavy_check_mark: <code>hostInfo</code> (db procs: <a href="src/anonimongo/dbops/diagnostic.nim#L62">  <code>hostInfo</code></a>)</li>
<li>:white_square_button: <code>isSelf</code> (internal command)</li>
<li>:heavy_check_mark: <code>listCommands</code> (db procs: <a href="src/anonimongo/dbops/diagnostic.nim#L66">  <code>listCommands</code></a>)</li>
<li>:white_square_button: <code>netstat</code> (internal command)</li>
<li>:heavy_check_mark: <code>ping</code> (db procs: <a href="src/anonimongo/dbops/diagnostic.nim#L69">  <code>ping</code></a>)</li>
<li>:heavy_check_mark: <code>profile</code> (internal command) (db procs: <a href="src/anonimongo/dbops/diagnostic.nim#L75">  <code>profile</code></a>)</li>
<li>:heavy_check_mark: <code>serverStatus</code> (db procs: <a href="src/anonimongo/dbops/diagnostic.nim#L83">  <code>serverStat</code></a>)</li>
<li>:heavy_check_mark: <code>shardConnPoolStats</code> (db procs: <a href="src/anonimongo/dbops/diagnostic.nim#L86">  <code>shardConnPoolStats</code></a>)</li>
<li>:heavy_check_mark: <code>top</code> (db procs: <a href="src/anonimongo/dbops/diagnostic.nim#L89">  <code>top</code></a>)</li>
<li>:heavy_check_mark: <code>validate</code> (db procs: <a href="src/anonimongo/dbops/diagnostic.nim#L92">  <code>validate</code></a>)</li>
<li>:white_square_button: <code>whatsmyuri</code> (internal command)</li>
</ul>
<h4>:white_check_mark: Free monitoring commands 2/2 <a href="https://docs.mongodb.com/manual/reference/command/nav-free-monitoring/">Mongo doc</a> <a href="src/anonimongo/dbops/freemonitoring.nim">Anonimongo module</a></h4>
<ul>
<li>:heavy_check_mark: <code>getFreeMonitoringStatus</code> (db procs: <a href="src/anonimongo/dbops/freemonitoring.nim#L4">  <code>getFreeMonitoringStatus</code></a>)</li>
<li>:heavy_check_mark: <code>setFreeMonitoring</code> (db procs: <a href="src/anonimongo/dbops/freemonitoring.nim#L9">  <code>setFreeMonitoring</code></a>)</li>
</ul>
<h4>:x: <del>Auditing commands 0/1</del>, only available for Mongodb Enterprise and AtlasDB <a href="https://docs.mongodb.com/manual/reference/command/nav-auditing/">Mongo doc</a> <del>Anonimongo module</del></h4>
<ul>
<li>:white_square_button: <code>logApplicationMessage</code></li>
</ul>
<h2>Caveats</h2>
<p>There are several points needed to keep in mind. Those are:</p>
<ul>
<li>
<p><code>diagnostic.explain</code> and its corresponding <code>explain</code>-ed version of various commands haven&apos;t
been undergone extensive testing.</p>
</li>
<li>
<p><code>Query</code> only provided for <code>db.find</code> commands. It&apos;s still not supporting Query Plan Cache or
anything regarded that.</p>
</li>
<li>
<p>All <code>readPreference</code> options are supported except <code>nearest</code>.</p>
</li>
<li>
<p>Some third-party library which targeting OpenSSL &lt;= 1.0 results in unstable behaviour. See
<a href="https://github.com/mashingan/anonimongo/issues/7#issuecomment-674516511">issue #7 comment</a></p>
</li>
<li>
<p>All internal connection implementations are Asynchronous IO. No support for multi-threading.</p>
</li>
<li>
<p><code>retryableWrites</code> is doing operation twice in case the first attempt is failed. The mongo
reference of it can be found <a href="https://docs.mongodb.com/manual/core/retryable-writes/#retryable-writes">here</a>. It&apos;s hard to test intentionally fail hence</p>
</li>
</ul>
<p>it hasn&apos;t been undergone extensive testing. As it&apos;s almost no different with normal operation,
user can retry by themselves to increase of the retrying. Bulk write is reusing the previous
mentioned operations so it&apos;s supported too.</p>
<h2>Support</h2>
<p>If this library is useful for you and you can spare some, any donation would be appreciated.
<a href="https://paypal.me/rahshingan?country.x=ID&amp;locale.x=en_US">Paypal</a>.</p>
<p>If you want to have particular features to be implemented and would like to have a commercial support,
you can email to <a href="rahmatullah21@proton.me">rahmatullah21@proton.me</a> for reaching out.</p>
<p>  <a href="#table-of-content">TOC</a></p>
<h2>License</h2>
<p>MIT</p>
</document>
            
        </div>
        <div class="col-3" id="meta-section">
            <div class="container box rounded p-3">
                
                    <p>
                        <strong>Licence:</strong>
                        MIT
                    </p>
                

                
                    <p> <a href="https://mashingan.github.io/anonimongo/src/htmldocs/anonimongo.html">Project website</a> </p>
                

                
            </div>
        </div>
    </div>
</div>
</div>

<footer class="pt-10 px-3">
  <div class="container pt-4">
    <div class="row mb-4">
      <div class="col-lg-3">
        <h4 class="h5">Getting started with Nim</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://learnxinyminutes.com/docs/nim/">Learn Nim in 5 minutes</a></li>
          <li><a class="text-decoration-none" href="https://nim-by-example.github.io/">Nim by Example</a></li>
          <li><a class="text-decoration-none" href="https://play.nim-lang.org/">Official Playground</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Official Tutorials</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut1.html">General Tutorial</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut2.html">Advanced Features</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut3.html">Macros and Metaprogramming</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Nim for...</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-C-programmers">C programmers</a></li>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-Python-Programmers">Python programmers</a></li>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-TypeScript-Programmers">TypeScript programmers</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Documentation</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/lib.html">Standard Library</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/manual.html">Language Manual</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tools.html">Tools Documentation</a></li>
        </ul>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-12 text-center mt-4 mx-auto">
        <a href="#" class="d-block mb-3 mx-auto bw"></a>
        <p class="text-muted">
        Created in <a href="https://nim-lang.org/">Nim</a> on <a href="https://pages.github.com/">GitHub Pages</a>.
        <a href="https://github.com/gabbhack/nimidirectory">Available</a>
        under <a href="https://en.wikipedia.org/wiki/GNU_General_Public_License#Version_3">GPLv3</a>
        </p>
        <p class="text-muted">
        Builded at 2023-07-11T01:39:15Z
        </p>
      </div>
    </div>
  </div>
</footer>
<script>
</script>
</body>
</html>
