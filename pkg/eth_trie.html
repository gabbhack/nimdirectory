<!DOCTYPE html>
<html lang="en">
<head>
  <title>Nim Package Directory</title>
  <link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="alternate" type="application/rss+xml" title="New and updated Nim packages" href="https://nimble.directory/packages.xml">
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/highlite.css">
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script type="text/javascript" src="/js/app.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg fixed-top py-3">
  <div class="container">
    <a href="/" class="logo fw-500 display-1 text-black text-decoration-none navbar-brand"></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item mx-2">
          <a href="https://nim-lang.org/" class="nav-link">What's Nim?</a>
        </li>
        <li class="nav-item mx-2">
          <a href="/about.html" class="nav-link">What's Nimble?</a>
        </li>
        <li class="nav-item mx-2">
          <a href="https://github.com/nim-lang/packages/" class="nav-link">Publish your package</a>
        </li>
        <!-- TODO: replace with something different -->
        <li class="nav-item ms-3">
          <a class="nav-link" href="https://www.youtube.com/channel/UCDAYn_VFt0VisL5-1a5Dk7Q/">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon></svg>
          </a>
        </li>
        <li class="nav-item ms-3">
          <a class="nav-link theme-switcher-btn" id="darkmode" onclick="toggle_dark_mode()" href="#">
            <span id="light-mode-icon">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </span>
            <span id="dark-mode-icon">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="content">
  <div class="container">
    <div class="container pt-10">
        <h3 class="mb-3 fw-bold display-6 pt-4">eth_trie</h3>
        <p class="tags">
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">deprecated</button></a>
                </span>
            
        </p>
        <p class="pkg-desc">some("Merkle Patricia Tries as specified by Ethereum (deprecated, now part of the \'eth\' package)")</p>
        <a title="Copy" onclick="document.querySelector('#cmd').select();document.execCommand('copy');"
            alt="Copy on clipboard">
            <i class="fa fa-copy"></i>
        </a>
        <input id="cmd" onclick="this.select();" value="nimble install eth_trie" readonly="">
        <br>
        <small style="font-size: 0.8rem;">Need help? Read <a
                href="https://github.com/nim-lang/nimble#creating-packages">Nimble</a></small>
    </div>

    <div class="container row pt-4" id="pkg-content">
        <div class="col-8 box rounded p-3" id="readme-section">
            
                <document><h1>nim-trie</h1>
<h1>MOVED TO https://github.com/status-im/nim-eth</h1>
<h2>Nim Implementation of the Ethereum Trie structure</h2>
<p><a href="https://travis-ci.org/status-im/nim-eth-trie">  <img src="https://img.shields.io/travis/status-im/nim-eth-trie/master.svg?label=Linux%20/%20macOS" style="max-width: 100%;" alt="Build Status (Travis)" title="Linux/macOS build status (Travis)" /></a>
<a href="https://ci.appveyor.com/project/nimbus/nim-eth-trie">  <img src="https://img.shields.io/appveyor/ci/nimbus/nim-eth-trie/master.svg?label=Windows" style="max-width: 100%;" alt="Windows build status (Appveyor)" title="Windows build status (Appveyor)" /></a>
<a href="https://opensource.org/licenses/Apache-2.0">  <img src="https://img.shields.io/badge/License-Apache%202.0-blue.svg" style="max-width: 100%;" alt="License: Apache" /></a>
<a href="https://opensource.org/licenses/MIT">  <img src="https://img.shields.io/badge/License-MIT-blue.svg" style="max-width: 100%;" alt="License: MIT" /></a>
<img src="https://img.shields.io/badge/stability-experimental-orange.svg" style="max-width: 100%;" alt="Stability: experimental" /></p>
<h2>Hexary Trie</h2>
<h2>Binary Trie</h2>
<p>Binary-trie is a dictionary-like data structure to store key-value pair.
Much like it&apos;s sibling Hexary-trie, the key-value pair will be stored into key-value flat-db.
The primary difference with Hexary-trie is, each node of Binary-trie only consist of one or two child,
while Hexary-trie node can contains up to 16 or 17 child-nodes.</p>
<p>Unlike Hexary-trie, Binary-trie store it&apos;s data into flat-db without using rlp encoding.
Binary-trie store its value using simple <strong>Node-Types</strong> encoding.
The encoded-node will be hashed by keccak_256 and the hash value will be the key to flat-db.
Each entry in the flat-db will looks like:</p>
<table>
<thead>
<tr>
<th>key</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>32-bytes-keccak-hash</td>
<td>encoded-node(KV or BRANCH or LEAF encoded)</td>
</tr></tbody></table>
<h3>Node-Types</h3>
<ul>
<li>KV = [0, encoded-key-path, 32 bytes hash of child]</li>
<li>BRANCH = [1, 32 bytes hash of left child, 32 bytes hash of right child]</li>
<li>LEAF = [2, value]</li>
</ul>
<p>The KV node can have BRANCH node or LEAF node as it&apos;s child, but cannot a KV node.
The internal algorithm will merge a KV(parent)-&gt;KV(child) into one KV node.
Every KV node contains encoded keypath to reduce the number of blank nodes.</p>
<p>The BRANCH node can have KV, BRANCH, or LEAF node as it&apos;s children.</p>
<p>The LEAF node is the terminal node, it contains the value of a key.</p>
<h3>encoded-key-path</h3>
<p>While Hexary-trie encode the path using Hex-Prefix encoding, Binary-trie
encode the path using binary encoding, the scheme looks like this table below.</p>
<pre>  <code class="language-text">            |--------- odd --------|
       00mm yyyy xxxx xxxx xxxx xxxx
            |------ even -----|
  1000 00mm yyyy xxxx xxxx xxxx
</code></pre>
<table>
<thead>
<tr>
<th>symbol</th>
<th>explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td>xxxx</td>
<td>nibble of binary keypath in bits, 0 = left, 1 = right</td>
</tr>
<tr>
<td>yyyy</td>
<td>nibble contains 0-3 bits padding + binary keypath</td>
</tr>
<tr>
<td>mm</td>
<td>number of binary keypath bits modulo 4 (0-3)</td>
</tr>
<tr>
<td>00</td>
<td>zero zero prefix</td>
</tr>
<tr>
<td>1000</td>
<td>even numbered nibbles prefix</td>
</tr></tbody></table>
<p>if there is no padding, then yyyy bit sequence is absent, mm also zero.
yyyy = mm bits + padding bits must be 4 bits length.</p>
<h3>The API</h3>
<p>The primary API for Binary-trie is <code>set</code> and <code>get</code>.</p>
<ul>
<li>set(key, value)  ---  <em>store a value associated with a key</em></li>
<li>get(key): value  --- <em>get a value using a key</em></li>
</ul>
<p>Both <code>key</code> and <code>value</code> are of <code>BytesRange</code> type. And they cannot have zero length.
You can also use convenience API <code>get</code> and <code>set</code> which accepts
<code>Bytes</code> or <code>string</code> (a <code>string</code> is conceptually wrong in this context
and may costlier than a <code>BytesRange</code>, but it is good for testing purpose).</p>
<p>Getting a non-existent key will return zero length BytesRange.</p>
<p>Binary-trie also provide dictionary syntax API for <code>set</code> and <code>get</code>.</p>
<ul>
<li>trie[key] = value -- same as <code>set</code></li>
<li>value = trie[key] -- same as <code>get</code></li>
<li>contains(key) a.k.a. <code>in</code> operator</li>
</ul>
<p>Additional APIs are:</p>
<ul>
<li>exists(key) -- returns <code>bool</code>, to check key-value existence -- same as contains</li>
<li>delete(key) -- remove a key-value from the trie</li>
<li>deleteSubtrie(key) -- remove a key-value from the trie plus all of it&apos;s subtrie
that starts with the same key prefix</li>
<li>rootNode() -- get root node</li>
<li>rootNode(node) -- replace the root node</li>
<li>getRootHash(): <code>KeccakHash</code> with <code>BytesRange</code> type</li>
<li>getDB(): <code>DB</code> -- get flat-db pointer</li>
</ul>
<p>Constructor API:</p>
<ul>
<li>initBinaryTrie(DB, rootHash[optional]) -- rootHash has <code>BytesRange</code> or KeccakHash type</li>
<li>init(BinaryTrie, DB, rootHash[optional])</li>
</ul>
<p>Normally you would not set the rootHash when constructing an empty Binary-trie.
Setting the rootHash occured in a scenario where you have a populated DB
with existing trie structure and you know the rootHash,
and then you want to continue/resume the trie operations.</p>
<h2>Examples</h2>
<pre>  <code class="language-Nim"><div class="line"><div class="line-content"><span class="kwd">import</span></div></div><div class="line"><div class="line-content">  <span class="ide">eth_trie</span><span class="op">/</span>[<span class="ide">db</span>, <span class="ide">binary</span>, <span class="ide">utils</span>]</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">db</span> <span class="op">=</span> <span class="ide">newMemoryDB</span>()</div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">trie</span> <span class="op">=</span> <span class="ide">initBinaryTrie</span>(<span class="ide">db</span>)</div></div><div class="line"><div class="line-content"><span class="ide">trie</span><span class="op">.</span><span class="ide">set</span>(<span class="str">&quot;key1&quot;</span>, <span class="str">&quot;value1&quot;</span>)</div></div><div class="line"><div class="line-content"><span class="ide">trie</span><span class="op">.</span><span class="ide">set</span>(<span class="str">&quot;key2&quot;</span>, <span class="str">&quot;value2&quot;</span>)</div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">trie</span><span class="op">.</span><span class="ide">get</span>(<span class="str">&quot;key1&quot;</span>) <span class="op">==</span> <span class="str">&quot;value1&quot;</span><span class="op">.</span><span class="ide">toRange</span></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">trie</span><span class="op">.</span><span class="ide">get</span>(<span class="str">&quot;key2&quot;</span>) <span class="op">==</span> <span class="str">&quot;value2&quot;</span><span class="op">.</span><span class="ide">toRange</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># delete all subtrie with key prefixes &quot;key&quot;</span></div></div><div class="line"><div class="line-content"><span class="ide">trie</span><span class="op">.</span><span class="ide">deleteSubtrie</span>(<span class="str">&quot;key&quot;</span>)</div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">trie</span><span class="op">.</span><span class="ide">get</span>(<span class="str">&quot;key1&quot;</span>) <span class="op">==</span> <span class="ide">zeroBytesRange</span></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">trie</span><span class="op">.</span><span class="ide">get</span>(<span class="str">&quot;key2&quot;</span>) <span class="op">==</span> <span class="ide">zeroBytesRange</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">trie</span>[<span class="str">&quot;moon&quot;</span>] <span class="op">=</span> <span class="str">&quot;sun&quot;</span></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="str">&quot;moon&quot;</span> <span class="kwd">in</span> <span class="ide">trie</span></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">trie</span>[<span class="str">&quot;moon&quot;</span>] <span class="op">==</span> <span class="str">&quot;sun&quot;</span><span class="op">.</span><span class="ide">toRange</span></div></div>  </code></pre>
<p>Remember, <code>set</code> and <code>get</code> are trie operations. A single <code>set</code> operation may invoke
more than one store/lookup operation into the underlying DB. The same is also happened to <code>get</code> operation,
it could do more than one flat-db lookup before it return the requested value.</p>
<h2>The truth behind a lie</h2>
<p>What kind of lie? actually, <code>delete</code> and <code>deleteSubtrie</code> doesn&apos;t remove the
&apos;deleted&apos; node from the underlying DB. It only make the node inaccessible
from the user of the trie. The same also happened if you update the value of a key,
the old value node is not removed from the underlying DB.
A more subtle lie also happened when you add new entrie into the trie using <code>set</code> operation.
The previous hash of affected branch become obsolete and replaced by new hash,
the old hash become inaccessible to the user.
You may think that is a waste of storage space.
Luckily, we also provide some utilities to deal with this situation, the branch utils.</p>
<h2>The branch utils</h2>
<p>The branch utils consist of these API:</p>
<ul>
<li>checkIfBranchExist(DB; rootHash; keyPrefix): bool</li>
<li>getBranch(DB; rootHash; key): branch</li>
<li>isValidBranch(branch, rootHash, key, value): bool</li>
<li>getWitness(DB; nodeHash; key): branch</li>
<li>getTrieNodes(DB; nodeHash): branch</li>
</ul>
<p><code>keyPrefix</code>, <code>key</code>, and <code>value</code> are bytes container with length greater than zero.
They can be BytesRange, Bytes, and string(again, for convenience and testing purpose).</p>
<p><code>rootHash</code> and <code>nodeHash</code> also bytes container,
but they have constraint: must be 32 bytes in length, and it must be a keccak_256 hash value.</p>
<p><code>branch</code> is a list of nodes, or in this case a seq[BytesRange].
A list? yes, the structure is stored along with the encoded node.
Therefore a list is enough to reconstruct the entire trie/branch.</p>
<pre>  <code class="language-Nim"><div class="line"><div class="line-content"><span class="kwd">import</span></div></div><div class="line"><div class="line-content">  <span class="ide">eth_trie</span><span class="op">/</span>[<span class="ide">db</span>, <span class="ide">binary</span>, <span class="ide">utils</span>]</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">db</span> <span class="op">=</span> <span class="ide">newMemoryDB</span>()</div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">trie</span> <span class="op">=</span> <span class="ide">initBinaryTrie</span>(<span class="ide">db</span>)</div></div><div class="line"><div class="line-content"><span class="ide">trie</span><span class="op">.</span><span class="ide">set</span>(<span class="str">&quot;key1&quot;</span>, <span class="str">&quot;value1&quot;</span>)</div></div><div class="line"><div class="line-content"><span class="ide">trie</span><span class="op">.</span><span class="ide">set</span>(<span class="str">&quot;key2&quot;</span>, <span class="str">&quot;value2&quot;</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">checkIfBranchExist</span>(<span class="ide">db</span>, <span class="ide">trie</span><span class="op">.</span><span class="ide">getRootHash</span>(), <span class="str">&quot;key&quot;</span>) <span class="op">==</span> <span class="ide">true</span></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">checkIfBranchExist</span>(<span class="ide">db</span>, <span class="ide">trie</span><span class="op">.</span><span class="ide">getRootHash</span>(), <span class="str">&quot;key1&quot;</span>) <span class="op">==</span> <span class="ide">true</span></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">checkIfBranchExist</span>(<span class="ide">db</span>, <span class="ide">trie</span><span class="op">.</span><span class="ide">getRootHash</span>(), <span class="str">&quot;ken&quot;</span>) <span class="op">==</span> <span class="ide">false</span></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">checkIfBranchExist</span>(<span class="ide">db</span>, <span class="ide">trie</span><span class="op">.</span><span class="ide">getRootHash</span>(), <span class="str">&quot;key123&quot;</span>) <span class="op">==</span> <span class="ide">false</span></div></div>  </code></pre>
<p>The tree will looks like:</p>
<pre>  <code class="language-text">    root ---&gt;  A(kvnode, *common key prefix*)
                         |
                         |
                         |
                    B(branchnode)
                     /         \
                    /           \
                   /             \
C1(kvnode, *remain kepath*) C2(kvnode, *remain kepath*)
            |                           |
            |                           |
            |                           |
  D1(leafnode, b&apos;value1&apos;)       D2(leafnode, b&apos;value2&apos;)
</code></pre>
<pre>  <code class="language-Nim"><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">branchA</span> <span class="op">=</span> <span class="ide">getBranch</span>(<span class="ide">db</span>, <span class="ide">trie</span><span class="op">.</span><span class="ide">getRootHash</span>(), <span class="str">&quot;key1&quot;</span>)</div></div><div class="line"><div class="line-content"><span class="com"># ==&gt; [A, B, C1, D1]</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">branchB</span> <span class="op">=</span> <span class="ide">getBranch</span>(<span class="ide">db</span>, <span class="ide">trie</span><span class="op">.</span><span class="ide">getRootHash</span>(), <span class="str">&quot;key2&quot;</span>)</div></div><div class="line"><div class="line-content"><span class="com"># ==&gt; [A, B, C2, D2]</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">isValidBranch</span>(<span class="ide">branchA</span>, <span class="ide">trie</span><span class="op">.</span><span class="ide">getRootHash</span>(), <span class="str">&quot;key1&quot;</span>, <span class="str">&quot;value1&quot;</span>) <span class="op">==</span> <span class="ide">true</span></div></div><div class="line"><div class="line-content"><span class="com"># wrong key, return zero bytes</span></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">isValidBranch</span>(<span class="ide">branchA</span>, <span class="ide">trie</span><span class="op">.</span><span class="ide">getRootHash</span>(), <span class="str">&quot;key5&quot;</span>, <span class="str">&quot;&quot;</span>) <span class="op">==</span> <span class="ide">true</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">isValidBranch</span>(<span class="ide">branchB</span>, <span class="ide">trie</span><span class="op">.</span><span class="ide">getRootHash</span>(), <span class="str">&quot;key1&quot;</span>, <span class="str">&quot;value1&quot;</span>) <span class="com"># InvalidNode</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">x</span> <span class="op">=</span> <span class="ide">getBranch</span>(<span class="ide">db</span>, <span class="ide">trie</span><span class="op">.</span><span class="ide">getRootHash</span>(), <span class="str">&quot;key&quot;</span>)</div></div><div class="line"><div class="line-content"><span class="com"># ==&gt; [A]</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">x</span> <span class="op">=</span> <span class="ide">getBranch</span>(<span class="ide">db</span>, <span class="ide">trie</span><span class="op">.</span><span class="ide">getRootHash</span>(), <span class="str">&quot;key123&quot;</span>) <span class="com"># InvalidKeyError</span></div></div><div class="line"><div class="line-content"><span class="ide">x</span> <span class="op">=</span> <span class="ide">getBranch</span>(<span class="ide">db</span>, <span class="ide">trie</span><span class="op">.</span><span class="ide">getRootHash</span>(), <span class="str">&quot;key5&quot;</span>) <span class="com"># there is still branch for non-exist key</span></div></div><div class="line"><div class="line-content"><span class="com"># ==&gt; [A]</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">branch</span> <span class="op">=</span> <span class="ide">getWitness</span>(<span class="ide">db</span>, <span class="ide">trie</span><span class="op">.</span><span class="ide">getRootHash</span>(), <span class="str">&quot;key1&quot;</span>)</div></div><div class="line"><div class="line-content"><span class="com"># equivalent to `getBranch(db, trie.getRootHash(), &quot;key1&quot;)`</span></div></div><div class="line"><div class="line-content"><span class="com"># ==&gt; [A, B, C1, D1]</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">branch</span> <span class="op">=</span> <span class="ide">getWitness</span>(<span class="ide">db</span>, <span class="ide">trie</span><span class="op">.</span><span class="ide">getRootHash</span>(), <span class="str">&quot;key&quot;</span>)</div></div><div class="line"><div class="line-content"><span class="com"># this will include additional nodes of &quot;key2&quot;</span></div></div><div class="line"><div class="line-content"><span class="com"># ==&gt; [A, B, C1, D1, C2, D2]</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">wholeTrie</span> <span class="op">=</span> <span class="ide">getWitness</span>(<span class="ide">db</span>, <span class="ide">trie</span><span class="op">.</span><span class="ide">getRootHash</span>(), <span class="str">&quot;&quot;</span>)</div></div><div class="line"><div class="line-content"><span class="com"># this will return the whole trie</span></div></div><div class="line"><div class="line-content"><span class="com"># ==&gt; [A, B, C1, D1, C2, D2]</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">node</span> <span class="op">=</span> <span class="ide">branch</span>[<span class="num">1</span>] <span class="com"># B</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">nodeHash</span> <span class="op">=</span> <span class="ide">keccak256</span><span class="op">.</span><span class="ide">digest</span>(<span class="ide">node</span><span class="op">.</span><span class="ide">baseAddr</span>, <span class="ide">uint</span>(<span class="ide">node</span><span class="op">.</span><span class="ide">len</span>))</div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">nodes</span> <span class="op">=</span> <span class="ide">getTrieNodes</span>(<span class="ide">db</span>, <span class="ide">nodeHash</span>)</div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">nodes</span><span class="op">.</span><span class="ide">len</span> <span class="op">==</span> <span class="ide">wholeTrie</span><span class="op">.</span><span class="ide">len</span> <span class="op">-</span> <span class="num">1</span></div></div><div class="line"><div class="line-content"><span class="com"># ==&gt; [B, C1, D1, C2, D2]</span></div></div>  </code></pre>
<h2>Remember the lie?</h2>
<p>Because trie <code>delete</code>, <code>deleteSubtrie</code> and <code>set</code> operation create inaccessible nodes in the underlying DB,
we need to remove them if necessary. We already see that <code>wholeTrie = getWitness(db, trie.getRootHash(), &quot;&quot;)</code>
will return the whole trie, a list of accessible nodes.
Then we can write the clean tree into a new DB instance to replace the old one.</p>
<h2>Sparse Merkle Trie</h2>
<p>Sparse Merkle Trie(SMT) is a variant of Binary Trie which uses binary encoding to
represent path during trie travelsal. When Binary Trie uses three types of node,
SMT only use one type of node without any additional special encoding to store it&apos;s key-path.</p>
<p>Actually, it doesn&apos;t even store it&apos;s key-path anywhere like Binary Trie,
the key-path is stored implicitly in the trie structure during key-value insertion.</p>
<p>Because the key-path is not encoded in any special ways, the bits can be extracted directly from
the key without any conversion.</p>
<p>However, the key restricted to a fixed length because the algorithm demand a fixed height trie
to works properly. In this case, the trie height is limited to 160 level,
or the key is of fixed length 20 bytes (8 bits x 20 = 160).</p>
<p>To be able to use variable length key, the algorithm can be adapted slightly using hashed key before
constructing the binary key-path. For example, if using keccak256 as the hashing function,
then the height of the tree will be 256, but the key itself can be any length.</p>
<h3>The API</h3>
<p>The primary API for Binary-trie is <code>set</code> and <code>get</code>.</p>
<ul>
<li>set(key, value, rootHash[optional])  ---  <em>store a value associated with a key</em></li>
<li>get(key, rootHash[optional]): value  --- <em>get a value using a key</em></li>
</ul>
<p>Both <code>key</code> and <code>value</code> are of <code>BytesRange</code> type. And they cannot have zero length.
You can also use convenience API <code>get</code> and <code>set</code> which accepts
<code>Bytes</code> or <code>string</code> (a <code>string</code> is conceptually wrong in this context
and may costlier than a <code>BytesRange</code>, but it is good for testing purpose).</p>
<p>rootHash is an optional parameter. When used, <code>get</code> will get a key from specific root,
and <code>set</code> will also set a key at specific root.</p>
<p>Getting a non-existent key will return zero length BytesRange or a zeroBytesRange.</p>
<p>Sparse Merkle Trie also provide dictionary syntax API for <code>set</code> and <code>get</code>.</p>
<ul>
<li>trie[key] = value -- same as <code>set</code></li>
<li>value = trie[key] -- same as <code>get</code></li>
<li>contains(key) a.k.a. <code>in</code> operator</li>
</ul>
<p>Additional APIs are:</p>
<ul>
<li>exists(key) -- returns <code>bool</code>, to check key-value existence -- same as contains</li>
<li>delete(key) -- remove a key-value from the trie</li>
<li>getRootHash(): <code>KeccakHash</code> with <code>BytesRange</code> type</li>
<li>getDB(): <code>DB</code> -- get flat-db pointer</li>
<li>prove(key, rootHash[optional]): proof -- useful for merkling</li>
</ul>
<p>Constructor API:</p>
<ul>
<li>initSparseBinaryTrie(DB, rootHash[optional])</li>
<li>init(SparseBinaryTrie, DB, rootHash[optional])</li>
</ul>
<p>Normally you would not set the rootHash when constructing an empty Sparse Merkle Trie.
Setting the rootHash occured in a scenario where you have a populated DB
with existing trie structure and you know the rootHash,
and then you want to continue/resume the trie operations.</p>
<h2>Examples</h2>
<pre>  <code class="language-Nim"><div class="line"><div class="line-content"><span class="kwd">import</span></div></div><div class="line"><div class="line-content">  <span class="ide">eth_trie</span><span class="op">/</span>[<span class="ide">db</span>, <span class="ide">sparse_binary</span>, <span class="ide">utils</span>]</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span></div></div><div class="line"><div class="line-content">  <span class="ide">db</span> <span class="op">=</span> <span class="ide">newMemoryDB</span>()</div></div><div class="line"><div class="line-content">  <span class="ide">trie</span> <span class="op">=</span> <span class="ide">initSparseMerkleTrie</span>(<span class="ide">db</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span></div></div><div class="line"><div class="line-content">  <span class="ide">key1</span> <span class="op">=</span> <span class="str">&quot;01234567890123456789&quot;</span></div></div><div class="line"><div class="line-content">  <span class="ide">key2</span> <span class="op">=</span> <span class="str">&quot;abcdefghijklmnopqrst&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">trie</span><span class="op">.</span><span class="ide">set</span>(<span class="ide">key1</span>, <span class="str">&quot;value1&quot;</span>)</div></div><div class="line"><div class="line-content"><span class="ide">trie</span><span class="op">.</span><span class="ide">set</span>(<span class="ide">key2</span>, <span class="str">&quot;value2&quot;</span>)</div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">trie</span><span class="op">.</span><span class="ide">get</span>(<span class="ide">key1</span>) <span class="op">==</span> <span class="str">&quot;value1&quot;</span><span class="op">.</span><span class="ide">toRange</span></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">trie</span><span class="op">.</span><span class="ide">get</span>(<span class="ide">key2</span>) <span class="op">==</span> <span class="str">&quot;value2&quot;</span><span class="op">.</span><span class="ide">toRange</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">trie</span><span class="op">.</span><span class="ide">delete</span>(<span class="ide">key1</span>)</div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">trie</span><span class="op">.</span><span class="ide">get</span>(<span class="ide">key1</span>) <span class="op">==</span> <span class="ide">zeroBytesRange</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">trie</span><span class="op">.</span><span class="ide">delete</span>(<span class="ide">key2</span>)</div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">trie</span>[<span class="ide">key2</span>] <span class="op">==</span> <span class="ide">zeroBytesRange</span></div></div>  </code></pre>
<p>Remember, <code>set</code> and <code>get</code> are trie operations. A single <code>set</code> operation may invoke
more than one store/lookup operation into the underlying DB. The same is also happened to <code>get</code> operation,
it could do more than one flat-db lookup before it return the requested value.
While Binary Trie perform a variable numbers of lookup and store operations, Sparse Merkle Trie
will do constant numbers of lookup and store operations each <code>get</code> and <code>set</code> operation.</p>
<h2>Merkle Proofing</h2>
<p>Using <code>prove</code> dan <code>verifyProof</code> API, we can do some merkling with SMT.</p>
<pre>  <code class="language-Nim"><div class="line"><div class="line-content"><span class="kwd">let</span></div></div><div class="line"><div class="line-content">    <span class="ide">value1</span> <span class="op">=</span> <span class="str">&quot;hello world&quot;</span></div></div><div class="line"><div class="line-content">    <span class="ide">badValue</span> <span class="op">=</span> <span class="str">&quot;bad value&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">trie</span>[<span class="ide">key1</span>] <span class="op">=</span> <span class="ide">value1</span></div></div><div class="line"><div class="line-content">  <span class="kwd">var</span> <span class="ide">proof</span> <span class="op">=</span> <span class="ide">trie</span><span class="op">.</span><span class="ide">prove</span>(<span class="ide">key1</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">assert</span> <span class="ide">verifyProof</span>(<span class="ide">proof</span>, <span class="ide">trie</span><span class="op">.</span><span class="ide">getRootHash</span>(), <span class="ide">key1</span>, <span class="ide">value1</span>) <span class="op">==</span> <span class="ide">true</span></div></div><div class="line"><div class="line-content">  <span class="ide">assert</span> <span class="ide">verifyProof</span>(<span class="ide">proof</span>, <span class="ide">trie</span><span class="op">.</span><span class="ide">getRootHash</span>(), <span class="ide">key1</span>, <span class="ide">badValue</span>) <span class="op">==</span> <span class="ide">false</span></div></div><div class="line"><div class="line-content">  <span class="ide">assert</span> <span class="ide">verifyProof</span>(<span class="ide">proof</span>, <span class="ide">trie</span><span class="op">.</span><span class="ide">getRootHash</span>(), <span class="ide">key2</span>, <span class="ide">value1</span>) <span class="op">==</span> <span class="ide">false</span></div></div>  </code></pre>
<h2>License</h2>
<p>Licensed and distributed under either of</p>
<ul>
<li>MIT license: <a href="LICENSE-MIT">LICENSE-MIT</a> or http://opensource.org/licenses/MIT</li>
</ul>
<p>or</p>
<ul>
<li>Apache License, Version 2.0, (<a href="LICENSE-APACHEv2">LICENSE-APACHEv2</a> or http://www.apache.org/licenses/LICENSE-2.0)</li>
</ul>
<p>at your option. This file may not be copied, modified, or distributed except according to those terms.</p>
</document>
            
        </div>
        <div class="col-3" id="meta-section">
            <div class="container box rounded p-3">
                
                    <p>
                        <strong>Licence:</strong>
                        Apache License 2.0
                    </p>
                

                
                    <p> <a href="https://github.com/status-im/nim-eth-trie">Project website</a> </p>
                

                
            </div>
        </div>
    </div>
</div>
</div>

<footer class="pt-10 px-3">
  <div class="container pt-4">
    <div class="row mb-4">
      <div class="col-lg-3">
        <h4 class="h5">Getting started with Nim</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://learnxinyminutes.com/docs/nim/">Learn Nim in 5 minutes</a></li>
          <li><a class="text-decoration-none" href="https://nim-by-example.github.io/">Nim by Example</a></li>
          <li><a class="text-decoration-none" href="https://play.nim-lang.org/">Official Playground</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Official Tutorials</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut1.html">General Tutorial</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut2.html">Advanced Features</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut3.html">Macros and Metaprogramming</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Nim for...</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-C-programmers">C programmers</a></li>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-Python-Programmers">Python programmers</a></li>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-TypeScript-Programmers">TypeScript programmers</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Documentation</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/lib.html">Standard Library</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/manual.html">Language Manual</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tools.html">Tools Documentation</a></li>
        </ul>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-12 text-center mt-4 mx-auto">
        <a href="#" class="d-block mb-3 mx-auto bw"></a>
        <p class="text-muted">
        Created in <a href="https://nim-lang.org/">Nim</a> on <a href="https://pages.github.com/">GitHub Pages</a>.
        <a href="https://github.com/gabbhack/nimidirectory">Available</a>
        under <a href="https://en.wikipedia.org/wiki/GNU_General_Public_License#Version_3">GPLv3</a>
        </p>
        <p class="text-muted">
        Builded at 2023-10-26T01:07:16Z
        </p>
      </div>
    </div>
  </div>
</footer>
<script>
</script>
</body>
</html>
