<!DOCTYPE html>
<html lang="en">
<head>
  <title>Nim Package Directory</title>
  <link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="alternate" type="application/rss+xml" title="New and updated Nim packages" href="https://nimble.directory/packages.xml">
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/highlite.css">
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script type="text/javascript" src="/js/app.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg fixed-top py-3">
  <div class="container">
    <a href="/" class="logo fw-500 display-1 text-black text-decoration-none navbar-brand"></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item mx-2">
          <a href="https://nim-lang.org/" class="nav-link">What's Nim?</a>
        </li>
        <li class="nav-item mx-2">
          <a href="/about.html" class="nav-link">What's Nimble?</a>
        </li>
        <li class="nav-item mx-2">
          <a href="https://github.com/nim-lang/packages/" class="nav-link">Publish your package</a>
        </li>
        <!-- TODO: replace with something different -->
        <li class="nav-item ms-3">
          <a class="nav-link" href="https://www.youtube.com/channel/UCDAYn_VFt0VisL5-1a5Dk7Q/">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon></svg>
          </a>
        </li>
        <li class="nav-item ms-3">
          <a class="nav-link theme-switcher-btn" id="darkmode" onclick="toggle_dark_mode()" href="#">
            <span id="light-mode-icon">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </span>
            <span id="dark-mode-icon">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="content">
  <div class="container">
    <div class="container pt-10">
        <h3 class="mb-3 fw-bold display-6 pt-4">pararules</h3>
        <p class="tags">
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">rules</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">rete</button></a>
                </span>
            
        </p>
        <p class="pkg-desc">some("A rules engine")</p>
        <a title="Copy" onclick="document.querySelector('#cmd').select();document.execCommand('copy');"
            alt="Copy on clipboard">
            <i class="fa fa-copy"></i>
        </a>
        <input id="cmd" onclick="this.select();" value="nimble install pararules" readonly="">
        <br>
        <small style="font-size: 0.8rem;">Need help? Read <a
                href="https://github.com/nim-lang/nimble#creating-packages">Nimble</a></small>
    </div>

    <div class="container row pt-4" id="pkg-content">
        <div class="col-8 box rounded p-3" id="readme-section">
            
                <document><p>Pararules is the first RETE-based rules engine made for games, having broad applicability to other kinds of programs as well. Rules engines have been around since the 70s, but for some reason, they haven&apos;t found their way into games yet. With pararules, you can store the entire state of your game and express the logic as a simple series of independent rules.</p>
<p>On the surface, this bears a resemblence to ECSs (entity component systems), but a rules engine can be much more powerful. Rules are fundamentally <em>reactive</em> -- they fire when their data is updated, they can create derived facts that always remain up-to-date, and they can trigger other rules in turn.</p>
<p>You can see it in action in the <a href="https://github.com/paranim/parakeet">parakeet</a> example game and the other <a href="https://github.com/paranim/paranim_examples">paranim examples</a>. Also watch <a href="https://www.youtube.com/watch?v=uYFEJUEOHPI">the FOSDEM 2022 talk</a>.</p>
<h2>Table of contents</h2>
<ul>
<li>  <a href="#start-with-the-data">Start with the data</a></li>
<li>  <a href="#your-first-rule">Your first rule</a></li>
<li>  <a href="#updating-the-session-from-inside-a-rule">Updating the session from inside a rule</a></li>
<li>  <a href="#queries">Queries</a></li>
<li>  <a href="#rulesets">Rulesets</a></li>
<li>  <a href="#avoiding-infinite-loops">Avoiding infinite loops</a></li>
<li>  <a href="#conditions">Conditions</a></li>
<li>  <a href="#complex-types">Complex types</a></li>
<li>  <a href="#joins">Joins</a></li>
<li>  <a href="#generating-ids">Generating ids</a></li>
<li>  <a href="#derived-facts">Derived facts</a></li>
<li>  <a href="#serializing-a-session">Serializing a session</a></li>
<li>  <a href="#performance">Performance</a></li>
<li>  <a href="#tips">Tips</a></li>
<li>  <a href="#wrap-up">Wrap up</a></li>
<li>  <a href="#comparison-to-clara-rules">Comparison to Clara Rules</a></li>
<li>  <a href="#acknowledgements">Acknowledgements</a></li>
</ul>
<h2>Start with the data</h2>
<p>Your data is stored as <code>(id, attribute, value)</code> tuples. For example, the player&apos;s X position might be <code>(Player, X, 100.0)</code>. The delta time (which is the number of seconds since the last frame) might be <code>(Global, DeltaTime, 0.0168121)</code>.</p>
<p>To do this, you need to first define your id and attribute enums, like this:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">type</span></div></div><div class="line"><div class="line-content">  <span class="ide">Id</span> <span class="op">=</span> <span class="kwd">enum</span></div></div><div class="line"><div class="line-content">    <span class="ide">Global</span>, <span class="ide">Player</span>,</div></div><div class="line"><div class="line-content">  <span class="ide">Attr</span> <span class="op">=</span> <span class="kwd">enum</span></div></div><div class="line"><div class="line-content">    <span class="ide">DeltaTime</span>, <span class="ide">TotalTime</span>,</div></div><div class="line"><div class="line-content">    <span class="ide">X</span>, <span class="ide">Y</span>,</div></div>  </code></pre>
<p>Then, you use the <code>schema</code> macro, which receives these two enums and defines what type the value will have for each attribute:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">schema</span> <span class="ide">Fact</span>(<span class="ide">Id</span>, <span class="ide">Attr</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">DeltaTime</span>: <span class="ide">float</span></div></div><div class="line"><div class="line-content">  <span class="ide">TotalTime</span>: <span class="ide">float</span></div></div><div class="line"><div class="line-content">  <span class="ide">X</span>: <span class="ide">float</span></div></div><div class="line"><div class="line-content">  <span class="ide">Y</span>: <span class="ide">float</span></div></div>  </code></pre>
<p>Underneath, this creates a new type called <code>Fact</code> which in Nim is called an <em>object variant</em> because it can store multiple types inside.</p>
<h2>Your first rule</h2>
<p>Let&apos;s start by just making a rule that prints out the <code>TotalTime</code> whenever it updates:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># create rule</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">rule1</span> <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="ide">rule</span> <span class="ide">printTime</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">      (<span class="ide">Global</span>, <span class="ide">TotalTime</span>, <span class="ide">tt</span>)</div></div><div class="line"><div class="line-content">    <span class="ide">then</span>:</div></div><div class="line"><div class="line-content">      <span class="ide">echo</span> <span class="ide">tt</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># create session and add rule</span></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">session</span> <span class="op">=</span> <span class="ide">initSession</span>(<span class="ide">Fact</span>)</div></div><div class="line"><div class="line-content"><span class="ide">session</span><span class="op">.</span><span class="ide">add</span>(<span class="ide">rule1</span>)</div></div>  </code></pre>
<p>The most important part of a rule is the <code>what</code> block, which specifies what tuples must exist for the rule to fire. The key is that you can create a <em>binding</em> in the id or value column by supplying a symbol that starts with a lowercase letter, like <code>tt</code> above. When the rule fires, the <code>then</code> block is executed, which has access to the bindings you created.</p>
<p>In your game loop, you can then insert the time values:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Global</span>, <span class="ide">DeltaTime</span>, <span class="ide">game</span><span class="op">.</span><span class="ide">deltaTime</span>)</div></div><div class="line"><div class="line-content"><span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Global</span>, <span class="ide">TotalTime</span>, <span class="ide">game</span><span class="op">.</span><span class="ide">totalTime</span>)</div></div>  </code></pre>
<p>The nice thing is that, if you insert something whose id + attribute combo already exists, it will simply replace it. So you can safely insert these values in your game loop without worrying that it will fill up with stale data.</p>
<h2>Updating the session from inside a rule</h2>
<p>Now imagine you want to make the player move to the right every time the frame is redrawn. Your rule might look like this:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">rule1</span> <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="ide">rule</span> <span class="ide">movePlayer</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">      (<span class="ide">Global</span>, <span class="ide">TotalTime</span>, <span class="ide">tt</span>)</div></div><div class="line"><div class="line-content">    <span class="ide">then</span>:</div></div><div class="line"><div class="line-content">      <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Player</span>, <span class="ide">X</span>, <span class="ide">tt</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">session</span> <span class="op">=</span> <span class="ide">initSession</span>(<span class="ide">Fact</span>)</div></div><div class="line"><div class="line-content"><span class="ide">session</span><span class="op">.</span><span class="ide">add</span>(<span class="ide">rule1</span>)</div></div>  </code></pre>
<p>This may look weird, because <code>session</code> is defined <em>after</em> the rule, but somehow the rule can still use it. This is because <code>then</code> blocks have an implicit <code>session</code> variable, which refers to whatever session the rule is part of. You should always use this when updating the session from within a rule.</p>
<h2>Queries</h2>
<p>Updating the player&apos;s <code>X</code> attribute isn&apos;t useful unless we can get the value externally to render it. To do this, make another rule that binds the values you would like to receive:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">rule2</span> <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="ide">rule</span> <span class="ide">getPlayer</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">      (<span class="ide">Player</span>, <span class="ide">X</span>, <span class="ide">x</span>)</div></div><div class="line"><div class="line-content">      (<span class="ide">Player</span>, <span class="ide">Y</span>, <span class="ide">y</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">session</span><span class="op">.</span><span class="ide">add</span>(<span class="ide">rule2</span>)</div></div>  </code></pre>
<p>As you can see, rules don&apos;t need a <code>then</code> block if you&apos;re only using them to query from the outside. In this case, we&apos;ll query it in our game loop and we&apos;ll get back a tuple whose fields have the names you created as bindings:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">player</span> <span class="op">=</span> <span class="ide">session</span><span class="op">.</span><span class="ide">query</span>(<span class="ide">rule2</span>)</div></div><div class="line"><div class="line-content"><span class="ide">echo</span> <span class="ide">player</span><span class="op">.</span><span class="ide">x</span>, <span class="str">&quot; &quot;</span>, <span class="ide">player</span><span class="op">.</span><span class="ide">y</span></div></div>  </code></pre>
<p>Be careful with <code>query</code>, though. If there are no results, this will cause an exception. You can use <code>queryAll</code> instead:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">results</span> <span class="op">=</span> <span class="ide">session</span><span class="op">.</span><span class="ide">queryAll</span>(<span class="ide">rule2</span>)</div></div><div class="line"><div class="line-content"><span class="kwd">if</span> <span class="ide">results</span><span class="op">.</span><span class="ide">len</span> <span class="op">&gt;</span> <span class="num">0</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">let</span> <span class="ide">player</span> <span class="op">=</span> <span class="ide">results</span>[<span class="num">0</span>]</div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="ide">player</span><span class="op">.</span><span class="ide">x</span>, <span class="str">&quot; &quot;</span>, <span class="ide">player</span><span class="op">.</span><span class="ide">y</span></div></div>  </code></pre>
<h2>Rulesets</h2>
<p>As a convenience, you can define your rules together like this:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">rules</span> <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="ide">ruleset</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">rule</span> <span class="ide">movePlayer</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">      <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">        (<span class="ide">Global</span>, <span class="ide">TotalTime</span>, <span class="ide">tt</span>)</div></div><div class="line"><div class="line-content">      <span class="ide">then</span>:</div></div><div class="line"><div class="line-content">        <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Player</span>, <span class="ide">X</span>, <span class="ide">tt</span>)</div></div><div class="line"><div class="line-content">    <span class="ide">rule</span> <span class="ide">getPlayer</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">      <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">        (<span class="ide">Player</span>, <span class="ide">X</span>, <span class="ide">x</span>)</div></div><div class="line"><div class="line-content">        (<span class="ide">Player</span>, <span class="ide">Y</span>, <span class="ide">y</span>)</div></div>  </code></pre>
<p>Then you can add them to a session all at once:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">for</span> <span class="ide">r</span> <span class="kwd">in</span> <span class="ide">rules</span><span class="op">.</span><span class="ide">fields</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">session</span><span class="op">.</span><span class="ide">add</span>(<span class="ide">r</span>)</div></div>  </code></pre>
<p>The <code>rules</code> value is a tuple whose fields have the same names as the rules&apos; names. This makes it nice to run queries:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">player</span> <span class="op">=</span> <span class="ide">session</span><span class="op">.</span><span class="ide">query</span>(<span class="ide">rules</span><span class="op">.</span><span class="ide">getPlayer</span>)</div></div><div class="line"><div class="line-content"><span class="ide">echo</span> <span class="ide">player</span><span class="op">.</span><span class="ide">x</span>, <span class="str">&quot; &quot;</span>, <span class="ide">player</span><span class="op">.</span><span class="ide">y</span></div></div>  </code></pre>
<h2>Avoiding infinite loops</h2>
<p>Imagine you want to move the player&apos;s position based on its current position. So instead of just using the total time, maybe we want to add the delta time to the player&apos;s latest <code>X</code> position:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">rule</span> <span class="ide">movePlayer</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">    (<span class="ide">Global</span>, <span class="ide">DeltaTime</span>, <span class="ide">dt</span>)</div></div><div class="line"><div class="line-content">    (<span class="ide">Player</span>, <span class="ide">X</span>, <span class="ide">x</span>)</div></div><div class="line"><div class="line-content">  <span class="ide">then</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Player</span>, <span class="ide">X</span>, <span class="ide">x</span> <span class="op">+</span> <span class="ide">dt</span>)</div></div>  </code></pre>
<p>If you try this, it will raise an expection because it hit the recursion limit. That&apos;s because you just created an infinite loop. The rule requires the player&apos;s <code>X</code> position and then updates it, which then causes the rule to fire again. The simple solution is to tell pararules that a certain tuple should not cause a rule&apos;s <code>then</code> block to re-fire when it updates:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">rule</span> <span class="ide">movePlayer</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">    (<span class="ide">Global</span>, <span class="ide">DeltaTime</span>, <span class="ide">dt</span>)</div></div><div class="line"><div class="line-content">    (<span class="ide">Player</span>, <span class="ide">X</span>, <span class="ide">x</span>, <span class="ide">then</span> <span class="op">=</span> <span class="ide">false</span>)</div></div><div class="line"><div class="line-content">  <span class="ide">then</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Player</span>, <span class="ide">X</span>, <span class="ide">x</span> <span class="op">+</span> <span class="ide">dt</span>)</div></div>  </code></pre>
<h2>Conditions</h2>
<p>Rules have nice a way of breaking apart your logic into independent units. If we want to prevent the player from moving off the right side of the screen, we could add a condition inside of the <code>then</code> block of <code>movePlayer</code>, but it&apos;s good to get in the habit of making separate rules.</p>
<p>To do so, we need to start storing the window size in the session. First, add the attributes:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">type</span></div></div><div class="line"><div class="line-content">  <span class="ide">Id</span> <span class="op">=</span> <span class="kwd">enum</span></div></div><div class="line"><div class="line-content">    <span class="ide">Global</span>, <span class="ide">Player</span>,</div></div><div class="line"><div class="line-content">  <span class="ide">Attr</span> <span class="op">=</span> <span class="kwd">enum</span></div></div><div class="line"><div class="line-content">    <span class="ide">DeltaTime</span>, <span class="ide">TotalTime</span>,</div></div><div class="line"><div class="line-content">    <span class="ide">X</span>, <span class="ide">Y</span>,</div></div><div class="line"><div class="line-content">    <span class="ide">WindowWidth</span>, <span class="ide">WindowHeight</span>,</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">schema</span> <span class="ide">Fact</span>(<span class="ide">Id</span>, <span class="ide">Attr</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">DeltaTime</span>: <span class="ide">float</span></div></div><div class="line"><div class="line-content">  <span class="ide">TotalTime</span>: <span class="ide">float</span></div></div><div class="line"><div class="line-content">  <span class="ide">X</span>: <span class="ide">float</span></div></div><div class="line"><div class="line-content">  <span class="ide">Y</span>: <span class="ide">float</span></div></div><div class="line"><div class="line-content">  <span class="ide">WindowWidth</span>: <span class="ide">int</span></div></div><div class="line"><div class="line-content">  <span class="ide">WindowHeight</span>: <span class="ide">int</span></div></div>  </code></pre>
<p>Then, wherever your window resize happens, insert the values:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">windowResized</span><span class="op">*</span>(<span class="ide">width</span>: <span class="ide">int</span>, <span class="ide">height</span>: <span class="ide">int</span>) <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Global</span>, <span class="ide">WindowWidth</span>, <span class="ide">width</span>)</div></div><div class="line"><div class="line-content">  <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Global</span>, <span class="ide">WindowHeight</span>, <span class="ide">height</span>)</div></div>  </code></pre>
<p>Finally, we make the rule:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">rule</span> <span class="ide">stopPlayer</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">    (<span class="ide">Player</span>, <span class="ide">X</span>, <span class="ide">x</span>)</div></div><div class="line"><div class="line-content">    (<span class="ide">Global</span>, <span class="ide">WindowWidth</span>, <span class="ide">windowWidth</span>)</div></div><div class="line"><div class="line-content">  <span class="ide">then</span>:</div></div><div class="line"><div class="line-content">    <span class="kwd">if</span> <span class="ide">x</span> <span class="op">&gt;=</span> <span class="ide">float</span>(<span class="ide">windowWidth</span>):</div></div><div class="line"><div class="line-content">      <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Player</span>, <span class="ide">X</span>, <span class="num">0.0</span>)</div></div>  </code></pre>
<p>Notice that we <em>don&apos;t</em> need <code>then = false</code> this time, because the condition is preventing the rule from re-firing (unless the <code>windowWidth</code> is 0, that is!).</p>
<p>While the above code works, you can also put your condition in a special <code>cond</code> block:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">rule</span> <span class="ide">stopPlayer</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">    (<span class="ide">Global</span>, <span class="ide">WindowWidth</span>, <span class="ide">windowWidth</span>)</div></div><div class="line"><div class="line-content">    (<span class="ide">Player</span>, <span class="ide">X</span>, <span class="ide">x</span>)</div></div><div class="line"><div class="line-content">  <span class="ide">cond</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">x</span> <span class="op">&gt;=</span> <span class="ide">float</span>(<span class="ide">windowWidth</span>)</div></div><div class="line"><div class="line-content">  <span class="ide">then</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Player</span>, <span class="ide">X</span>, <span class="num">0.0</span>)</div></div>  </code></pre>
<p>You can add as many conditions as you want, and they will implicitly work as if they were combined together with <code>and</code>:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">rule</span> <span class="ide">stopPlayer</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">    (<span class="ide">Global</span>, <span class="ide">WindowWidth</span>, <span class="ide">windowWidth</span>)</div></div><div class="line"><div class="line-content">    (<span class="ide">Player</span>, <span class="ide">X</span>, <span class="ide">x</span>)</div></div><div class="line"><div class="line-content">  <span class="ide">cond</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">x</span> <span class="op">&gt;=</span> <span class="ide">float</span>(<span class="ide">windowWidth</span>)</div></div><div class="line"><div class="line-content">    <span class="ide">windowWidth</span> <span class="op">&gt;</span> <span class="num">0</span></div></div><div class="line"><div class="line-content">  <span class="ide">then</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Player</span>, <span class="ide">X</span>, <span class="num">0.0</span>)</div></div>  </code></pre>
<p>Using a <code>cond</code> block is better because it also affects the results of <code>queryAll</code> -- matches that didn&apos;t pass the conditions will not be included. Also, in the future I&apos;ll probably be able to create more optimal code because it will let me run those conditions earlier in the network.</p>
<h2>Complex types</h2>
<p>Pararules is not limited to storing scalar types like <code>float</code> and <code>int</code> — you can use any type you want. For example, to store the currently-pressed keys, you can import the <code>sets</code> module and use a <code>HashSet[int]</code> to store them. However, you need to use a type alias when specifying it in the schema:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">type</span></div></div><div class="line"><div class="line-content">  <span class="ide">Id</span> <span class="op">=</span> <span class="kwd">enum</span></div></div><div class="line"><div class="line-content">    <span class="ide">Global</span>, <span class="ide">Player</span>,</div></div><div class="line"><div class="line-content">  <span class="ide">Attr</span> <span class="op">=</span> <span class="kwd">enum</span></div></div><div class="line"><div class="line-content">    <span class="ide">DeltaTime</span>, <span class="ide">TotalTime</span>,</div></div><div class="line"><div class="line-content">    <span class="ide">X</span>, <span class="ide">Y</span>,</div></div><div class="line"><div class="line-content">    <span class="ide">WindowWidth</span>, <span class="ide">WindowHeight</span>,</div></div><div class="line"><div class="line-content">    <span class="ide">PressedKeys</span>,</div></div><div class="line"><div class="line-content">  <span class="ide">IntSet</span> <span class="op">=</span> <span class="ide">HashSet</span>[<span class="ide">int</span>]</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">schema</span> <span class="ide">Fact</span>(<span class="ide">Id</span>, <span class="ide">Attr</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">DeltaTime</span>: <span class="ide">float</span></div></div><div class="line"><div class="line-content">  <span class="ide">TotalTime</span>: <span class="ide">float</span></div></div><div class="line"><div class="line-content">  <span class="ide">X</span>: <span class="ide">float</span></div></div><div class="line"><div class="line-content">  <span class="ide">Y</span>: <span class="ide">float</span></div></div><div class="line"><div class="line-content">  <span class="ide">WindowWidth</span>: <span class="ide">int</span></div></div><div class="line"><div class="line-content">  <span class="ide">WindowHeight</span>: <span class="ide">int</span></div></div><div class="line"><div class="line-content">  <span class="ide">PressedKeys</span>: <span class="ide">IntSet</span></div></div>  </code></pre>
<p>If you put <code>HashSet[int]</code> directly in the <code>schema</code> macro, it will fail, because it wants a simple name to refer to it by. Also note that if you create two type aliases that point to the same type, the schema macro will complain...so don&apos;t do that. These are just implementation restrictions right now.</p>
<p>When you initialize your game, you can put an empty set in it:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Global</span>, <span class="ide">PressedKeys</span>, <span class="ide">initHashSet</span>[<span class="ide">int</span>]())</div></div>  </code></pre>
<p>Then add a rule to get the keys:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">rule</span> <span class="ide">getKeys</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">    (<span class="ide">Global</span>, <span class="ide">PressedKeys</span>, <span class="ide">keys</span>)</div></div>  </code></pre>
<p>Wherever your key up/down events are, you can update the keys:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">keyPressed</span><span class="op">*</span>(<span class="ide">key</span>: <span class="ide">int</span>) <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="kwd">var</span> (<span class="ide">keys</span>) <span class="op">=</span> <span class="ide">session</span><span class="op">.</span><span class="ide">query</span>(<span class="ide">rules</span><span class="op">.</span><span class="ide">getKeys</span>)</div></div><div class="line"><div class="line-content">  <span class="ide">keys</span><span class="op">.</span><span class="ide">incl</span>(<span class="ide">key</span>)</div></div><div class="line"><div class="line-content">  <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Global</span>, <span class="ide">PressedKeys</span>, <span class="ide">keys</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">keyReleased</span><span class="op">*</span>(<span class="ide">key</span>: <span class="ide">int</span>) <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="kwd">var</span> (<span class="ide">keys</span>) <span class="op">=</span> <span class="ide">session</span><span class="op">.</span><span class="ide">query</span>(<span class="ide">rules</span><span class="op">.</span><span class="ide">getKeys</span>)</div></div><div class="line"><div class="line-content">  <span class="ide">keys</span><span class="op">.</span><span class="ide">excl</span>(<span class="ide">key</span>)</div></div><div class="line"><div class="line-content">  <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Global</span>, <span class="ide">PressedKeys</span>, <span class="ide">keys</span>)</div></div>  </code></pre>
<p>You can see we are destructuring the <code>keys</code> out of the tuple, modifying it, and then updating <code>PressedKeys</code> with it. Now we can modify <code>movePlayer</code> to change the player&apos;s <code>X</code> position based on the arrow keys:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">rule</span> <span class="ide">movePlayer</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">    (<span class="ide">Global</span>, <span class="ide">DeltaTime</span>, <span class="ide">dt</span>)</div></div><div class="line"><div class="line-content">    (<span class="ide">Global</span>, <span class="ide">PressedKeys</span>, <span class="ide">keys</span>, <span class="ide">then</span> <span class="op">=</span> <span class="ide">false</span>)</div></div><div class="line"><div class="line-content">    (<span class="ide">Player</span>, <span class="ide">X</span>, <span class="ide">x</span>, <span class="ide">then</span> <span class="op">=</span> <span class="ide">false</span>)</div></div><div class="line"><div class="line-content">  <span class="ide">then</span>:</div></div><div class="line"><div class="line-content">    <span class="kwd">if</span> <span class="ide">keys</span><span class="op">.</span><span class="ide">contains</span>(<span class="num">263</span>): <span class="com"># left arrow</span></div></div><div class="line"><div class="line-content">      <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Player</span>, <span class="ide">X</span>, <span class="ide">x</span> <span class="op">-</span> <span class="num">1.0</span>)</div></div><div class="line"><div class="line-content">    <span class="kwd">elif</span> <span class="ide">keys</span><span class="op">.</span><span class="ide">contains</span>(<span class="num">262</span>): <span class="com"># right arrow</span></div></div><div class="line"><div class="line-content">      <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Player</span>, <span class="ide">X</span>, <span class="ide">x</span> <span class="op">+</span> <span class="num">1.0</span>)</div></div>  </code></pre>
<p>Notice that we aren&apos;t even using <code>DeltaTime</code> anymore, but we&apos;re keeping it in the <code>what</code> block so the rule continues to fire every frame. If all tuples in the <code>what</code> block have <code>then = false</code>, it will never fire. This way, it will move the player exactly one pixel each frame that an arrow key is pressed. Not exactly the best way to do character movement, but you get the idea.</p>
<h2>Joins</h2>
<p>Instead of the <code>getPlayer</code> rule, we could make a more generic &quot;getter&quot; rule that works for any id:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">rule</span> <span class="ide">getCharacter</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">    (<span class="ide">id</span>, <span class="ide">X</span>, <span class="ide">x</span>)</div></div><div class="line"><div class="line-content">    (<span class="ide">id</span>, <span class="ide">Y</span>, <span class="ide">y</span>)</div></div>  </code></pre>
<p>Now, we&apos;re making a binding on the id column, and since we&apos;re using the same binding symbol (&quot;id&quot;) in both, pararules will ensure that they are equal, much like a join in SQL.</p>
<p>We can query it just as before, but if you want to make sure it returns the data for <code>Player</code>, you can add that as a filter to the query:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">player</span> <span class="op">=</span> <span class="ide">session</span><span class="op">.</span><span class="ide">query</span>(<span class="ide">rules</span><span class="op">.</span><span class="ide">getCharacter</span>, <span class="ide">id</span> <span class="op">=</span> <span class="ide">Player</span>)</div></div><div class="line"><div class="line-content"><span class="ide">echo</span> <span class="ide">player</span><span class="op">.</span><span class="ide">x</span>, <span class="str">&quot; &quot;</span>, <span class="ide">player</span><span class="op">.</span><span class="ide">y</span></div></div>  </code></pre>
<p>You can also use <code>queryAll</code> to retrieve all results and filter afterwards:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">chars</span> <span class="op">=</span> <span class="ide">session</span><span class="op">.</span><span class="ide">queryAll</span>(<span class="ide">rules</span><span class="op">.</span><span class="ide">getCharacter</span>)</div></div><div class="line"><div class="line-content"><span class="kwd">for</span> <span class="ide">c</span> <span class="kwd">in</span> <span class="ide">chars</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">if</span> <span class="ide">c</span><span class="op">.</span><span class="ide">id</span> <span class="op">==</span> <span class="ide">Player</span><span class="op">.</span><span class="ide">ord</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="ide">c</span><span class="op">.</span><span class="ide">x</span>, <span class="str">&quot; &quot;</span>, <span class="ide">c</span><span class="op">.</span><span class="ide">y</span></div></div>  </code></pre>
<h2>Generating ids</h2>
<p>In addition to known ids like <code>Player</code>, it is likely that you&apos;ll want to generate ids at runtime. For example, if you just want to spawn random enemies, you probably don&apos;t want to create a special id in the enum for each one. For this reason, <code>insert</code> allows you to just pass arbitrary integers as ids:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">nextId</span> <span class="op">=</span> <span class="ide">Id</span><span class="op">.</span><span class="ide">high</span><span class="op">.</span><span class="ide">ord</span> <span class="op">+</span> <span class="num">1</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">for</span> <span class="ide">_</span> <span class="kwd">in</span> <span class="num">0</span> <span class="op">..&lt;</span> <span class="num">5</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">nextId</span>, <span class="ide">X</span>, <span class="ide">rand</span>(<span class="num">50.0</span>))</div></div><div class="line"><div class="line-content">  <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">nextId</span>, <span class="ide">Y</span>, <span class="ide">rand</span>(<span class="num">50.0</span>))</div></div><div class="line"><div class="line-content">  <span class="ide">nextId</span> <span class="op">+=</span> <span class="num">1</span></div></div>  </code></pre>
<p>By starting the ids at <code>Id.high.ord + 1</code>, we begin using the first integer after <code>Player</code>. This is important, because if you use anything lower, it&apos;ll overlap with one of the known ids:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># these modify the same id</span></div></div><div class="line"><div class="line-content"><span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="num">1</span>, <span class="ide">X</span>, <span class="ide">rand</span>(<span class="num">50.0</span>))</div></div><div class="line"><div class="line-content"><span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Player</span>, <span class="ide">X</span>, <span class="ide">rand</span>(<span class="num">50.0</span>))</div></div>  </code></pre>
<p>This is also why the following is a compile error:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">rule</span> <span class="ide">getCharacter</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">    (<span class="ide">id</span>, <span class="ide">X</span>, <span class="ide">x</span>)</div></div><div class="line"><div class="line-content">    (<span class="ide">id</span>, <span class="ide">Y</span>, <span class="ide">y</span>)</div></div><div class="line"><div class="line-content">  <span class="ide">cond</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">id</span> <span class="op">!=</span> <span class="ide">Player</span> <span class="com"># type mismatch: got &lt;int, Id&gt;</span></div></div>  </code></pre>
<p>You need to write <code>id != Player.ord</code> instead, because pararules transforms all ids to normal integers and gives them back that way.</p>
<h2>Derived facts</h2>
<p>Sometimes we want to make a rule that receives a <em>collection</em> of facts. This is done by creating facts that are derived from other facts.</p>
<p>If you want to create a fact that contains all characters, one clever way to do it is to run a query in the <code>getCharacter</code> rule, and insert the result as a new fact:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">rule</span> <span class="ide">getCharacter</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">    (<span class="ide">id</span>, <span class="ide">X</span>, <span class="ide">x</span>)</div></div><div class="line"><div class="line-content">    (<span class="ide">id</span>, <span class="ide">Y</span>, <span class="ide">y</span>)</div></div><div class="line"><div class="line-content">  <span class="ide">then</span>:</div></div><div class="line"><div class="line-content">    <span class="kwd">let</span> <span class="ide">chars</span> <span class="op">=</span> <span class="ide">session</span><span class="op">.</span><span class="ide">queryAll</span>(<span class="ide">this</span>)</div></div><div class="line"><div class="line-content">    <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Derived</span>, <span class="ide">AllCharacters</span>, <span class="ide">chars</span>)</div></div><div class="line"><div class="line-content"><span class="ide">rule</span> <span class="ide">printAllCharacters</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">    (<span class="ide">Derived</span>, <span class="ide">AllCharacters</span>, <span class="ide">chars</span>)</div></div><div class="line"><div class="line-content">  <span class="ide">then</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;All characters: &quot;</span>, <span class="ide">chars</span></div></div>  </code></pre>
<p>The special <code>this</code> symbol refers to the rule itself, so it&apos;s the same as running <code>session.queryAll(rules.getCharacter)</code>. Every time <em>any</em> character is updated, the query is run again and the derived fact is updated.</p>
<p>For this to work, we need to add a few things to the types at the top:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">type</span></div></div><div class="line"><div class="line-content">  <span class="com"># update the enums</span></div></div><div class="line"><div class="line-content">  <span class="ide">Id</span> <span class="op">=</span> <span class="kwd">enum</span></div></div><div class="line"><div class="line-content">    <span class="com"># ...</span></div></div><div class="line"><div class="line-content">    <span class="ide">Derived</span></div></div><div class="line"><div class="line-content">  <span class="ide">Attr</span> <span class="op">=</span> <span class="kwd">enum</span></div></div><div class="line"><div class="line-content">    <span class="com"># ...</span></div></div><div class="line"><div class="line-content">    <span class="ide">AllCharacters</span></div></div><div class="line"><div class="line-content">  <span class="com"># define a type to store the query results</span></div></div><div class="line"><div class="line-content">  <span class="ide">Characters</span> <span class="op">=</span> <span class="ide">seq</span>[<span class="kwd">tuple</span>[<span class="ide">id</span>: <span class="ide">int</span>, <span class="ide">x</span>: <span class="ide">float</span>, <span class="ide">y</span>: <span class="ide">float</span>]]</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># update the schema</span></div></div><div class="line"><div class="line-content"><span class="ide">schema</span> <span class="ide">Fact</span>(<span class="ide">Id</span>, <span class="ide">Attr</span>):</div></div><div class="line"><div class="line-content">  <span class="com"># ...</span></div></div><div class="line"><div class="line-content">  <span class="ide">AllCharacters</span>: <span class="ide">Characters</span></div></div>  </code></pre>
<p>When we insert our random enemies, it seems to work:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">nextId</span> <span class="op">=</span> <span class="ide">Id</span><span class="op">.</span><span class="ide">high</span><span class="op">.</span><span class="ide">ord</span> <span class="op">+</span> <span class="num">1</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">for</span> <span class="ide">_</span> <span class="kwd">in</span> <span class="num">0</span> <span class="op">..&lt;</span> <span class="num">5</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">nextId</span>, <span class="ide">X</span>, <span class="ide">rand</span>(<span class="num">50.0</span>))</div></div><div class="line"><div class="line-content">  <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">nextId</span>, <span class="ide">Y</span>, <span class="ide">rand</span>(<span class="num">50.0</span>))</div></div><div class="line"><div class="line-content">  <span class="ide">nextId</span> <span class="op">+=</span> <span class="num">1</span></div></div><div class="line"><div class="line-content"><span class="com"># All characters: @[(id: 3, x: 9.394868845262195, y: 25.43175850160218), (id: 4, x: 11.17467397291547, y: 41.71452255154022), (id: 7, x: 30.03014845607234, y: 48.31479800236611), (id: 5, x: 0.5064720243960097, y: 27.21672010097956), (id: 6, x: 8.553239146114377, y: 9.315216984770858)]</span></div></div>  </code></pre>
<p>But what happens if we retract one?</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">session</span><span class="op">.</span><span class="ide">retract</span>(<span class="num">3</span>, <span class="ide">X</span>)</div></div><div class="line"><div class="line-content"><span class="ide">session</span><span class="op">.</span><span class="ide">retract</span>(<span class="num">3</span>, <span class="ide">Y</span>)</div></div>  </code></pre>
<p>It didn&apos;t print, which means the <code>AllCharacters</code> fact hasn&apos;t been updated! This is because <code>then</code> blocks only run on insertions, not retractions. After all, if facts pertinent to a rule are retracted, the match will be incomplete, and there will be nothing to bind the symbols from the <code>what</code> block to.</p>
<p>The solution is to use <code>thenFinally</code>:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">rule</span> <span class="ide">getCharacter</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">    (<span class="ide">id</span>, <span class="ide">X</span>, <span class="ide">x</span>)</div></div><div class="line"><div class="line-content">    (<span class="ide">id</span>, <span class="ide">Y</span>, <span class="ide">y</span>)</div></div><div class="line"><div class="line-content">  <span class="ide">thenFinally</span>:</div></div><div class="line"><div class="line-content">    <span class="kwd">let</span> <span class="ide">chars</span> <span class="op">=</span> <span class="ide">session</span><span class="op">.</span><span class="ide">queryAll</span>(<span class="ide">this</span>)</div></div><div class="line"><div class="line-content">    <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Derived</span>, <span class="ide">AllCharacters</span>, <span class="ide">chars</span>)</div></div>  </code></pre>
<p>A <code>thenFinally</code> block runs when a rule&apos;s matches are changed at all, including from retractions. This also means you won&apos;t have access to the bindings from the <code>what</code> block, so if you want to run code on each individual match, you need to use a normal <code>then</code> block before it.</p>
<p>One last thing: it is <em>highly</em> recommended that you use reference types like <code>ref seq</code>, rather than value types like <code>seq</code>, unless you are sure they will be small. Many copies of facts are made inside the session, so this could be a significant performance problem if you store collections that copy by value.</p>
<p>The example above could be changed to declare the <code>Characters</code> type like this:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">type</span></div></div><div class="line"><div class="line-content">  <span class="com"># ...</span></div></div><div class="line"><div class="line-content">  <span class="ide">Characters</span> <span class="op">=</span> <span class="kwd">ref</span> <span class="ide">seq</span>[<span class="kwd">tuple</span>[<span class="ide">id</span>: <span class="ide">int</span>, <span class="ide">x</span>: <span class="ide">float</span>, <span class="ide">y</span>: <span class="ide">float</span>]]</div></div>  </code></pre>
<p>And then the rule could be changed like this:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">rule</span> <span class="ide">getCharacter</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">    (<span class="ide">id</span>, <span class="ide">X</span>, <span class="ide">x</span>)</div></div><div class="line"><div class="line-content">    (<span class="ide">id</span>, <span class="ide">Y</span>, <span class="ide">y</span>)</div></div><div class="line"><div class="line-content">  <span class="ide">thenFinally</span>:</div></div><div class="line"><div class="line-content">    <span class="kwd">var</span> <span class="ide">chars</span>: <span class="ide">Characters</span> <span class="op">=</span> <span class="kwd">nil</span></div></div><div class="line"><div class="line-content">    <span class="ide">new</span> <span class="ide">chars</span></div></div><div class="line"><div class="line-content">    <span class="ide">chars</span>[] <span class="op">=</span> <span class="ide">session</span><span class="op">.</span><span class="ide">queryAll</span>(<span class="ide">this</span>)</div></div><div class="line"><div class="line-content">    <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Derived</span>, <span class="ide">AllCharacters</span>, <span class="ide">chars</span>)</div></div>  </code></pre>
<h2>Serializing a session</h2>
<p>To save a session to the disk or send it over a network, we need to serialize it somehow. It wouldn&apos;t be a good idea to directly serialize the session. It would prevent you from updating your rules, or possibly even the version of this library, due to all the implementation details contained in the session after deserializing it.</p>
<p>Instead, it makes more sense to just serialize the <em>facts</em>. There is an overload of <code>queryAll</code> that returns a sequence of all the individual facts that were inserted:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">facts</span> <span class="op">=</span> <span class="ide">session</span><span class="op">.</span><span class="ide">queryAll</span>()</div></div><div class="line"><div class="line-content"><span class="ide">echo</span> <span class="ide">facts</span></div></div><div class="line"><div class="line-content"><span class="com"># @[(id: 2, attr: 13, value: Fact(...)), (id: 7, attr: 3, value: Fact(...)), (id: 5, attr: 2, value: Fact(...)), (id: 4, attr: 3, value: Fact(...)), (id: 6, attr: 3, value: Fact(...)), (id: 5, attr: 3, value: Fact(...)), (id: 6, attr: 2, value: Fact(...)), (id: 4, attr: 2, value: Fact(...)), (id: 3, attr: 3, value: Fact(...)), (id: 7, attr: 2, value: Fact(...)), (id: 3, attr: 2, value: Fact(...))]</span></div></div>  </code></pre>
<p>As you can see, it returns the data as <code>(int, int, Fact)</code> tuples. The id and attr have been converted to integers, but you can cast them back to enums:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">fact</span> <span class="op">=</span> <span class="ide">facts</span>[<span class="num">0</span>]</div></div><div class="line"><div class="line-content"><span class="ide">echo</span> <span class="ide">Id</span>(<span class="ide">fact</span><span class="op">.</span><span class="ide">id</span>)</div></div><div class="line"><div class="line-content"><span class="ide">echo</span> <span class="ide">Attr</span>(<span class="ide">fact</span><span class="op">.</span><span class="ide">attr</span>)</div></div>  </code></pre>
<p>The value is of the type we defined with the <code>schema</code> macro, which is an object variant. You can pull out the value within it using <code>unwrap</code>:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">for</span> <span class="ide">fact</span> <span class="kwd">in</span> <span class="ide">facts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">case</span> <span class="ide">Attr</span>(<span class="ide">fact</span><span class="op">.</span><span class="ide">attr</span>):</div></div><div class="line"><div class="line-content">    <span class="kwd">of</span> <span class="ide">X</span>, <span class="ide">Y</span>:</div></div><div class="line"><div class="line-content">      <span class="ide">echo</span> <span class="ide">unwrap</span>(<span class="ide">fact</span><span class="op">.</span><span class="ide">value</span>, <span class="ide">float</span>)</div></div><div class="line"><div class="line-content">    <span class="kwd">of</span> <span class="ide">AllCharacters</span>:</div></div><div class="line"><div class="line-content">      <span class="ide">echo</span> <span class="ide">unwrap</span>(<span class="ide">fact</span><span class="op">.</span><span class="ide">value</span>, <span class="ide">Characters</span>)</div></div><div class="line"><div class="line-content">    <span class="kwd">else</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">discard</span></div></div>  </code></pre>
<p>Notice that it includes the <code>AllCharacters</code> derived fact that we made before. There is no need to serialize derived facts -- they can be derived later, so it&apos;s a waste of space. We can filter them out before serializing:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">primaryFacts</span>: <span class="ide">seq</span>[(<span class="ide">int</span>, <span class="ide">int</span>, <span class="ide">Fact</span>)]</div></div><div class="line"><div class="line-content"><span class="kwd">for</span> <span class="ide">fact</span> <span class="kwd">in</span> <span class="ide">facts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">if</span> <span class="ide">fact</span><span class="op">.</span><span class="ide">id</span> <span class="op">!=</span> <span class="ide">Derived</span><span class="op">.</span><span class="ide">ord</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">primaryFacts</span><span class="op">.</span><span class="ide">add</span>(<span class="ide">fact</span>)</div></div>  </code></pre>
<p>How you go about serializing the facts is up to you. When you deserialize them later, simply <code>insert</code> them into your session again.</p>
<p>Keep in mind that, if you save the ids and attrs as integers, they need to remain stable -- that is, you can&apos;t move items around in those enums, because they won&apos;t match up when you deserialize your facts later.</p>
<h2>Performance</h2>
<h3>Disabling auto fire</h3>
<p>By default, rules are fired after every <code>insert</code> call. This can be inefficient; you should normally only fire the rules once per frame. You can disable this when creating your session:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">session</span> <span class="op">=</span> <span class="ide">initSession</span>(<span class="ide">Fact</span>, <span class="ide">autoFire</span> <span class="op">=</span> <span class="ide">false</span>)</div></div>  </code></pre>
<p>Then, you need to explicitly fire the rules:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Global</span>, <span class="ide">DeltaTime</span>, <span class="ide">game</span><span class="op">.</span><span class="ide">deltaTime</span>)</div></div><div class="line"><div class="line-content"><span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Global</span>, <span class="ide">TotalTime</span>, <span class="ide">game</span><span class="op">.</span><span class="ide">totalTime</span>)</div></div><div class="line"><div class="line-content"><span class="ide">session</span><span class="op">.</span><span class="ide">fireRules</span>()</div></div>  </code></pre>
<h3>Using staticRuleset</h3>
<p>Additionally, a very significant performance gain can be had by taking advantage of Nim&apos;s macro system to define your rules &quot;statically&quot;:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">let</span> (<span class="ide">initSession</span>, <span class="ide">rules</span>) <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="ide">staticRuleset</span>(<span class="ide">Fact</span>, <span class="ide">FactMatch</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">rule</span> <span class="ide">getPlayer</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">      <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">        (<span class="ide">Player</span>, <span class="ide">X</span>, <span class="ide">x</span>)</div></div><div class="line"><div class="line-content">        (<span class="ide">Player</span>, <span class="ide">Y</span>, <span class="ide">y</span>)</div></div><div class="line"><div class="line-content">    <span class="ide">rule</span> <span class="ide">movePlayer</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">      <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">        (<span class="ide">Global</span>, <span class="ide">DeltaTime</span>, <span class="ide">dt</span>)</div></div><div class="line"><div class="line-content">        (<span class="ide">Global</span>, <span class="ide">PressedKeys</span>, <span class="ide">keys</span>, <span class="ide">then</span> <span class="op">=</span> <span class="ide">false</span>)</div></div><div class="line"><div class="line-content">        (<span class="ide">Player</span>, <span class="ide">X</span>, <span class="ide">x</span>, <span class="ide">then</span> <span class="op">=</span> <span class="ide">false</span>)</div></div><div class="line"><div class="line-content">      <span class="ide">then</span>:</div></div><div class="line"><div class="line-content">        <span class="kwd">if</span> <span class="ide">keys</span><span class="op">.</span><span class="ide">contains</span>(<span class="num">263</span>): <span class="com"># left arrow</span></div></div><div class="line"><div class="line-content">          <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Player</span>, <span class="ide">X</span>, <span class="ide">x</span> <span class="op">-</span> <span class="num">1.0</span>)</div></div><div class="line"><div class="line-content">        <span class="kwd">elif</span> <span class="ide">keys</span><span class="op">.</span><span class="ide">contains</span>(<span class="num">262</span>): <span class="com"># right arrow</span></div></div><div class="line"><div class="line-content">          <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Player</span>, <span class="ide">X</span>, <span class="ide">x</span> <span class="op">+</span> <span class="num">1.0</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">session</span>: <span class="ide">Session</span>[<span class="ide">Fact</span>, <span class="ide">FactMatch</span>] <span class="op">=</span> <span class="ide">initSession</span>(<span class="ide">autoFire</span> <span class="op">=</span> <span class="ide">false</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">for</span> <span class="ide">r</span> <span class="kwd">in</span> <span class="ide">rules</span><span class="op">.</span><span class="ide">fields</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">session</span><span class="op">.</span><span class="ide">add</span>(<span class="ide">r</span>)</div></div>  </code></pre>
<p>This is not a superficial syntax change; there is a very big internal difference. Since <code>staticRuleset</code> knows all of your session&apos;s rules at compile time, it is able to generate a special type to store the matches (in the example above, this type is called <code>FactMatch</code>). Normally, matches are stored in tables, which are significantly slower.</p>
<p>You must call <code>staticRuleset</code> at the top-level of your module because it&apos;s creating exported types. As arguments, it receives the base and match type and then the rules. It returns a tuple containing a special <code>initSession</code> proc as well as the <code>rules</code> tuple (similar to what you&apos;d get from <code>ruleset</code>).</p>
<p>There are a few downsides:</p>
<ol>
<li>You will not be able to <code>add</code> other rules later, because it must know all of its rules at compile time.</li>
<li>Compile times will slow down as more rules are added.</li>
</ol>
<p>You may think that an additional downside is that you now must define all your rules in one place, without the flexibility to separate them into different modules. This actually isn&apos;t true: you can define your rules separately and use a &quot;wrapper&quot; macro to put them into <code>staticRuleset</code> at compile time. This is a bit advanced, but see <a href="tests/test3.nim">the test</a> for an example of this.</p>
<h3>Using ref types</h3>
<p>As mentioned before, it is <em>highly</em> recommended that you use reference types like <code>ref seq</code>, rather than value types like <code>seq</code>, to store collections in the session. Many copies of facts are made inside the session, so this could be a significant performance problem if you store collections that copy by value.</p>
<p>For example, to store a sequence of tuples as a fact, it might look like this:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">type</span> <span class="ide">Characters</span> <span class="op">=</span> <span class="kwd">ref</span> <span class="ide">seq</span>[<span class="kwd">tuple</span>[<span class="ide">id</span>: <span class="ide">int</span>, <span class="ide">x</span>: <span class="ide">float</span>, <span class="ide">y</span>: <span class="ide">float</span>]]</div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">chars</span>: <span class="ide">Characters</span> <span class="op">=</span> <span class="kwd">nil</span></div></div><div class="line"><div class="line-content"><span class="ide">new</span> <span class="ide">chars</span></div></div><div class="line"><div class="line-content"><span class="ide">chars</span>[] <span class="op">=</span> <span class="ide">session</span><span class="op">.</span><span class="ide">queryAll</span>(<span class="ide">rules</span><span class="op">.</span><span class="ide">getCharacter</span>)</div></div><div class="line"><div class="line-content"><span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Derived</span>, <span class="ide">AllCharacters</span>, <span class="ide">chars</span>)</div></div>  </code></pre>
<h3>Using derived facts</h3>
<p>In any non-trivial project, you&apos;ll end up with a lot of rules that share some common tuples in their <code>what</code> blocks, like this:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">rules</span> <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="ide">ruleset</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">rule</span> <span class="ide">getCharacter</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">      <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">        (<span class="ide">id</span>, <span class="ide">X</span>, <span class="ide">x</span>)</div></div><div class="line"><div class="line-content">        (<span class="ide">id</span>, <span class="ide">Y</span>, <span class="ide">y</span>)</div></div><div class="line"><div class="line-content">    <span class="ide">rule</span> <span class="ide">moveCharacter</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">      <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">        (<span class="ide">Global</span>, <span class="ide">DeltaTime</span>, <span class="ide">dt</span>)</div></div><div class="line"><div class="line-content">        (<span class="ide">id</span>, <span class="ide">X</span>, <span class="ide">x</span>, <span class="ide">then</span> <span class="op">=</span> <span class="ide">false</span>)</div></div><div class="line"><div class="line-content">        (<span class="ide">id</span>, <span class="ide">Y</span>, <span class="ide">y</span>, <span class="ide">then</span> <span class="op">=</span> <span class="ide">false</span>)</div></div><div class="line"><div class="line-content">      <span class="ide">then</span>:</div></div><div class="line"><div class="line-content">        <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">id</span>, <span class="ide">X</span>, <span class="ide">x</span> <span class="op">+</span> <span class="ide">dt</span>)</div></div><div class="line"><div class="line-content">        <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">id</span>, <span class="ide">Y</span>, <span class="ide">y</span> <span class="op">+</span> <span class="ide">dt</span>)</div></div>  </code></pre>
<p>Here we have a <code>getCharacter</code> rule whose only purpose is for queries, and a <code>moveCharacter</code> rule that modifies it when the timestamp is updated. In both cases, there is a join on the <code>id</code> binding. Joins are not free -- they have a runtime cost, and in this case, that cost is paid twice.</p>
<p>In theory, this could be solved using a common optimization in rules engines calling node sharing. However, node sharing adds a lot of complexity to the codebase, and if it is automatic, it can be easily lost when subtle changes are made to a rule -- a regression that isn&apos;t easy to notice.</p>
<p>It turns out that a feature we&apos;ve already discussed can solve this: derived facts. The above example can be rewritten like this:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">rules</span> <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="ide">ruleset</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">rule</span> <span class="ide">getCharacter</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">      <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">        (<span class="ide">id</span>, <span class="ide">X</span>, <span class="ide">x</span>)</div></div><div class="line"><div class="line-content">        (<span class="ide">id</span>, <span class="ide">Y</span>, <span class="ide">y</span>)</div></div><div class="line"><div class="line-content">      <span class="ide">then</span>:</div></div><div class="line"><div class="line-content">        <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">id</span>, <span class="ide">Character</span>, <span class="ide">match</span>)</div></div><div class="line"><div class="line-content">    <span class="ide">rule</span> <span class="ide">moveCharacter</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">      <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">        (<span class="ide">Global</span>, <span class="ide">DeltaTime</span>, <span class="ide">dt</span>)</div></div><div class="line"><div class="line-content">        (<span class="ide">id</span>, <span class="ide">Character</span>, <span class="ide">ch</span>, <span class="ide">then</span> <span class="op">=</span> <span class="ide">false</span>)</div></div><div class="line"><div class="line-content">      <span class="ide">then</span>:</div></div><div class="line"><div class="line-content">        <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">id</span>, <span class="ide">X</span>, <span class="ide">ch</span><span class="op">.</span><span class="ide">x</span> <span class="op">+</span> <span class="ide">dt</span>)</div></div><div class="line"><div class="line-content">        <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">id</span>, <span class="ide">Y</span>, <span class="ide">ch</span><span class="op">.</span><span class="ide">y</span> <span class="op">+</span> <span class="ide">dt</span>)</div></div>  </code></pre>
<p>With <code>match</code> we can get all the bindings in a convenient tuple, such as <code>(id: 1, x: 10.0, y: 5.0)</code>. We then insert it as a derived fact, and bring it into the <code>moveCharacter</code> rule (the <code>Character</code> attribute, of course, must be added to the <code>Attr</code> enum and its type must be defined in the <code>schema</code>).</p>
<p>This will be faster because we now are only doing the join once, and all subsequent rules are just using the derived fact. As the number of joined tuples gets larger, the performance difference gets more and more substantial.</p>
<h2>Tips</h2>
<p>In <code>then</code> blocks, you can use the special <code>match</code> symbol to access all the bound values in a single tuple:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">session</span> <span class="op">=</span> <span class="ide">initSession</span>(<span class="ide">Fact</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">session</span><span class="op">.</span><span class="ide">add</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">rule</span> <span class="ide">getCharacter</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">      (<span class="ide">id</span>, <span class="ide">X</span>, <span class="ide">x</span>)</div></div><div class="line"><div class="line-content">      (<span class="ide">id</span>, <span class="ide">Y</span>, <span class="ide">y</span>)</div></div><div class="line"><div class="line-content">    <span class="ide">then</span>:</div></div><div class="line"><div class="line-content">      <span class="ide">echo</span> <span class="ide">match</span> <span class="com"># (id: 1, x: 10.0, y: 25.0)</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Player</span>, <span class="ide">X</span>, <span class="num">10.0</span>)</div></div><div class="line"><div class="line-content"><span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Player</span>, <span class="ide">Y</span>, <span class="num">25.0</span>)</div></div>  </code></pre>
<p>If you&apos;re trying to debug a <code>cond</code> block, keep in mind that you can put whatever arbitrary code you want in there. For example, you can make it print out the values by creating a new scope with <code>block</code>, as long as the condition itself is the last thing in that scope:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">rule</span> <span class="ide">stopPlayer</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">    (<span class="ide">Global</span>, <span class="ide">WindowWidth</span>, <span class="ide">windowWidth</span>)</div></div><div class="line"><div class="line-content">    (<span class="ide">Player</span>, <span class="ide">X</span>, <span class="ide">x</span>)</div></div><div class="line"><div class="line-content">  <span class="ide">cond</span>:</div></div><div class="line"><div class="line-content">    <span class="kwd">block</span>:</div></div><div class="line"><div class="line-content">      <span class="ide">echo</span> <span class="ide">x</span>, <span class="str">&quot; &quot;</span>, <span class="ide">windowWidth</span> <span class="com"># this is one way you can debug the condition</span></div></div><div class="line"><div class="line-content">      <span class="ide">x</span> <span class="op">&gt;=</span> <span class="ide">float</span>(<span class="ide">windowWidth</span>)</div></div><div class="line"><div class="line-content">    <span class="ide">windowWidth</span> <span class="op">&gt;</span> <span class="num">0</span></div></div><div class="line"><div class="line-content">  <span class="ide">then</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">session</span><span class="op">.</span><span class="ide">insert</span>(<span class="ide">Player</span>, <span class="ide">X</span>, <span class="num">0.0</span>)</div></div>  </code></pre>
<p>If you want to reference any external values (such as constants) in the <code>what</code> block, you need to quote them, because by default any symbol with a lowercase letter will be interpreted as a binding:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">const</span> <span class="ide">playerId</span> <span class="op">=</span> <span class="ide">Player</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">session</span><span class="op">.</span><span class="ide">add</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">rule</span> <span class="ide">getPlayer</span>(<span class="ide">Fact</span>):</div></div><div class="line"><div class="line-content">    <span class="ide">what</span>:</div></div><div class="line"><div class="line-content">      (`<span class="ide">playerId</span>`, <span class="ide">X</span>, <span class="ide">x</span>)</div></div><div class="line"><div class="line-content">      (`<span class="ide">playerId</span>`, <span class="ide">Y</span>, <span class="ide">y</span>)</div></div>  </code></pre>
<h2>Wrap up</h2>
<p>In a way, rules engines just give you a fancy <code>if</code> statement. You tell it what data it needs, what conditions the data must meet, and what should happen when it does. The real power is that they let you express your game&apos;s logic as independent units, each one explicitly stating what they need in order to run. That lets you reason about them in isolation.</p>
<h2>Comparison to Clara Rules</h2>
<p>I was inspired a lot by <a href="https://github.com/cerner/clara-rules">Clara Rules</a>, a rules engine for Clojure. Right now pararules has advantages and disadvantages compared to it.</p>
<p>Advantages compared to Clara:</p>
<ul>
<li>Pararules stores data in <code>(id, attribute, value)</code> tuples, whereas Clara uses Clojure records. I think storing each key-value pair as a separate fact leads to a much more flexible system. Technically you could make Clara work this way, but records tend to encourage you to combine data together.</li>
<li>Pararules has built-in support for updating facts. You don&apos;t even need to explicitly do it; simply inserting a fact with an existing id + attribute combo will cause the old fact to be removed. This is only possible because of the aforementioned use of tuples.</li>
<li>Pararules provides a simple <code>rule</code> macro that returns an object that can be added to any (or even multiple) sessions. Clara&apos;s <code>defrule</code> macro creates a global var that is implicitly added to a session. I tried to solve that particular problem with my <a href="https://github.com/oakes/clarax">clarax</a> library but with pararules it&apos;s even cleaner because each rule is completely separate and can be added to a session independently.</li>
<li>Pararules makes no distinction between rules and queries — all rules are also queries. Clara has a separate <code>defquery</code> macro for making queries, which means potential duplication since queries can often be the same as the &quot;left hand side&quot; of a rule.</li>
</ul>
<p>Disadvantages compared to Clara:</p>
<ul>
<li>Clara supports <a href="https://www.clara-rules.org/docs/truthmaint/">truth maintenance</a>, which can be a very useful feature in some domains. I don&apos;t plan on supporting this in pararules because I&apos;m not convinced it&apos;s that useful for game dev.</li>
<li>Clara&apos;s sessions are completely immutable data structures. This makes it really simple to hold on to old versions of a session, in order to implement time rewinding or as a useful debugging tool. I want to implement this in pararules eventually.</li>
</ul>
<h2>Acknowledgements</h2>
<p>I could not have built this without the <a href="http://reports-archive.adm.cs.cmu.edu/anon/1995/CMU-CS-95-113.pdf">1995 thesis paper from Robert Doorenbos</a>, which describes the RETE algorithm better than I&apos;ve found anywhere else. I also stole a lot of design ideas from <a href="https://github.com/cerner/clara-rules">Clara Rules</a>.</p>
</document>
            
        </div>
        <div class="col-3" id="meta-section">
            <div class="container box rounded p-3">
                
                    <p>
                        <strong>Licence:</strong>
                        Public Domain
                    </p>
                

                

                
            </div>
        </div>
    </div>
</div>
</div>

<footer class="pt-10 px-3">
  <div class="container pt-4">
    <div class="row mb-4">
      <div class="col-lg-3">
        <h4 class="h5">Getting started with Nim</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://learnxinyminutes.com/docs/nim/">Learn Nim in 5 minutes</a></li>
          <li><a class="text-decoration-none" href="https://nim-by-example.github.io/">Nim by Example</a></li>
          <li><a class="text-decoration-none" href="https://play.nim-lang.org/">Official Playground</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Official Tutorials</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut1.html">General Tutorial</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut2.html">Advanced Features</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut3.html">Macros and Metaprogramming</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Nim for...</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-C-programmers">C programmers</a></li>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-Python-Programmers">Python programmers</a></li>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-TypeScript-Programmers">TypeScript programmers</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Documentation</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/lib.html">Standard Library</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/manual.html">Language Manual</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tools.html">Tools Documentation</a></li>
        </ul>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-12 text-center mt-4 mx-auto">
        <a href="#" class="d-block mb-3 mx-auto bw"></a>
        <p class="text-muted">
        Created in <a href="https://nim-lang.org/">Nim</a> on <a href="https://pages.github.com/">GitHub Pages</a>.
        <a href="https://github.com/gabbhack/nimidirectory">Available</a>
        under <a href="https://en.wikipedia.org/wiki/GNU_General_Public_License#Version_3">GPLv3</a>
        </p>
        <p class="text-muted">
        Builded at 2023-06-24T01:44:43Z
        </p>
      </div>
    </div>
  </div>
</footer>
<script>
</script>
</body>
</html>
