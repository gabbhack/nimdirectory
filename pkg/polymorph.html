<!DOCTYPE html>
<html lang="en">
<head>
  <title>Nim Package Directory</title>
  <link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="alternate" type="application/rss+xml" title="New and updated Nim packages" href="https://nimble.directory/packages.xml">
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/highlite.css">
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script type="text/javascript" src="/js/app.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg fixed-top py-3">
  <div class="container">
    <a href="/" class="logo fw-500 display-1 text-black text-decoration-none navbar-brand"></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item mx-2">
          <a href="https://nim-lang.org/" class="nav-link">What's Nim?</a>
        </li>
        <li class="nav-item mx-2">
          <a href="/about.html" class="nav-link">What's Nimble?</a>
        </li>
        <li class="nav-item mx-2">
          <a href="https://github.com/nim-lang/packages/" class="nav-link">Publish your package</a>
        </li>
        <!-- TODO: replace with something different -->
        <li class="nav-item ms-3">
          <a class="nav-link" href="https://www.youtube.com/channel/UCDAYn_VFt0VisL5-1a5Dk7Q/">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon></svg>
          </a>
        </li>
        <li class="nav-item ms-3">
          <a class="nav-link theme-switcher-btn" id="darkmode" onclick="toggle_dark_mode()" href="#">
            <span id="light-mode-icon">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </span>
            <span id="dark-mode-icon">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="content">
  <div class="container">
    <div class="container pt-10">
        <h3 class="mb-3 fw-bold display-6 pt-4">polymorph</h3>
        <p class="tags">
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">entity-component-system</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">ecs</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">gamedev</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">metaprogramming</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">compile-time</button></a>
                </span>
            
        </p>
        <p class="pkg-desc">some("An entity-component-system with a focus on compile time optimisation")</p>
        <a title="Copy" onclick="document.querySelector('#cmd').select();document.execCommand('copy');"
            alt="Copy on clipboard">
            <i class="fa fa-copy"></i>
        </a>
        <input id="cmd" onclick="this.select();" value="nimble install polymorph" readonly="">
        <br>
        <small style="font-size: 0.8rem;">Need help? Read <a
                href="https://github.com/nim-lang/nimble#creating-packages">Nimble</a></small>
    </div>

    <div class="container row pt-4" id="pkg-content">
        <div class="col-8 box rounded p-3" id="readme-section">
            
                <document><ul>
<li><a href="#project-overview">Project overview</a>
<ul>
<li>  <a href="#goals">Goals</a></li>
<li><a href="#entity-component-system-ecs">Entity-component-system (ECS)</a>
<ul>
<li>  <a href="#an-example-ecs">An example ECS</a></li>
<li>  <a href="#benefits-of-ecs">Benefits of ECS</a></li>
<li>  <a href="#ecs-contrasted-with-object-oriented-design">ECS contrasted with Object Oriented Design</a></li>
</ul>
</li>
<li><a href="#polymorph-a-generative-approach-to-a-queryless-system-oriented-ecs">Polymorph: a generative approach to a queryless, system oriented ECS.</a>
<ul>
<li>  <a href="#compile-time-focus">Compile time focus</a></li>
<li>  <a href="#features">Features</a></li>
</ul>
</li>
<li>  <a href="#polymers-companion-library">Polymers companion library</a></li>
<li>  <a href="#why-nim">Why Nim?</a></li>
</ul>
</li>
<li><a href="#overview-of-building-an-ecs">Overview of building an ECS</a>
<ul>
<li>  <a href="#after-makeecsmakeecscommit">After   <code>makeEcs</code>/  <code>makeEcsCommit</code></a></li>
</ul>
</li>
<li><a href="#defining-components">Defining components</a>
<ul>
<li>  <a href="#registercomponents-generated-types">  <code>registerComponents</code> generated types</a></li>
<li>  <a href="#components-and-instance-types">Components and instance types</a></li>
<li><a href="#instances-in-components">Instances in components</a>
<ul>
<li>  <a href="#instance-volatility">Instance volatility</a></li>
</ul>
</li>
<li><a href="#component-utilities">Component utilities</a>
<ul>
<li>  <a href="#matching-run-time-componenttypeid">Matching run time   <code>ComponentTypeId</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#defining-systems">Defining systems</a>
<ul>
<li><a href="#system-anatomy">System anatomy</a>
<ul>
<li>  <a href="#system-scope-blocks">System scope blocks</a></li>
<li>  <a href="#work-item-blocks">Work item blocks</a></li>
<li><a href="#accessing-items">Accessing items</a>
<ul>
<li>  <a href="#access-templates-and-aliasing">Access templates and aliasing</a></li>
</ul>
</li>
</ul>
</li>
<li>  <a href="#system-component-negation">System component negation</a></li>
<li>  <a href="#systems-without-components">Systems without components</a></li>
<li>  <a href="#committing-systems">Committing systems</a></li>
<li>  <a href="#ecsimport">    <code>ecsImport</code>  </a></li>
<li>  <a href="#system-execution-order">System execution order</a></li>
<li>  <a href="#running-systems-at-time-intervals">Running systems at time intervals</a></li>
<li>  <a href="#adding-custom-fields-to-systems">Adding custom fields to systems</a></li>
<li><a href="#grouping-systems">Grouping systems</a>
<ul>
<li>  <a href="#execution-control">Execution control</a></li>
<li>  <a href="#removing-components-during-all-or-stream-blocks">Removing components during   <code>all</code> or   <code>stream</code> blocks</a></li>
</ul>
</li>
<li><a href="#system-utilities">System utilities</a>
<ul>
<li>  <a href="#clear">    <code>clear</code>  </a></li>
<li>  <a href="#removeremovecomponents">  <code>remove</code>/  <code>removeComponents</code></a></li>
<li>  <a href="#systemsused">    <code>systemsUsed</code>  </a></li>
<li>  <a href="#casesystem">    <code>caseSystem</code>  </a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#working-with-entities">Working with entities</a>
<ul>
<li>  <a href="#creating-entities">Creating entities</a></li>
<li>  <a href="#adding-components-to-existing-entities">Adding components to existing entities</a></li>
<li>  <a href="#fetching-and-checking-for-components">Fetching and checking for components</a></li>
<li>  <a href="#removing-components">Removing components</a></li>
<li>  <a href="#deleting-entities">Deleting entities</a></li>
<li>  <a href="#checking-entities-satisfy-specific-systems">Checking entities satisfy specific systems</a></li>
</ul>
</li>
<li><a href="#constructing-entities-at-run-time">Constructing entities at run time</a>
<ul>
<li>  <a href="#constructing-multiple-entities">Constructing multiple entities</a></li>
<li>  <a href="#cloning-entities">Cloning entities</a></li>
</ul>
</li>
<li><a href="#switching-components-with-component-lists">Switching components with component lists</a>
<ul>
<li>  <a href="#updating-entities-with-component-lists">Updating entities with component lists</a></li>
</ul>
</li>
<li><a href="#events">Events</a>
<ul>
<li>  <a href="#inline-events">Inline events</a></li>
<li>  <a href="#system-events">System events</a></li>
<li>  <a href="#mutating-entities-within-events">Mutating entities within events</a></li>
<li>  <a href="#change-events">Change events</a></li>
<li>  <a href="#onecsbuilt">    <code>onEcsBuilt</code>  </a></li>
<li><a href="#construction-and-clone-events">Construction and clone events</a>
<ul>
<li>  <a href="#construction-events">Construction events</a></li>
</ul>
</li>
</ul>
</li>
<li>  <a href="#writing-component-libraries">Writing component libraries</a></li>
<li><a href="#code-generation-options">Code generation options</a>
<ul>
<li>  <a href="#ecscompoptions">EcsCompOptions</a></li>
<li>  <a href="#ecssysoptions">EcsSysOptions</a></li>
<li>  <a href="#ecsentityoptions">EcsEntityOptions</a></li>
</ul>
</li>
<li>  <a href="#compile-switches">Compile switches</a></li>
<li><a href="#performance-considerations">Performance considerations</a>
<ul>
<li>  <a href="#memory-access-patterns">Memory access patterns</a></li>
<li>  <a href="#fragmentation-analysis">Fragmentation analysis</a></li>
</ul>
</li>
<li><a href="#owned-components-and-removing-indirection">Owned components and removing indirection</a>
<ul>
<li>  <a href="#satisfying-owner-systems">Satisfying owner systems</a></li>
<li>  <a href="#deleting-from-owner-systems">Deleting from owner systems</a></li>
</ul>
</li>
<li><a href="#ecs-identities">ECS identities</a>
<ul>
<li>  <a href="#multiple-ecs-outputs-with-a-single-identity">Multiple ECS outputs with a single identity</a></li>
<li>  <a href="#private-ecs">Private ECS</a></li>
<li>  <a href="#multiple-identities">Multiple identities</a></li>
</ul>
</li>
<li><a href="#future-work">Future work</a>
<ul>
<li>  <a href="#performance">Performance</a></li>
</ul>
</li>
</ul>
<h1>Project overview</h1>
<p>  <img src="https://user-images.githubusercontent.com/36367371/152667517-d00339f4-bf1b-423f-abd5-323506277186.png" style="max-width: 100%;" alt="pmf150" /></p>
<p>A lean, generative abstraction for writing programs with the <a href="https://en.wikipedia.org/wiki/Entity_component_system">entity-component-system</a> pattern.</p>
<h2>Goals</h2>
<ul>
<li>Manage complexity with declarative dispatch and run time composition.</li>
<li>Scalable, low boilerplate platform for composing data oriented designs.</li>
<li>No runtime, zero system iteration overhead.</li>
<li>Leverage static typing and metaprogramming to elide run time work.</li>
<li>Support low resource embedded devices.</li>
<li>No external dependencies.</li>
</ul>
<h2>Entity-component-system (ECS)</h2>
<p>This pattern lets you build composite types at run time and dispatch program logic for specific sets of types.</p>
<p>The three elements of ECS are:</p>
<ul>
<li><strong>Entity</strong>: a handle that lets you add or remove data types.</li>
<li><strong>Component</strong>: a data type that can be added to an entity.</li>
<li><strong>System</strong>: logic with component parameters that runs for matching entities.</li>
</ul>
<p>Entity-component-systems offer a way to structure programs &apos;bottom up&apos; by combining data to compose system behaviour at run time.</p>
<h3>An example ECS</h3>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Create some component data types.</span></div></div><div class="line"><div class="line-content"><span class="ide">register</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span></div></div><div class="line"><div class="line-content">    <span class="ide">Pos</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">x</span>, <span class="ide">y</span>: <span class="ide">int</span></div></div><div class="line"><div class="line-content">    <span class="ide">Vel</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">x</span>, <span class="ide">y</span>: <span class="ide">int</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Define some logic for when Pos and Vel are together.</span></div></div><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;move&quot;</span>, [<span class="ide">Pos</span>, <span class="ide">Vel</span>]:</div></div><div class="line"><div class="line-content">  <span class="ide">all</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">pos</span><span class="op">.</span><span class="ide">x</span> <span class="op">+=</span> <span class="ide">vel</span><span class="op">.</span><span class="ide">x</span></div></div><div class="line"><div class="line-content">    <span class="ide">pos</span><span class="op">.</span><span class="ide">y</span> <span class="op">+=</span> <span class="ide">vel</span><span class="op">.</span><span class="ide">y</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Generate the ECS for use.</span></div></div><div class="line"><div class="line-content"><span class="ide">makeEcsCommit</span> <span class="str">&quot;runSystems&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Compose Pos and Vel to trigger &quot;move&quot;.</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span></div></div><div class="line"><div class="line-content">  <span class="ide">moving</span> <span class="op">=</span> <span class="ide">newEntityWith</span>(</div></div><div class="line"><div class="line-content">    <span class="ide">Pos</span>(<span class="ide">x</span>: <span class="num">0</span>, <span class="ide">y</span>: <span class="num">0</span>),</div></div><div class="line"><div class="line-content">    <span class="ide">Vel</span>(<span class="ide">x</span>: <span class="num">1</span>, <span class="ide">y</span>: <span class="num">1</span>)</div></div><div class="line"><div class="line-content">  )</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Run the &quot;move&quot; system a number of times.</span></div></div><div class="line"><div class="line-content"><span class="kwd">for</span> <span class="ide">i</span> <span class="kwd">in</span> <span class="num">0</span> <span class="op">..&lt;</span> <span class="num">4</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">runSystems</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Confirm the updated Pos value.</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">pos</span> <span class="op">=</span> <span class="ide">moving</span><span class="op">.</span><span class="ide">fetch</span> <span class="ide">Pos</span></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">pos</span><span class="op">.</span><span class="ide">x</span> <span class="op">==</span> <span class="num">4</span> <span class="kwd">and</span> <span class="ide">pos</span><span class="op">.</span><span class="ide">y</span> <span class="op">==</span> <span class="num">4</span></div></div>  </code></pre>
<h3>Benefits of ECS</h3>
<ul>
<li><a href="https://www.sebaslab.com/the-quest-for-maintainable-code-and-the-path-to-ecs/">The principles</a> of <a href="https://en.wikipedia.org/wiki/SOLID">SOLID</a></li>
<li>  <a href="https://en.wikipedia.org/wiki/Inversion_of_control">Inversion of control</a></li>
<li>Naturally data oriented and data driven</li>
<li>Remove <a href="https://en.wikipedia.org/wiki/Multiple_inheritance#The_diamond_problem">ambiguities, coupling, dependencies</a> and slow virtual calls of inheritance trees</li>
<li>Maintain design agility and rapid prototyping by composing behaviour at run time</li>
<li>Avoid data coupling and the &apos;conceptual crystallisation&apos; of top down design</li>
<li>Encourage decoupled and isolated logic that&apos;s easy to reuse, extend, and maintain</li>
<li>High performance through machine friendly batch processing with uniform lists</li>
<li>Natively asynchronous</li>
</ul>
<h3>ECS contrasted with Object Oriented Design</h3>
<p>Objects in OOD describe <code>is a</code> relationships with hierarchies of types.
Subtyping and encapsulation naturally fit a top down design process, where a general overview of a task is split into sub-tasks.
The mechanics of execution is often bespoke to each solution.</p>
<p>By contrast, entities in ECS describe <code>has a</code> relationships with sets of types.
Mutable composition lends itself more to a bottom up design process, where behaviour is built by composing tasks.
Systems dispatch over matching entities automatically in a fixed order.</p>
<p>For a view of ECS from an OOP perspective, see <a href="https://mzaks.medium.com/ecs-for-die-hard-oo-developers-2a10cbc1f5db">here</a>.</p>
<h2>Polymorph: a generative approach to a queryless, system oriented ECS.</h2>
<p>Traditionally, ECS implementations orient their data model from the perspective of components (aggregate data) or entities (data compositions).</p>
<p>In order to perform work in these models, a system must query a management layer for live data to process. The efficiency of this process can become a key factor in complex designs.</p>
<p>Polymorph instead orients its data model from the perspective of systems (execution); systems hold component state for matching entities, and are updated when entities add or remove components.</p>
<p>By avoiding the disconnect between execution and state, systems are always available to run without any iteration overhead.</p>
<p>Entity operations are transactional system state changes, and the component types involved infer the systems affected.</p>
<p>This allows entity operations to be entirely generated at compile time, guided by system/component relationships to emit pared down system updates that perform the minimum run time work possible.</p>
<p>The output is statically dispatched with a linear execution flow (no need for callbacks), consisting of simple loops over incrementally updated component data.</p>
<h3>Compile time focus</h3>
<p>Polymorph takes extensive advantage of Nim&apos;s metaprogramming features to shift as much work to compile time as possible.</p>
<p>Functionality such as building entities from blueprints, cloning entities, and debugging utilities are also fully generated from your types and system design at compile time.</p>
<p>The more that state can be determined at compile time, the less run time work is needed. Creating a new entity with a set of components fully specifies the entity state, and systems are unconditionally matched at compile time. Any system updates required are then generated as direct, static updates, without any run time speculative work.</p>
<p>Adding and removing multiple components at once is also minimised at compile time, outputting single pass inline operations.</p>
<h3>Features</h3>
<ul>
<li><em>  <strong>Design driven</strong></em>: code generation directly from component/system interactions.</li>
<li><em>  <strong>Zero system overhead</strong></em>: no queries or iteration overhead for systems.</li>
<li><em>  <strong>Cheap to change components</strong></em>: freely evolve entities with wildly disparate components without moving memory.</li>
<li><em>  <strong>Sequential code flow</strong></em>: flatten run time composition, declarative code execution, and event hooks into a linear execution flow without needing callbacks or virtual calls.</li>
<li><em>  <strong>Architecturally simple output</strong></em>: outputs simple loops over lists in a set order. Aims to scale from stack only, low resource environments to cache efficient, high performance data processing.</li>
<li><em>  <strong>Granular code generation options</strong></em>: select different data structures for each component and system, choose error handling mechanisms, system interval execution, indexing and removal strategies, and more - without changing any code.</li>
<li><em>  <strong>Compile time checked</strong></em>:
<ul>
<li>Event expansions are parsed for conflicting changes and potential cycles.</li>
<li>Iterating systems detect component removals that affect themselves:
<ul>
<li>Automatically adjust loop generation.</li>
<li>Subsequent access of the iteration entity is a compile time error.</li>
</ul>
</li>
</ul>
</li>
<li><em>  <strong>Compile time optimised</strong></em>:
<ul>
<li>Only</li>
</ul>
</li>
</ul>
<h2>Polymers companion library</h2>
<p>The <a href="https://github.com/rlipsc/polymers/">  <strong>Polymers</strong></a> library provides ready-made components and systems as both an effort at a data oriented &apos;stdlib&apos; and as practical examples:</p>
<ul>
<li><code>OpenGl</code>: render instanced models using the <a href="https://github.com/rlipsc/glbits">glBits</a> shader wrapper.</li>
<li><code>Physics</code>: components for interacting with the <a href="https://chipmunk-physics.net/">Chipmunk2D</a> physics engine.</li>
<li><code>Console</code>: reading keyboard and mouse events, writing text with normalised (-1, 1) coordinates.</li>
<li><code>Database</code>: performing queries with ODBC.</li>
<li><code>Networking</code>: components for:
<ul>
<li>socket TCP/IP (Windows IOCP) and UDP,</li>
<li>HTTP processing,</li>
<li>Serving webpages,</li>
<li>JSON RPC over HTTP.</li>
</ul>
</li>
</ul>
<h2>Why Nim?</h2>
<p><a href="https://nim-lang.org/">Nim</a> is an adaptable language with low development friction, very high performance, and fast compile times. It&apos;s built to be readable with a flexible syntax.</p>
<p>The language is extremely portable, compiling to C, C++, ObjC, and JavaScript, along with good Python interop. Nim&apos;s static typing and high level abstractions can be shared across domain boundaries and interface with a huge variety of ecosystems.</p>
<p>Extensibility is a core philosophy, with hygienic macros using the language in a VM to process abstract syntax trees directly. Nim&apos;s compile time evaluation and well supported metaprogramming make this library possible.</p>
<h1>Overview of building an ECS</h1>
<ol>
<li><strong>Create component types</strong> with <code>register</code>/<code>registerComponents</code></li>
<li><strong>Create system code</strong> to process components with <code>defineSystems</code>/<code>makeSystem</code>.</li>
<li><em>  <strong>Generate the code</strong></em> with <code>makeEcs</code>/<code>makeEcsCommit</code>.</li>
</ol>
<p>For example:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Design stage.</span></div></div><div class="line"><div class="line-content"><span class="ide">register</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span> <span class="ide">MyComponent</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;mySystem&quot;</span>, [<span class="ide">MyComponent</span>]: <span class="kwd">discard</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Seal the design and generate the ECS and system code.</span></div></div><div class="line"><div class="line-content"><span class="ide">makeEcsCommit</span> <span class="str">&quot;runSystems&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># ECS can now be used.</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">e</span> <span class="op">=</span> <span class="ide">newEntityWith</span>(<span class="ide">MyComponent</span>())</div></div><div class="line"><div class="line-content"><span class="ide">runSystems</span>()</div></div>  </code></pre>
<h2>After <code>makeEcs</code>/<code>makeEcsCommit</code></h2>
<p>Once all the components and systems have been defined, the <code>makeEcs</code> macro generates the ECS:</p>
<ul>
<li>Macros:
<ul>
<li><code>newEntityWith</code>: create an entity with a set of components.</li>
<li><code>add</code>/<code>addComponents</code>: add components to an entity.</li>
<li><code>remove</code>/<code>removeComponents</code>: remove components from an entity.</li>
</ul>
</li>
<li>Procs:
<ul>
<li><code>newEntity</code>: create an entity.</li>
<li><code>fetch</code>/<code>fetchComponent</code>: returns a component instance from an entity.</li>
<li><code>delete</code>: delete the entity.</li>
<li><code>construct</code>: build an entity from a list of components.</li>
<li><code>clone</code>: copy an entity.</li>
</ul>
</li>
<li>Systems:
<ul>
<li>By default, system types are created and instantiated.</li>
</ul>
</li>
<li>Templates:
<ul>
<li><code>caseComponent</code>: a <code>case</code> statement for run time component type ids.</li>
<li><code>caseSystem</code>: a <code>case</code> statement for run time system ids.</li>
</ul>
</li>
<li>Debugging:
<ul>
<li><code>$</code> operators for entities, component instances, and other supporting types.</li>
</ul>
</li>
</ul>
<h1>Defining components</h1>
<p>Components are the data and attributes that make up the program state. They act as the parameters to dispatch systems, and therefore define the granularity of program behaviour. Whilst system program code is fixed at compile time, entities can freely change components to drive system execution.</p>
<p>Component design is conceptually flexible. They may contain all or part of the raw data for systems to process, act as program events, orchestrate collections of entities, modify behaviour as dataless tags, serve as descriptive annotations, and so on as required.</p>
<p>Creating components is as simple as wrapping type definitions with <code>registerComponents</code>. This will process any <code>typedef</code> and pass the block through unaltered.</p>
<p><code>registerComponents</code> takes two parameters:</p>
<ul>
<li>An <code>ECSCompOptions</code> object. This controls code generation for these components.</li>
<li>A block of code with type definitions.</li>
</ul>
<p>For example, to create three components, <code>A</code>, <code>B</code>, and <code>C</code>.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Create components with the default options.</span></div></div><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span></div></div><div class="line"><div class="line-content">    <span class="ide">A</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">B</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">text</span>: <span class="ide">string</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">C</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">value</span>: <span class="ide">int</span></div></div>  </code></pre>
<p>You can use <code>registerComponents</code> multiple times before actually constructing the ECS, for example to split component definitions over separate modules. Each <code>registerComponents</code> may have separate options.</p>
<p>As a special case, you can include type definitions in <code>registerComponents</code> that should not be made into components with the <code>{.notComponent.}</code> pragma. This can be useful when you want to refer to types within component definitions, but can&apos;t (or don&apos;t want to) define them externally to the type block.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span></div></div><div class="line"><div class="line-content">    <span class="ide">SubData</span> {<span class="op">.</span><span class="ide">notComponent</span><span class="op">.</span>} <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">contents</span>: <span class="ide">seq</span>[<span class="ide">int</span>]</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">Data</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">value</span>: <span class="ide">SubData</span></div></div>  </code></pre>
<p>In general, it&apos;s recommended to use <code>object</code> types for components for convenience.
For non-object types, for example <code>type MyComponent = float</code>, use <code>access</code> to read and <code>update</code> to write the value.</p>
<p>You can also pass existing types to register them as components:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">type</span></div></div><div class="line"><div class="line-content">  <span class="ide">ExternalType</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">register</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">ExternalType</span></div></div>  </code></pre>
<h2><code>registerComponents</code> generated types</h2>
<p>Each type passed to <code>registerComponents</code> creates two other types to support its use as a component:</p>
<ol>
<li>
<p>An instance type, generated with the <code>Instance</code> postfix. This is used to point to a specific component&apos;s data in storage.</p>
</li>
<li>
<p>A container type, generated with the <code>Ref</code> postfix. This is inherited from the <code>Component</code> supertype, and allows <code>seq[Component]</code> with different component types for <a href="#constructing-entities-at-run-time">  <code>construct</code></a> to build arbitrary entities at run time.</p>
</li>
</ol>
<h2>Components and instance types</h2>
<p>Instance types are <code>distinct</code> integers that reference values for that type, and are how components are generally represented within the ECS.</p>
<p>For example systems use instances by default, and <code>fetch</code> returns them. Any component attached to an entity can be represented by an instance.</p>
<p>It can be useful to understand how this mechanism works for usability and performance reasons.</p>
<p>Polymorph implements the dot accessors <code>.</code> and <code>.=</code> for instance types so that fields can be accessed like the original data type. This works by using the integer value of the instance to index into the type&apos;s associated component storage.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span></div></div><div class="line"><div class="line-content">    <span class="ide">Foo</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">text</span>: <span class="ide">string</span></div></div><div class="line"><div class="line-content">      <span class="ide">value</span>: <span class="ide">int</span></div></div><div class="line"><div class="line-content">    <span class="ide">Bar</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">value</span>: <span class="ide">float</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeEcs</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Create an entity with both components.</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span></div></div><div class="line"><div class="line-content">  <span class="ide">entity</span> <span class="op">=</span> <span class="ide">newEntityWith</span>(</div></div><div class="line"><div class="line-content">    <span class="ide">Foo</span>(<span class="ide">text</span>: <span class="str">&quot;Hello!&quot;</span>, <span class="ide">value</span>: <span class="num">123</span>),</div></div><div class="line"><div class="line-content">    <span class="ide">Bar</span>(<span class="ide">value</span>: <span class="num">12.34</span>))</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Get instances for the components.</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span></div></div><div class="line"><div class="line-content">  <span class="ide">foo</span> <span class="op">=</span> <span class="ide">entity</span><span class="op">.</span><span class="ide">fetch</span> <span class="ide">Foo</span></div></div><div class="line"><div class="line-content">  <span class="ide">bar</span> <span class="op">=</span> <span class="ide">entity</span><span class="op">.</span><span class="ide">fetch</span> <span class="ide">Bar</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Act on component fields through instances.</span></div></div><div class="line"><div class="line-content"><span class="ide">foo</span><span class="op">.</span><span class="ide">text</span> <span class="op">=</span> <span class="str">&quot;Hello&quot;</span></div></div><div class="line"><div class="line-content"><span class="ide">foo</span><span class="op">.</span><span class="ide">value</span> <span class="op">=</span> <span class="num">17</span></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">foo</span><span class="op">.</span><span class="ide">value</span> <span class="op">==</span> <span class="num">17</span></div></div><div class="line"><div class="line-content"><span class="ide">bar</span><span class="op">.</span><span class="ide">value</span> <span class="op">=</span> <span class="num">5.5</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># This is transformed into something like:</span></div></div><div class="line"><div class="line-content"><span class="ide">storageFoo</span>[<span class="ide">foo</span><span class="op">.</span><span class="ide">int</span>]<span class="op">.</span><span class="ide">text</span> <span class="op">=</span> <span class="str">&quot;Hello&quot;</span></div></div><div class="line"><div class="line-content"><span class="ide">storageFoo</span>[<span class="ide">foo</span><span class="op">.</span><span class="ide">int</span>]<span class="op">.</span><span class="ide">value</span> <span class="op">=</span> <span class="num">17</span></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">storageFoo</span>[<span class="ide">foo</span><span class="op">.</span><span class="ide">int</span>]<span class="op">.</span><span class="ide">value</span> <span class="op">==</span> <span class="num">17</span></div></div><div class="line"><div class="line-content"><span class="ide">storageBar</span>[<span class="ide">bar</span><span class="op">.</span><span class="ide">int</span>]<span class="op">.</span><span class="ide">value</span> <span class="op">=</span> <span class="num">5.5</span></div></div>  </code></pre>
<p>Instance types have reference semantics, and as they are simply integers they&apos;re cheap to pass about and validate without invoking the GC. Looking up the index to storage is one indirection with list storages, and that indirection should have a good chance of being in the cache - assuming a linear component allocation pattern.</p>
<p>Sometimes, however, you want access to the underlying type directly. For this, there is the <code>access</code> template, which transposes the storage lookup for the whole component type.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">copyFoo</span> <span class="op">=</span> <span class="ide">foo</span><span class="op">.</span><span class="ide">access</span></div></div><div class="line"><div class="line-content">  <span class="com"># Translates to something like this:</span></div></div><div class="line"><div class="line-content">  <span class="kwd">let</span> <span class="ide">copyFoo</span> <span class="op">=</span> <span class="ide">storageFoo</span>[<span class="ide">foo</span><span class="op">.</span><span class="ide">int</span>]</div></div>  </code></pre>
<p>You can also update whole components using instances:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">foo</span><span class="op">.</span><span class="ide">update</span> <span class="ide">Foo</span>(<span class="ide">text</span>: <span class="str">&quot;Hey there&quot;</span>, <span class="ide">value</span>: <span class="num">18</span>)</div></div>  </code></pre>
<p>To check if instances returned from <code>fetch</code> were found, use the <code>valid</code> template.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">foo</span> <span class="op">=</span> <span class="ide">entity</span><span class="op">.</span><span class="ide">fetch</span> <span class="ide">Foo</span></div></div><div class="line"><div class="line-content"><span class="kwd">if</span> <span class="kwd">not</span> <span class="ide">foo</span><span class="op">.</span><span class="ide">valid</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;Cannot find Foo on this entity&quot;</span></div></div>  </code></pre>
<h2>Instances in components</h2>
<p><code>registerComponents</code> generates and inserts instance types before the component definitions themselves. This lets you use instance types within component definitions and have type safe links to other components.</p>
<p>Instance types are always defined as the component type name postfixed with &quot;Instance&quot;.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># Parse and generate instance types.</span></div></div><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span></div></div><div class="line"><div class="line-content">    <span class="ide">A</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">b</span>: <span class="ide">BInstance</span></div></div><div class="line"><div class="line-content">    <span class="ide">B</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">a</span>: <span class="ide">AInstance</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Outputs something like:</span></div></div><div class="line"><div class="line-content"><span class="kwd">type</span></div></div><div class="line"><div class="line-content">  <span class="ide">AInstance</span> <span class="op">=</span> <span class="kwd">distinct</span> <span class="ide">int</span></div></div><div class="line"><div class="line-content">  <span class="ide">BInstance</span> <span class="op">=</span> <span class="kwd">distinct</span> <span class="ide">int</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">A</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">b</span>: <span class="ide">BInstance</span></div></div><div class="line"><div class="line-content">  <span class="ide">B</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">a</span>: <span class="ide">AInstance</span></div></div>  </code></pre>
<h3>Instance volatility</h3>
<p>Component instances <strong>don&apos;t store generation information</strong>, and should be considered:</p>
<ul>
<li><strong>current</strong> within system storages and when directly fetched from entities.</li>
<li><strong>volatile</strong> when stored in components or other data structures.</li>
</ul>
<p>Whilst you can check if a stored instance is <code>valid</code> or <code>alive</code>, potentially the storage it refers to could have been deleted and recreated for another entity.</p>
<p>When storing instances it&apos;s up to the user to make sure things make sense, but this is usually easy thanks to the general semantics of how components relate to entities in an ECS and the event system.</p>
<p>For more longer term references, passing a component instance to <code>toRef</code> returns a <code>ComponentRef</code> and captures the generation for the instance. This can be used to detect if a reference to a particular value no longer exists.</p>
<h2>Component utilities</h2>
<ul>
<li>
<p><code>componentCount</code>: retrieves the number of instances in use for a particular component type.</p>
</li>
<li>
<p><code>typeName(typeId: componentTypeId)</code> converts a run time type id to the string of the type it represents.</p>
</li>
</ul>
<h3>Matching run time <code>ComponentTypeId</code></h3>
<p>The <code>caseComponent</code> template creates a case statement to handle all components from a run time <code>ComponentTypeId</code>. Within a <code>caseComponent</code> block the details of a component&apos;s type can be accessed with various templates. This allows code to perform type specific actions with dynamic component types such as in <code>ComponentList</code>.</p>
<p>Note:</p>
<ul>
<li>Has no concept of entity, this is a static case statement with injected actions</li>
<li>The same action block is compiled for every choice.</li>
</ul>
<p>The following templates are available with the <code>caseComponent</code> block:</p>
<ul>
<li><code>componentId</code>: the <code>ComponentTypeId</code> being matched.</li>
<li><code>componentName</code>: the string of the component name.</li>
<li><code>componentType</code>: the <code>type</code> of the component.</li>
<li><code>componentRefType</code>: the <code>ref</code> container type of the component.</li>
<li><code>componentDel</code>: the delete procedure for manually deleting a component slot.</li>
<li><code>componentAlive</code>: the <code>alive</code> proc for this component.</li>
<li><code>componentGenerations</code>: the storage list for this component&apos;s generation info.</li>
<li><code>componentInstanceType</code>: the instance type for this component.</li>
<li><code>componentData</code>: the storage list for this component.</li>
<li><code>isOwned</code>: returns <code>true</code> when the component is owned by a system, or <code>false</code> otherwise.</li>
<li><code>owningSystemIndex</code>: the <code>SystemIndex</code> of the owner system, or <code>InvalidSystemIndex</code> if the component is not owned.</li>
<li><code>owningSystem</code>: this is only included for owned components, and references the owner system variable.</li>
</ul>
<p>Example of use:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span> <span class="ide">Comp1</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeEcs</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span></div></div><div class="line"><div class="line-content">  <span class="ide">compList</span> <span class="op">=</span> <span class="ide">cl</span>(<span class="ide">Comp1</span>())</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">caseComponent</span> <span class="ide">compList</span>[<span class="num">0</span>]<span class="op">.</span><span class="ide">typeId</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;Component type is &quot;</span>, <span class="ide">componentName</span></div></div>  </code></pre>
<h1>Defining systems</h1>
<p>Systems dispatch code over entities with a specific set of components, and program behaviour is directed by the composition of entities. Systems may be completely stand alone, or work together through components as data pipelines.</p>
<p>Systems are efficient: their state is incrementally updated by entity changes so they don&apos;t perform work to iterate, and they execute as batch operations without call overhead. Even single line systems can be powerful processing tools.</p>
<p>For systems to participate in an ECS, they must first be defined with <code>defineSystem</code> by passing the name of the system along with the component types it uses. This allows <code>makeEcs</code> to create ECS operations based on how systems and components interact.</p>
<p>After a system is defined, it needs program logic assigned to it in order to perform work. Such logic is referred to as a system <em>body</em>.</p>
<p>A system can only have one body, and this contains all the code the system needs to perform.</p>
<p>When <code>defineSystem</code> is used, you can declare the body of a system later with <code>makeSystemBody</code>. This allows you to keep the code for a system separate from its definition.</p>
<p>Alternatively, you can define a system and its body at the same time with <code>makeSystem</code>, or <code>makeSystemOpts</code> if you wish to specify system compile options.</p>
<p><code>makeSystem</code> is passed the name and component types like <code>defineSystem</code>. If the system is already defined, <code>makeSystem</code> will just add the system body whilst ensuring that the components and options match the previous definition. It&apos;s a compile time error for the types or options to be mismatched between <code>defineSystem</code> and <code>makeSystem</code> for the same system.</p>
<p>Once a system is defined (whether using <code>defineSystem</code> or <code>makeSystem</code>), the system type is created and its variable is instantiated. These variables are created with the system&apos;s name, prefixed with <code>sys</code> and are immediately accessible.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span></div></div><div class="line"><div class="line-content">    <span class="ide">Comp1</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">Comp2</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Define a system.</span></div></div><div class="line"><div class="line-content"><span class="ide">defineSystem</span> <span class="str">&quot;mySystem1&quot;</span>, [<span class="ide">Comp1</span>]</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Define a system and pass compile options to it.</span></div></div><div class="line"><div class="line-content"><span class="ide">defineSystem</span> <span class="str">&quot;mySystem2&quot;</span>, [<span class="ide">Comp1</span>, <span class="ide">Comp2</span>], <span class="ide">defaultSysOpts</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Define a system and code body at the same time.</span></div></div><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;mySystem3&quot;</span>, [<span class="ide">Comp1</span>, <span class="ide">Comp2</span>]:</div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;Hello from system &quot;</span>, <span class="ide">sys</span><span class="op">.</span><span class="ide">name</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Once the ECS is sealed, new systems can&apos;t be defined using these components.</span></div></div><div class="line"><div class="line-content"><span class="com"># By default, system types are created and instantiated here.</span></div></div><div class="line"><div class="line-content"><span class="ide">makeEcs</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Access the instantiated system.</span></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">sysMySystem1</span><span class="op">.</span><span class="ide">count</span> <span class="op">==</span> <span class="num">0</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Define a code body for a previously defined system.</span></div></div><div class="line"><div class="line-content"><span class="ide">makeSystemBody</span> <span class="str">&quot;mySystem1&quot;</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;Hello from system &quot;</span>, <span class="ide">sys</span><span class="op">.</span><span class="ide">name</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Define a code body for a previously defined system with makeSystem.</span></div></div><div class="line"><div class="line-content"><span class="com"># Options are retrieved from the system&apos;s defineSystem.</span></div></div><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;mySystem2&quot;</span>, [<span class="ide">Comp1</span>, <span class="ide">Comp2</span>]:</div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;Hello from system &quot;</span>, <span class="ide">sys</span><span class="op">.</span><span class="ide">name</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Output systems with bodies defined so far.</span></div></div><div class="line"><div class="line-content"><span class="ide">commitSystems</span> <span class="str">&quot;runSystems&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">runSystems</span>()</div></div>  </code></pre>
<p>Outputs:</p>
<pre>  <code>Hello from system mySystem1
Hello from system mySystem2
Hello from system mySystem3
</code></pre>
<h2>System anatomy</h2>
<p>Systems offer several labelled blocks that allow executing code in different contexts. These are classified into two categories: <em>system scope</em> blocks and <em>work item</em> blocks.</p>
<p><em>System scope</em> blocks (<code>init</code>, <code>start</code>, and <code>finish</code>) are run at specific points in a system&apos;s execution. They may be written at any point in the root of the system&apos;s body, but are <em>extracted</em> from the body and pieced together in the order they&apos;re written, to be executed within the appropriate scope.</p>
<p><em>Work item</em> blocks (<code>all</code> and <code>stream</code>) are run for items in the system&apos;s work list. These blocks are expanded in place within the system body, allowing multiple processing passes within a system.</p>
<p>Code in the root of a system body is executed when the system is run and <code>paused</code> and <code>disabled</code> are <code>false</code>.</p>
<p>Within a system the <code>sys</code> template refers to the variable for the current system.</p>
<h3>System scope blocks</h3>
<ul>
<li>
<p><code>init:</code> run when the system&apos;s <code>initialised</code> field is <code>false</code>. After execution, <code>initialised</code> is set to <code>true</code>.</p>
</li>
<li>
<p><code>start:</code> executed every time a non-disabled system begins running, before the check for <code>sys.paused</code>.</p>
<p>The <code>start</code> block is in the same scope as the system body and the <code>all</code>, <code>stream</code>, and <code>finish</code> blocks, so variables and data defined in <code>start</code> can be used within these blocks.</p>
</li>
<li>
<p><code>finish:</code> run after a system body has finished executing, regardless of <code>sys.paused</code> state.</p>
</li>
</ul>
<h3>Work item blocks</h3>
<p>These block include an <code>item</code> template to access the current row entity&apos;s components. This template provides access to the entity being processed as <code>item.entity</code>, and components the system uses defined as the type name in lower case (eg; <code>item.myComponent</code>).</p>
<ul>
<li>
<p><code>all:</code> run for every entity in the system.</p>
</li>
<li>
<p><code>stream:</code> run for an arbitrary number of entities in the system:</p>
<ul>
<li><code>stream:</code> run for up to <code>sys.streamRate</code> entities in order. If <code>sys.streamRate</code> is zero, all entities are processed as if this were an <code>all</code> block.</li>
<li><code>stream N:</code> run for up to <code>N</code> entities in order.</li>
<li><code>stream multipass:</code> run for <code>sys.streamRate</code> entities, reprocessing entities in order if necessary.</li>
<li><code>stream multipass N:</code> run for <code>N</code> entities, reprocessing entities in order if necessary.</li>
<li><code>stream stochastic:</code> selects <code>sys.streamRate</code> entities, may select entities multiple times.</li>
<li><code>stream stochastic N:</code> selects <code>N</code> entities, may select entities multiple times.</li>
</ul>
</li>
</ul>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span>, <span class="ide">random</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span> <span class="ide">DemoBlocks</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;allTheBlocks&quot;</span>, [<span class="ide">DemoBlocks</span>]:</div></div><div class="line"><div class="line-content">  <span class="ide">init</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;Init: first run for &quot;</span>, <span class="ide">sys</span><span class="op">.</span><span class="ide">name</span></div></div><div class="line"><div class="line-content">    <span class="ide">randomize</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">start</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;Start: system entities: &quot;</span>, <span class="ide">sys</span><span class="op">.</span><span class="ide">count</span></div></div><div class="line"><div class="line-content">  </div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;System running...&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="kwd">template</span> <span class="ide">entId</span>: <span class="ide">string</span> <span class="op">=</span> <span class="str">&quot;entity &quot;</span> <span class="op">&amp;</span> <span class="op">$</span><span class="ide">item</span><span class="op">.</span><span class="ide">entity</span><span class="op">.</span><span class="ide">entityId</span><span class="op">.</span><span class="ide">int</span></div></div><div class="line"><div class="line-content">  <span class="kwd">let</span> <span class="ide">srStr</span> <span class="op">=</span> <span class="str">&quot;(rate: &quot;</span> <span class="op">&amp;</span> <span class="op">$</span><span class="ide">sys</span><span class="op">.</span><span class="ide">streamRate</span> <span class="op">&amp;</span> <span class="str">&quot;)&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">all</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;  All: &quot;</span>, <span class="ide">entId</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">stream</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;  Stream: &quot;</span>, <span class="ide">srStr</span>,<span class="str">&quot; &quot;</span>, <span class="ide">entId</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="kwd">let</span> <span class="ide">itemCount</span> <span class="op">=</span> <span class="num">3</span></div></div><div class="line"><div class="line-content">  <span class="ide">stream</span> <span class="ide">itemCount</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;  Stream up to &quot;</span>, <span class="ide">itemCount</span>, <span class="str">&quot;: &quot;</span>, <span class="ide">entId</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">stream</span> <span class="ide">multipass</span> <span class="num">4</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;  Stream multipass 4: &quot;</span>, <span class="ide">entId</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">stream</span> <span class="ide">stochastic</span> <span class="num">2</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;  Stream stochastic 2: &quot;</span>, <span class="ide">entId</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">stream</span> <span class="ide">stochastic</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;  Stream stochastic &quot;</span>, <span class="ide">srStr</span>, <span class="str">&quot;: &quot;</span>, <span class="ide">entId</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;System completed.&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">start</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">sys</span><span class="op">.</span><span class="ide">streamRate</span> <span class="op">=</span> <span class="num">1</span></div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;Start: set stream rate to &quot;</span>, <span class="ide">sys</span><span class="op">.</span><span class="ide">streamRate</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">finish</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;Finish: finished execution for &quot;</span>, <span class="ide">sys</span><span class="op">.</span><span class="ide">name</span></div></div><div class="line"><div class="line-content">  </div></div><div class="line"><div class="line-content"><span class="ide">makeEcs</span>()</div></div><div class="line"><div class="line-content"><span class="ide">commitSystems</span> <span class="str">&quot;run&quot;</span></div></div><div class="line"><div class="line-content"><span class="kwd">for</span> <span class="ide">i</span> <span class="kwd">in</span> <span class="num">0</span> <span class="op">..&lt;</span> <span class="num">3</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">discard</span> <span class="ide">newEntityWith</span>(<span class="ide">DemoBlocks</span>())</div></div><div class="line"><div class="line-content"><span class="ide">run</span>()</div></div>  </code></pre>
<p>The above outputs (stochastic blocks may vary):</p>
<pre>  <code>Init: first run for allTheBlocks
Start: system entities: 3
Start: set stream rate to 1
System running...
  All: entity 1
  All: entity 2
  All: entity 3
  Stream: (rate: 1) entity 1
  Stream up to 3: entity 2
  Stream up to 3: entity 3
  Stream multipass 4: entity 1
  Stream multipass 4: entity 2
  Stream multipass 4: entity 3
  Stream multipass 4: entity 1
  Stream stochastic 2: entity 2
  Stream stochastic 2: entity 1
  Stream stochastic (rate: 1): entity 3
System completed.
Finish: finished execution for allTheBlocks
</code></pre>
<h3>Accessing items</h3>
<p>When iterating through a system, such as with an <code>all</code> or <code>stream</code> block, the current row is accessed with the <code>item</code> template.</p>
<p>This template contains the current <code>entity</code>, as well as fields for all the components the system uses.</p>
<p>Other components need to be fetched from the entity.</p>
<p>Access to <code>item</code> is checked at compile time for &apos;use after free&apos; - for example when a system <a href="#removing-components-during-all-or-stream-blocks">removes rows while iterating</a>.</p>
<p>The injected variable <code>entity</code> contains the entity that the row started with.
This is the same as <code>item.entity</code>, but is still valid if the system removes its own rows during iteration.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;displayItem&quot;</span>, [<span class="ide">Comp1</span>]:</div></div><div class="line"><div class="line-content">  <span class="ide">all</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;Current entity: &quot;</span>, <span class="ide">item</span><span class="op">.</span><span class="ide">entity</span></div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;Comp1: &quot;</span>, <span class="ide">item</span><span class="op">.</span><span class="ide">comp1</span></div></div><div class="line"><div class="line-content">    <span class="ide">assert</span> <span class="ide">entity</span> <span class="op">==</span> <span class="ide">item</span><span class="op">.</span><span class="ide">entity</span></div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="ide">entity</span><span class="op">.</span><span class="ide">fetch</span>(<span class="ide">SomeOtherComponent</span>)</div></div>  </code></pre>
<h4>Access templates and aliasing</h4>
<p>Lots of <code>item</code> ends up becoming boilerplate.</p>
<p>For easier reading, a set of templates is created for each component that does the equivalent to <code>item.component</code>:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;displayItem2&quot;</span>, [<span class="ide">Comp1</span>]:</div></div><div class="line"><div class="line-content">  <span class="ide">all</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;Comp1: &quot;</span>, <span class="ide">comp1</span> <span class="com"># Equivalent to item.comp1.</span></div></div>  </code></pre>
<p>These can be aliased using colons in the system&apos;s component requirements.</p>
<p>Note that this only renames the access template, not the component itself, nor it&apos;s field in the current <code>item</code>.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;displayItem2&quot;</span>, [<span class="ide">c1</span>: <span class="ide">Comp1</span>]:</div></div><div class="line"><div class="line-content">  <span class="ide">all</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;Comp1: &quot;</span>, <span class="ide">c1</span> <span class="com"># Equivalent to item.comp1.</span></div></div>  </code></pre>
<p>Aliasing is also useful for component libraries that combine with externally created components:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">template</span> <span class="ide">systemUsingComp</span>(<span class="ide">userComponent</span>: <span class="ide">typedesc</span>) {<span class="op">.</span><span class="ide">dirty</span><span class="op">.</span>} <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="ide">makeSystem</span> <span class="str">&quot;use&quot;</span> <span class="op">&amp;</span> <span class="op">$</span><span class="ide">userComponent</span>, [<span class="ide">uc</span>: <span class="ide">userComponent</span>]:</div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="ide">sys</span><span class="op">.</span><span class="ide">name</span></div></div><div class="line"><div class="line-content">    <span class="ide">all</span>:</div></div><div class="line"><div class="line-content">      <span class="com"># &apos;userComponent&apos; is a type.</span></div></div><div class="line"><div class="line-content">      <span class="com"># To access it in the current row we have to know the ident in</span></div></div><div class="line"><div class="line-content">      <span class="com"># lower case.</span></div></div><div class="line"><div class="line-content">      </div></div><div class="line"><div class="line-content">      <span class="com"># We could do this:</span></div></div><div class="line"><div class="line-content">      <span class="ide">echo</span> <span class="ide">userComponent</span><span class="op">.</span><span class="ide">access</span></div></div><div class="line"><div class="line-content">      </div></div><div class="line"><div class="line-content">      <span class="com"># Aliasing makes things more clear:</span></div></div><div class="line"><div class="line-content">      <span class="ide">echo</span> <span class="ide">uc</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">register</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span></div></div><div class="line"><div class="line-content">    <span class="ide">MyComp1</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">data</span>: <span class="ide">int</span></div></div><div class="line"><div class="line-content">    <span class="ide">MyComp2</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">data</span>: <span class="ide">int</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Create systems for MyComp1 and MyComp2.</span></div></div><div class="line"><div class="line-content"><span class="ide">systemUsingComp</span>(<span class="ide">MyComp1</span>)</div></div><div class="line"><div class="line-content"><span class="ide">systemUsingComp</span>(<span class="ide">MyComp2</span>)</div></div>  </code></pre>
<h2>System component negation</h2>
<p>Systems can also be defined to only match when components are not present:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;notB&quot;</span>, [<span class="ide">A</span>, <span class="kwd">not</span> <span class="ide">B</span>]:</div></div><div class="line"><div class="line-content">  <span class="kwd">discard</span></div></div>  </code></pre>
<h2>Systems without components</h2>
<p>Systems can be defined without components in order to run code within the system workflow:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;noComponents&quot;</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;Runs within the expect system order&quot;</span></div></div>  </code></pre>
<p>These systems cannot use <code>all</code> or <code>stream</code> blocks, since they don&apos;t store components to process.</p>
<h2>Committing systems</h2>
<p>Once committed, each system is output as a procedure named after the system, prefixed with &quot;<code>do</code>&quot;.</p>
<p>Separating <code>makeEcs</code> and <code>commitSystems</code> allows for more design flexibility, for example:</p>
<ul>
<li>to write code that uses the sealed ECS (after <code>makeEcs</code>) and is also used within system code,</li>
<li>to allow the sealed ECS and system code as separate imports,</li>
<li>to split systems into separate wrapper procs.</li>
</ul>
<p>Systems bind at the site they&apos;re output, <em>not</em> where the body is defined with <code>makeSystem</code>.</p>
<p>By default, systems types and instances are emitted by <code>makeEcs</code>, and <code>commitSystems</code> emits the system procedure.</p>
<p>As such, external routines or variables used by systems need to be accessible at the commit site.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># CommitSystems uses the string parameter to create a wrapper proc that</span></div></div><div class="line"><div class="line-content"><span class="com"># runs the systems it outputs in order.</span></div></div><div class="line"><div class="line-content"><span class="ide">commitSystems</span> <span class="str">&quot;runMySystems&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Run systems output by `commitSystems` above.</span></div></div><div class="line"><div class="line-content"><span class="ide">runMySystems</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># You can run systems individually using their `do` proc.</span></div></div><div class="line"><div class="line-content"><span class="ide">doMySystem</span>()</div></div>  </code></pre>
<h2>  <code>ecsImport</code></h2>
<p>In this example, <code>foo</code> is only visible in <code>moduleA</code>, but the &quot;useImported&quot; system is actually output in <code>moduleB</code>:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># Module A</span></div></div><div class="line"><div class="line-content"><span class="kwd">from</span> <span class="ide">localModule</span> <span class="kwd">import</span> <span class="ide">foo</span></div></div><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;useImported&quot;</span>: <span class="ide">echo</span> <span class="ide">foo</span>  <span class="com"># Can&apos;t find &apos;foo&apos;!</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Module B</span></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">moduleA</span></div></div><div class="line"><div class="line-content"><span class="ide">makeEcs</span>()</div></div><div class="line"><div class="line-content"><span class="ide">commitSystems</span>()  <span class="com"># &lt;- &quot;useImported&quot; is emitted here, where &apos;foo&apos; is not imported.</span></div></div>  </code></pre>
<p>To help with this kind of deferred output, <code>ecsImport</code> and <code>ecsImportFrom</code> allow deferring imports to <code>makeEcs</code>.
Similarly, <code>ecsImportCommit</code>/<code>ecsImportCommitFrom</code> allows deferring imports to just before the system procedure is emitted.</p>
<p>This offers two advantages.</p>
<p>Firstly it lets you write <code>ecsImport</code> alongside your system definitions, and have them emitted where the code is placed.</p>
<p>Secondly, imports are tried relative to the call site path first, and passed through unchanged if that doesn&apos;t compile.
This lets you spread system declarations and support modules into different directory structures and write the imports as if they were run at the call site.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># Module A</span></div></div><div class="line"><div class="line-content"><span class="ide">ecsImportFrom</span> <span class="ide">localModule</span>, <span class="ide">foo</span></div></div><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;useImported&quot;</span>: <span class="ide">echo</span> <span class="ide">foo</span>  <span class="com"># &apos;foo&apos; is found!</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Module B</span></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">moduleA</span></div></div><div class="line"><div class="line-content"><span class="ide">makeEcs</span>()       <span class="com"># &lt;- &apos;from localModule import foo&apos; emitted here.</span></div></div><div class="line"><div class="line-content"><span class="ide">commitSystems</span>() <span class="com"># &lt;- &quot;useImported&quot; can now see &apos;foo&apos;.</span></div></div>  </code></pre>
<h2>System execution order</h2>
<p>The order systems are run defines how your ECS operates.</p>
<p>By default, systems are emitted by <code>commitSystems</code> in the order they&apos;re defined by <code>defineSystem</code>.</p>
<p>When no matching <code>defineSystem</code> is present, <code>makeSystem</code> will invoke <code>defineSystem</code> for you.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">executionOrder</span>: <span class="ide">seq</span>[<span class="ide">string</span>]</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span> <span class="ide">Foo</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># The order systems are defined sets the order they&apos;re run when output</span></div></div><div class="line"><div class="line-content"><span class="com"># by `commitSystems`.</span></div></div><div class="line"><div class="line-content"><span class="ide">defineSystem</span> <span class="str">&quot;a&quot;</span>, [<span class="ide">Foo</span>], <span class="ide">EcsSysOptions</span>(<span class="ide">maxEntities</span>: <span class="num">1</span>)</div></div><div class="line"><div class="line-content"><span class="ide">defineSystem</span> <span class="str">&quot;b&quot;</span>, [<span class="ide">Foo</span>]</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Define the system &quot;c&quot; and also add a code body.</span></div></div><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;c&quot;</span>, [<span class="ide">Foo</span>]:</div></div><div class="line"><div class="line-content">  <span class="ide">executionOrder</span><span class="op">.</span><span class="ide">add</span> <span class="ide">sys</span><span class="op">.</span><span class="ide">name</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Seal and generate the ECS.</span></div></div><div class="line"><div class="line-content"><span class="ide">makeEcs</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Define the code body for &quot;a&quot;.</span></div></div><div class="line"><div class="line-content"><span class="ide">makeSystemBody</span> <span class="str">&quot;a&quot;</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">executionOrder</span><span class="op">.</span><span class="ide">add</span> <span class="ide">sys</span><span class="op">.</span><span class="ide">name</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Both &quot;c&quot; and &quot;a&quot; have bodies waiting to be committed, but &quot;b&quot; doesn&apos;t</span></div></div><div class="line"><div class="line-content"><span class="com"># have a code body yet and so is not included in the output of `commitSystems`.</span></div></div><div class="line"><div class="line-content"><span class="com">#</span></div></div><div class="line"><div class="line-content"><span class="com"># As systems are run in the order they&apos;re defined, the output proc will</span></div></div><div class="line"><div class="line-content"><span class="com"># run &quot;a&quot; then &quot;c&quot;.</span></div></div><div class="line"><div class="line-content"><span class="ide">commitSystems</span> <span class="str">&quot;runAC&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Define the body for &quot;b&quot;. This will be included in the next `commitSystems`.</span></div></div><div class="line"><div class="line-content"><span class="ide">makeSystemBody</span> <span class="str">&quot;b&quot;</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">executionOrder</span><span class="op">.</span><span class="ide">add</span> <span class="ide">sys</span><span class="op">.</span><span class="ide">name</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Only &quot;b&quot; has an uncommitted code body so the output will just run &quot;b&quot;.</span></div></div><div class="line"><div class="line-content"><span class="ide">commitSystems</span> <span class="str">&quot;runB&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Execute the two run procs.</span></div></div><div class="line"><div class="line-content"><span class="ide">runAC</span>()</div></div><div class="line"><div class="line-content"><span class="ide">runB</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Check the order of execution is as expected.</span></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">executionOrder</span> <span class="op">==</span> <span class="op">@</span>[<span class="str">&quot;a&quot;</span>, <span class="str">&quot;c&quot;</span>, <span class="str">&quot;b&quot;</span>]</div></div>  </code></pre>
<h2>Running systems at time intervals</h2>
<p>The <code>timings</code> field in <code>EcsSysOptions</code> lets you control the type of timing code the system uses:</p>
<ul>
<li>
<p><code>stNone</code>: the default is to not insert timing code.</p>
</li>
<li>
<p><code>stRunEvery</code>: insert code to allow the system to run at intervals.</p>
<p>Inserts the following fields into the system:</p>
<ul>
<li><code>lastTick</code>: keeps track of the last time a system was executed.</li>
<li><code>runEvery</code>: when this field is non-zero, the system will only trigger after this many seconds.
A value of zero runs the system without delay as if it were defined with <code>stNone</code>.</li>
</ul>
</li>
<li>
<p><code>stProfiling</code>: implies <code>stRunEvery</code> and adds fields for measuring system performance.</p>
<p>The following procedures access per run timings:</p>
<ul>
<li><code>timePerRun</code>: time taken for the last system run.</li>
<li><code>timePerItem</code>: the <code>timePerRun</code> divided by the number of items in the system.</li>
</ul>
<p>Min/max timing procedures return accumulated times over multiple system runs:</p>
<ul>
<li><code>minTimePerItem</code>: the minimum time recorded for a single item so far.</li>
<li><code>maxTimePerItem</code>: the maximum time recorded for a single item so far.</li>
<li><code>minTimePerRun</code>: the minimum time recorded for a system run so far.</li>
<li><code>maxTimePerRun</code>: the maximum time recorded for a system run so far.</li>
</ul>
<p>These timings can be manually reset with the <code>resetMinMax</code> procedure.</p>
</li>
</ul>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span>, <span class="ide">os</span>, <span class="ide">times</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span> <span class="ide">Foo</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">seen</span>: <span class="ide">int</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeSystemOpts</span> <span class="str">&quot;runEvery&quot;</span>, [<span class="ide">Foo</span>], <span class="ide">EcsSysOptions</span>(<span class="ide">timings</span>: <span class="ide">stRunEvery</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">all</span>: <span class="ide">foo</span><span class="op">.</span><span class="ide">seen</span> <span class="op">+=</span> <span class="num">1</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeSystemOpts</span> <span class="str">&quot;sleepy&quot;</span>, [<span class="ide">Foo</span>], <span class="ide">EcsSysOptions</span>(<span class="ide">timings</span>: <span class="ide">stProfiling</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">all</span>: <span class="ide">sleep</span>(<span class="num">10</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeEcs</span>()</div></div><div class="line"><div class="line-content"><span class="ide">commitSystems</span> <span class="str">&quot;run&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">sysRunEvery</span><span class="op">.</span><span class="ide">runEvery</span> <span class="op">=</span> <span class="num">0.1</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">entity</span> <span class="op">=</span> <span class="ide">newEntityWith</span>(<span class="ide">Foo</span>())</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">for</span> <span class="ide">i</span> <span class="kwd">in</span> <span class="num">0</span> <span class="op">..&lt;</span> <span class="num">200</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">run</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">echo</span> <span class="str">&quot;Last: &quot;</span>, <span class="ide">sysSleepy</span><span class="op">.</span><span class="ide">timePerRun</span></div></div><div class="line"><div class="line-content"><span class="ide">echo</span> <span class="str">&quot; Min: &quot;</span>, <span class="ide">sysSleepy</span><span class="op">.</span><span class="ide">minTimePerRun</span></div></div><div class="line"><div class="line-content"><span class="ide">echo</span> <span class="str">&quot; Max: &quot;</span>, <span class="ide">sysSleepy</span><span class="op">.</span><span class="ide">maxTimePerRun</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span></div></div><div class="line"><div class="line-content">  <span class="ide">start</span> <span class="op">=</span> <span class="ide">cpuTime</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">while</span> <span class="ide">cpuTime</span>() <span class="op">-</span> <span class="ide">start</span> <span class="op">&lt;</span> <span class="num">1.0</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">run</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">echo</span> <span class="str">&quot;Seen: &quot;</span>, <span class="ide">entity</span><span class="op">.</span><span class="ide">fetch</span> <span class="ide">Foo</span></div></div>  </code></pre>
<p>Output (timings will vary as <code>sleep</code> works with OS time slices):</p>
<pre>  <code>Last: 0.016
 Min: 0.015
 Max: 0.025
Seen: (seen: 37)
</code></pre>
<h2>Adding custom fields to systems</h2>
<p>Passing field definitions to <code>defineSystem</code> will add them to the system variable declaration.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">const</span> <span class="ide">sysOpts</span> <span class="op">=</span> <span class="ide">EcsSysOptions</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">defineSystem</span> <span class="str">&quot;mySystem&quot;</span>, [<span class="ide">Comp1</span>], <span class="ide">sysOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">myFieldStr</span>: <span class="ide">string</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">sysMySystem</span><span class="op">.</span><span class="ide">myFieldStr</span> <span class="op">=</span> <span class="str">&quot;Foo&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeSystemBody</span> <span class="str">&quot;mySystem&quot;</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;myFieldStr = &quot;</span>, <span class="ide">sys</span><span class="op">.</span><span class="ide">myFieldStr</span></div></div>  </code></pre>
<p>These fields can also be initialised at system creation.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">defineSystem</span> <span class="str">&quot;mySystem&quot;</span>, [<span class="ide">Comp1</span>], <span class="ide">sysOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">myFieldStr</span> <span class="op">=</span> <span class="str">&quot;Foo&quot;</span></div></div>  </code></pre>
<p>When the type cannot be inferred but needs to be initialised, you can explicitly define it.</p>
<p>Since <code>name: type = value</code> isn&apos;t valid syntax in this context, the type is defined with <code>-&gt;</code>.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">defineSystem</span> <span class="str">&quot;mySystem&quot;</span>, [<span class="ide">Comp1</span>], <span class="ide">sysOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">myFieldStr</span> <span class="op">-&gt;</span> <span class="ide">string</span> <span class="op">=</span> <span class="str">&quot;Foo&quot;</span></div></div>  </code></pre>
<p>Fields can also be added when defining a system and its body with <code>makeSystem</code> by using the <code>fields</code> block. If the system has already been defined these fields are checked to match the definition.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;mySystem&quot;</span>, [<span class="ide">Comp1</span>]:</div></div><div class="line"><div class="line-content">  <span class="ide">fields</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">myFieldInt</span>: <span class="ide">int</span></div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;This system has a custom field: &quot;</span>, <span class="ide">sys</span><span class="op">.</span><span class="ide">myFieldInt</span></div></div>  </code></pre>
<h2>Grouping systems</h2>
<p>Systems can be extracted into separate procedures using <code>defineGroup</code>. Grouping can be useful to separate the concerns of multiple systems to particular procedures.</p>
<p>Systems can be part of <em>multiple</em> groups at the same time.</p>
<p>When a system is grouped, it will not be output by <code>commitSystem</code> and must be manually output using <code>commitGroup</code>.</p>
<p>Grouping can be performed explicitly by passing a list of systems to <code>defineGroup</code>, or ad hoc by using <code>defineGroup</code> without specifying systems. In the latter case, any systems that have been defined but <em>not already grouped or committed</em> are added to the group.</p>
<p>It&apos;s a compile time error to try to perform <code>commitGroup</code> for systems that don&apos;t have bodies.</p>
<p>Grouping can occur before or after <code>makeEcs</code>.</p>
<p>Group names are case insensitive.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span> <span class="ide">Comp1</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;g1a&quot;</span>, [<span class="ide">Comp1</span>]: <span class="kwd">discard</span></div></div><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;g1b&quot;</span>, [<span class="ide">Comp1</span>]: <span class="kwd">discard</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Gather previously defined systems into a group.</span></div></div><div class="line"><div class="line-content"><span class="ide">defineGroup</span> <span class="str">&quot;group1&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;g2a&quot;</span>, [<span class="ide">Comp1</span>]: <span class="kwd">discard</span></div></div><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;g2b&quot;</span>, [<span class="ide">Comp1</span>]: <span class="kwd">discard</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Add specific systems to a group.</span></div></div><div class="line"><div class="line-content"><span class="ide">defineGroup</span> <span class="str">&quot;group2&quot;</span>, [<span class="str">&quot;g2a&quot;</span>, <span class="str">&quot;g2b&quot;</span>]</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;ungrouped&quot;</span>, [<span class="ide">Comp1</span>]: <span class="kwd">discard</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeEcs</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">commitGroup</span> <span class="str">&quot;group1&quot;</span>, <span class="str">&quot;runGroup1&quot;</span></div></div><div class="line"><div class="line-content"><span class="ide">commitGroup</span> <span class="str">&quot;group2&quot;</span>, <span class="str">&quot;runGroup2&quot;</span></div></div><div class="line"><div class="line-content"><span class="com"># Commit the remaining &quot;ungrouped&quot; system.</span></div></div><div class="line"><div class="line-content"><span class="ide">commitSystems</span> <span class="str">&quot;runUngrouped&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">runGroup1</span>()</div></div><div class="line"><div class="line-content"><span class="ide">runGroup2</span>()</div></div><div class="line"><div class="line-content"><span class="ide">runUngrouped</span>()</div></div>  </code></pre>
<h3>Execution control</h3>
<p>Systems can be paused by setting the system <code>paused</code> field to <code>true</code>.</p>
<p>When paused, the system body doesn&apos;t run, but <em>system scope</em> blocks are still executed. This can be useful for things like self pausing &quot;fire once&quot; systems and conditional system execution.</p>
<p>Systems can be disabled by setting the system <code>disabled</code> field to <code>true</code>. When disabled a system performs no work until <code>disabled</code> is <code>false</code>.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span> <span class="ide">DemoExecCtrl</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;fireOnce&quot;</span>, [<span class="ide">DemoExecCtrl</span>]:</div></div><div class="line"><div class="line-content">  <span class="ide">finish</span>: <span class="ide">sys</span><span class="op">.</span><span class="ide">paused</span> <span class="op">=</span> <span class="ide">true</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;One time.&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;fireAlt&quot;</span>, [<span class="ide">DemoExecCtrl</span>]:</div></div><div class="line"><div class="line-content">  <span class="ide">fields</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">ticks</span>: <span class="ide">int</span></div></div><div class="line"><div class="line-content">  <span class="ide">start</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">sys</span><span class="op">.</span><span class="ide">paused</span> <span class="op">=</span> <span class="ide">sys</span><span class="op">.</span><span class="ide">ticks</span> <span class="kwd">mod</span> <span class="num">3</span> <span class="op">==</span> <span class="num">0</span></div></div><div class="line"><div class="line-content">    <span class="ide">sys</span><span class="op">.</span><span class="ide">ticks</span> <span class="op">+=</span> <span class="num">1</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;Alternating: &quot;</span>, <span class="ide">sys</span><span class="op">.</span><span class="ide">ticks</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeEcs</span>()</div></div><div class="line"><div class="line-content"><span class="ide">commitSystems</span> <span class="str">&quot;run&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">for</span> <span class="ide">i</span> <span class="kwd">in</span> <span class="num">0</span> <span class="op">..&lt;</span> <span class="num">5</span>: <span class="ide">run</span>()</div></div>  </code></pre>
<p>Outputs:</p>
<pre>  <code>One time.
Alternating: 2
Alternating: 3
Alternating: 5
</code></pre>
<h3>Removing components during <code>all</code> or <code>stream</code> blocks</h3>
<p>Operations that remove rows from the <em>currently iterating</em> system in a work item block may invalidate the <code>item</code> template until the next row.</p>
<p>For example <code>item.entity.delete</code> or <code>item.entity.removeComponent</code> with components the system uses (both of which will cause the current row to be removed) causes <code>item</code> refer to a different entity and set of components, or even out of bounds memory!</p>
<p>To force checking this condition each time <code>item</code> is accessed at run time, set <code>assertItem = true</code> in the <code>ECSSysOptions</code> passed when defining the system. This inserts an <code>assert</code> inside the <code>item</code> template to ensure it refers to the same row the iteration step started on, and that the row is within the system&apos;s item bounds.</p>
<p>Alternatively, to perform compile time checking with destructive iteration pass <code>-d:ecsStrict</code> when compiling (see <a href="#compile-switches">compile switches</a>). This will halt compilation when <code>item</code> is used after a system removes components that affect the iterating system, or if <code>item</code> is used after <em>any</em> delete operation. Note that this does not perform semantic analysis of the code, and will respond in the same to conditional remove/delete operations even when they are not triggered.</p>
<p>To help with these cases without needing run time or compile time checks, the <code>entity</code> variable accessible in these blocks references the entity that the row <em>originally</em> started with, regardless of the system state. This can be useful when you want to perform destructive operations to the row without worrying about the <code>item</code> being invalidated:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;processEntities&quot;</span>, [<span class="ide">SomeComponent</span>]:</div></div><div class="line"><div class="line-content">  <span class="ide">all</span>:</div></div><div class="line"><div class="line-content">    <span class="com"># Removing a component used by the system will remove</span></div></div><div class="line"><div class="line-content">    <span class="com"># the row and invalidates `item`.</span></div></div><div class="line"><div class="line-content">    <span class="ide">entity</span><span class="op">.</span><span class="ide">remove</span> <span class="ide">SomeComponent</span></div></div><div class="line"><div class="line-content">    <span class="com"># Accessing `item` here is a compile error as the row no longer exists.</span></div></div><div class="line"><div class="line-content">    <span class="com"># We can, however, still access the original `entity`.</span></div></div><div class="line"><div class="line-content">    <span class="ide">entity</span><span class="op">.</span><span class="ide">add</span> <span class="ide">SomeOtherComponent</span></div></div>  </code></pre>
<p>Polymorph detects when you add or remove components that affect the currently iterating system within <code>all</code> and <code>stream</code> blocks at compile time, and will add extra checks to ensure iterations stay within bounds.</p>
<p><em>Deleting</em> entities, however, is opaque to compile time analysis as it cannot be known what components exist on a run time entity. This means these checks will always be added when deleting entities inside <code>all</code> or <code>stream</code> blocks.</p>
<p>To see information about which system iteration loops are affected by removes/deletes, compile with <code>-d:ecsPerformanceHints</code>.</p>
<p>Another option for deleting entities is to use the system&apos;s <code>deleteList</code>. Any entity added to this <code>seq</code> will be removed after the <code>finish</code> block is executed, and the list is then cleared. These deletes don&apos;t affect iteration, but simple appending may cause a heap allocation and potentially memory moving as part of the standard <code>seq</code> operation. For extensive use of <code>deleteList</code>, it may be worth setting the capacity at the start of system execution.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;deleteEntities&quot;</span>, [<span class="ide">SomeComponent</span>]:</div></div><div class="line"><div class="line-content">  <span class="ide">all</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">sys</span><span class="op">.</span><span class="ide">deleteList</span><span class="op">.</span><span class="ide">add</span> <span class="ide">entity</span></div></div>  </code></pre>
<h2>System utilities</h2>
<p>You can perform delete/remove operations on systems as a whole with the following two operations:</p>
<h3>  <code>clear</code></h3>
<p>Deletes <strong>all entities</strong> in the given system. Use with caution!</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">mySystem</span><span class="op">.</span><span class="ide">clear</span></div></div>  </code></pre>
<h3><code>remove</code>/<code>removeComponents</code></h3>
<p>Removes one or more components from all entities in the given system.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">mySystem</span><span class="op">.</span><span class="ide">remove</span> <span class="ide">Comp1</span>, <span class="ide">Comp2</span>, <span class="ide">Comp3</span></div></div>  </code></pre>
<p>Within system blocks you can use the <code>sys</code> template with these utilities to act on the current system:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;removeComp1&quot;</span>, [<span class="ide">Comp1</span>]:</div></div><div class="line"><div class="line-content">  <span class="ide">finish</span>: <span class="ide">sys</span><span class="op">.</span><span class="ide">remove</span> <span class="ide">Comp1</span></div></div>  </code></pre>
<h3>  <code>systemsUsed</code></h3>
<p>This utility returns a string containing the systems that would be used for entities with a particular set of components. This can be used as a static debugging tool to check a set of components invokes the systems you expect.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">echo</span> <span class="ide">systemsUsed</span>([<span class="ide">MyComponent1</span>, <span class="ide">MyComponent2</span>])</div></div>  </code></pre>
<h3>  <code>caseSystem</code></h3>
<p>Similar to <code>caseComponent</code>, the <code>caseSystem</code> template creates a case statement that matches a <code>SystemIndex</code> with its instantiation.</p>
<p>This generates a runtime case statement that will perform <code>actions</code> for all systems.</p>
<p>This allows you to write generic code that dynamically applies to any system chosen at runtime.</p>
<p>The <code>SystemIndex</code> of a system variable is accessed from the <code>id</code> field at run time.</p>
<p>Within <code>caseSystem</code>, use the <code>sys</code> template to access to the system variable the index represents, and <code>SystemTupleType</code> to reference the tuple type for the system&apos;s <code>groups</code> field (in other words, the type of the system&apos;s <code>item</code> when iterating).</p>
<h1>Working with entities</h1>
<h2>Creating entities</h2>
<p>Once <code>makeEcs</code> has finished, entities can be created with either <code>newEntity</code> or <code>newEntityWith</code>, where the latter allows setting up entities with components.</p>
<p>In particular, <code>newEntityWith</code> can be a very performant way to create entities, as by definition the entity can only contain the components passed to it, and the systems that need to be updated are fully constrained at compile time.</p>
<p>This means that the output code consists of simply updating the entity&apos;s internal list and producing static system updates only where parameter components fully satisfy systems. No conditional work is required.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span></div></div><div class="line"><div class="line-content">    <span class="ide">Comp1</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">value</span>: <span class="ide">int</span></div></div><div class="line"><div class="line-content">    <span class="ide">Comp2</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">value</span>: <span class="ide">string</span></div></div><div class="line"><div class="line-content">    <span class="ide">Comp3</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">value</span>: <span class="ide">float</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;mySystem&quot;</span>, [<span class="ide">Comp1</span>, <span class="ide">Comp2</span>]:</div></div><div class="line"><div class="line-content">  <span class="ide">all</span>: <span class="kwd">discard</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeEcs</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span></div></div><div class="line"><div class="line-content">  <span class="com"># An entity without any components.</span></div></div><div class="line"><div class="line-content">  <span class="ide">entity</span> <span class="op">=</span> <span class="ide">newEntity</span>()</div></div><div class="line"><div class="line-content">  </div></div><div class="line"><div class="line-content">  <span class="com"># Create an entity and include it in &quot;mySystem&quot;.</span></div></div><div class="line"><div class="line-content">  <span class="ide">entWithComps</span> <span class="op">=</span> <span class="ide">newEntityWith</span>(</div></div><div class="line"><div class="line-content">    <span class="ide">Comp1</span>(<span class="ide">value</span>: <span class="num">123</span>),</div></div><div class="line"><div class="line-content">    <span class="ide">Comp2</span>(<span class="ide">value</span>: <span class="str">&quot;Foo&quot;</span>))</div></div>  </code></pre>
<h2>Adding components to existing entities</h2>
<p>Entities can be updated &apos;piecemeal&apos; with <code>add</code> or <code>addComponents</code>.</p>
<p>This operation also supports multiple components at a time. Providing multiple components in one operation (as opposed to several singular <code>add</code> operations) can help inform code generation to confirm systems that are definitely being updated, producing non-conditional code.</p>
<blockquote>
<p><strong>Note</strong>: it&apos;s a run time error to add a component type that already exists on the entity.</p>
</blockquote>
<p>Adding components returns the component instances that have been added. For multiple components, this is a named tuple of the components being added. For single components, just the instance is returned.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># `comps` is a named tuple with the instances of the components we&apos;ve added.</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">comps</span> <span class="op">=</span> <span class="ide">entity</span><span class="op">.</span><span class="ide">add</span>(<span class="ide">Comp1</span>(<span class="ide">value</span>: <span class="num">456</span>), <span class="ide">Comp2</span>(<span class="ide">value</span>: <span class="str">&quot;Bar&quot;</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">echo</span> <span class="str">&quot;Comp1: &quot;</span>, <span class="ide">comps</span><span class="op">.</span><span class="ide">comp1</span>, <span class="str">&quot; Comp2: &quot;</span>, <span class="ide">comps</span><span class="op">.</span><span class="ide">comp2</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># For single components, just the component being added is returned.</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">comp3</span> <span class="op">=</span> <span class="ide">entity</span><span class="op">.</span><span class="ide">add</span>(<span class="ide">Comp3</span>(<span class="ide">value</span>: <span class="num">0.123</span>))</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">echo</span> <span class="str">&quot;Comp3: &quot;</span>, <span class="ide">comp3</span></div></div>  </code></pre>
<h2>Fetching and checking for components</h2>
<p>To retrieve a component from an entity, use <code>fetch</code>/<code>fetchComponent</code>. This takes the <em>type</em> of the component and returns an instance.</p>
<p>Fetching a component that doesn&apos;t exist on the entity returns <code>InvalidComponent</code>, and can be checked for with <code>valid</code>.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">comp1</span> <span class="op">=</span> <span class="ide">myEntity</span><span class="op">.</span><span class="ide">fetch</span> <span class="ide">Comp1</span></div></div><div class="line"><div class="line-content"><span class="kwd">if</span> <span class="ide">comp1</span><span class="op">.</span><span class="ide">valid</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;Comp1 was found: &quot;</span>, <span class="ide">comp1</span></div></div><div class="line"><div class="line-content"><span class="kwd">else</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;Comp1 was not found.&quot;</span></div></div>  </code></pre>
<p>To see if a component exists on an entity without fetching it, use <code>has</code>/<code>hasComponent</code>.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">if</span> <span class="ide">myEntity</span><span class="op">.</span><span class="ide">has</span>(<span class="ide">Comp1</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;Comp1 was found!&quot;</span></div></div><div class="line"><div class="line-content"><span class="kwd">else</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;Comp1 was not found.&quot;</span></div></div>  </code></pre>
<h2>Removing components</h2>
<p>Removing components is performed with <code>remove</code> or <code>removeComponents</code>. Much like adding, this operation also allows multiple components to be removed in a single operation.</p>
<p>This takes the <em>type</em> of components.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># Remove components from the entity and systems using Comp1 and/or Comp2.</span></div></div><div class="line"><div class="line-content"><span class="ide">entity</span><span class="op">.</span><span class="ide">remove</span> <span class="ide">Comp1</span>, <span class="ide">Comp2</span></div></div>  </code></pre>
<h2>Deleting entities</h2>
<p>Entities are deleting using the <code>delete</code> operation. This operation is fully run time bound, as components cannot be determined at compile time. However, like other operations, it is generated as a static procedure from your design at compile time, so fewer components in a design will generate less code.</p>
<p>In general, the performance of <code>delete</code> depends on how many components the entity has. Deleting also doesn&apos;t need to bookkeep the components being removed like <code>remove</code> does.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># Remove the entity and delete associated component and/or system storage.</span></div></div><div class="line"><div class="line-content"><span class="ide">entity</span><span class="op">.</span><span class="ide">delete</span></div></div>  </code></pre>
<h2>Checking entities satisfy specific systems</h2>
<p>The <code>expectSystems</code> utility will generate a <code>doAssert</code> operation to ensure that an entity is using particular systems. The code is constructed at compile time based on the systems passed to it and is therefore unique to your design and the systems involved.</p>
<p>When the entity doesn&apos;t match the parameter systems and the <code>doAssert</code> fails, the following output is produced:</p>
<ul>
<li>the expected systems passed in the parameters,</li>
<li>the current systems the entity satisfies,</li>
<li>the missing systems, and components the entity lacks to satisfy these systems,</li>
<li>the entity&apos;s current components,</li>
<li>a summary of all components required to satisfy all missing systems.</li>
</ul>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">entity</span><span class="op">.</span><span class="ide">expectSystems</span> [<span class="str">&quot;mySystem1&quot;</span>, <span class="str">&quot;mySystem2&quot;</span>]</div></div>  </code></pre>
<h1>Constructing entities at run time</h1>
<p><code>makeEcs</code> generates a <code>construct</code> procedure that lets you build entities from lists of components.</p>
<p>This is fairly efficient, as the list is parsed for types then the entity is created in a single integrated operation in a similar way to <code>newEntityWith</code>. As such it can elide the speculation and repeated work of multiple separate <code>addComponent</code> operations.</p>
<p>To allow storing different component types in a single list, <code>registerComponents</code> generates a <code>ref</code> container type for each component, descended from the <code>Component</code> object.</p>
<p>These container types are defined as the component type name postfixed with <code>Ref</code>.</p>
<p>The <code>construct</code> procedure then takes a <code>seq[Component]</code>, aliased as <code>ComponentList</code>, to build an entity.</p>
<p>All container types have a <code>typeId</code> that must be initialised with the component&apos;s <code>ComponentTypeId</code> in order for <code>construct</code> to extract the value from the subtype. Containers with an uninitialised <code>typeId</code> will cause <code>construct</code> to fail at run time.</p>
<p>The <code>makeContainer</code> template will correctly set up containers for individual components.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">mcContainer</span> <span class="op">=</span> <span class="ide">MyComponent</span>(<span class="ide">data</span>: <span class="num">1234</span>)<span class="op">.</span><span class="ide">makeContainer</span></div></div>  </code></pre>
<p>The <code>cl</code> macro makes setting up a <code>ComponentList</code> much more convenient.</p>
<p>This macro lets you mix the original component types and <code>ref</code> container types, and ensures containers are correctly set up. Another advantage of <code>cl</code> is that it always outputs <code>ComponentList</code>, and avoids over constraining the list type when single components are used - for example <code>@[MyComponentRef()]</code> is of type <code>seq[MyComponentRef]</code>, not the <code>seq[Component]</code> type that <code>construct</code> expects.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span></div></div><div class="line"><div class="line-content">    <span class="ide">Comp1</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">value</span>: <span class="ide">int</span></div></div><div class="line"><div class="line-content">    <span class="ide">Comp2</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">value</span>: <span class="ide">string</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeEcs</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span></div></div><div class="line"><div class="line-content">  <span class="ide">entityBlueprint</span> <span class="op">=</span> <span class="ide">cl</span>(<span class="ide">Comp1</span>(<span class="ide">value</span>: <span class="num">1234</span>), <span class="ide">Comp2</span>(<span class="ide">value</span>: <span class="str">&quot;Foo&quot;</span>))</div></div><div class="line"><div class="line-content">  <span class="ide">entity</span> <span class="op">=</span> <span class="ide">entityBlueprint</span><span class="op">.</span><span class="ide">construct</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span></div></div><div class="line"><div class="line-content">  <span class="ide">c1</span> <span class="op">=</span> <span class="ide">entity</span><span class="op">.</span><span class="ide">fetch</span> <span class="ide">Comp1</span></div></div><div class="line"><div class="line-content">  <span class="ide">c2</span> <span class="op">=</span> <span class="ide">entity</span><span class="op">.</span><span class="ide">fetch</span> <span class="ide">Comp2</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">c1</span><span class="op">.</span><span class="ide">value</span> <span class="op">==</span> <span class="num">1234</span></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">c2</span><span class="op">.</span><span class="ide">value</span> <span class="op">==</span> <span class="str">&quot;Foo&quot;</span></div></div>  </code></pre>
<h2>Constructing multiple entities</h2>
<p>To create multiple entities in one operation, a <code>seq[ComponentList]</code> is used. This is aliased as <code>ConstructionTemplate</code>.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">let</span></div></div><div class="line"><div class="line-content">  <span class="ide">myEntityBlueprints</span> <span class="op">=</span> <span class="op">@</span>[</div></div><div class="line"><div class="line-content">    <span class="ide">cl</span>(<span class="ide">Comp1</span>(<span class="ide">value</span>: <span class="num">1234</span>), <span class="ide">Comp2</span>(<span class="ide">value</span>: <span class="str">&quot;Foo&quot;</span>)),</div></div><div class="line"><div class="line-content">    <span class="ide">cl</span>(<span class="ide">Comp2</span>(<span class="ide">value</span>: <span class="str">&quot;Bar&quot;</span>)),</div></div><div class="line"><div class="line-content">  ]</div></div><div class="line"><div class="line-content">  <span class="ide">myEntities</span> <span class="op">=</span> <span class="ide">myEntityBlueprints</span><span class="op">.</span><span class="ide">construct</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">echo</span> <span class="ide">myEntities</span>[<span class="num">0</span>], <span class="ide">myEntities</span>[<span class="num">1</span>]</div></div>  </code></pre>
<h2>Cloning entities</h2>
<p>Entities may be duplicated at run time with the generated <code>clone</code> procedure.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">myClose</span> <span class="op">=</span> <span class="ide">myEntity</span><span class="op">.</span><span class="ide">clone</span></div></div>  </code></pre>
<p>This performs less validation work than <code>construct</code>, as the entity state must already be valid for the entity to exist.</p>
<h1>Switching components with component lists</h1>
<p>The <code>transition</code> template lets you remove one set of components and add or update another. This can be useful for using components for state machine behaviour. Only components within the parameter lists <code>prevState</code> and <code>newState</code> are considered. Other components are unaffected.</p>
<p>This comes in two flavours:</p>
<ul>
<li>
<p>  <code>transition(entity: EntityRef, prevState, newState: ComponentList, transitionType: static[EntityTransitionType])</code></p>
<p><code>transitionType</code> controls whether to just update components that
are in both states, or to always remove components in
<code>prevState</code> and add <code>newState</code>.</p>
<ul>
<li>A transition type of <code>ettUpdate</code> will remove components that are in
<code>prevState</code> but don&apos;t exist in <code>newState</code>, and update components that</li>
</ul>
<p>exist in both <code>prevState</code> and <code>newState</code>.
Events such as <code>onAdd</code>/<code>onRemove</code> for updated components are not
triggered, the data for the component is just updated.</p>
<ul>
<li>A transition type of <code>ettRemoveAdd</code> will always trigger events
such as <code>onAdd</code>/<code>onRemove</code>, but does more work when many components</li>
</ul>
<p>are shared between <code>prevState</code> and <code>newState</code> and may reorder more
system rows. This can be useful for components containing managed
resources and other situations where events must be triggered.</p>
</li>
<li>
<p>  <code>transition(entity: EntityRef, prevState, newState: ComponentList)</code></p>
<p>This version calls <code>transition</code> with <code>ettUpdate</code>.</p>
</li>
</ul>
<blockquote>
<p>Note: be aware when using <code>transition</code> whilst iterating in a system that removing components the system uses can invalidate the current <code>item</code> template.</p>
</blockquote>
<blockquote>
<p><strong>Note</strong>: as components are added/removed individually, designs with systems that own two or more components <strong>may not allow such transitions to compile</strong> as they are not added in a single state change.</p>
</blockquote>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span></div></div><div class="line"><div class="line-content">    <span class="ide">A</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">value</span>: <span class="ide">int</span></div></div><div class="line"><div class="line-content">    <span class="ide">B</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">value</span>: <span class="ide">int</span></div></div><div class="line"><div class="line-content">    <span class="ide">C</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">value</span>: <span class="ide">string</span></div></div><div class="line"><div class="line-content">    <span class="ide">D</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">value</span>: <span class="ide">string</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeEcs</span>(<span class="ide">defaultEntOpts</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span></div></div><div class="line"><div class="line-content">  <span class="ide">compsAB</span> <span class="op">=</span> <span class="ide">cl</span>(<span class="ide">A</span>(<span class="ide">value</span>: <span class="num">456</span>), <span class="ide">B</span>(<span class="ide">value</span>: <span class="num">789</span>))</div></div><div class="line"><div class="line-content">  <span class="ide">compsAD</span> <span class="op">=</span> <span class="ide">cl</span>(<span class="ide">A</span>(<span class="ide">value</span>: <span class="num">999</span>), <span class="ide">D</span>(<span class="ide">value</span>: <span class="str">&quot;Bar&quot;</span>))</div></div><div class="line"><div class="line-content">  </div></div><div class="line"><div class="line-content">  <span class="ide">entity</span> <span class="op">=</span> <span class="ide">newEntityWith</span>(<span class="ide">A</span>(<span class="ide">value</span>: <span class="num">123</span>), <span class="ide">C</span>(<span class="ide">value</span>: <span class="str">&quot;Foo&quot;</span>))</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">entity</span><span class="op">.</span><span class="ide">transition</span>(<span class="ide">compsAB</span>, <span class="ide">compsAD</span>)</div></div><div class="line"><div class="line-content"><span class="com"># A is overwritten with the A in `compsAC` and D is added.</span></div></div><div class="line"><div class="line-content"><span class="com"># There&apos;s no B to remove yet and C is unaffected.</span></div></div><div class="line"><div class="line-content"><span class="com"># Entity is now: A(value: 999), C(value: &quot;Foo&quot;), D(value: &quot;Bar&quot;)</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">entity</span><span class="op">.</span><span class="ide">transition</span>(<span class="ide">compsAD</span>, <span class="ide">compsAB</span>)</div></div><div class="line"><div class="line-content"><span class="com"># A is overwritten with the A in `compsAB`, D is removed, and B is added.</span></div></div><div class="line"><div class="line-content"><span class="com"># C is unaffected.</span></div></div><div class="line"><div class="line-content"><span class="com"># Entity is now (A(value: 456), C(value: &quot;Foo&quot;), B(value: 789))</span></div></div>  </code></pre>
<h2>Updating entities with component lists</h2>
<p>You can use <code>update</code>/<code>updateComponents</code> to update multiple components on an entity at once using a <code>ComponentList</code>. This only updates the components that exist on the entity, others in the list are ignored. This can be useful for constructed entities that need context sensitive component initialisation after they&apos;ve been built, or for applying bulk changes to entities at run time without adding or removing components.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">entity</span><span class="op">.</span><span class="ide">update</span> <span class="ide">cl</span>(</div></div><div class="line"><div class="line-content">    <span class="ide">A</span>(<span class="ide">value</span>: <span class="num">765</span>),</div></div><div class="line"><div class="line-content">    <span class="ide">B</span>(<span class="ide">value</span>: <span class="num">825</span>)</div></div><div class="line"><div class="line-content">  )</div></div>  </code></pre>
<h1>Events</h1>
<p>Polymorph includes a variety of events for different situations. Most of these are &apos;inline&apos; and are composed ad hoc when required in the output code. All events are called immediately at the point of invocation.</p>
<p>In general, events are invoked <em>after</em> the state has been fully resolved for events that trigger when &apos;adding&apos; and <em>before</em> the state has been resolved for &apos;removing&apos; events.</p>
<h2>Inline events</h2>
<p>These events are directly injected during a state change without any call overhead. This makes them great for component initialisations/deinitialisations, monitoring, and other light work.</p>
<p>Each event <em>appends</em> code, which is run in the order the event code is added. This allows extending events on components even if they already have existing event code.</p>
<table>
<thead>
<tr>
<th>Event</th>
<th>Parameters</th>
<th>Triggered</th>
</tr>
</thead>
<tbody>
<tr>
<td>  <code>onAdd</code></td>
<td>A component type</td>
<td>When this type is added to an entity</td>
</tr>
<tr>
<td>  <code>onRemove</code></td>
<td>A component type</td>
<td>When this type is removed from an entity</td>
</tr>
<tr>
<td>  <code>onSystemAdd</code></td>
<td>A component type</td>
<td>When a type is added to any system</td>
</tr>
<tr>
<td>  <code>onSystemRemove</code></td>
<td>A component type</td>
<td>When a type is removed from any system</td>
</tr>
<tr>
<td>  <code>onSystemAddTo</code></td>
<td>A component type and a system name</td>
<td>When a type is added to a particular system</td>
</tr>
<tr>
<td>  <code>onSystemRemoveFrom</code></td>
<td>A component type and a system name</td>
<td>When a type is removed from a particular system</td>
</tr></tbody></table>
<h2>System events</h2>
<p>These events are invoked when system rows are added or removed, and can use the <code>item</code> template to access components within the system row that&apos;s affected.</p>
<table>
<thead>
<tr>
<th>Event</th>
<th>Triggered</th>
</tr>
</thead>
<tbody>
<tr>
<td>  <code>added</code></td>
<td>When a new row is added to the system</td>
</tr>
<tr>
<td>  <code>removed</code></td>
<td>When a row is removed from the system</td>
</tr>
<tr>
<td>  <code>addedCallback</code></td>
<td>Call a procedure when a new row is added to the system</td>
</tr>
<tr>
<td>  <code>removedCallback</code></td>
<td>Call a procedure when a row is removed from the system</td>
</tr></tbody></table>
<h2>Mutating entities within events</h2>
<p>Events are allowed to add or remove components from their host/calling entity, as long as they don&apos;t invalidate other events within a state change.</p>
<p>In other words, event execution is <strong>immutable</strong>: once a state change occurs, such as adding or removing components, all the events associated with that state change <em>must</em> be allowed to execute.</p>
<p>As long as this condition is respected, events are allowed to freely embed further state changes to the entity.</p>
<p>This means, for example, events are free to remove the component being added within an <code>onAdd</code> event, as long as there aren&apos;t subsequent add events for this component scheduled to execute.</p>
<p>The compile time expansion of events checks for the following conflicts:</p>
<ol>
<li>Removing components that invalidate a future event from the same state change (as above).</li>
<li>Event cycles, even if called indirectly through other events.</li>
<li>Deleting the host/caller entity.</li>
<li>Recursive events, for example an <code>onAdd</code> that removes a component, coupled with an <code>onRemove</code> event that adds the same component.</li>
</ol>
<p>However this analysis is currently limited to code expansion, not semantic analysis. This means it cannot determine conditional event triggers, for example.</p>
<p>Events are a powerful feature, and it&apos;s worth being aware of how they affect a design, particularly if your systems are being used by other developers who may use their own events which could be triggered along with, or inside, your event code.</p>
<p>You can see the flow of event expansion by compiling with the <code>-d:ecsLogDetails</code> switch.</p>
<h2>Change events</h2>
<table>
<thead>
<tr>
<th>Event</th>
<th>Triggered</th>
</tr>
</thead>
<tbody>
<tr>
<td>  <code>onEntityChange</code></td>
<td>When components are added or removed from any entity</td>
</tr></tbody></table>
<p>This event is triggered whenever an entity state changes. This includes components being added or removed from entities, new entities are constructed from a template of components, or entities are deleted. However it is not triggered for &apos;empty&apos; entities such as created with <code>newEntity</code> (since no components have been added yet).</p>
<p>This example shows logging all component changes for entities:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">onEntityChange</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;Change: &quot;</span>, <span class="ide">entity</span><span class="op">.</span><span class="ide">entityId</span><span class="op">.</span><span class="ide">int</span>, <span class="str">&quot;: &quot;</span>, <span class="ide">state</span>, <span class="str">&quot;: &quot;</span>, <span class="ide">types</span></div></div>  </code></pre>
<h2>  <code>onEcsBuilt</code></h2>
<p>Code passed to this macro will be emitted after <code>makeEcs</code> has completed.</p>
<p>This can be useful when you want to define logic that uses the ECS and must be available as soon as possible. For example, for use within system bodies, for general set up situations, or for providing utility functions.</p>
<p>In particular, this is invaluable for library components/systems, where some initialisation or utility procedures may use the ECS, but the library doesn&apos;t have control over when <code>makeEcs</code> is run.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span> <span class="ide">Counter</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">value</span>: <span class="ide">int</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">onEcsBuilt</span>:</div></div><div class="line"><div class="line-content">  <span class="com"># This code is inserted after makeEcs has completed.</span></div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;makeEcs has finished!&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="com"># This procedure uses the ECS.</span></div></div><div class="line"><div class="line-content">  <span class="kwd">proc</span> <span class="ide">inc</span>(<span class="ide">entity</span>: <span class="ide">EntityRef</span>) <span class="op">=</span></div></div><div class="line"><div class="line-content">    <span class="kwd">let</span> <span class="ide">counter</span> <span class="op">=</span> <span class="ide">entity</span><span class="op">.</span><span class="ide">fetch</span> <span class="ide">Counter</span></div></div><div class="line"><div class="line-content">    <span class="kwd">if</span> <span class="ide">counter</span><span class="op">.</span><span class="ide">valid</span>:</div></div><div class="line"><div class="line-content">      <span class="ide">counter</span><span class="op">.</span><span class="ide">value</span><span class="op">.</span><span class="ide">inc</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeEcs</span>()</div></div><div class="line"><div class="line-content"><span class="com"># Outputs &quot;makeEcs has finished!&quot; to the console, and the `inc` proc is</span></div></div><div class="line"><div class="line-content"><span class="com"># included.</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">ent</span> <span class="op">=</span> <span class="ide">newEntityWith</span>(<span class="ide">Counter</span>(<span class="ide">value</span>: <span class="num">1</span>))</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Use the previously defined proc.</span></div></div><div class="line"><div class="line-content"><span class="ide">ent</span><span class="op">.</span><span class="ide">inc</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">ent</span><span class="op">.</span><span class="ide">fetch</span>(<span class="ide">Counter</span>)<span class="op">.</span><span class="ide">value</span> <span class="op">==</span> <span class="num">2</span></div></div>  </code></pre>
<h2>Construction and clone events</h2>
<p>These events allow you to intercept the construction and cloning of entities and edit, replace, ignore, or provide multiple components in response.</p>
<p>Changing the component types being added is not possible with other events.</p>
<p>To register these events <code>makeEcs</code> must have been run, and as such they have full access to ECS operations.</p>
<p>One use for these kind of events is for blueprinting run time only data such as external resources.
One component type can be used to provide information for instantiation, and is replaced with a different component that represents initialised data. This can be useful for separating the concerns of systems.</p>
<p>Another example is for meta-components. One component can contain information that adds one or more other components when passed to <code>construct</code>. Components can also create and manage sets of <em>entities</em> on construction as well.</p>
<h3>Construction events</h3>
<ul>
<li>
<p><code>registerConstructor</code> takes a component type and a proc of the form:</p>
<pre>  <code class="language-nim">proc (entity: EntityRef, component: Component, context: EntityRef): seq[Component]
</code></pre>
<ul>
<li>
<p><code>entity</code>: the current entity being constructed.</p>
</li>
<li>
<p><code>component</code>: the <code>Component</code> container supertype passed from the <code>ComponentList</code> being built.</p>
<p>To get the value stored within, type cast to the container subtype for the component you&apos;re hooking and access its <code>value</code> field.</p>
<p>The component&apos;s container type is created by <code>registerComponents</code> as the component name with the <code>Ref</code> postfix, for example a <code>MyComponent</code> type would use <code>MyComponentRef(component).value</code>.</p>
</li>
<li>
<p><code>context</code>: the <code>construct</code> proc allows optionally passing an entity to provide input to construction events.</p>
<p>If no entity is provided, <code>context</code> will match the <code>entity</code> parameter.</p>
<p>When <code>construct</code> creates multiple entities from a <code>ConstructionTemplate</code>, the first entity built is always passed as <code>context</code> to these events. This allows you to define the context for multiple entities in the <code>ConstructionTemplate</code> itself.</p>
</li>
</ul>
<p>Components are added by appending to the <code>seq[Component]</code> result. It&apos;s possible to add any number of components to the result, as long as there aren&apos;t any repeated types. It&apos;s also valid to not add to the result and elide the component from the entity.</p>
<pre>  <code class="language-nim">registerComponents defaultCompOpts:
  type
    Original = object
      data: int
    Replaced = object
      data: int

makeEcs()

# This event will replace the `Original` component type with `Replaced`
# during construction.
proc replaceOriginal(entity: EntityRef, component: Component, context: EntityRef): seq[Component] =
  let original = OriginalRef(component).value
  result.add Replaced(data: original.data)

registerConstructor Original, replaceOriginal

# Build an entity from a component list using the `Original` type.
let entity = Original(data: 1234).cl.construct

# Confirm the replaced component.
assert not entity.has(Original)
assert entity.has(Replaced)
assert entity.fetch(Replaced).data == 1234
</code></pre>
</li>
<li>
<p><code>registerPostConstructor</code>: takes a component type and proc of the form:</p>
<pre>  <code class="language-nim">proc (entity: EntityRef, component: ComponentRef, entities: var Entities)
</code></pre>
<ul>
<li><code>entity</code>: the entity being constructed.</li>
<li><code>component</code>: the component ref that&apos;s been assigned to the entity. To convert this to an instance to access it, type cast the index field with the component&apos;s instance type, which is the type postfixed with <code>Instance</code>. For example for <code>MyComponent</code> the instance would be accessed with <code>MyComponentInstance(component.index)</code>.</li>
<li><code>entities</code>: the list of entities that will be returned to the user.</li>
</ul>
<p>These events are called after multiple entities are built by using <code>construct</code> with a <code>ConstructionTemplate</code>. The event allows work to be performed on the fully constructed sets of entities.</p>
<p>It does not allow changing the type of components <em>as they&apos;re added</em> like <code>registerConstructor</code>, but allows full manipulation of the fully constructed entities afterwards.</p>
<p>This can be useful to update components that keep track of other entities, or perform other multi-entity work.</p>
<pre>  <code class="language-nim">proc countEntities(entity: EntityRef, component: ComponentRef, entities: var Entities) =
  echo &quot;I counted: &quot;, entities.len

registerPostConstructor MyOtherComponent, countEntities
</code></pre>
</li>
<li>
<p><code>registerCloneConstructor</code>: takes a component type and proc of the form:</p>
<pre>  <code class="language-nim">proc (entity: EntityRef, component: ComponentRef): seq[Component]
</code></pre>
<ul>
<li><code>entity</code>: the new cloned entity.</li>
<li><code>component</code>: the <em>  <strong>source</strong></em> component being cloned. This is a <code>ComponentRef</code>, to convert this to an instance to access it, type cast the index field with the component&apos;s instance type. For example: <code>MyComponentInstance(component.index)</code>.</li>
</ul>
<p>Clone events allow you to transform components from entities built by <code>clone</code>. This can be useful when resources need to perform some extra work to be duplicated, or to deny duplication entirely.</p>
<pre>  <code class="language-nim">proc displayCloning(entity: EntityRef, component: ComponentRef): seq[Component] =
  let instance = MyOtherComponentInstance(component.index)
  echo &quot;We&apos;re cloning MyOtherComponent: &quot;, instance
  # Create a copy of the original component.
  result.add instance.makeContainer

registerCloneConstructor MyOtherComponent, displayCloning
</code></pre>
</li>
</ul>
<h1>Writing component libraries</h1>
<p>Components and systems can be shared and reused by defining them within templates.</p>
<p>Code generation options can be passed through these templates to let the consumer define the implementation details.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># Module writingcomponentlibs1</span></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">template</span> <span class="ide">defineSay</span><span class="op">*</span>(<span class="ide">compOpts</span>: <span class="ide">EcsCompOptions</span>, <span class="ide">sysOpts</span>: <span class="ide">EcsSysOptions</span>) {<span class="op">.</span><span class="ide">dirty</span><span class="op">.</span>} <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="com"># The {.dirty.} pragma passes the code through for outside access.</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">registerComponents</span> <span class="ide">compOpts</span>:</div></div><div class="line"><div class="line-content">    <span class="kwd">type</span> <span class="ide">Say</span><span class="op">*</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">text</span><span class="op">*:</span> <span class="ide">string</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">makeSystemOpts</span> <span class="str">&quot;sayer&quot;</span>, [<span class="ide">Say</span>], <span class="ide">sysOpts</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">all</span>: <span class="ide">echo</span> <span class="ide">sayOnTick</span><span class="op">.</span><span class="ide">say</span><span class="op">.</span><span class="ide">text</span></div></div><div class="line"><div class="line-content">    <span class="ide">finish</span>: <span class="ide">sys</span><span class="op">.</span><span class="ide">remove</span> <span class="ide">Say</span></div></div>  </code></pre>
<p>This can then be instantiated along with other components and systems.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span>, <span class="ide">writingcomponentlibs1</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">const</span></div></div><div class="line"><div class="line-content">  <span class="ide">compOpts</span> <span class="op">=</span> <span class="ide">defaultCompOpts</span></div></div><div class="line"><div class="line-content">  <span class="ide">sysOpts</span> <span class="op">=</span> <span class="ide">defaultSysOpts</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Include the `Say` component and system.</span></div></div><div class="line"><div class="line-content"><span class="ide">defineSay</span>(<span class="ide">compOpts</span>, <span class="ide">sysOpts</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Add our own component and system.</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">compOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span></div></div><div class="line"><div class="line-content">    <span class="ide">SayOnTick</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">      <span class="ide">current</span>, <span class="ide">ticks</span>: <span class="ide">Natural</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeSystemOpts</span> <span class="str">&quot;sayTicks&quot;</span>, [<span class="ide">SayOnTick</span>], <span class="ide">sysOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">all</span>:</div></div><div class="line"><div class="line-content">    <span class="kwd">if</span> <span class="ide">sayOnTick</span><span class="op">.</span><span class="ide">current</span> <span class="kwd">mod</span> <span class="ide">sayOnTick</span><span class="op">.</span><span class="ide">ticks</span> <span class="op">==</span> <span class="num">0</span>:</div></div><div class="line"><div class="line-content">      <span class="ide">entity</span><span class="op">.</span><span class="ide">add</span> <span class="ide">Say</span>(<span class="ide">text</span>: <span class="op">$</span><span class="ide">sayOnTick</span><span class="op">.</span><span class="ide">current</span>)</div></div><div class="line"><div class="line-content">    <span class="ide">sayOnTick</span><span class="op">.</span><span class="ide">current</span> <span class="op">+=</span> <span class="num">1</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Seal and generate.</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeEcs</span>()</div></div><div class="line"><div class="line-content"><span class="ide">commitSystems</span> <span class="str">&quot;run&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Try out the ECS.</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">entity</span> <span class="op">=</span> <span class="ide">newEntityWith</span>(<span class="ide">SayOnTick</span>(<span class="ide">ticks</span>: <span class="num">25</span>))</div></div><div class="line"><div class="line-content"><span class="kwd">for</span> <span class="ide">i</span> <span class="kwd">in</span> <span class="num">0</span> <span class="op">..&lt;</span> <span class="num">100</span>: <span class="ide">run</span>()</div></div>  </code></pre>
<p>The following output is emitted:</p>
<pre>  <code>0
25
50
75
</code></pre>
<h1>Code generation options</h1>
<p>Polymorph offers three configuration types to control how code is generated.</p>
<h2>EcsCompOptions</h2>
<p>When passed to <code>registerComponents</code>, this object controls how these components are generated at compile time.</p>
<p>  <strong>EcsCompOptions fields:</strong></p>
<ul>
<li><code>maxComponents</code>: maximum amount of components when <code>cisArray</code> is selected for storage.</li>
<li><code>componentStorageFormat</code>: Underlying storage format for components.
<ul>
<li><code>cisSeq</code>: store components in a heap allocated <code>seq</code>. This allows dynamically sizing storage by component. Resizing often, however, requires moving memory which can degrade performance.</li>
<li><code>cisArray</code>: store components in a stack allocated, fixed size array of size <code>maxComponents</code>.</li>
</ul>
</li>
<li><code>accessMethod</code>: controls accessing fields through instances. This currently only offers dot operator access with <code>amDotOp</code>.</li>
<li><code>clearAfterDelete</code>: when set, zeros memory of components after deletion.</li>
<li><code>useThreadVar</code>: declare the component arrays as {.threadVar.}.</li>
<li><code>invalidAccess</code>: allow inserting assert checks for each instance field access.
<ul>
<li><code>iaIgnore</code>: no check is performed.</li>
<li><code>iaAssert</code>: a run time assert is invoked.</li>
</ul>
</li>
</ul>
<h2>EcsSysOptions</h2>
<p>When passed to <code>defineSystem</code>, <code>defineSystemOwner</code>, or <code>makeSystem</code>, this object controls how systems are generated at compile time.</p>
<p>  <strong>EcsSysOptions fields:</strong></p>
<ul>
<li><code>maxEntities</code>: maximum entities this system can hold for <code>ssArray</code> storage, and for indexes set to <code>sifArray</code> or <code>sifAllocatedSeq</code>.</li>
<li><code>storageFormat</code>: underlying storage format for the system groups.
<ul>
<li><code>ssSeq</code>: heap allocated and resized dynamically. Useful for adaptive memory use. Resizing often, however, involves moving memory which can degrade performance.</li>
<li><code>ssArray</code>: stack allocated and fixed size according to <code>maxEntities</code>.</li>
</ul>
</li>
<li><code>indexFormat</code>:
<ul>
<li><code>sifArray</code>: constant time deletes, uses <code>maxEntities</code> * ~8 bytes per system, uses stack space. Recommended for performance applications.
<code>sifAllocatedSeq</code>: heap allocated storage, initialised to <code>maxEntities</code>. Useful for large amounts of entities where stack space is at a premium.</li>
</ul>
<code>sifTable</code>: adaptive memory use, but requires reallocated when extended.</li>
<li><code>timings</code>: generate timing code.</li>
<li><code>useThreadVar</code>: declare the system variable as <code>{.threadVar.}</code>.</li>
<li><code>echoRunning</code>: reporting system execution state can be useful for debugging blocking systems or to monitor the sequence of system actions.
<ul>
<li><code>seNone</code>: no reporting.</li>
<li><code>seEchoUsed</code>: echo when a defined system block has been entered.</li>
<li><code>seEchoUsedAndRunning</code>: echo when a system proc has been entered, and also any defined system block has been entered</li>
<li><code>seEchoUsedAndRunningAndFinished</code>: echo when a system proc has been entered, and also any defined system block has been entered, and also when the system proc has completed and is about to return.</li>
<li><code>seEchoAll</code>: unconditionally echo when a system proc has been entered, any system block has been entered (even if not defined by the user), and when the system has completed.</li>
</ul>
</li>
<li><code>assertItem</code>: add asserts to check the system <code>item</code> is within bounds.</li>
<li><code>orderedRemove</code>: maintains the execution order when items are removed from groups. This changes deletion from an O(1) to an O(N) operation.</li>
</ul>
<h2>EcsEntityOptions</h2>
<p>When passed to <code>makeEcs</code>, this object controls how entities are generated at compile time.</p>
<p>  <strong>EcsEntityOptions fields:</strong></p>
<ul>
<li><code>maxEntities</code>: controls the maximum amount of entities for fixed size formats (ignored for <code>esSeq</code>).</li>
<li><code>componentStorageFormat</code>: choose the format of the component list in entity items.
<ul>
<li><code>csSeq</code>: store entity components in a dynamically allocated heap <code>seq</code>.</li>
<li><code>csArray</code>: store entity components in a fixed sized, stack allocated array of size <code>maxEntities</code>.</li>
<li><code>csTable</code>: store entity components in a dynamically allocated <code>Table</code>. This offers O(1) fetch access, but may use more memory and be slower to iterate an entity&apos;s components than a <code>seq</code>.</li>
</ul>
</li>
<li><code>entityStorageFormat</code>: choose between stack allocated or heap allocated array.</li>
<li><code>maxComponentsPerEnt</code>: only applies to <code>csArray</code> storage format.</li>
<li><code>recyclerFormat</code>: array access should be much faster, but takes up more space.</li>
<li><code>useSet</code>: use a set for hasComponent.
<ul>
<li>
<p>Note: sets can dramatically increase entity header size with a lot of components,
as each <code>8</code> components defined will double the size of the set in bytes.</p>
<p>Operations like creating, adding or removing are also slightly slower with
a set due to the additional update work (~5% depending on component count).</p>
<p>The advantage of using a set is that it allows an O(1) response for <code>hasComponent</code>
when also using seq/array component lists.</p>
<p>If you have seq/array component lists and don&apos;t want the extra memory burden
of sets, you can ameliorate the O(N) cost of iteration for hasComponent by
adding often checked/fetched components first, so finding them can return
earlier.</p>
<p>Component lists defined as a table will probably find the set unnecessary.</p>
<p>Note that using hasComponent often can imply the need for a new system
incorporating these components.</p>
</li>
</ul>
</li>
<li><code>errors</code>: control how errors are generated.
Each option here may use <code>erAssert</code> (the default) or <code>erRaise</code> to generate a run time exception.
<ul>
<li><code>errEntityOverflow</code>: control how exceeding the maximum number of entities is reported.</li>
<li><code>errCaseComponent</code>: control how invalid component types in <code>caseComponent</code> is reported.</li>
<li><code>errIncompleteOwned</code>: control what happens when owned components passed to <code>addComponent</code> do not fully satisfy their owner system.</li>
</ul>
</li>
</ul>
<h1>Compile switches</h1>
<ul>
<li>
<p><code>-d:ecsLog</code>: use this switch to <code>echo</code> the ECS generation process.</p>
<p>This includes:</p>
<ul>
<li>component generation information,</li>
<li>system generation information,</li>
<li>the system execution order in the wrapper proc created by <code>commitSystems</code>.</li>
</ul>
</li>
<li>
<p><code>-d:ecsLogDetails</code>: this expands on <code>ecsLog</code> and includes:</p>
<ul>
<li>the ECS compile options used for systems and components,</li>
<li>details about each stage of the compile process by identity,</li>
<li>the creation for <code>delete</code>, <code>construct</code>, and <code>clone</code>,</li>
<li>operations such as <code>newEntityWith</code>, <code>addComponents</code> and <code>removeComponents</code>,</li>
<li>events triggered within operations,</li>
<li>event chains within system <code>added</code>/<code>removed</code> events.</li>
</ul>
</li>
<li>
<p><code>-d:ecsPerformanceHints</code>: displays compile time information for tuning memory access patterns.
This includes:</p>
<ul>
<li>read/write component instance field access within a system; when there are many field accesses, it may be worth considering a read/update/write pattern and use <code>access</code> and/or <code>update</code>,</li>
<li>use of remove/delete in a system that has incurred an iteration checks,</li>
</ul>
</li>
<li>
<p><code>-d:ecsLogCode</code>: outputs the generated code from <code>registerComponents</code>, <code>makeEcs</code>, and <code>commitSystems</code>, along with any ECS operations performed up to this point to a log file for inspection. This can be useful for low level debugging or performance reasons, or just to understand the raw logic generated from the ECS design.</p>
<p>Useful things in the code log:</p>
<ul>
<li>storage variables and access machinery for components and systems,</li>
<li>the output of <code>macro</code> operations such as <code>newEntityWith</code>, <code>addComponents</code>, and <code>removeComponents</code>,</li>
<li><code>proc</code> operations such <code>construct</code>, <code>clone</code>, and <code>delete</code>,</li>
<li>how events are expanded within operations in the design.</li>
</ul>
<p>Note that any generated code <em>after</em> the above operations has to be manually &apos;flushed&apos; with <code>flushGenLog()</code>. The log will then include subsequent operations.</p>
<blockquote>
<p><strong>Important note</strong>: as Nim doesn&apos;t currently allow you to output to files at compile time, the log is generated at compile time but written at <em>  <strong>run time</strong></em>. In other words, using this switch will bulk your output executable and write a static string to file at program startup.</p>
</blockquote>
<p>The log file is named <code>ecs_code_log.nim</code> and will be placed in the same path as the executable when run. This file isn&apos;t actually runnable as it doesn&apos;t include the full program context, and the <code>.nim</code> extension is just a hint for editors to use syntax highlighting.</p>
</li>
<li>
<p><code>-d:ecsStrict</code>: systems include an extra check to catch accessing <code>item</code> after a remove has affected the system (which can potentially change what <code>item</code> refers to).</p>
</li>
</ul>
<h1>Performance considerations</h1>
<h2>Memory access patterns</h2>
<p>Polymorph is a very thin layer over simple list processing, and the order of memory accesses is (currently) up to the user to manage. Future version may ameliorate this by optimising the insertion points of new rows, for now, high performance applications may find it useful to understand how systems execute with respect to memory access.</p>
<p>Systems have no overhead to iterate, but each (non-<a href="#owned-components-and-removing-indirection">owned</a>) component is accessed via an index indirection to a list of structures. This format can be cache efficient for systems that access all the fields in the component, but can be less so when components contain large and seldom accessed fields, as this unused data may be pulled from RAM and fill the cache only to be skipped over by systems.</p>
<p>The key to high performance is to fully utilise the instruction and data cache within the CPU, fetching memory from RAM only when necessary. Components that are processed often should therefore be designed to hold the minimum reasonable data required for associated system tasks.</p>
<p>When a system&apos;s indirections are skipping backwards or far forwards in memory, performance will degrade as the CPU cache cannot be effectively used.</p>
<p>This can happen if systems often have rows removed then readded again from adding/removing components. The current implementation reuses component slots in the reverse order they&apos;re deleted, but new system rows are appended to the end of the system. Depending on the pattern of deletes and creates, this can mean these systems are accessing memory locations out of sequence.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># Consider this abstract representation of the memory locations that a</span></div></div><div class="line"><div class="line-content"><span class="com"># system is accessing as it&apos;s iterating:</span></div></div><div class="line"><div class="line-content">[<span class="num">0</span>, <span class="num">1</span>, <span class="num">2</span>, <span class="num">3</span>, <span class="num">4</span>, <span class="num">5</span>, <span class="num">6</span>, <span class="num">7</span>, <span class="num">8</span>, <span class="num">9</span>]</div></div><div class="line"><div class="line-content"><span class="com"># This is an optimal access pattern, lending itself to good cache utilisation.</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Suppose components are now removed and readded many times, we could</span></div></div><div class="line"><div class="line-content"><span class="com"># end up with something like this:</span></div></div><div class="line"><div class="line-content">[<span class="num">9</span>, <span class="num">1</span>, <span class="num">7</span>, <span class="num">2</span>, <span class="num">8</span>, <span class="num">3</span>, <span class="num">6</span>, <span class="num">0</span>, <span class="num">5</span>, <span class="num">4</span>]</div></div><div class="line"><div class="line-content"><span class="com"># As this system iterates, it&apos;s skipping about in memory and the cache</span></div></div><div class="line"><div class="line-content"><span class="com"># can&apos;t be as effectively used.</span></div></div>  </code></pre>
<p>This kind of &apos;system churn&apos; can dramatically affect the performance of systems by reducing the chance of data being in the CPU cache, causing many long trips to main memory. Each system has a unique &quot;indirection window&quot; to the underlying component storage based on the order of updates.</p>
<p>One solution is to simply not change components often and maintain bulk entity creation/deletion, or to design systems that undergo churn to work with smaller data sets that fit within cache, if possible. However, it can often be useful to take advantage of the dynamic qualities of run time composition in designs with large amounts of data.</p>
<p>Two tools that can help when performance sensitive systems often reorder their execution:</p>
<ul>
<li>
<p>Statistically analyse a system&apos;s memory access with <code>analyseSystem</code>.</p>
</li>
<li>
<p>Remove indirection with owned components: inline component data and lifetime to a system.</p>
</li>
</ul>
<h2>Fragmentation analysis</h2>
<p>Ideally, a system processes each component sequentially, meaning component memory access moves forward by the size of the component. Systems which randomly access component storage will perform worse because the cache is not being effectively used.</p>
<p>To investigate how a system is accessing component storage, there is the <code>analyseSystem</code> proc.</p>
<p>This runs through each memory access the system is making and records the difference in subsequent accesses of the same component. This provides a &quot;fragmentation&quot; metric, which is a normalised value representing what portion of a system&apos;s memory accesses are <em>not</em> sequential.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span>, <span class="ide">random</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span> <span class="ide">Comp1</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;frag&quot;</span>, [<span class="ide">Comp1</span>]:</div></div><div class="line"><div class="line-content">  <span class="ide">all</span>: <span class="kwd">discard</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeEcs</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">num</span> <span class="op">=</span> <span class="num">100</span></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">ents</span> <span class="op">=</span> <span class="ide">newSeqOfCap</span>[<span class="ide">EntityRef</span>](<span class="ide">num</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">for</span> <span class="ide">i</span> <span class="kwd">in</span> <span class="num">0</span> <span class="op">..&lt;</span> <span class="ide">num</span>:</div></div><div class="line"><div class="line-content">  <span class="com"># Appending to the &quot;frag&quot; system and creating the component leads to</span></div></div><div class="line"><div class="line-content">  <span class="com"># &quot;frag&quot; accessing Comp1 in sequentially.</span></div></div><div class="line"><div class="line-content">  <span class="ide">ents</span><span class="op">.</span><span class="ide">add</span> <span class="ide">newEntityWith</span>(<span class="ide">Comp1</span>())</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">for</span> <span class="ide">i</span> <span class="kwd">in</span> <span class="num">0</span> <span class="op">..&lt;</span> <span class="ide">num</span>:</div></div><div class="line"><div class="line-content">  <span class="ide">ents</span>[<span class="ide">i</span>]<span class="op">.</span><span class="ide">remove</span> <span class="ide">Comp1</span></div></div><div class="line"><div class="line-content">  <span class="ide">ents</span>[<span class="ide">i</span>]<span class="op">.</span><span class="ide">add</span> <span class="ide">Comp1</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Display fragmentation analysis.</span></div></div><div class="line"><div class="line-content"><span class="ide">echo</span> <span class="ide">sysFrag</span><span class="op">.</span><span class="ide">analyseSystem</span>()</div></div>  </code></pre>
<p>Passing the output of <code>analyseSystem</code> to the <code>$</code> operator includes some further processing of the results. Each component is listed along with the statistical characteristics of the locations that are referenced from the system.</p>
<p>This data also lets you understand the &quot;shape&quot; of indirections within a system and overall pattern of accesses, the trend of non-sequential accesses (forward or backwards in memory), the coefficient of variation, how this relates to a normal distribution, and how many outliers are present.</p>
<p>Tabulated to the right is a simplified &apos;quick look&apos; version of the data.</p>
<blockquote>
<p>Note that &apos;outliers&apos; in the &quot;Kurtosis/spread&quot; right tabulated data refer to the excess kurtosis. Many/few outliers in this case refer to outliers from the normal distribution for this data set.</p>
</blockquote>
<p>The analysis is split into two parts for each component: statistics for out of order accesses as &quot;Fragmentation&quot;, and statistics for all memory accesses within the system.</p>
<p>Here we can see that the fragmentation is not too bad in this system. Fragmentation for Comp1 is at just 2%, with only 2 accesses being out of sequence.</p>
<pre>  <code>Analysis for frag (100 rows of 1 components):
  comp1:
    Value size: 1 B, jump threshold: 1 B
    Jumps over threshold : 1                                          Jump ahead: 1.0101 %
    Backwards jumps      : 1                                          Jump back: 1.0101 %
    Fragmentation: 2 % (n = 2):
      Mean scale: -48 times threshold
      Min: -98, max: 2, sum: -96                                      Range: 100 B
      Mean: -48
      Std dev: 50                                                     CoV: -1.0417
      Variance: 2500
      Kurtosis/spread (normal = 3.0): -2 (excess: -5)                 Few outliers
      Skewness: 0
    All address deltas (n = 99):
      Min: -98, max: 2, sum: 1                                        Range: 100 B
      Mean: 0.0101
      Std dev: 9.901                                                  CoV: 980.201
      Variance: 98.0302
      Kurtosis/spread (normal = 3.0): 93.9904 (excess: 90.9904)       Many outliers
      Skewness: -9.7969                                               Outliers trend backwards
</code></pre>
<p>However, if we perform the same operation to entities in a random order we see a different pattern.</p>
<p>In the example below, by removing and adding the component to the same entity, Comp1&apos;s storage may be reused whilst the system row in &quot;frag&quot; is appended to.</p>
<p>This can cause the order of accesses to Comp1, from the perspective of the &quot;frag&quot; system, to be out of sequence.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">for</span> <span class="ide">i</span> <span class="kwd">in</span> <span class="num">0</span> <span class="op">..&lt;</span> <span class="ide">num</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">let</span> <span class="ide">index</span> <span class="op">=</span> <span class="ide">rand</span>(<span class="ide">num</span> <span class="op">-</span> <span class="num">1</span>)</div></div><div class="line"><div class="line-content">  <span class="ide">ents</span>[<span class="ide">index</span>]<span class="op">.</span><span class="ide">remove</span> <span class="ide">Comp1</span></div></div><div class="line"><div class="line-content">  <span class="ide">ents</span>[<span class="ide">index</span>]<span class="op">.</span><span class="ide">add</span> <span class="ide">Comp1</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">echo</span> <span class="ide">sysFrag</span><span class="op">.</span><span class="ide">analyseSystem</span>()</div></div>  </code></pre>
<p>Here the fragmentation is at 88%, with nearly half being forward accesses and nearly half skipping backwards in memory. This will likely perform much worse, unless all the data was already in cache.</p>
<pre>  <code>Analysis for frag (100 rows of 1 components):
  comp1:
    Value size: 1 B, jump threshold: 1 B
    Jumps over threshold : 43                                         Jump ahead: 43.4343 %
    Backwards jumps      : 45                                         Jump back: 45.4545 %
    Fragmentation: 88 % (n = 88):
      Mean scale: -0.3523 times threshold
      Min: -85, max: 84, sum: -31                                     Range: 169 B
      Mean: -0.3523
      Std dev: 39.0137                                                CoV: -110.7486
      Variance: 1522.0691
      Kurtosis/spread (normal = 3.0): -0.6593 (excess: -3.6593)       Few outliers
      Skewness: 0.0711                                                Outliers trend forwards
    All address deltas (n = 99):
      Min: -85, max: 84, sum: -20                                     Range: 169 B
      Mean: -0.202
      Std dev: 36.7849                                                CoV: -182.0854
      Variance: 1353.1309
      Kurtosis/spread (normal = 3.0): -0.3686 (excess: -3.3686)       Few outliers
      Skewness: 0.0632                                                Outliers trend forwards
</code></pre>
<h1>Owned components and removing indirection</h1>
<p>Systems can &apos;inline&apos; component data into their work list, ensuring that each system item contains component data side by side in memory. Systems that own all of their components have no indirection and process memory in a forward access pattern. This offers a theoretically higher iteration speed, fewer cache misses, and potentially SIMD optimisations.</p>
<p>The practical performance advantages from this, however, depend on the nature of the system&apos;s work, the size of the components, and whether all or only some of the component data is used. This guarantee only applies to the owning system.</p>
<p>For components that are to be added and removed often from entities, owned components offer the advantage that their owning system will always access memory forwards when executing, even if the order of data itself may change.</p>
<blockquote>
<p>Note that systems are compacted when rows are removed, and the order of data may change.</p>
</blockquote>
<p>To declare component ownership the system must be defined using <code>defineSystemOwner</code>. This takes a secondary set of components that the system will manage. Owned components must be components the system uses.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span></div></div><div class="line"><div class="line-content">    <span class="ide">A</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">B</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">C</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># This system uses components A, B, and C, and owns the storage for</span></div></div><div class="line"><div class="line-content"><span class="com"># components A and C.</span></div></div><div class="line"><div class="line-content"><span class="ide">defineSystemOwner</span> <span class="str">&quot;owns&quot;</span>, [<span class="ide">A</span>, <span class="ide">B</span>, <span class="ide">C</span>], [<span class="ide">A</span>, <span class="ide">C</span>], <span class="ide">defaultSysOpts</span></div></div>  </code></pre>
<blockquote>
<p><strong>Note:</strong> A component type can only be owned by a single system.</p>
</blockquote>
<p>When a system iterates, components that it owns are inlined into the row type itself, and require no indirections to access.</p>
<p>As owned components are stored within the actual system and are adjacent in memory, they can be a useful tool to help maintain cache performance even with high system churn.</p>
<p>References to owned components outside of the owning system itself, such as in other systems or retrieved from an entity with <code>fetch</code>, are indirections into the owning system&apos;s work list and therefore retain reference semantics.</p>
<blockquote>
<p><strong>Note:</strong> Owned components have the same semantics as the source type when accessed within the owning system:</p>
<pre>  <code class="language-nim">makeSystemBody &quot;owns&quot;:
  all:
    # Component instances used for non-owned components have reference
    # semantics; copies of the instance will refer to the same memory
    # location.
    #
    # Within an owned system the source type is used directly.
    # As the `A` component is defined above as an object, it uses
    # value semantics and by default Nim will copy values on
    # assignment.
    let aCopy = item.a
</code></pre>
</blockquote>
<h2>Satisfying owner systems</h2>
<p>When a system owns components, a new row can only be created if all of the system&apos;s owned components are present in a single state change.</p>
<p>Incomplete owned state results in a compile time error for <code>newEntityWith</code> or for <code>add</code>/<code>addComponents</code> that affect fully owned systems. For systems that include instanced components, a run time error occurs for <code>add</code>/<code>addComponents</code> if the owning system cannot access the required components from the entity.</p>
<p>These constraints also apply to <code>construct</code>, which will fail at run time if ownership cannot be satisfied.</p>
<p>For example:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span></div></div><div class="line"><div class="line-content">    <span class="ide">A</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">B</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">C</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">defineSystemOwner</span> <span class="str">&quot;fullyOwned&quot;</span>, [<span class="ide">A</span>, <span class="ide">B</span>, <span class="ide">C</span>], [<span class="ide">A</span>, <span class="ide">B</span>, <span class="ide">C</span>], <span class="ide">defaultSysOpts</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeEcs</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Error: Owned component(s) [A] need their owner systems completed with component(s): [B, C]</span></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">e1</span> <span class="op">=</span> <span class="ide">newEntityWith</span>(<span class="ide">A</span>())</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">e2</span> <span class="op">=</span> <span class="ide">newEntity</span>()</div></div><div class="line"><div class="line-content"><span class="com"># Error: Cannot add A, missing required owned component C</span></div></div><div class="line"><div class="line-content"><span class="kwd">discard</span> <span class="ide">e2</span><span class="op">.</span><span class="ide">add</span>(<span class="ide">A</span>(), <span class="ide">B</span>())</div></div>  </code></pre>
<h2>Deleting from owner systems</h2>
<p>When a component is owned by a system, its storage space depends on the owning system matching the entity and cannot exist independently. If a component is removed such that an owning system is no longer satisfied, the system row is removed and along with it any other components that are owned by the system.</p>
<p>Therefore operations that result in removing a row from an owning system ensure that:</p>
<ol>
<li>Other owned components in the system row will also be removed (non-owned components are unaffected).</li>
<li>If other owning systems depend on these components, they too will remove their owned components, and so on.</li>
</ol>
<p>This process is determined at compile time based on the component types involved, and output as static code to perform the final updates.</p>
<p>This occurs even for indirect system dependencies, where multiple owning system share components.</p>
<p>For example:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># The &quot;fullyOwned&quot; system holds the storage for A, B, C, and D.</span></div></div><div class="line"><div class="line-content"><span class="ide">defineSystemOwner</span> <span class="str">&quot;fullyOwned&quot;</span>, [<span class="ide">A</span>, <span class="ide">B</span>, <span class="ide">C</span>, <span class="ide">D</span>], [<span class="ide">A</span>, <span class="ide">B</span>, <span class="ide">C</span>, <span class="ide">D</span>], <span class="ide">sysOpts</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Both these systems rely on `fullyOwned` to exist as they use its components.</span></div></div><div class="line"><div class="line-content"><span class="ide">defineSystem</span> <span class="str">&quot;refToOwned1&quot;</span>, [<span class="ide">A</span>, <span class="ide">B</span>, <span class="ide">C</span>, <span class="ide">D</span>], <span class="ide">sysOpts</span></div></div><div class="line"><div class="line-content"><span class="ide">defineSystem</span> <span class="str">&quot;refToOwned2&quot;</span>, [<span class="ide">A</span>, <span class="ide">B</span>], <span class="ide">sysOpts</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># This system requires owned components C, and D from `fullyOwned` and</span></div></div><div class="line"><div class="line-content"><span class="com"># also has its own owned components, E and F.</span></div></div><div class="line"><div class="line-content"><span class="ide">defineSystemOwner</span> <span class="str">&quot;partiallyOwned&quot;</span>, [<span class="ide">C</span>, <span class="ide">D</span>, <span class="ide">E</span>, <span class="ide">F</span>], [<span class="ide">E</span>, <span class="ide">F</span>], <span class="ide">sysOpts</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeEcs</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">e</span> <span class="op">=</span> <span class="ide">newEntityWith</span>(<span class="ide">A</span>(), <span class="ide">B</span>(), <span class="ide">C</span>(), <span class="ide">D</span>(), <span class="ide">E</span>(), <span class="ide">F</span>())</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">e</span><span class="op">.</span><span class="ide">remove</span> <span class="ide">D</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">e</span><span class="op">.</span><span class="ide">componentCount</span> <span class="op">==</span> <span class="num">0</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Removing the owned component `D` invalidates the storage</span></div></div><div class="line"><div class="line-content"><span class="com"># row in the owner system `sysFullyOwned`, and so components</span></div></div><div class="line"><div class="line-content"><span class="com"># A, B, and C are also invalid and removed.</span></div></div><div class="line"><div class="line-content"><span class="com">#</span></div></div><div class="line"><div class="line-content"><span class="com"># The system `sysPartiallyOwned` owns E and F but also relies on</span></div></div><div class="line"><div class="line-content"><span class="com"># indirections to C and D which are now invalid, invalidating</span></div></div><div class="line"><div class="line-content"><span class="com"># this system too, and removing E and F.</span></div></div><div class="line"><div class="line-content"><span class="com">#</span></div></div><div class="line"><div class="line-content"><span class="com"># This leaves the entity with no components.</span></div></div>  </code></pre>
<h1>ECS identities</h1>
<p>Polymorph supports generating multiple ECS designs during a single compilation.</p>
<p>Designs are handled by <em>identities</em>. An identity is like a write-only compile time database that stores all the information required to build the ECS.</p>
<p>If not otherwise specified, an ECS is built with the default identity.</p>
<h2>Multiple ECS outputs with a single identity</h2>
<p>After <code>makeEcs</code> has completed generating the ECS from the identity, the state is marked as processed and subsequent component/system definitions will apply to the next <code>makeEcs</code> statement.</p>
<p>This allows the same identity (such as the default identity) to generate multiple different ECS outputs in serial.</p>
<p>The resultant ECS outputs are incompatible and must be generated in separate modules, otherwise the type names will clash as, by default, they are exported. This means you can&apos;t use entities from multiple ECS together, though you can communicate by standard means outside of the ECS.</p>
<p>The <code>ComponentTypeId</code> for components created in <code>registerComponents</code> is consecutively allocated by identity, so whilst the multiple ECS outputs are incompatible directly, the <code>typeId</code> will be unique for each component defined through the same identity.</p>
<p>You must provide unique names for components and systems that use the same identity.</p>
<p>Here&apos;s a contrived example:</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># Module multipleecs1</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">someData</span><span class="op">*:</span> <span class="ide">int</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span> <span class="ide">Comp1</span><span class="op">*</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">value</span>: <span class="ide">int</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;test1&quot;</span>, [<span class="ide">Comp1</span>]:</div></div><div class="line"><div class="line-content">  <span class="ide">all</span>: <span class="ide">item</span><span class="op">.</span><span class="ide">comp1</span><span class="op">.</span><span class="ide">value</span> <span class="op">+=</span> <span class="num">1</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeEcs</span>()</div></div><div class="line"><div class="line-content"><span class="ide">commitSystems</span>(<span class="str">&quot;run&quot;</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">e</span> <span class="op">=</span> <span class="ide">newEntityWith</span>(<span class="ide">Comp1</span>(<span class="ide">value</span>: <span class="num">2</span>))</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">run</span>()</div></div><div class="line"><div class="line-content"><span class="ide">someData</span> <span class="op">=</span> <span class="ide">e</span><span class="op">.</span><span class="ide">fetch</span>(<span class="ide">Comp1</span>)<span class="op">.</span><span class="ide">value</span></div></div>  </code></pre>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="com"># Module multipleecs2</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">someData</span><span class="op">*:</span> <span class="ide">int</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span> <span class="ide">Comp2</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">    <span class="ide">value</span>: <span class="ide">int</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeSystem</span> <span class="str">&quot;test2&quot;</span>, [<span class="ide">Comp2</span>]:</div></div><div class="line"><div class="line-content">  <span class="ide">all</span>: <span class="ide">item</span><span class="op">.</span><span class="ide">comp2</span><span class="op">.</span><span class="ide">value</span> <span class="op">+=</span> <span class="num">2</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">makeEcs</span>()</div></div><div class="line"><div class="line-content"><span class="ide">commitSystems</span>(<span class="str">&quot;run&quot;</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">e</span> <span class="op">=</span> <span class="ide">newEntityWith</span>(<span class="ide">Comp2</span>(<span class="ide">value</span>: <span class="num">2</span>))</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">run</span>()</div></div><div class="line"><div class="line-content"><span class="ide">someData</span> <span class="op">=</span> <span class="ide">e</span><span class="op">.</span><span class="ide">fetch</span>(<span class="ide">Comp2</span>)<span class="op">.</span><span class="ide">value</span></div></div>  </code></pre>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">multipleecs1</span>, <span class="ide">multipleecs2</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Both ECS are generated and run.</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Note that as both ECS export their types, operations would require</span></div></div><div class="line"><div class="line-content"><span class="com"># disambiguation internally to use in this module, which is not possible.</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">multipleecs1</span><span class="op">.</span><span class="ide">someData</span> <span class="op">==</span> <span class="num">3</span></div></div><div class="line"><div class="line-content"><span class="ide">assert</span> <span class="ide">multipleecs2</span><span class="op">.</span><span class="ide">someData</span> <span class="op">==</span> <span class="num">4</span></div></div>  </code></pre>
<h2>Private ECS</h2>
<p>You can tell Polymorph to automatically strip export markers from generated code, allowing an ECS to be used within a private scope such as a block statement.</p>
<p>To declare an ECS as private, the identity has to have the <code>private</code> option set. This can only be done in a compile time context such as <code>static</code> blocks.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">static</span>: <span class="ide">defaultIdentity</span><span class="op">.</span><span class="ide">setPrivate</span> <span class="ide">true</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">let</span> <span class="ide">result</span> <span class="op">=</span></div></div><div class="line"><div class="line-content">  <span class="kwd">block</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">type</span> <span class="ide">Calc</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content">        <span class="ide">data</span>: <span class="ide">int</span></div></div><div class="line"><div class="line-content">    </div></div><div class="line"><div class="line-content">    <span class="ide">makeSystem</span> <span class="str">&quot;calc&quot;</span>, [<span class="ide">Calc</span>]:</div></div><div class="line"><div class="line-content">      <span class="ide">fields</span>: <span class="ide">value</span>: <span class="ide">int</span></div></div><div class="line"><div class="line-content">      <span class="ide">all</span>: <span class="ide">sys</span><span class="op">.</span><span class="ide">value</span> <span class="op">+=</span> <span class="ide">item</span><span class="op">.</span><span class="ide">calc</span><span class="op">.</span><span class="ide">data</span></div></div><div class="line"><div class="line-content">    </div></div><div class="line"><div class="line-content">    <span class="ide">makeEcs</span>()</div></div><div class="line"><div class="line-content">    <span class="ide">commitSystems</span> <span class="str">&quot;run&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="kwd">for</span> <span class="ide">i</span> <span class="kwd">in</span> <span class="num">0</span> <span class="op">..&lt;</span> <span class="num">10</span>:</div></div><div class="line"><div class="line-content">      <span class="kwd">discard</span> <span class="ide">newEntityWith</span>(<span class="ide">Calc</span>(<span class="ide">data</span>: <span class="num">123</span> <span class="op">*</span> <span class="ide">i</span>))</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">run</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">sysCalc</span><span class="op">.</span><span class="ide">value</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">echo</span> <span class="ide">result</span></div></div>  </code></pre>
<p>Output:</p>
<pre>  <code>5535
</code></pre>
<h2>Multiple identities</h2>
<p>You may create new identities with <code>newEcsIdentity</code>.</p>
<p>In most cases, you only need one identity, and the default identity is assumed.
However, it can be useful to create separate ECS identities to fully isolate an ECS design, for example for creating an internal ECS for use in library code whilst being unaffected by a user&apos;s ECS design, or simply to split out designs.</p>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">polymorph</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">const</span> <span class="ide">myId</span> <span class="op">=</span> <span class="ide">newEcsIdentity</span> <span class="str">&quot;myId&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">myId</span><span class="op">.</span><span class="ide">registerComponents</span> <span class="ide">defaultCompOpts</span>:</div></div><div class="line"><div class="line-content">  <span class="kwd">type</span> <span class="ide">Comp1</span> <span class="op">=</span> <span class="kwd">object</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">myId</span><span class="op">.</span><span class="ide">makeSystem</span> <span class="str">&quot;test1&quot;</span>, [<span class="ide">Comp1</span>]: <span class="kwd">discard</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">myId</span><span class="op">.</span><span class="ide">makeEcs</span> <span class="ide">defaultEntOpts</span></div></div>  </code></pre>
<h1>Future work</h1>
<h2>Performance</h2>
<ul>
<li>Optimise component metadata management.</li>
<li>Provide an option to split component storage into separate lists per field.</li>
<li>Heuristics for inserting components and systems to minimise fragmentation in non-owner systems with high system churn.</li>
<li>Automatically group systems that interact into threads.</li>
</ul>
</document>
            
        </div>
        <div class="col-3" id="meta-section">
            <div class="container box rounded p-3">
                
                    <p>
                        <strong>Licence:</strong>
                        Apache-2.0
                    </p>
                

                
                    <p> <a href="https://github.com/rlipsc/polymorph">Project website</a> </p>
                

                
            </div>
        </div>
    </div>
</div>
</div>

<footer class="pt-10 px-3">
  <div class="container pt-4">
    <div class="row mb-4">
      <div class="col-lg-3">
        <h4 class="h5">Getting started with Nim</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://learnxinyminutes.com/docs/nim/">Learn Nim in 5 minutes</a></li>
          <li><a class="text-decoration-none" href="https://nim-by-example.github.io/">Nim by Example</a></li>
          <li><a class="text-decoration-none" href="https://play.nim-lang.org/">Official Playground</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Official Tutorials</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut1.html">General Tutorial</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut2.html">Advanced Features</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut3.html">Macros and Metaprogramming</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Nim for...</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-C-programmers">C programmers</a></li>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-Python-Programmers">Python programmers</a></li>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-TypeScript-Programmers">TypeScript programmers</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Documentation</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/lib.html">Standard Library</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/manual.html">Language Manual</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tools.html">Tools Documentation</a></li>
        </ul>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-12 text-center mt-4 mx-auto">
        <a href="#" class="d-block mb-3 mx-auto bw"></a>
        <p class="text-muted">
        Created in <a href="https://nim-lang.org/">Nim</a> on <a href="https://pages.github.com/">GitHub Pages</a>.
        <a href="https://github.com/gabbhack/nimidirectory">Available</a>
        under <a href="https://en.wikipedia.org/wiki/GNU_General_Public_License#Version_3">GPLv3</a>
        </p>
        <p class="text-muted">
        Builded at 2023-05-06T01:14:41Z
        </p>
      </div>
    </div>
  </div>
</footer>
<script>
</script>
</body>
</html>
