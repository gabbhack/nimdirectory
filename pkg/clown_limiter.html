<!DOCTYPE html>
<html lang="en">
<head>
  <title>Nim Package Directory</title>
  <link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="alternate" type="application/rss+xml" title="New and updated Nim packages" href="https://nimble.directory/packages.xml">
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/highlite.css">
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script type="text/javascript" src="/js/app.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg fixed-top py-3">
  <div class="container">
    <a href="/" class="logo fw-500 display-1 text-black text-decoration-none navbar-brand"></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item mx-2">
          <a href="https://nim-lang.org/" class="nav-link">What's Nim?</a>
        </li>
        <li class="nav-item mx-2">
          <a href="/about.html" class="nav-link">What's Nimble?</a>
        </li>
        <li class="nav-item mx-2">
          <a href="https://github.com/nim-lang/packages/" class="nav-link">Publish your package</a>
        </li>
        <!-- TODO: replace with something different -->
        <li class="nav-item ms-3">
          <a class="nav-link" href="https://www.youtube.com/channel/UCDAYn_VFt0VisL5-1a5Dk7Q/">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon></svg>
          </a>
        </li>
        <li class="nav-item ms-3">
          <a class="nav-link theme-switcher-btn" id="darkmode" onclick="toggle_dark_mode()" href="#">
            <span id="light-mode-icon">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </span>
            <span id="dark-mode-icon">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="content">
  <div class="container">
    <div class="container pt-10">
        <h3 class="mb-3 fw-bold display-6 pt-4">clown_limiter</h3>
        <p class="tags">
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">jester</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">rate_limiter</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">plugin</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">clown_limiter</button></a>
                </span>
            
        </p>
        <p class="pkg-desc">some("Jester rate limiter plugin")</p>
        <a title="Copy" onclick="document.querySelector('#cmd').select();document.execCommand('copy');"
            alt="Copy on clipboard">
            <i class="fa fa-copy"></i>
        </a>
        <input id="cmd" onclick="this.select();" value="nimble install clown_limiter" readonly="">
        <br>
        <small style="font-size: 0.8rem;">Need help? Read <a
                href="https://github.com/nim-lang/nimble#creating-packages">Nimble</a></small>
    </div>

    <div class="container row pt-4" id="pkg-content">
        <div class="col-8 box rounded p-3" id="readme-section">
            
                <document><h3>Clown limiter</h3>
<p>Jester plugin for api rate limiting. This plugin is built to work on single and multithreaded jester servers. This plugin implements to types of trackers to limit api rate. The first tracker makes use of locks and nim&apos;s <code>ref type</code> for gcsafe and corruption free rate limiting. While the other makes use of a sqlite in memory instance which is not bounded to the nim <code>gc</code> and the db&apos;s write operations are controlled by locks to prevent data corruption hence it is also gcsafe and corruption free. This plugin is safe to be used in single and mutithreaded instances</p>
<h3>Example</h3>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">threadpool</span>, <span class="ide">clown_limiter</span>, <span class="ide">jester</span></div></div><div class="line"><div class="line-content"><span class="kwd">from</span> <span class="ide">std</span> <span class="op">/</span> <span class="ide">nre</span> <span class="kwd">import</span> <span class="ide">re</span></div></div><div class="line"><div class="line-content"><span class="kwd">from</span> <span class="ide">std</span> <span class="op">/</span> <span class="ide">jsonutils</span> <span class="kwd">import</span> <span class="ide">toJson</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">addLimiterEndpoints</span>(<span class="op">@</span>[(<span class="ide">nre</span><span class="op">.</span>re"^/$", <span class="num">50</span>, <span class="num">60</span>), (<span class="ide">nre</span><span class="op">.</span>re"([/]|[A-z])+(.json)$", <span class="num">50</span>, <span class="num">60</span>)]) <span class="com">## only limit the endpoint &apos;/&apos; and </span></div></div><div class="line"><div class="line-content"><span class="com">## endpoints ending with `.json` and limit those endpoints by 50 rates per 60 seconds. Do not call this in a threaded proc</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">server</span>() <span class="op">=</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">routes</span>:</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">        <span class="ide">get</span> <span class="str">&quot;/&quot;</span>:</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">            <span class="ide">resp</span> <span class="str">&quot;home page&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">        <span class="ide">get</span> <span class="str">&quot;/apiendpoint.json&quot;</span>:</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">            <span class="ide">resp</span> (<span class="ide">status</span> : <span class="ide">true</span>, <span class="ide">msg</span> : <span class="str">&quot;opt successful&quot;</span>)<span class="op">.</span><span class="ide">toJson</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">        <span class="ide">extend</span> <span class="ide">clown_limiter</span>, <span class="str">&quot;&quot;</span> <span class="com">## can use second param of extend to further restrict clown limiter to certain endpoints</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">runForever</span>()</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">server</span>()</div></div>  </code></pre>
<h3>Compiler flags</h3>
<p>-d:useSqliteTracker enables the use of in memory sqlite as the counter, else the normal counter will be used</p>
<h3>Using clown limiter with other http server libraries</h3>
<pre>  <code class="language-nim"><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">clown_limiter</span> <span class="op">/</span> <span class="ide">datatype</span></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">std</span> <span class="op">/</span> [<span class="ide">locks</span>, <span class="ide">exitprocs</span>, <span class="ide">asynchttpserver</span>, <span class="ide">asyncdispatch</span>]</div></div><div class="line"><div class="line-content"><span class="kwd">from</span> <span class="ide">std</span> <span class="op">/</span> <span class="ide">nre</span> <span class="kwd">import</span> <span class="ide">contains</span>, <span class="ide">Regex</span></div></div><div class="line"><div class="line-content"><span class="kwd">from</span> <span class="ide">std</span> <span class="op">/</span> <span class="ide">asyncnet</span> <span class="kwd">import</span> <span class="ide">getPeerAddr</span></div></div><div class="line"><div class="line-content"><span class="kwd">from</span> <span class="ide">std</span> <span class="op">/</span> <span class="ide">httpcore</span> <span class="kwd">import</span> <span class="ide">newHttpHeaders</span></div></div><div class="line"><div class="line-content"><span class="kwd">from</span> <span class="ide">std</span> <span class="op">/</span> <span class="ide">sugar</span> <span class="kwd">import</span> `<span class="op">=&gt;</span>`</div></div><div class="line"><div class="line-content"><span class="kwd">from</span> <span class="ide">std</span> <span class="op">/</span> <span class="ide">strformat</span> <span class="kwd">import</span> <span class="ide">fmt</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">when</span> <span class="kwd">not</span> <span class="ide">defined</span>(<span class="ide">useSqliteCounter</span>):</div></div><div class="line"><div class="line-content">    <span class="com">## when not specified to use in memory sqlite to store tracking data</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="kwd">import</span> <span class="ide">clown_limiter</span> <span class="op">/</span> <span class="ide">counters</span> <span class="op">/</span> <span class="ide">counter</span></div></div><div class="line"><div class="line-content">    <span class="kwd">export</span> <span class="ide">counter</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">else</span>:</div></div><div class="line"><div class="line-content">    <span class="com">## when specified to use in memory sqlite to store tracking data</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="kwd">import</span> <span class="ide">clown_limiter</span> <span class="op">/</span> <span class="ide">counters</span> <span class="op">/</span> <span class="ide">sqlitecounter</span></div></div><div class="line"><div class="line-content">    <span class="kwd">export</span> <span class="ide">sqlitecounter</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">type</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="ide">LimitRule</span><span class="op">*</span> <span class="op">=</span> <span class="kwd">tuple</span>[<span class="ide">pattern</span> : <span class="ide">Regex</span>, <span class="ide">rate</span>, <span class="ide">freq</span> : <span class="ide">int</span>]</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> </div></div><div class="line"><div class="line-content">    <span class="ide">ruleLock</span><span class="op">*</span> : <span class="ide">Lock</span></div></div><div class="line"><div class="line-content">    <span class="ide">clownLimiterDataDoNotTouch</span><span class="op">*</span> {<span class="op">.</span><span class="ide">guard</span> : <span class="ide">ruleLock</span><span class="op">.</span>} : <span class="ide">seq</span>[<span class="ide">LimitRule</span>] <span class="com">## Do not mutate this variable directly ðŸ‘€ðŸ‘€, </span></div></div><div class="line"><div class="line-content">    <span class="com">## but instead use the addLimiterEndpoints proc</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">initLock</span>(<span class="ide">ruleLock</span>)</div></div><div class="line"><div class="line-content"><span class="ide">addExitProc</span>(() {<span class="op">.</span><span class="ide">noconv</span><span class="op">.</span>} <span class="op">=&gt;</span> (<span class="ide">deinitLock</span>(<span class="ide">ruleLock</span>)))</div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">addLimiterEndpoints</span><span class="op">*</span>(<span class="ide">rules</span> : <span class="ide">seq</span>[<span class="ide">LimitRule</span>]) {<span class="op">.</span><span class="ide">gcsafe</span><span class="op">.</span>} <span class="op">=</span></div></div><div class="line"><div class="line-content">    <span class="com">## sets the data for api endpoints to be rate limited.</span></div></div><div class="line"><div class="line-content">    <span class="com">## makes sure that there are no multiple rules for a single regex endpoint</span></div></div><div class="line"><div class="line-content">    </div></div><div class="line"><div class="line-content">    {<span class="op">.</span><span class="kwd">cast</span>(<span class="ide">gcsafe</span>)<span class="op">.</span>}:</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">        <span class="ide">withLock</span> <span class="ide">ruleLock</span>:</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">            <span class="kwd">var</span> <span class="ide">sortedRules</span> : <span class="ide">seq</span>[<span class="ide">LimitRule</span>]</div></div><div class="line"><div class="line-content">            <span class="kwd">for</span> <span class="ide">rule</span> <span class="kwd">in</span> <span class="ide">rules</span>:</div></div><div class="line"><div class="line-content">                </div></div><div class="line"><div class="line-content">                <span class="kwd">var</span> <span class="ide">duplicate</span> : <span class="ide">bool</span></div></div><div class="line"><div class="line-content">                <span class="kwd">for</span> <span class="ide">sortrule</span> <span class="kwd">in</span> <span class="ide">sortedRules</span>:</div></div><div class="line"><div class="line-content">                    </div></div><div class="line"><div class="line-content">                    <span class="kwd">if</span> <span class="ide">sortrule</span><span class="op">.</span><span class="ide">pattern</span> <span class="op">==</span> <span class="ide">rule</span><span class="op">.</span><span class="ide">pattern</span>:</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">                        <span class="ide">duplicate</span> <span class="op">=</span> <span class="ide">true</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">                <span class="kwd">if</span> <span class="kwd">not</span> <span class="ide">duplicate</span>:</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">                    <span class="ide">sortedRules</span><span class="op">.</span><span class="ide">add</span>(<span class="ide">rule</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">            <span class="ide">clownLimiterDataDoNotTouch</span> <span class="op">=</span> <span class="ide">sortedRules</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">addLimiterEndpoints</span><span class="op">*</span>(<span class="ide">rule</span> : <span class="ide">LimitRule</span>) {<span class="op">.</span><span class="ide">gcsafe</span><span class="op">.</span>} <span class="op">=</span></div></div><div class="line"><div class="line-content">    <span class="com">## adds rule for api endpoints to be rate limited.</span></div></div><div class="line"><div class="line-content">    <span class="com">## makes sure that there are no multiple rules for a single regex endpoint</span></div></div><div class="line"><div class="line-content">    </div></div><div class="line"><div class="line-content">    {<span class="op">.</span><span class="kwd">cast</span>(<span class="ide">gcsafe</span>)<span class="op">.</span>}:</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">        <span class="ide">withLock</span> <span class="ide">ruleLock</span>:</div></div><div class="line"><div class="line-content">            </div></div><div class="line"><div class="line-content">            <span class="kwd">var</span> <span class="ide">insertPos</span> : <span class="ide">int</span> <span class="op">=</span> <span class="op">-</span><span class="num">1</span></div></div><div class="line"><div class="line-content">            <span class="kwd">for</span> <span class="ide">pos</span> <span class="kwd">in</span> <span class="num">0.</span><span class="op">.&lt;</span><span class="ide">clownLimiterDataDoNotTouch</span><span class="op">.</span><span class="ide">len</span>():</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">                <span class="kwd">if</span> <span class="ide">clownLimiterDataDoNotTouch</span>[<span class="ide">pos</span>]<span class="op">.</span><span class="ide">pattern</span> <span class="op">==</span> <span class="ide">rule</span><span class="op">.</span><span class="ide">pattern</span>:</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">                    <span class="ide">insertPos</span> <span class="op">=</span> <span class="ide">pos</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">            <span class="kwd">if</span> <span class="ide">insertPos</span> <span class="op">&gt;=</span> <span class="num">0</span>:</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">                <span class="ide">clownLimiterDataDoNotTouch</span>[<span class="ide">insertPos</span>] <span class="op">=</span> <span class="ide">rule</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">            <span class="kwd">else</span>:</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">                <span class="ide">clownLimiterDataDoNotTouch</span><span class="op">.</span><span class="ide">add</span>(<span class="ide">rule</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">callBack</span>(<span class="ide">req</span> : <span class="ide">Request</span>) {<span class="op">.</span><span class="ide">async</span>, <span class="ide">gcsafe</span><span class="op">.</span>} <span class="op">=</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="kwd">try</span>:</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">        <span class="kwd">var</span> <span class="ide">rules</span> : <span class="ide">seq</span>[<span class="ide">LimitRule</span>]</div></div><div class="line"><div class="line-content">        {<span class="op">.</span><span class="kwd">cast</span>(<span class="ide">gcsafe</span>)<span class="op">.</span>}:</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">            <span class="ide">withLock</span> <span class="ide">ruleLock</span>:</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">                <span class="ide">rules</span> <span class="op">=</span> <span class="ide">clownLimiterDataDoNotTouch</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">        <span class="kwd">var</span> </div></div><div class="line"><div class="line-content">            <span class="ide">checkRate</span> : <span class="ide">bool</span> <span class="op">=</span> <span class="ide">false</span></div></div><div class="line"><div class="line-content">            <span class="ide">rate</span>, <span class="ide">freq</span> : <span class="ide">int</span></div></div><div class="line"><div class="line-content">            <span class="ide">endpoint</span> : <span class="ide">string</span></div></div><div class="line"><div class="line-content">            <span class="ide">httpcode</span> : <span class="ide">HttpCode</span></div></div><div class="line"><div class="line-content">        <span class="kwd">let</span> <span class="ide">url</span> <span class="op">=</span> <span class="ide">req</span><span class="op">.</span><span class="ide">url</span><span class="op">.</span><span class="ide">path</span></div></div><div class="line"><div class="line-content">        <span class="kwd">for</span> <span class="ide">rule</span> <span class="kwd">in</span> <span class="ide">rules</span>:</div></div><div class="line"><div class="line-content">            </div></div><div class="line"><div class="line-content">            <span class="kwd">if</span> <span class="ide">contains</span>(<span class="ide">url</span>, <span class="ide">rule</span><span class="op">.</span><span class="ide">pattern</span>):</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">                <span class="ide">checkRate</span> <span class="op">=</span> <span class="ide">true</span></div></div><div class="line"><div class="line-content">                <span class="ide">rate</span> <span class="op">=</span> <span class="ide">rule</span><span class="op">.</span><span class="ide">rate</span></div></div><div class="line"><div class="line-content">                <span class="ide">freq</span> <span class="op">=</span> <span class="ide">rule</span><span class="op">.</span><span class="ide">freq</span></div></div><div class="line"><div class="line-content">                <span class="ide">endpoint</span> <span class="op">=</span> <span class="ide">rule</span><span class="op">.</span><span class="ide">pattern</span><span class="op">.</span><span class="ide">pattern</span></div></div><div class="line"><div class="line-content">                <span class="kwd">break</span></div></div><div class="line"><div class="line-content">        </div></div><div class="line"><div class="line-content">        <span class="kwd">block</span> <span class="ide">limitValidation</span>:</div></div><div class="line"><div class="line-content">            </div></div><div class="line"><div class="line-content">            <span class="kwd">if</span> <span class="ide">checkRate</span>:</div></div><div class="line"><div class="line-content">                </div></div><div class="line"><div class="line-content">                <span class="kwd">let</span> </div></div><div class="line"><div class="line-content">                    <span class="ide">ip</span> <span class="op">=</span> <span class="ide">req</span><span class="op">.</span><span class="ide">client</span><span class="op">.</span><span class="ide">getPeerAddr</span>()[<span class="num">0</span>]</div></div><div class="line"><div class="line-content">                    <span class="ide">rateinfo</span> <span class="op">=</span> <span class="ide">rateStatus</span>(<span class="ide">endpoint</span>, <span class="ide">ip</span>, <span class="ide">rate</span>, <span class="ide">freq</span>)</div></div><div class="line"><div class="line-content">                </div></div><div class="line"><div class="line-content">                <span class="kwd">case</span> <span class="ide">rateinfo</span><span class="op">.</span><span class="ide">status</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">                <span class="kwd">of</span> <span class="ide">Exceeded</span>:</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">                    <span class="ide">await</span> <span class="ide">req</span><span class="op">.</span><span class="ide">respond</span>(<span class="ide">Http429</span>, <span class="str">&quot;Too many requests&quot;</span>)</div></div><div class="line"><div class="line-content">                    <span class="ide">httpcode</span> <span class="op">=</span> <span class="ide">Http429</span></div></div><div class="line"><div class="line-content">                    <span class="kwd">break</span> <span class="ide">limitValidation</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">                <span class="kwd">of</span> <span class="ide">NotExceeded</span>:</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">                    <span class="ide">recordReqRate</span>(<span class="ide">endpoint</span>, <span class="ide">ip</span>, <span class="ide">rateinfo</span><span class="op">.</span><span class="ide">calls</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">                <span class="kwd">of</span> <span class="ide">Expired</span>:</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">                    <span class="ide">resetReqRate</span>(<span class="ide">endpoint</span>, <span class="ide">ip</span>)</div></div><div class="line"><div class="line-content">            </div></div><div class="line"><div class="line-content">                <span class="ide">await</span> <span class="ide">req</span><span class="op">.</span><span class="ide">respond</span>(<span class="ide">Http200</span>, <span class="str">&quot;Hello boss&quot;</span>, <span class="ide">newHttpHeaders</span>(</div></div><div class="line"><div class="line-content">                    <span class="op">@</span>[</div></div><div class="line"><div class="line-content">                        (<span class="str">&quot;X-RateLimit-Limit&quot;</span>, fmt"{rate}/{freq}s"),</div></div><div class="line"><div class="line-content">                        (<span class="str">&quot;X-RateLimit-Remaining&quot;</span>, <span class="op">$</span>(<span class="ide">rate</span> <span class="op">-</span> <span class="ide">rateinfo</span><span class="op">.</span><span class="ide">calls</span>)),</div></div><div class="line"><div class="line-content">                        (<span class="str">&quot;X-RateLimit-Reset&quot;</span>, <span class="op">$</span><span class="ide">rateinfo</span><span class="op">.</span><span class="ide">resetime</span>)</div></div><div class="line"><div class="line-content">                    ]</div></div><div class="line"><div class="line-content">                ))</div></div><div class="line"><div class="line-content">                <span class="ide">httpcode</span> <span class="op">=</span> <span class="ide">Http200</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">            <span class="kwd">else</span>:</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">                <span class="ide">await</span> <span class="ide">req</span><span class="op">.</span><span class="ide">respond</span>(<span class="ide">Http400</span>, <span class="str">&quot;Not Found&quot;</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">        <span class="ide">echo</span> fmt"{req.reqMethod} :: {req.url.path} :: {httpcode}"</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="kwd">except</span> <span class="ide">Exception</span> <span class="kwd">as</span> <span class="ide">e</span>:</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">        <span class="ide">echo</span> <span class="ide">e</span><span class="op">.</span><span class="ide">getStackTrace</span>()</div></div><div class="line"><div class="line-content">        <span class="ide">await</span> <span class="ide">req</span><span class="op">.</span><span class="ide">respond</span>(<span class="ide">Http500</span>, <span class="str">&quot;Server Error&quot;</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">proc</span> <span class="ide">server</span><span class="op">*</span>(<span class="ide">ip</span> : <span class="ide">string</span>, <span class="ide">port</span> : <span class="ide">int</span>) {<span class="op">.</span><span class="ide">async</span><span class="op">.</span>} <span class="op">=</span></div></div><div class="line"><div class="line-content">    <span class="com">## run http server</span></div></div><div class="line"><div class="line-content">    </div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> fmt"Http server listening on {ip}:{port}"</div></div><div class="line"><div class="line-content">    <span class="ide">addLimiterEndpoints</span>(<span class="op">@</span>[(<span class="ide">nre</span><span class="op">.</span>re"^/$", <span class="num">50</span>, <span class="num">60</span>), (<span class="ide">nre</span><span class="op">.</span>re"([/]|[A-z])+(.json)$", <span class="num">50</span>, <span class="num">60</span>)])</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">    <span class="kwd">let</span> <span class="ide">server</span> <span class="op">=</span> <span class="ide">newAsyncHttpServer</span>()</div></div><div class="line"><div class="line-content">    <span class="ide">addExitProc</span>(() {<span class="op">.</span><span class="ide">closure</span><span class="op">.</span>} <span class="op">=&gt;</span> (</div></div><div class="line"><div class="line-content">        <span class="ide">echo</span> <span class="str">&quot;Stopping http server...&quot;</span>; </div></div><div class="line"><div class="line-content">        <span class="ide">server</span><span class="op">.</span><span class="ide">close</span>()</div></div><div class="line"><div class="line-content">    ))</div></div><div class="line"><div class="line-content">    </div></div><div class="line"><div class="line-content">    <span class="ide">await</span> <span class="ide">server</span><span class="op">.</span><span class="ide">serve</span>(<span class="ide">Port</span>(<span class="ide">port</span>), <span class="ide">callBack</span>, <span class="ide">ip</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">asyncCheck</span> <span class="ide">server</span>(<span class="str">&quot;0.0.0.0&quot;</span>, <span class="num">5000</span>)</div></div><div class="line"><div class="line-content"><span class="ide">runForever</span>()</div></div>  </code></pre>
</document>
            
        </div>
        <div class="col-3" id="meta-section">
            <div class="container box rounded p-3">
                
                    <p>
                        <strong>Licence:</strong>
                        MIT
                    </p>
                

                
                    <p> <a href="https://github.com/C-NERD/clown_limiter">Project website</a> </p>
                

                
            </div>
        </div>
    </div>
</div>
</div>

<footer class="pt-10 px-3">
  <div class="container pt-4">
    <div class="row mb-4">
      <div class="col-lg-3">
        <h4 class="h5">Getting started with Nim</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://learnxinyminutes.com/docs/nim/">Learn Nim in 5 minutes</a></li>
          <li><a class="text-decoration-none" href="https://nim-by-example.github.io/">Nim by Example</a></li>
          <li><a class="text-decoration-none" href="https://play.nim-lang.org/">Official Playground</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Official Tutorials</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut1.html">General Tutorial</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut2.html">Advanced Features</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut3.html">Macros and Metaprogramming</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Nim for...</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-C-programmers">C programmers</a></li>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-Python-Programmers">Python programmers</a></li>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-TypeScript-Programmers">TypeScript programmers</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Documentation</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/lib.html">Standard Library</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/manual.html">Language Manual</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tools.html">Tools Documentation</a></li>
        </ul>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-12 text-center mt-4 mx-auto">
        <a href="#" class="d-block mb-3 mx-auto bw"></a>
        <p class="text-muted">
        Created in <a href="https://nim-lang.org/">Nim</a> on <a href="https://pages.github.com/">GitHub Pages</a>.
        <a href="https://github.com/gabbhack/nimidirectory">Available</a>
        under <a href="https://en.wikipedia.org/wiki/GNU_General_Public_License#Version_3">GPLv3</a>
        </p>
        <p class="text-muted">
        Builded at 2023-06-08T01:42:57Z
        </p>
      </div>
    </div>
  </div>
</footer>
<script>
</script>
</body>
</html>
