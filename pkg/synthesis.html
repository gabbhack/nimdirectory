<!DOCTYPE html>
<html lang="en">
<head>
  <title>Nim Package Directory</title>
  <link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="alternate" type="application/rss+xml" title="New and updated Nim packages" href="https://nimble.directory/packages.xml">
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/highlite.css">
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script type="text/javascript" src="/js/app.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg fixed-top py-3">
  <div class="container">
    <a href="/" class="logo fw-500 display-1 text-black text-decoration-none navbar-brand"></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item mx-2">
          <a href="https://nim-lang.org/" class="nav-link">What's Nim?</a>
        </li>
        <li class="nav-item mx-2">
          <a href="/about.html" class="nav-link">What's Nimble?</a>
        </li>
        <li class="nav-item mx-2">
          <a href="https://github.com/nim-lang/packages/" class="nav-link">Publish your package</a>
        </li>
        <!-- TODO: replace with something different -->
        <li class="nav-item ms-3">
          <a class="nav-link" href="https://www.youtube.com/channel/UCDAYn_VFt0VisL5-1a5Dk7Q/">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon></svg>
          </a>
        </li>
        <li class="nav-item ms-3">
          <a class="nav-link theme-switcher-btn" id="darkmode" onclick="toggle_dark_mode()" href="#">
            <span id="light-mode-icon">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </span>
            <span id="dark-mode-icon">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="content">
  <div class="container">
    <div class="container pt-10">
        <h3 class="mb-3 fw-bold display-6 pt-4">synthesis</h3>
        <p class="tags">
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">finite-state-machine</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">state-machine</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">fsm</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">event-driven</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">reactive-programming</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">embedded</button></a>
                </span>
            
                <span class="tag">
                    <button class="btn-tag pkg-btn-tag">actor</button></a>
                </span>
            
        </p>
        
            <p class="pkg-desc">A compile-time, compact, fast, without allocation, state-machine generator.</p>
        
        <a title="Copy" onclick="document.querySelector('#cmd').select();document.execCommand('copy');"
            alt="Copy on clipboard">
            <i class="fa fa-copy"></i>
        </a>
        <input id="cmd" onclick="this.select();" value="nimble install synthesis" readonly="">
        <br>
        <small style="font-size: 0.8rem;">Need help? Read <a
                href="https://github.com/nim-lang/nimble#creating-packages">Nimble</a></small>
    </div>

    <div class="container row pt-4" id="pkg-content">
        <div class="col-8 box rounded p-3" id="readme-section">
            
                <document><h1>Synthesis</h1>
<p><a href="https://travis-ci.com/mratsim/Synthesis">  <img src="https://img.shields.io/travis/com/mratsim/Synthesis?label=Travis%20%28Linux%2FMac%20-%20x86_64%2FARM64%29" style="max-width: 100%;" alt="Build Status: Travis" /></a>
<a href="https://dev.azure.com/numforge/Synthesis/_build/latest?definitionId=1&amp;branchName=master">  <img src="https://img.shields.io/azure-devops/build/numforge/e96b84dd-e587-47d1-aea3-64cb49b50ca2/1?label=Azure%20%28C%2FC%2B%2B%2C%20Linux%2064-bit%2C%20Windows%2032-bit%2F64-bit%2C%20MacOS%2064-bit%29" style="max-width: 100%;" alt="Build Status: Azure" /></a></p>
<p><a href="https://opensource.org/licenses/Apache-2.0">  <img src="https://img.shields.io/badge/License-Apache%202.0-blue.svg" style="max-width: 100%;" alt="License: Apache" /></a>
<a href="https://opensource.org/licenses/MIT">  <img src="https://img.shields.io/badge/License-MIT-blue.svg" style="max-width: 100%;" alt="License: MIT" /></a>
<img src="https://img.shields.io/badge/stability-experimental-orange.svg" style="max-width: 100%;" alt="Stability: experimental" /></p>
<h2>Overview</h2>
<p>This package exports a set of macros to synthesize static procedure-based automata from
a declarative description of states, triggers and transitions
with all states, triggers and transitions known at compile-time.</p>
<p>It is fast, composable, threadsafe, generates compact code and does not allocate on the heap.</p>
<p>Within each states you also have the full power
of the Nim language instead of being restricted to only operations
supported by a custom domain-specific language.</p>
<p>The generated state machine is a procedure, with parameters of your choosing that access in your states.
You can easily call other procedures to build nested state machines or
introduce a stack of past states to create a pushdown automata (for parsing Brainfuck or JSON for example).</p>
<p>A detailed usage tutorial is available at <a href="">examples/water_phase_transitions.nim</a>. It is executable.</p>
<p>This is a support library for the <a href="https://github.com/mratsim/weave">Weave</a> multithreading runtime.
Requirements for a multithreading runtime makes Synthesis also an excellent fit
to generate state machines for embedded devices, protocols
and managing complex event-driven workloads in general.</p>
<h2>Appetizers</h2>
<p>Here are 2 simple examples of the usage of Synthesis in production code to implement components of the Weave multithreading runtime.</p>
<h3>Worker state machine</h3>
<p>  <a href="https://github.com/mratsim/weave/blob/4493b493/weave/work_fsm.nim">Source</a></p>
<p>This is the description of the transitions of a worker thread that ran out of tasks in its own task queue
and checks if it managed to steal tasks from other threads. (The theft is handled in another state machine.)</p>
<pre>  <code class="language-Nim"><div class="line"><div class="line-content"><span class="kwd">type</span></div></div><div class="line"><div class="line-content">  <span class="ide">RecvTaskState</span> <span class="op">=</span> <span class="kwd">enum</span></div></div><div class="line"><div class="line-content">    <span class="ide">RT_CheckChannel</span></div></div><div class="line"><div class="line-content">    <span class="ide">RT_FoundTask</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content">  <span class="ide">RT_Event</span> <span class="op">=</span> <span class="kwd">enum</span></div></div><div class="line"><div class="line-content">    <span class="ide">RTE_CheckedAllChannels</span></div></div><div class="line"><div class="line-content">    <span class="ide">RTE_FoundTask</span></div></div><div class="line"><div class="line-content">    <span class="ide">RTE_isWaiting</span></div></div>  </code></pre>
<p>  <img src="media/work_fsm.png" style="max-width: 100%;" alt="worker thread FSA" /></p>
<h3>sync (await) a task that may be spawned on another thread</h3>
<p>  <a href="https://github.com/mratsim/weave/blob/4493b493/weave/await_fsm.nim">Source</a></p>
<p>This is the description of the transitions of any thread that syncs (awaits) a future that may be handled in another thread.</p>
<p>In summary, while the awaited task has child tasks still pending in this worker thread, those are processed in priority,
otherwise, it steals tasks from other threads to help them on their workload.
As soon as the future is ready, it exits.</p>
<pre>  <code class="language-Nim"><div class="line"><div class="line-content"><span class="kwd">type</span> <span class="ide">AwaitState</span> <span class="op">=</span> <span class="kwd">enum</span></div></div><div class="line"><div class="line-content">  <span class="ide">AW_CheckTask</span></div></div><div class="line"><div class="line-content">  <span class="ide">AW_OutOfChildTasks</span></div></div><div class="line"><div class="line-content">  <span class="ide">AW_Steal</span></div></div><div class="line"><div class="line-content">  <span class="ide">AW_SuccessfulTheft</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">type</span> <span class="ide">AwaitEvent</span> <span class="op">=</span> <span class="kwd">enum</span></div></div><div class="line"><div class="line-content">  <span class="ide">AWE_FutureReady</span></div></div><div class="line"><div class="line-content">  <span class="ide">AWE_HasChildTask</span></div></div><div class="line"><div class="line-content">  <span class="ide">AWE_ReceivedTask</span></div></div>  </code></pre>
<p>  <img src="media/await_fsm.png" style="max-width: 100%;" alt="sync/await FSA" /></p>
<h2>Table of Contents</h2>
<ul>
<li><a href="#synthesis">Synthesis</a>
<ul>
<li>  <a href="#overview">Overview</a></li>
<li><a href="#appetizers">Appetizers</a>
<ul>
<li>  <a href="#worker-state-machine">Worker state machine</a></li>
<li>  <a href="#sync-await-a-task-that-may-be-spawned-on-another-thread">sync (await) a task that may be spawned on another thread</a></li>
</ul>
</li>
<li>  <a href="#table-of-contents">Table of Contents</a></li>
<li>  <a href="#commented-example-water-phases">Commented example: Water phases</a></li>
<li>  <a href="#displaying-the-state-machine">Displaying the state machine</a></li>
<li>  <a href="#technical-constraints">Technical constraints</a></li>
<li>  <a href="#references">References</a></li>
</ul>
</li>
</ul>
<h2>Commented example: Water phases</h2>
<p>The example below gives you a short overview of how to build your state machine.</p>
<p>Recipe:</p>
<ul>
<li>A state enum (called <code>Phase</code> in the example)</li>
<li>An event/trigger/condition enum (called <code>Event</code>)</li>
<li>Declaring a state machine</li>
<li>Declaring prologue, epilogue, initial state, terminal state. SOme are optional</li>
<li>Implement your events. Those are boolean tests.
Events have visibility on variables declared
<ul>
<li>in the prologue</li>
<li>in <code>onEntry</code></li>
<li>and the synthesized function parameters (here <code>tempFeed</code>).
<pre>  <code class="language-Nim">synthesize(waterMachine):
  proc observeWater(tempFeed: var seq[float])
</code></pre>
</li>
</ul>
</li>
<li>Implement common setup and teardown on state entry and exit if needed</li>
<li>Describe behaviours (i.e. state to state transition):
<ul>
<li>Transition without condition</li>
<li>Conditional transition due to an event</li>
<li>&quot;Interrupt&quot; which is a conditional transition that shortcuts regular control flow
and allow handling exceptional cases, for example reaching the end of the <code>tempFeed</code> sequence.</li>
</ul>
</li>
<li>Synthesize the state machine</li>
<li>Run it</li>
<li>...</li>
<li>Profit!</li>
</ul>
<pre>  <code class="language-Nim"><div class="line"><div class="line-content"><span class="kwd">type</span> <span class="ide">Phase</span> <span class="op">=</span> <span class="kwd">enum</span></div></div><div class="line"><div class="line-content">  <span class="com">## States of your automaton.</span></div></div><div class="line"><div class="line-content">  <span class="com">## The terminal state does not need to be defined</span></div></div><div class="line"><div class="line-content">  <span class="ide">Solid</span></div></div><div class="line"><div class="line-content">  <span class="ide">Liquid</span></div></div><div class="line"><div class="line-content">  <span class="ide">Gas</span></div></div><div class="line"><div class="line-content">  <span class="com"># Plasma is unused. On the graph display, it will not be reachable from the InitialState.</span></div></div><div class="line"><div class="line-content">  <span class="com"># The graph will also show that transitions out of the Plasma state are undefined via an `unreachable` transition.</span></div></div><div class="line"><div class="line-content">  <span class="ide">Plasma</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="kwd">type</span> <span class="ide">Event</span> <span class="op">=</span> <span class="kwd">enum</span></div></div><div class="line"><div class="line-content">  <span class="com">## Named events. They will be associated with a boolean expression.</span></div></div><div class="line"><div class="line-content">  <span class="ide">Over100</span></div></div><div class="line"><div class="line-content">  <span class="ide">Between0and100</span></div></div><div class="line"><div class="line-content">  <span class="ide">Below0</span></div></div><div class="line"><div class="line-content">  <span class="ide">OutOfWater</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Common configuration</span></div></div><div class="line"><div class="line-content"><span class="com"># -------------------------------------------</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Create a &quot;waterMachine&quot; entry.</span></div></div><div class="line"><div class="line-content"><span class="ide">declareAutomaton</span>(<span class="ide">waterMachine</span>, <span class="ide">Phase</span>, <span class="ide">Event</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Optionally setup the &quot;prologue&quot;. Extra state goes there, the variables are visible by all.</span></div></div><div class="line"><div class="line-content"><span class="ide">setPrologue</span>(<span class="ide">waterMachine</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;Welcome to the Steamy machine version 2000!</span>\n<span class="str">&quot;</span></div></div><div class="line"><div class="line-content">  <span class="kwd">var</span> <span class="ide">temp</span>: <span class="ide">float64</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Mandatory initial state. This must be one of the valid state of the state enum (&quot;Phase&quot; in our case)</span></div></div><div class="line"><div class="line-content"><span class="ide">setInitialState</span>(<span class="ide">waterMachine</span>, <span class="ide">Liquid</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Terminal state is mandatory. It&apos;s a pseudo state and does not have to be part of the state enum.</span></div></div><div class="line"><div class="line-content"><span class="ide">setTerminalState</span>(<span class="ide">waterMachine</span>, <span class="ide">Exit</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Optionally setup the &quot;epilogue&quot;. Cleaning up what was setup in the prologue goes there.</span></div></div><div class="line"><div class="line-content"><span class="ide">setEpilogue</span>(<span class="ide">waterMachine</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;Now I need some coffee.&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Events</span></div></div><div class="line"><div class="line-content"><span class="com"># -------------------------------------------</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">implEvent</span>(<span class="ide">waterMachine</span>, <span class="ide">OutOfWater</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">tempFeed</span><span class="op">.</span><span class="ide">len</span> <span class="op">==</span> <span class="num">0</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">implEvent</span>(<span class="ide">waterMachine</span>, <span class="ide">Between0and100</span>):</div></div><div class="line"><div class="line-content">  <span class="num">0</span> <span class="op">&lt;</span> <span class="ide">temp</span> <span class="kwd">and</span> <span class="ide">temp</span> <span class="op">&lt;</span> <span class="num">100</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">implEvent</span>(<span class="ide">waterMachine</span>, <span class="ide">Below0</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">temp</span> <span class="op">&lt;</span> <span class="num">0</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">implEvent</span>(<span class="ide">waterMachine</span>, <span class="ide">Over100</span>):</div></div><div class="line"><div class="line-content">  <span class="num">100</span> <span class="op">&lt;</span> <span class="ide">temp</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># `onEntry` and `onExit` hooks</span></div></div><div class="line"><div class="line-content"><span class="com"># -------------------------------------------</span></div></div><div class="line"><div class="line-content"><span class="com">#</span></div></div><div class="line"><div class="line-content"><span class="com"># Those are applied on each state entry, before conditions are checked</span></div></div><div class="line"><div class="line-content"><span class="com"># and on each state exits. The only exceptions are &quot;interrupt&quot; behaviours.</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">onEntry</span>(<span class="ide">waterMachine</span>, [<span class="ide">Solid</span>, <span class="ide">Liquid</span>, <span class="ide">Gas</span>]):</div></div><div class="line"><div class="line-content">  <span class="kwd">let</span> <span class="ide">oldTemp</span> <span class="op">=</span> <span class="ide">temp</span></div></div><div class="line"><div class="line-content">  <span class="ide">temp</span> <span class="op">=</span> <span class="ide">tempFeed</span><span class="op">.</span><span class="ide">pop</span>()</div></div><div class="line"><div class="line-content">  <span class="ide">echo</span> <span class="str">&quot;Temperature: &quot;</span>, <span class="ide">temp</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># `behaviors`</span></div></div><div class="line"><div class="line-content"><span class="com"># -------------------------------------------</span></div></div><div class="line"><div class="line-content"><span class="com">#</span></div></div><div class="line"><div class="line-content"><span class="com"># Interrupts are special triggers which ignores onEntry/onExit</span></div></div><div class="line"><div class="line-content"><span class="com">#</span></div></div><div class="line"><div class="line-content"><span class="com"># They allow the normal operations to make assumptions like</span></div></div><div class="line"><div class="line-content"><span class="com"># a container not being empty or a value being available.</span></div></div><div class="line"><div class="line-content"><span class="com">#</span></div></div><div class="line"><div class="line-content"><span class="com"># They are also suitable to handle termination signals.</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">behavior</span>(<span class="ide">waterMachine</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">ini</span>: [<span class="ide">Solid</span>, <span class="ide">Liquid</span>, <span class="ide">Gas</span>, <span class="ide">Plasma</span>]</div></div><div class="line"><div class="line-content">  <span class="ide">fin</span>: <span class="ide">Exit</span></div></div><div class="line"><div class="line-content">  <span class="ide">interrupt</span>: <span class="ide">OutOfWater</span></div></div><div class="line"><div class="line-content">  <span class="ide">transition</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;Running out of steam ...&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Conditional state change, depending on temperature.</span></div></div><div class="line"><div class="line-content"><span class="ide">behavior</span>(<span class="ide">waterMachine</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">ini</span>: <span class="ide">Solid</span></div></div><div class="line"><div class="line-content">  <span class="ide">fin</span>: <span class="ide">Liquid</span></div></div><div class="line"><div class="line-content">  <span class="ide">event</span>: <span class="ide">Between0and100</span></div></div><div class="line"><div class="line-content">  <span class="ide">transition</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">assert</span> <span class="num">0</span> <span class="op">&lt;=</span> <span class="ide">temp</span> <span class="kwd">and</span> <span class="ide">temp</span> <span class="op">&lt;=</span> <span class="num">100</span></div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;Ice is melting into Water.</span>\n<span class="str">&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">behavior</span>(<span class="ide">waterMachine</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">ini</span>: <span class="ide">Liquid</span></div></div><div class="line"><div class="line-content">  <span class="ide">fin</span>: <span class="ide">Gas</span></div></div><div class="line"><div class="line-content">  <span class="ide">event</span>: <span class="ide">Over100</span></div></div><div class="line"><div class="line-content">  <span class="ide">transition</span>:</div></div><div class="line"><div class="line-content">    <span class="ide">assert</span> <span class="ide">temp</span> <span class="op">&gt;=</span> <span class="num">100</span></div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;Water is vaporizing into Vapor.</span>\n<span class="str">&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com">#...</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Steady state, if no phase change was triggered, we stay in our current phase</span></div></div><div class="line"><div class="line-content"><span class="ide">behavior</span>(<span class="ide">waterMachine</span>):</div></div><div class="line"><div class="line-content">  <span class="ide">steady</span>: [<span class="ide">Solid</span>, <span class="ide">Liquid</span>, <span class="ide">Gas</span>]</div></div><div class="line"><div class="line-content">  <span class="ide">transition</span>:</div></div><div class="line"><div class="line-content">    <span class="com"># Note how we use the oldTemp that was declared in `onEntry`</span></div></div><div class="line"><div class="line-content">    <span class="ide">echo</span> <span class="str">&quot;Changing temperature from &quot;</span>, <span class="ide">oldTemp</span>, <span class="str">&quot; to &quot;</span>, <span class="ide">temp</span>, <span class="str">&quot; didn&apos;t change phase. How exciting!</span>\n<span class="str">&quot;</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># `Synthesize`</span></div></div><div class="line"><div class="line-content"><span class="com"># -------------------------------------------</span></div></div><div class="line"><div class="line-content"><span class="com"># Synthesizing the automaton will transform the previous specification</span></div></div><div class="line"><div class="line-content"><span class="com"># into a concrete procedure with a name, type and inputs of your choosing.</span></div></div><div class="line"><div class="line-content"><span class="com">#</span></div></div><div class="line"><div class="line-content"><span class="com"># Assertions are inserted to ensure the automaton</span></div></div><div class="line"><div class="line-content"><span class="com"># stops if a state+event combination was not handled.</span></div></div><div class="line"><div class="line-content"><span class="com">#</span></div></div><div class="line"><div class="line-content"><span class="com"># You can pass &quot;-d:debugSynthesis&quot; to view the state machine generated</span></div></div><div class="line"><div class="line-content"><span class="com"># at compile-time.</span></div></div><div class="line"><div class="line-content"><span class="com">#</span></div></div><div class="line"><div class="line-content"><span class="com"># The generated code can also be copy-pasted for debugging or for further refining.</span></div></div><div class="line"><div class="line-content"><span class="ide">synthesize</span>(<span class="ide">waterMachine</span>):</div></div><div class="line"><div class="line-content">  <span class="kwd">proc</span> <span class="ide">observeWater</span>(<span class="ide">tempFeed</span>: <span class="kwd">var</span> <span class="ide">seq</span>[<span class="ide">float</span>])</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Running the machine</span></div></div><div class="line"><div class="line-content"><span class="com"># -------------------------------------------</span></div></div><div class="line"><div class="line-content"><span class="kwd">import</span> <span class="ide">random</span>, <span class="ide">sequtils</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="ide">echo</span> <span class="str">&quot;</span>\n<span class="str">&quot;</span></div></div><div class="line"><div class="line-content"><span class="com"># Create 20 random temperature observations.</span></div></div><div class="line"><div class="line-content"><span class="kwd">var</span> <span class="ide">obs</span> <span class="op">=</span> <span class="ide">newSeqWith</span>(<span class="num">20</span>, <span class="ide">rand</span>(<span class="op">-</span><span class="num">50.0</span><span class="op">..</span><span class="num">150.0</span>))</div></div><div class="line"><div class="line-content"><span class="ide">echo</span> <span class="ide">obs</span></div></div><div class="line"><div class="line-content"><span class="ide">echo</span> <span class="str">&quot;</span>\n<span class="str">&quot;</span></div></div><div class="line"><div class="line-content"><span class="ide">observeWater</span>(<span class="ide">obs</span>)</div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Output</span></div></div><div class="line"><div class="line-content"><span class="com"># -------------------------------------------</span></div></div><div class="line"><div class="line-content"><span class="com"># @[-3.460770047808822, 114.5693402308219, 16.66758940395412, 147.8992369379481, 38.74529893378966, -34.83679531473696, 68.73127270016445, -10.89306136942781, 55.17781700115015, 114.8825749296374, 86.88038583504948, 47.98729291960338, -40.94605405014646, 141.4807806383724, -19.78255259056119, -1.654260475969281, 37.0554825533913, 80.74588296425821, -7.707680239048244, 37.63170603752019]</span></div></div><div class="line"><div class="line-content"></div></div><div class="line"><div class="line-content"><span class="com"># Welcome to the Steamy machine version 2000!</span></div></div><div class="line"><div class="line-content"><span class="com">#</span></div></div><div class="line"><div class="line-content"><span class="com"># Temperature: 37.63170603752019</span></div></div><div class="line"><div class="line-content"><span class="com"># Changing temperature from 0.0 to 37.63170603752019 didn&apos;t change phase. How exciting!</span></div></div><div class="line"><div class="line-content"><span class="com">#</span></div></div><div class="line"><div class="line-content"><span class="com"># Temperature: -7.707680239048244</span></div></div><div class="line"><div class="line-content"><span class="com"># Water is freezing into Ice.</span></div></div><div class="line"><div class="line-content"><span class="com">#</span></div></div><div class="line"><div class="line-content"><span class="com"># Temperature: 80.74588296425821</span></div></div><div class="line"><div class="line-content"><span class="com"># Ice is melting into Water.</span></div></div><div class="line"><div class="line-content"><span class="com">#</span></div></div><div class="line"><div class="line-content"><span class="com"># Temperature: 37.0554825533913</span></div></div><div class="line"><div class="line-content"><span class="com"># Changing temperature from 80.74588296425821 to 37.0554825533913 didn&apos;t change phase. How exciting!</span></div></div><div class="line"><div class="line-content"><span class="com">#</span></div></div><div class="line"><div class="line-content"><span class="com"># Temperature: -1.654260475969281</span></div></div><div class="line"><div class="line-content"><span class="com"># Water is freezing into Ice.</span></div></div><div class="line"><div class="line-content"><span class="com">#</span></div></div><div class="line"><div class="line-content"><span class="com"># Temperature: -19.78255259056119</span></div></div><div class="line"><div class="line-content"><span class="com"># Changing temperature from -1.654260475969281 to -19.78255259056119 didn&apos;t change phase. How exciting!</span></div></div><div class="line"><div class="line-content"><span class="com">#</span></div></div><div class="line"><div class="line-content"><span class="com"># Temperature: 141.4807806383724</span></div></div><div class="line"><div class="line-content"><span class="com"># Ice is sublimating into Vapor.</span></div></div><div class="line"><div class="line-content"><span class="com"># ...</span></div></div>  </code></pre>
<h2>Displaying the state machine</h2>
<p>It is possible to display the finite state machine using Graphviz.
Synthesis representation can be converted to Graphviz &quot;.dot&quot; (or &quot;.gv&quot;) with <code>toGraphviz</code></p>
<p>Using the previous <code>waterMachine</code></p>
<pre>  <code class="language-Nim"><div class="line"><div class="line-content"><span class="kwd">const</span> <span class="ide">dotRepr</span> <span class="op">=</span> <span class="ide">toGraphviz</span>(<span class="ide">waterMachine</span>)</div></div><div class="line"><div class="line-content"><span class="ide">writeFile</span>(<span class="str">&quot;water_phase_transitions.dot&quot;</span>, <span class="ide">dotRepr</span>)</div></div>  </code></pre>
<p>Note: The conversion is done at compile-time and stored in a string.</p>
<p>To convert the graph described in the graphviz file to a <code>.png</code> use the following command (assuming a shell and graphviz package being installed)</p>
<pre>  <code class="language-sh">dot -Tpng water_phase_transitions.dot -o water_phase_transitions.png
</code></pre>
<p>For SVG</p>
<pre>  <code class="language-sh">dot -Tsvg water_phase_transitions.dot -o water_phase_transitions.svg
</code></pre>
<p>A default style is used to differentiate between states, interrupts (exceptional events) and regular events/triggers.</p>
<p>Output of the waterMachine</p>
<p>  <img src="examples/water_phase_transitions.png" style="max-width: 100%;" alt="water state transitions" /></p>
<p>Alternatives to Graphviz can be used on the <code>.dot</code> files if the output is unsatisfactory. Remember that graph node placement is usually an NP-complete task and requires heuristics to be solved that may not be optimal for your specific graph.
In that case consider splitting your finite state machine hence building hierarchical state machines.</p>
<h2>Technical constraints</h2>
<p>The state machine is used as the core of a multithreading runtime:</p>
<ul>
<li>
<p>Threading friendly:</p>
<ul>
<li>No GC or memory management on the heap</li>
</ul>
</li>
<li>
<p>Visual debugging via printing the graph to ensure that all events are handled
and no state leads to an unreachable code path.</p>
</li>
<li>
<p>Easy to map to model checking and formal verification via clearly labeled: states, events, transitions.</p>
<p>Multithreading is complex and the more we can prove properties (like the absence of deadlocks or livelocks)
the more confidence we can have in the runtime.</p>
</li>
<li>
<p>Extremely fast and very low CPU-overhead, as overhead in the state machine means more latency in scheduling work. Furthermore, slowness effects are &quot;scaled&quot; by the number of cores.</p>
</li>
<li>
<p>Extensibility: as runtime requirements grow (distributed clusters, heterogeneous computing, fine-grained barriers, IO, continuations, cancellations,...),</p>
<p>Synthesis should help minimizing the potential for entangled control-flow
and missing edge-cases.</p>
</li>
</ul>
<p>Synthesis generates a procedure-based automaton using gotos for transitions:</p>
<ul>
<li>This avoids function calls/returns and associated pushing/poping stack overhead</li>
<li>and switch dispatch branch prediction miss due to having a single point of dispatch..</li>
</ul>
<p>In addition to the multithreading runtime requirements this architecture
allow Synthesis to produce code with a very low footprint which makes it suitable for embedded.
Furthermore, setPrologue/setEpilogue/onEntry/onExit and the transitions are very flexible, they can
use inline statements, declare new variables or defer computation to one or more procs.</p>
<h2>References</h2>
<ul>
<li>  <a href="https://en.wikipedia.org/wiki/Mealy_machine">Mealy State Machine</a></li>
<li>  <a href="https://en.wikipedia.org/wiki/Pushdown_automaton">Pushdown Automaton</a></li>
<li>  <a href="https://en.wikipedia.org/wiki/Communicating_finite-state_machine">Communicating Finite State Machines</a></li>
<li>  <a href="https://en.wikipedia.org/wiki/Petri_net">Petri Nets</a></li>
<li>  <a href="https://en.wikipedia.org/wiki/Kahn_process_networks">Kahn Process Networks</a></li>
</ul>
<p>Extras</p>
<ul>
<li>  <a href="https://www.dejazzer.com/ece777/ECE777_3_system_modeling.pptx">Overview/Slides from Marquette Embedded SystemS Laboratory</a></li>
<li>  <a href="https://ptolemy.berkeley.edu/index.htm">Berkeley&apos;s Ptolemy project</a></li>
</ul>
</document>
            
        </div>
        <div class="col-3" id="meta-section">
            <div class="container box rounded p-3">
                
                    <p>
                        <strong>Licence:</strong>
                        MIT or Apache License 2.0
                    </p>
                

                
                    <p> <a href="https://github.com/mratsim/Synthesis">Project website</a> </p>
                

                
            </div>
        </div>
    </div>
</div>
</div>

<footer class="pt-10 px-3">
  <div class="container pt-4">
    <div class="row mb-4">
      <div class="col-lg-3">
        <h4 class="h5">Getting started with Nim</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://learnxinyminutes.com/docs/nim/">Learn Nim in 5 minutes</a></li>
          <li><a class="text-decoration-none" href="https://nim-by-example.github.io/">Nim by Example</a></li>
          <li><a class="text-decoration-none" href="https://play.nim-lang.org/">Official Playground</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Official Tutorials</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut1.html">General Tutorial</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut2.html">Advanced Features</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tut3.html">Macros and Metaprogramming</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Nim for...</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-C-programmers">C programmers</a></li>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-Python-Programmers">Python programmers</a></li>
          <li><a class="text-decoration-none" href="https://github.com/nim-lang/Nim/wiki/Nim-for-TypeScript-Programmers">TypeScript programmers</a></li>
        </ul>
      </div>
      <div class="col-lg-3">
        <h4 class="h5">Documentation</h4>
        <ul>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/lib.html">Standard Library</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/manual.html">Language Manual</a></li>
          <li><a class="text-decoration-none" href="https://nim-lang.org/docs/tools.html">Tools Documentation</a></li>
        </ul>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-12 text-center mt-4 mx-auto">
        <a href="#" class="d-block mb-3 mx-auto bw"></a>
        <p class="text-muted">
        Created in <a href="https://nim-lang.org/">Nim</a> on <a href="https://pages.github.com/">GitHub Pages</a>.
        <a href="https://github.com/gabbhack/nimidirectory">Available</a>
        under <a href="https://en.wikipedia.org/wiki/GNU_General_Public_License#Version_3">GPLv3</a>
        </p>
        <p class="text-muted">
        Builded at 2024-03-21T01:08:56Z
        </p>
      </div>
    </div>
  </div>
</footer>
<script>
</script>
</body>
</html>
